{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/2022-05-12-Linux-Network-Namespace/",
    "result": {"data":{"site":{"siteMetadata":{"title":"LRF"}},"markdownRemark":{"id":"73c57c26-06fd-5dd0-8ba8-7ac5d58e7737","excerpt":"NetWork Namespace简介  是  版本引入的，作用是隔离出一个独立的网络栈（包括设备、IP、路由表、端口、防火墙等），它能创建多个隔离的网络空间。 在系统上，我们可以使用命令来创建和管理。 ip netns 命令手册 按照操作手册中的命令就可以创建 . 管理Network Namespace 创建NS…","html":"<h2>NetWork Namespace简介</h2>\n<p><code class=\"language-text\">NetWork Namespace</code> 是 <code class=\"language-text\">Linux 2.6</code> 版本引入的，作用是隔离出一个独立的网络栈（包括设备、IP、路由表、端口、防火墙等），它能创建多个隔离的网络空间。</p>\n<p>在<code class=\"language-text\">Linux</code>系统上，我们可以使用<code class=\"language-text\">ip</code>命令来创建和管理<code class=\"language-text\">Network namespace</code>。</p>\n<h3>ip netns 命令手册</h3>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">SYNOPSIS\n       <span class=\"token function\">ip</span> netns <span class=\"token punctuation\">[</span> list <span class=\"token punctuation\">]</span>：列出所有的network namespace\n\n       <span class=\"token function\">ip</span> netns <span class=\"token function\">add</span> NETNSNAME：添加一个新的ns\n\n       <span class=\"token function\">ip</span> <span class=\"token punctuation\">[</span>-all<span class=\"token punctuation\">]</span> netns del <span class=\"token punctuation\">[</span> NETNSNAME <span class=\"token punctuation\">]</span>：删除所有或者指定的ns\n\n       <span class=\"token function\">ip</span> netns <span class=\"token builtin class-name\">set</span> NETNSNAME NETNSID：修改netnsname或者netnsid\n\n       <span class=\"token function\">ip</span> netns identify <span class=\"token punctuation\">[</span> PID <span class=\"token punctuation\">]</span>：把某个进程加入到network namespace中\n\n       <span class=\"token function\">ip</span> netns pids NETNSNAME：列出加入当前ns的pid\n\n       <span class=\"token function\">ip</span> <span class=\"token punctuation\">[</span>-all<span class=\"token punctuation\">]</span> netns <span class=\"token builtin class-name\">exec</span> <span class=\"token punctuation\">[</span> NETNSNAME <span class=\"token punctuation\">]</span> command<span class=\"token punctuation\">..</span>.：在netns中执行命令，如ping、ifconfig\n\n       <span class=\"token function\">ip</span> netns monitor：监控</code></pre></div>\n<p>按照操作手册中的命令就可以创建 <code class=\"language-text\">ns</code>.</p>\n<h3>管理Network Namespace</h3>\n<ul>\n<li>创建NS</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip netns add nets1</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip netns list</span>\nnets1</code></pre></div>\n<ul>\n<li>查看NS中的网络信息</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip netns exec nets1 ip link list</span>\n<span class=\"token number\">1</span>: lo: <span class=\"token operator\">&lt;</span>LOOPBACK<span class=\"token operator\">></span> mtu <span class=\"token number\">65536</span> qdisc noop state DOWN mode DEFAULT group default qlen <span class=\"token number\">1000</span>\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip netns exec nets1 route</span>\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip netns exec nets1 iptables -L</span>\nChain INPUT <span class=\"token punctuation\">(</span>policy ACCEPT<span class=\"token punctuation\">)</span>\ntarget     prot opt <span class=\"token builtin class-name\">source</span>               destination         \n\nChain FORWARD <span class=\"token punctuation\">(</span>policy ACCEPT<span class=\"token punctuation\">)</span>\ntarget     prot opt <span class=\"token builtin class-name\">source</span>               destination         \n\nChain OUTPUT <span class=\"token punctuation\">(</span>policy ACCEPT<span class=\"token punctuation\">)</span>\ntarget     prot opt <span class=\"token builtin class-name\">source</span>               destination</code></pre></div>\n<p>从结果来看，创建的<code class=\"language-text\">nets1</code>网络栈中只有<code class=\"language-text\">lo</code>这个未启用的回环设备，并且没有配置路由和防火墙规则等。</p>\n<ul>\n<li>创建一个网络设备并配置IP</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># 创建veth pair虚拟网络设备网卡</span>\n<span class=\"token comment\"># 创建一个veth0和veth1的veth 对，把veth1插入到nets1的网络栈中，veth0默认在跟network namespace中。</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip link add  veth0 type veth peer name veth1</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip link set veth1 netns nets1</span>\n<span class=\"token comment\"># 此时查看就发现多了一个网络设备veth1，但是设备没有启动，并且没有配置IP</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip netns exec nets1 ip link list</span>\n<span class=\"token number\">1</span>: lo: <span class=\"token operator\">&lt;</span>LOOPBACK<span class=\"token operator\">></span> mtu <span class=\"token number\">65536</span> qdisc noop state DOWN mode DEFAULT group default qlen <span class=\"token number\">1000</span>\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n<span class=\"token number\">9</span>: veth1@if10: <span class=\"token operator\">&lt;</span>BROADCAST,MULTICAST<span class=\"token operator\">></span> mtu <span class=\"token number\">1500</span> qdisc noop state DOWN mode DEFAULT group default qlen <span class=\"token number\">1000</span>\n    link/ether aa:54:ee:12:3a:34 brd ff:ff:ff:ff:ff:ff link-netnsid <span class=\"token number\">0</span>\n<span class=\"token comment\"># 启用网卡，并设置ip</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip netns exec nets1 ifconfig veth1 10.1.1.1/24 up</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip netns exec nets1 ifconfig</span>\nveth1: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">409</span><span class=\"token operator\"><span class=\"token file-descriptor important\">9</span>&lt;</span>UP,BROADCAST,MULTICAST<span class=\"token operator\">></span>  mtu <span class=\"token number\">1500</span>\n        inet <span class=\"token number\">10.1</span>.1.1  netmask <span class=\"token number\">255.255</span>.255.0  broadcast <span class=\"token number\">10.1</span>.1.255\n        ether aa:54:ee:12:3a:34  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Ethernet<span class=\"token punctuation\">)</span>\n        RX packets <span class=\"token number\">0</span>  bytes <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span> B<span class=\"token punctuation\">)</span>\n        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span>\n        TX packets <span class=\"token number\">0</span>  bytes <span class=\"token number\">0</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span> B<span class=\"token punctuation\">)</span>\n        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></code></pre></div>\n<ul>\n<li>删除veth对和ns</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># veth对是一个整体，删除veth0，veth1也就不存在。</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip link del veth0</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip netns del nets1</span></code></pre></div>\n<h2>单主机两个 NetWork Namespace 之间通信</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 483px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4597c3ced57ab15543a4ac1b2514a153/77a9e/veth1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.77215189873418%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsTAAALEwEAmpwYAAABY0lEQVQY02WQS0sbYRSG50f2B9Sla1cmztgWBRHciLoqXhYNhSJBM0kbAt7GTuZ85/JNTTIXhCAKEgwEU0hXk/kkKfGCz+KcFw4PHF5LKUWEWoPWIBIwN/9nIkREpQRAA+ggkGaTAbRSgjMsIuV5ulKJXTfe2a7t711Uq6nrRr7PRHR11UiSShy7termycnXNK22Wr9ohhWGQbl8vbhoHMcUHWM7k2Dbeb3eZsZ+f8uYQp4vG+NMZ2E43EB8KxcK5stytl4crNj/Jv47OXtcGv+1jVl6I4vg+VlrbQN3PpXvP8z5xd2Dw4fv37qXl5qZ0uTo9q500y0NFj72P8+fnq8yH2iteYoFAMwKwMPAuzj8oU4b+o8SDogUIgJwMxAF+qx8/Ptn3fPA9/GlsM6EqNOJozjV7TayJhIiYZbpeyhCIqSE23GUJFEUdaIZ1vg1WTbbmTGm1+uFYTgajUyeP59e8wTLjH138zp0EwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"veth1\"\n        title=\"veth1\"\n        src=\"/static/4597c3ced57ab15543a4ac1b2514a153/77a9e/veth1.png\"\n        srcset=\"/static/4597c3ced57ab15543a4ac1b2514a153/c26ae/veth1.png 158w,\n/static/4597c3ced57ab15543a4ac1b2514a153/6bdcf/veth1.png 315w,\n/static/4597c3ced57ab15543a4ac1b2514a153/77a9e/veth1.png 483w\"\n        sizes=\"(max-width: 483px) 100vw, 483px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>主机上创建两个<code class=\"language-text\">ns</code>，它们之间如何通信呢，可以使用<code class=\"language-text\">veth pair</code>进行连接。</p>\n<ul>\n<li>创建两个<code class=\"language-text\">ns</code></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\">#创建两个ns</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip netns add nets1</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip netns add nets2</span>\n\n<span class=\"token comment\"># 创建veth，并分别插入ns中</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip link add veth0 type veth peer name veth1</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip link set veth0 netns nets1</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip link set veth1 netns nets2</span></code></pre></div>\n<ul>\n<li>配置两个veth网络设备</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip netns exec nets2 ifconfig veth1 10.1.1.2/24 up</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip netns exec nets1 ifconfig veth0 10.1.1.1/24 up</span>\n\n<span class=\"token comment\"># 检查是否配置成功</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip netns exec nets1 ifconfig</span>\nveth0: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">416</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class=\"token operator\">></span>  mtu <span class=\"token number\">1500</span>\n        inet <span class=\"token number\">10.1</span>.1.1  netmask <span class=\"token number\">255.255</span>.255.0  broadcast <span class=\"token number\">10.1</span>.1.255\n        inet6 fe80::b4c2:70ff:fe8d:3b0e  prefixlen <span class=\"token number\">64</span>  scopeid 0x2<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>link<span class=\"token operator\">></span>\n        ether b6:c2:70:8d:3b:0e  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Ethernet<span class=\"token punctuation\">)</span>\n        RX packets <span class=\"token number\">8</span>  bytes <span class=\"token number\">656</span> <span class=\"token punctuation\">(</span><span class=\"token number\">656.0</span> B<span class=\"token punctuation\">)</span>\n        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span>\n        TX packets <span class=\"token number\">8</span>  bytes <span class=\"token number\">656</span> <span class=\"token punctuation\">(</span><span class=\"token number\">656.0</span> B<span class=\"token punctuation\">)</span>\n        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span>\n\n\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip netns exec nets2 ifconfig</span>\nveth1: <span class=\"token assign-left variable\">flags</span><span class=\"token operator\">=</span><span class=\"token number\">416</span><span class=\"token operator\"><span class=\"token file-descriptor important\">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class=\"token operator\">></span>  mtu <span class=\"token number\">1500</span>\n        inet <span class=\"token number\">10.1</span>.1.2  netmask <span class=\"token number\">255.255</span>.255.0  broadcast <span class=\"token number\">10.1</span>.1.255\n        inet6 fe80::f046:44ff:fe62:1ecc  prefixlen <span class=\"token number\">64</span>  scopeid 0x2<span class=\"token operator\"><span class=\"token file-descriptor important\">0</span>&lt;</span>link<span class=\"token operator\">></span>\n        ether f2:46:44:62:1e:cc  txqueuelen <span class=\"token number\">1000</span>  <span class=\"token punctuation\">(</span>Ethernet<span class=\"token punctuation\">)</span>\n        RX packets <span class=\"token number\">9</span>  bytes <span class=\"token number\">726</span> <span class=\"token punctuation\">(</span><span class=\"token number\">726.0</span> B<span class=\"token punctuation\">)</span>\n        RX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span>  overruns <span class=\"token number\">0</span>  frame <span class=\"token number\">0</span>\n        TX packets <span class=\"token number\">9</span>  bytes <span class=\"token number\">726</span> <span class=\"token punctuation\">(</span><span class=\"token number\">726.0</span> B<span class=\"token punctuation\">)</span>\n        TX errors <span class=\"token number\">0</span>  dropped <span class=\"token number\">0</span> overruns <span class=\"token number\">0</span>  carrier <span class=\"token number\">0</span>  collisions <span class=\"token number\">0</span></code></pre></div>\n<ul>\n<li>测试网络</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># 从nets1 ping nets2网络是通的</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip netns exec nets1 ping 10.1.1.2</span>\nPING <span class=\"token number\">10.1</span>.1.2 <span class=\"token punctuation\">(</span><span class=\"token number\">10.1</span>.1.2<span class=\"token punctuation\">)</span> <span class=\"token number\">56</span><span class=\"token punctuation\">(</span><span class=\"token number\">84</span><span class=\"token punctuation\">)</span> bytes of data.\n<span class=\"token number\">64</span> bytes from <span class=\"token number\">10.1</span>.1.2: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.106</span> ms\n<span class=\"token number\">64</span> bytes from <span class=\"token number\">10.1</span>.1.2: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.079</span> ms\n<span class=\"token number\">64</span> bytes from <span class=\"token number\">10.1</span>.1.2: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">3</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.083</span> ms\n\n<span class=\"token comment\"># 从nets2 ping nets1 网络是通的</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip netns exec nets2 ping 10.1.1.1</span>\nPING <span class=\"token number\">10.1</span>.1.1 <span class=\"token punctuation\">(</span><span class=\"token number\">10.1</span>.1.1<span class=\"token punctuation\">)</span> <span class=\"token number\">56</span><span class=\"token punctuation\">(</span><span class=\"token number\">84</span><span class=\"token punctuation\">)</span> bytes of data.\n<span class=\"token number\">64</span> bytes from <span class=\"token number\">10.1</span>.1.1: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.108</span> ms\n<span class=\"token number\">64</span> bytes from <span class=\"token number\">10.1</span>.1.1: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.085</span> ms\n<span class=\"token number\">64</span> bytes from <span class=\"token number\">10.1</span>.1.1: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">3</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.078</span> ms</code></pre></div>\n<h2>单主机多个 NetWork Namespace 之间通信</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/00697df5524e023cc18bc052c267f0b7/6af66/bridge.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 39.24050632911392%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsTAAALEwEAmpwYAAABoklEQVQY02XK3W/SUBiA8f7HXhiUaeLNTEiciR8XmM0riWbLDFMU9iV17ekp5z3vOe1pV0AW122sNkDFNRDlY05q9MIY/V0+eTRE7jgAQCyiS8mEAEQEEAAOMRt63WRMAghE5MgBwSDGe0PngpuWqRmGt7o6fPCod7cQFotfSqUIUR0fl0ejJ+fxw6OwcHFRPOpUQTidxofUSk9qpx/fno7oqKW3tL291s18did/tXzrey6XFQpjYP5gsJZl1xZX+cXlUpZdj7ovbHTP6VlWzxb6j8XuPDvIuu+6GrPV4zWndvtpkLtfet4pl5uUYdDc5d6zzsa9ZOXG2cmmCnSLgSKyTcKwVP28tAybFqlRTUqhFHckOBKUy22gtPKaVncMW5g7+9b6SyZ8+qpCajXSsFEiCo4IwkXLtjREgb+aFEJyxvcte7C1lR7o7TiKGvTbxnr/63j8phJub9cJcVBIIaWQruNSSjX1F1epZhB8SpI4SeIoCtptppTvefFwGPV6weHhn9PzPM65dvmf6WQynUxms1m/3/d9P03T6W//bPP5/CcrfoFQCM/bJwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"bridge\"\n        title=\"bridge\"\n        src=\"/static/00697df5524e023cc18bc052c267f0b7/f058b/bridge.png\"\n        srcset=\"/static/00697df5524e023cc18bc052c267f0b7/c26ae/bridge.png 158w,\n/static/00697df5524e023cc18bc052c267f0b7/6bdcf/bridge.png 315w,\n/static/00697df5524e023cc18bc052c267f0b7/f058b/bridge.png 630w,\n/static/00697df5524e023cc18bc052c267f0b7/6af66/bridge.png 640w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>上述是两个<code class=\"language-text\">ns</code>可以采用直接<code class=\"language-text\">veth</code>的模式进行通信，就好比采用一根网线，连接两台电脑，如果出现3台电脑需要通信，此时就不能再通过拉取网线的新式了，在物理网络中是采用交换机来处理这种问题。</p>\n<p>在虚拟网络中通常用<code class=\"language-text\">Linux bridge</code>, <code class=\"language-text\">Linux Bridge</code>可以连接任意真实的物理设备（如：eth0网卡）或任意虚拟设备（如：veth pair设备，tap设备）。</p>\n<ul>\n<li>创建一个bridge</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip link add name br0 type bridge</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip link set br0 up</span></code></pre></div>\n<ul>\n<li>创建三个ns</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># 创建3个ns</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip netns add nets1</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip netns add nets2</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip netns add nets3</span>\n<span class=\"token comment\"># 创建3对veth pair</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip link add type veth</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip link add type veth</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip link add type veth</span>\n</code></pre></div>\n<ul>\n<li>把br0和3个ns版定</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># 把veth1、veth3、veth5分别插入nets1、nets2、nets3中</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip link set veth1 netns nets1</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip link set veth3 netns nets2</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip link set veth5 netns nets3</span>\n<span class=\"token comment\"># 把veth0、veth2、veth4插入br0中</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip link set dev veth0 master br0 up</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip link set dev veth2 master br0 up</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip link set dev veth4 master br0 up</span>\n<span class=\"token comment\"># 设置三个ip给veth1、veth3、veth5设备并启用</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip netns exec nets1 ifconfig veth1 10.1.1.1/24 up</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip netns exec nets2 ifconfig veth3 10.1.1.2/24 up</span>\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip netns exec nets3 ifconfig veth5 10.1.1.3/24 up</span></code></pre></div>\n<p>进过上述配置之后呢就把这三个ns通过br0这个桥绑定上了，就可以做到两两任意访问了。</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip netns exec nets1 ping 10.1.1.2</span>\nPING <span class=\"token number\">10.1</span>.1.2 <span class=\"token punctuation\">(</span><span class=\"token number\">10.1</span>.1.2<span class=\"token punctuation\">)</span> <span class=\"token number\">56</span><span class=\"token punctuation\">(</span><span class=\"token number\">84</span><span class=\"token punctuation\">)</span> bytes of data.\n<span class=\"token number\">64</span> bytes from <span class=\"token number\">10.1</span>.1.2: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.138</span> ms\n<span class=\"token number\">64</span> bytes from <span class=\"token number\">10.1</span>.1.2: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.172</span> ms\n<span class=\"token number\">64</span> bytes from <span class=\"token number\">10.1</span>.1.2: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">3</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.138</span> ms\n\n<span class=\"token punctuation\">[</span>root@k8s-master-168 ~<span class=\"token punctuation\">]</span><span class=\"token comment\"># ip netns exec nets1 ping 10.1.1.3</span>\nPING <span class=\"token number\">10.1</span>.1.3 <span class=\"token punctuation\">(</span><span class=\"token number\">10.1</span>.1.3<span class=\"token punctuation\">)</span> <span class=\"token number\">56</span><span class=\"token punctuation\">(</span><span class=\"token number\">84</span><span class=\"token punctuation\">)</span> bytes of data.\n<span class=\"token number\">64</span> bytes from <span class=\"token number\">10.1</span>.1.3: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">1</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.149</span> ms\n<span class=\"token number\">64</span> bytes from <span class=\"token number\">10.1</span>.1.3: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">2</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.114</span> ms\n<span class=\"token number\">64</span> bytes from <span class=\"token number\">10.1</span>.1.3: <span class=\"token assign-left variable\">icmp_seq</span><span class=\"token operator\">=</span><span class=\"token number\">3</span> <span class=\"token assign-left variable\">ttl</span><span class=\"token operator\">=</span><span class=\"token number\">64</span> <span class=\"token assign-left variable\">time</span><span class=\"token operator\">=</span><span class=\"token number\">0.130</span> ms\n</code></pre></div>\n<h2>跨主机多个 NetWork Namespace 之间通信</h2>\n<p>跨主机网络通信涉及到需要通过<code class=\"language-text\">vxlan</code>、<code class=\"language-text\">macvlan</code>、<code class=\"language-text\">ipvlan</code>等技术进行跨主机组网，</p>","frontmatter":{"title":"Linux网络虚拟化:探索NetWork Namespace","date":"May 12, 2022","description":null}},"previous":{"fields":{"slug":"/2022-05-11-k8s之CNI规范解读/"},"frontmatter":{"title":"Kubernetes网络之CNI规范解读"}},"next":{"fields":{"slug":"/2022-05-18-读云计算那些事/"},"frontmatter":{"title":"读《云计算那些事儿》"}}},"pageContext":{"id":"73c57c26-06fd-5dd0-8ba8-7ac5d58e7737","previousPostId":"c9d34b82-e40f-54f2-9ab5-df07216db4c3","nextPostId":"f3cee233-439e-58e1-b2da-f022123debe7"}},
    "staticQueryHashes": ["2841359383","3257411868"]}