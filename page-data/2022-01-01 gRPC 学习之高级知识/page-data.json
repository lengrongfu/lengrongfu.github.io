{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/2022-01-01 gRPC 学习之高级知识/",
    "result": {"data":{"site":{"siteMetadata":{"title":"LRF"}},"markdownRemark":{"id":"20dad7a7-ca51-555f-b384-6509115a774e","excerpt":"高级知识 之前的文章中记录了对 gRPC 的使用，但是都没有涉及底层的通信基础知识。这篇文章主要介绍 gRPC 的高级知识，涉及到 gRPC 的底层原理、 gRPC 底层原理 gRPC 超越基础知识 这部分主要讲述在构建真正的gRPC应用时，对于需要增强它们的各种能力，比如：拦截gRPC…","html":"<h2>高级知识</h2>\n<p>之前的文章中记录了对 gRPC 的使用，但是都没有涉及底层的通信基础知识。这篇文章主要介绍 gRPC 的高级知识，涉及到 gRPC 的底层原理、</p>\n<h3>gRPC 底层原理</h3>\n<h3>gRPC 超越基础知识</h3>\n<p>这部分主要讲述在构建真正的gRPC应用时，对于需要增强它们的各种能力，比如：拦截gRPC的输入和输出、弹性处理网络延迟、处理错误、在服务和消费者之间共享元数据。</p>\n<h4>拦截器</h4>\n<p>在 <code class=\"language-text\">gRPC</code> 中，可以拦截 <code class=\"language-text\">gRPC</code> 的执行.来满足特定的需求，如日志、认证、性能度盐指标等，这会使用一种名为拦截器的扩展机制。它是 <code class=\"language-text\">gRPC</code> 核心扩展机制之一 ，在一些使用场呆中非常有用，比如日志、身份验证、授权、性能度盘指标、跟踪以及其他一些自定义错求.</p>\n<p>根据所拦截的 <code class=\"language-text\">RPC</code> 调用类型，<code class=\"language-text\">gRPC</code> 拦截可以分为两类，对于一元<code class=\"language-text\">RPC</code>，使用一元拦截器，对于流<code class=\"language-text\">RPC</code>，使用流拦截器；这些拦截器既可以用在服务端也可以用在客户端。</p>\n<h5>服务端拦截器</h5>\n<p>当客户端调用 gRPC服务的远程方法肘，通过使用服务器端拦截器，可以在执行远程方法 之前，执行一个通用的逻辑。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/49e9add621361ce0afb361338b098d87/b7756/grpc-server-intercepter.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.75949367088608%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAACJElEQVQoz42R62+aUBiH+f8/NnZ2ly5LlrRpdrGdiiIVxbWK1dr1opaLiKJ4AUQEDj1wDmexLm2yfdnv03vy5nnPk/yoKIqSJMEYJ0lC/glCSJ/O3I1HCPlrjxCiEEK7RxAAmmbzNEsXzulCOZst0YUyw/IMyxdZvlDkCgzHcRdc5bJauWTZ6k3nlkIo3sHz+TKXK82MuTYcTyazr1/OWLayXFgT3dB14+Qks7f3VhKVle1Y1mo8mtT4OuVuNuu1q8jqaKhf/GwmhJjWCj6hElO9uuogTGxn7YdhNl96kz60LHv3EwBhU2hTT+FTHMcQQsNY8HwdIex5fgiiAl0WGm2EEj8AGx9kfhRT6Q/LpbmDfT+oN1pUFL9oLxpCixCyO19iuJvOHXkWiRE+yzH76UPTtDHGURQBEApCi4pf4WWjsYXXjksIYYqVzvUtIcR1N3GMT3PMVtu0kySJYwQAqAstKggAhNBZOdPpjK/Vt7OzDvyAKXJNoQ2jyHHdtetlssX9g4+LxR9tz/O32p7nBwHQtPFkYgiNq+fOQkJIuVz7dbPVDsIQRihHnx+8+2Tbq5dem8L1a8/m0jrN5Ps9+f6+3+1Kx0ff8zTblwd3XfG2K34++pZKve9c36nqSB1oDw/9SuWCghCi50AYybLa6z72+1KvK8myKsuDR1EWRUWUBpo21sdTdaApsqooQ0VR5/MFpeuGadq9nihJqqbpGGPy3/kNVAV+i61jIzYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"grpc-server-intercepter\"\n        title=\"grpc-server-intercepter\"\n        src=\"/static/49e9add621361ce0afb361338b098d87/f058b/grpc-server-intercepter.png\"\n        srcset=\"/static/49e9add621361ce0afb361338b098d87/c26ae/grpc-server-intercepter.png 158w,\n/static/49e9add621361ce0afb361338b098d87/6bdcf/grpc-server-intercepter.png 315w,\n/static/49e9add621361ce0afb361338b098d87/f058b/grpc-server-intercepter.png 630w,\n/static/49e9add621361ce0afb361338b098d87/40601/grpc-server-intercepter.png 945w,\n/static/49e9add621361ce0afb361338b098d87/78612/grpc-server-intercepter.png 1260w,\n/static/49e9add621361ce0afb361338b098d87/b7756/grpc-server-intercepter.png 2294w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>在服务器销， 一元拦截器拦截一元 RPC，梳拦iliV:ìI售出1拦截流 RPC. 下回来右一下服务器揣\n一元拦敲器.</p>\n<ul>\n<li>一元拦截</li>\n</ul>\n<p>要实现这一点 ，需要先实现 <code class=\"language-text\">UnaryServerlnterceptor</code> 类型的函数， 并在创 <code class=\"language-text\">gRPC</code> 服务器端时将函数注册进来。 <code class=\"language-text\">UnaryServerlnterceptor</code> 是用于服务器端一元拦截的类型。函数定义类型如下。</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>ctx context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> req <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> info 叫JnaryServerlnfo，\nhand1er UnaryHand1er<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>re5p <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> err <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>例如：进行一元拦截，打印日志。</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">orderUnaryServerlnterceptor</span><span class=\"token punctuation\">(</span>ctx context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> req <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n\tinfo <span class=\"token operator\">*</span>grpc<span class=\"token punctuation\">.</span>UnaryServerInfo<span class=\"token punctuation\">,</span> handler grpc<span class=\"token punctuation\">.</span>UnaryHandler<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"======= [Server Interceptor1 \"</span><span class=\"token punctuation\">,</span> info<span class=\"token punctuation\">.</span>FullMethod<span class=\"token punctuation\">)</span>\n\tm<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> req<span class=\"token punctuation\">)</span>\n\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"post proc mess: %s\"</span><span class=\"token punctuation\">,</span> m<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 可以拦截修改返回内容</span>\n    <span class=\"token keyword\">if</span> order<span class=\"token punctuation\">,</span> ok <span class=\"token operator\">:=</span> m<span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>pb<span class=\"token punctuation\">.</span>Order<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> ok <span class=\"token punctuation\">{</span>\n\t\torder<span class=\"token punctuation\">.</span>Price <span class=\"token operator\">=</span> <span class=\"token number\">100</span>\n\t\t<span class=\"token keyword\">return</span> order<span class=\"token punctuation\">,</span> err\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token keyword\">return</span> m<span class=\"token punctuation\">,</span> err\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span><span class=\"token punctuation\">.</span>省略\n\ts <span class=\"token operator\">:=</span> grpc<span class=\"token punctuation\">.</span><span class=\"token function\">NewServer</span><span class=\"token punctuation\">(</span>grpc<span class=\"token punctuation\">.</span><span class=\"token function\">UnaryInterceptor</span><span class=\"token punctuation\">(</span>orderUnaryServerlnterceptor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\tpb<span class=\"token punctuation\">.</span><span class=\"token function\">RegisterOrderManagementServer</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>server<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">Serve</span><span class=\"token punctuation\">(</span>listen<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token function\">panic</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<ul>\n<li>流拦截</li>\n</ul>\n<p>服务器端流拦截器会拦截 <code class=\"language-text\">gRPC</code> 服务器所处理的所有流<code class=\"language-text\">RPC</code>。 流拦截器包括前置处理阶段和流操作拦截阶段。</p>\n<p>要实现流拦截，需要实现<code class=\"language-text\">Streal'1Serverlnterceptor</code> 函数：</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>srv <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> ss grpc<span class=\"token punctuation\">.</span>ServerStream<span class=\"token punctuation\">,</span>info <span class=\"token operator\">*</span>grpc<span class=\"token punctuation\">.</span>StreamServerInfo<span class=\"token punctuation\">,</span>handler grpc<span class=\"token punctuation\">.</span>StreamHandler<span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span>  <span class=\"token punctuation\">{</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">grpc.ServerStream</code> 的包装器可以拦截 <code class=\"language-text\">gRPC</code> 服务发送或接收到的数据，它实现了 <code class=\"language-text\">SendMsg</code> 函数和 <code class=\"language-text\">RecvMsg</code> 函数，这两个函数分别会在服务发送和接收 <code class=\"language-text\">RPC</code> 流消息的时候调用。</p>\n<p>在流 <code class=\"language-text\">RPC</code> 进入服务前，可以通过 <code class=\"language-text\">grpc.ServeStream</code> 进行流的处理，再通过 <code class=\"language-text\">grpc.StreamHandler</code> 来进行调用。</p>\n<p>例如：在 <code class=\"language-text\">OrderManager</code> 的流接口中先进行输入流的处理，再调用 <code class=\"language-text\">RPC</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">type</span> wrappedSteam <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n\tgrpc<span class=\"token punctuation\">.</span>ServerStream\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">var</span> <span class=\"token boolean\">_</span> grpc<span class=\"token punctuation\">.</span>ServerStream <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>wrappedSteam<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>w <span class=\"token operator\">*</span>wrappedSteam<span class=\"token punctuation\">)</span> <span class=\"token function\">RecvMsg</span><span class=\"token punctuation\">(</span>m <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"=====RecvMSg==== %T\"</span><span class=\"token punctuation\">,</span> m<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">return</span> w<span class=\"token punctuation\">.</span>ServerStream<span class=\"token punctuation\">.</span><span class=\"token function\">RecvMsg</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>w <span class=\"token operator\">*</span>wrappedSteam<span class=\"token punctuation\">)</span> <span class=\"token function\">SendMsg</span><span class=\"token punctuation\">(</span>m <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"====SendMsg====\"</span><span class=\"token punctuation\">,</span> m<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">return</span> w<span class=\"token punctuation\">.</span>ServerStream<span class=\"token punctuation\">.</span><span class=\"token function\">SendMsg</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">newWrappedStream</span><span class=\"token punctuation\">(</span>s grpc<span class=\"token punctuation\">.</span>ServerStream<span class=\"token punctuation\">)</span> grpc<span class=\"token punctuation\">.</span>ServerStream <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token operator\">&amp;</span>wrappedSteam<span class=\"token punctuation\">{</span>s<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">orderServerStreamInterceptor</span><span class=\"token punctuation\">(</span>srv <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> ss grpc<span class=\"token punctuation\">.</span>ServerStream<span class=\"token punctuation\">,</span> info <span class=\"token operator\">*</span>grpc<span class=\"token punctuation\">.</span>StreamServerInfo<span class=\"token punctuation\">,</span> handler grpc<span class=\"token punctuation\">.</span>StreamHandler<span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"===== [Server Steam Interceptor ]\"</span><span class=\"token punctuation\">,</span> info<span class=\"token punctuation\">.</span>FullMethod<span class=\"token punctuation\">)</span> \n\terr <span class=\"token operator\">:=</span> <span class=\"token function\">handler</span><span class=\"token punctuation\">(</span>srv<span class=\"token punctuation\">,</span> <span class=\"token function\">newWrappedStream</span><span class=\"token punctuation\">(</span>ss<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Fatalf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"RPC failed with error %v\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token keyword\">return</span> err\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token operator\">...</span>\n\ts <span class=\"token operator\">:=</span> grpc<span class=\"token punctuation\">.</span><span class=\"token function\">NewServer</span><span class=\"token punctuation\">(</span>grpc<span class=\"token punctuation\">.</span><span class=\"token function\">StreamInterceptor</span><span class=\"token punctuation\">(</span>orderServerStreamInterceptor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\tpb<span class=\"token punctuation\">.</span><span class=\"token function\">RegisterOrderManagementServer</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>server<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> s<span class=\"token punctuation\">.</span><span class=\"token function\">Serve</span><span class=\"token punctuation\">(</span>listen<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token function\">panic</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>在流开始时会进入 <code class=\"language-text\">orderServerStreamInterceptor</code> 方法，流结束后才会推出，在流每次 <code class=\"language-text\">RecvMsg</code> 时会进入到流拦截的 <code class=\"language-text\">(w *wrappedSteam) RecvMsg</code> 方法中，<code class=\"language-text\">SendMsg</code> 同理。</p>\n<h5>客户端拦截器</h5>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/dc07d75222f341085a962a66a82ecc2c/bf668/grpc-client-interceptor.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.12658227848101%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB/0lEQVQoz3WSa2/TMBSG8/9/BkhcMjRRkGg3MSZglxa2wZo4dhK7TtqNrmnX3Bw7vsRD3aBDmni+HR09Oq9eHUdrffcEa+3iJhOifbrSf5FSOlm29LwgAMj3oO9BABAIQt+HFxfeeBx4IByDcOyjsQ89gCCMtfpzzBjjAB9d/gRpOkvoNADh82fu7pv3ISKEJGlydXQ0+tA/wCTBmCbp1Zevw7KsHuUwxEVRPsxNw3fc3v7eoRAtY41SKorI6bcfWquyqrUxAYyybBljUpYVF8KBML5drR/kumLu696g/4nVDRdcaw1hdHz6vZUt59wY43lwvS4YY0pppdRGzparVkou2qpmrtvbHxwqpfK8MMZgQk+GZ53pbte5tR0KcZ6Xj7E3crZqGs4Yr+rGdXt7G1kXRdkZExN6MjqztsvzwlqLEM6LraydIIhW29g127mP3TAupeyMgSg+Hp5JKdu27TpzuYmdN5wrpbTWDkJxvi62hbmv3g76B03Dy7IWQsAwPhmet63M80JJCYJwschiTIqiFEI4IAg9gK7n2a/5IsLJyxe773qDCZkmdDa7mh+PzgcfP0/S2SSdzq7np6OLqqq33+LMbxY+CD0feT6EMCKEEpzgmGJMMaF4kmBCY0IjQskkSdKplFIbbcx928vlijG2zJaUpg9lWGvv/o/9h9+C2YzsH6YUUgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"grpc-client-interceptor\"\n        title=\"grpc-client-interceptor\"\n        src=\"/static/dc07d75222f341085a962a66a82ecc2c/f058b/grpc-client-interceptor.png\"\n        srcset=\"/static/dc07d75222f341085a962a66a82ecc2c/c26ae/grpc-client-interceptor.png 158w,\n/static/dc07d75222f341085a962a66a82ecc2c/6bdcf/grpc-client-interceptor.png 315w,\n/static/dc07d75222f341085a962a66a82ecc2c/f058b/grpc-client-interceptor.png 630w,\n/static/dc07d75222f341085a962a66a82ecc2c/40601/grpc-client-interceptor.png 945w,\n/static/dc07d75222f341085a962a66a82ecc2c/78612/grpc-client-interceptor.png 1260w,\n/static/dc07d75222f341085a962a66a82ecc2c/bf668/grpc-client-interceptor.png 2328w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ul>\n<li>一元拦截</li>\n</ul>\n<p>一元拦截的函数签名：</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">type</span> UnaryClientInterceptor <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>ctx context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> method <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> req<span class=\"token punctuation\">,</span> reply <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> cc <span class=\"token operator\">*</span>ClientConn<span class=\"token punctuation\">,</span> invoker UnaryInvoker<span class=\"token punctuation\">,</span> opts <span class=\"token operator\">...</span>CallOption<span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span>\n</code></pre></div>\n<p>与服务端拦截一元拦截器一样，客户端一元拦截器也有不同的阶段。</p>\n<p>例子：</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">orderClientInterceptor</span><span class=\"token punctuation\">(</span>ctx context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> method <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> req<span class=\"token punctuation\">,</span> apply <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> cc <span class=\"token operator\">*</span>grpc<span class=\"token punctuation\">.</span>ClientConn<span class=\"token punctuation\">,</span> invoker grpc<span class=\"token punctuation\">.</span>UnaryInvoker<span class=\"token punctuation\">,</span> opts <span class=\"token operator\">...</span>grpc<span class=\"token punctuation\">.</span>CallOption<span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Method :\"</span> <span class=\"token operator\">+</span> method<span class=\"token punctuation\">)</span>\n\tstart <span class=\"token operator\">:=</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\terr <span class=\"token operator\">:=</span> <span class=\"token function\">invoker</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> method<span class=\"token punctuation\">,</span> req<span class=\"token punctuation\">,</span> apply<span class=\"token punctuation\">,</span> cc<span class=\"token punctuation\">,</span> opts<span class=\"token operator\">...</span><span class=\"token punctuation\">)</span>\n\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"cost is [%d]ms\"</span><span class=\"token punctuation\">,</span>time<span class=\"token punctuation\">.</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Sub</span><span class=\"token punctuation\">(</span>start<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Milliseconds</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">return</span> err\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\tconn<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> grpc<span class=\"token punctuation\">.</span><span class=\"token function\">Dial</span><span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">,</span> grpc<span class=\"token punctuation\">.</span><span class=\"token function\">WithInsecure</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>grpc<span class=\"token punctuation\">.</span><span class=\"token function\">WithUnaryInterceptor</span><span class=\"token punctuation\">(</span>orderClientInterceptor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>流拦截</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">type</span> StreamClientInterceptor <span class=\"token keyword\">func</span><span class=\"token punctuation\">(</span>ctx context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> desc <span class=\"token operator\">*</span>StreamDesc<span class=\"token punctuation\">,</span> cc <span class=\"token operator\">*</span>ClientConn<span class=\"token punctuation\">,</span> method <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> streamer Streamer<span class=\"token punctuation\">,</span> opts <span class=\"token operator\">...</span>CallOption<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>ClientStream<span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>例子：</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">type</span> wrappedSteam <span class=\"token keyword\">struct</span> <span class=\"token punctuation\">{</span>\n\tgrpc<span class=\"token punctuation\">.</span>ClientStream\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>w <span class=\"token operator\">*</span>wrappedSteam<span class=\"token punctuation\">)</span> <span class=\"token function\">RecvMsg</span><span class=\"token punctuation\">(</span>m <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"===== [ Client Stream Interceptor ] Receive a message (Type :%T) at %v\"</span><span class=\"token punctuation\">,</span> m<span class=\"token punctuation\">,</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Format</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>RFC3339<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">return</span> w<span class=\"token punctuation\">.</span>ClientStream<span class=\"token punctuation\">.</span><span class=\"token function\">RecvMsg</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>w <span class=\"token operator\">*</span>wrappedSteam<span class=\"token punctuation\">)</span> <span class=\"token function\">SendMsg</span><span class=\"token punctuation\">(</span>m <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"===== [Client Stream Interceptor ] Send a message (Type :%T) at %v\"</span><span class=\"token punctuation\">,</span>m<span class=\"token punctuation\">,</span> time<span class=\"token punctuation\">.</span><span class=\"token function\">Now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Format</span><span class=\"token punctuation\">(</span>time<span class=\"token punctuation\">.</span>RFC3339<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">return</span> w<span class=\"token punctuation\">.</span>ClientStream<span class=\"token punctuation\">.</span><span class=\"token function\">SendMsg</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">newWrappedStream</span><span class=\"token punctuation\">(</span>cs grpc<span class=\"token punctuation\">.</span>ClientStream<span class=\"token punctuation\">)</span> grpc<span class=\"token punctuation\">.</span>ClientStream <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token operator\">&amp;</span>wrappedSteam<span class=\"token punctuation\">{</span>cs<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">orderClientStreamInterceptor</span><span class=\"token punctuation\">(</span>ctx context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> desc <span class=\"token operator\">*</span>grpc<span class=\"token punctuation\">.</span>StreamDesc<span class=\"token punctuation\">,</span> cc <span class=\"token operator\">*</span>grpc<span class=\"token punctuation\">.</span>ClientConn<span class=\"token punctuation\">,</span> method <span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> streamer grpc<span class=\"token punctuation\">.</span>Streamer<span class=\"token punctuation\">,</span> opts <span class=\"token operator\">...</span>grpc<span class=\"token punctuation\">.</span>CallOption<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>grpc<span class=\"token punctuation\">.</span>ClientStream<span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"===== [Client Interceptor] \"</span><span class=\"token punctuation\">,</span>method<span class=\"token punctuation\">)</span>\n\ts<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> <span class=\"token function\">streamer</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> desc<span class=\"token punctuation\">,</span> cc<span class=\"token punctuation\">,</span> method<span class=\"token punctuation\">,</span> opts<span class=\"token operator\">...</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token function\">newWrappedStream</span><span class=\"token punctuation\">(</span>s<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> err\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\tconn<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> grpc<span class=\"token punctuation\">.</span><span class=\"token function\">Dial</span><span class=\"token punctuation\">(</span>address<span class=\"token punctuation\">,</span> grpc<span class=\"token punctuation\">.</span><span class=\"token function\">WithInsecure</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>grpc<span class=\"token punctuation\">.</span><span class=\"token function\">WithStreamInterceptor</span><span class=\"token punctuation\">(</span>orderClientStreamInterceptor<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h4>截止时间</h4>","frontmatter":{"title":"gRPC 学习之-高级知识","date":"December 26, 2021","description":"我把 `gRPC`  共划分为四个级别来学习，有浅入深的展开，对应不同阶段的人进行学习。"}},"previous":{"fields":{"slug":"/2021-12-30 gRPC 学习之中级知识/"},"frontmatter":{"title":"gRPC 学习之-中级知识"}},"next":{"fields":{"slug":"/2022-03-01-serverless基础知识/"},"frontmatter":{"title":"Serverless 入门知识"}}},"pageContext":{"id":"20dad7a7-ca51-555f-b384-6509115a774e","previousPostId":"6599b40c-659d-546e-a496-bc5dfd06a04b","nextPostId":"978b29f5-589f-5781-8b9a-21e46df0632f"}},
    "staticQueryHashes": ["2841359383","3257411868"]}