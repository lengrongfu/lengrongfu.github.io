{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/2018-10-17-es-xpack-watch-user/",
    "result": {"data":{"site":{"siteMetadata":{"title":"LRF"}},"markdownRemark":{"id":"a5dbd2cc-2d87-5816-90b7-c112ccb62043","excerpt":"Watcher Es 安装了官方x-pack的插件，可以用来做业务监控。第一次使用请先阅读下面的注意事项。 使用 1、进入页面，从进入，有一个的按钮，进入之后就可以进行添加.…","html":"<h1>Watcher</h1>\n<p><strong>Es 安装了官方x-pack的插件，可以用来做业务监控。第一次使用请先阅读下面的注意事项。</strong></p>\n<h2>使用</h2>\n<p>1、进入<code class=\"language-text\">kibana</code>页面，从<code class=\"language-text\">management</code>进入，有一个<code class=\"language-text\">Watcher</code>的按钮，进入之后就可以进行<code class=\"language-text\">watcher</code>添加.</p>\n<p>2、点击<code class=\"language-text\">Addr</code>进入页面之后添加一个<code class=\"language-text\">ID</code>和<code class=\"language-text\">name</code>.之后编辑<code class=\"language-text\">watch Json</code>内容。</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"trigger\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"schedule\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"interval\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"30m\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"input\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"search\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"request\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"body\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"size\"</span><span class=\"token operator\">:</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"query\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token property\">\"match_all\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"indices\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n          <span class=\"token string\">\"*\"</span>\n        <span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"condition\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"compare\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"ctx.payload.hits.total\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"gte\"</span><span class=\"token operator\">:</span> <span class=\"token number\">10</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"actions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"my-logging-action\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"logging\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"There are {{ctx.payload.hits.total}} documents in your index. Threshold is 10.\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>一个<code class=\"language-text\">Watcher</code>由四部分组成.</p>\n<ul>\n<li><code class=\"language-text\">Schedule</code>：查询和检查的定时任务</li>\n<li><code class=\"language-text\">Query</code>：查询的语句，支持<code class=\"language-text\">es</code>的完整查询语句。</li>\n<li><code class=\"language-text\">Condition</code>:判断条件，是否满足</li>\n<li><code class=\"language-text\">Actions</code>:满足条件之后触发的动作</li>\n</ul>\n<p>1、上面的定时任务是<code class=\"language-text\">30</code>分钟,可以改为<code class=\"language-text\">10s</code>,<code class=\"language-text\">1h</code>,不建议这个值太小，这样对<code class=\"language-text\">es</code>服务器压力比较大，并且没有太大意义。</p>\n<p>2、上面的<code class=\"language-text\">query</code>就是查询所有<code class=\"language-text\">index</code>的所以数据，具体的查看语句需要自己写。</p>\n<p>3、比较条件，上面的是比较<code class=\"language-text\">ctx.payload.hits.total</code>这个返回的值是否大于<code class=\"language-text\">10</code>,大于等于用<code class=\"language-text\">gte</code>,大于用<code class=\"language-text\">gt</code>,小于用<code class=\"language-text\">lt</code>,小于等于用<code class=\"language-text\">lte</code>.</p>\n<p>4、触发动作，上述的触发动作是打印日志。触发动作可以选择发送邮件。</p>\n<h2>场景用列</h2>\n<ul>\n<li>业务系统中一个关键节点异常告警</li>\n<li>监控 <code class=\"language-text\">nginx</code> 一分钟之内<code class=\"language-text\">code</code>为<code class=\"language-text\">500</code>出现次数10次以上则告警</li>\n</ul>\n<h2>注意事项</h2>\n<ul>\n<li>新建的<code class=\"language-text\">watcher</code>的<code class=\"language-text\">id</code>和<code class=\"language-text\">name</code>，不要和已有的重名，不然会把人家的给覆盖掉，并且不能恢复回来，必须重写。所以写的人也要注意，自己写了的也要保存一份。</li>\n<li>定时任务时间不到太短</li>\n<li>上述查询返回是没有内容的，之后返回查询命中多少条，如果要返回多少条，请修改<code class=\"language-text\">query</code>中的<code class=\"language-text\">size</code>字段，这个值不要给太大，最好不要超过<code class=\"language-text\">100</code>,太大，会把服务器内存耗尽。如果需要只返回前面的几条数据即可。</li>\n<li>每个<code class=\"language-text\">watch</code>语句最好都在开发环境上测试一下，开发环境有同样的工具。</li>\n<li>如果<code class=\"language-text\">query</code>语句比较复杂，请在<code class=\"language-text\">Dev Tools</code>控制面板中先写好测试过了之后再使用，添加到线上之前请再三进行测试一下。</li>\n</ul>\n<h2>其他问题</h2>\n<ul>\n<li>如果要获取返回的数据并且序列化为一个字符串需要使用</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"actions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"my_webhook\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"transform\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"script\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token property\">\"inline\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"return ctx.payload.hits.hits.stream().map(p -> p._source.message).collect(Collectors.toList())\"</span><span class=\"token punctuation\">,</span>\n          <span class=\"token property\">\"lang\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"painless\"</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"my-logging-action\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"logging\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"text\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"{{#toJson}}ctx.payload{{/toJson}}\"</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<h2>参考文档</h2>\n<ul>\n<li><a href=\"https://www.elastic.co/guide/en/x-pack/5.4/xpack-alerting.html\">https://www.elastic.co/guide/en/x-pack/5.4/xpack-alerting.html</a></li>\n<li><a href=\"https://demo.elastic.co\">https://demo.elastic.co</a></li>\n</ul>","frontmatter":{"title":"es-xpack-watch-user","date":"October 17, 2018","description":null}},"previous":{"fields":{"slug":"/2018-10-17-es-xpack-install/"},"frontmatter":{"title":"ES X-Pack 5.4.3破解安装"}},"next":{"fields":{"slug":"/2018-10-17-es-node-restart-problme/"},"frontmatter":{"title":"ES 节点重启问题"}}},"pageContext":{"id":"a5dbd2cc-2d87-5816-90b7-c112ccb62043","previousPostId":"c67bfda4-f0f6-539d-b5e5-5f482a7b2c2b","nextPostId":"6c4d6dfe-fe0a-5535-8d4a-e89892c367ec"}},
    "staticQueryHashes": ["2841359383","3257411868"]}