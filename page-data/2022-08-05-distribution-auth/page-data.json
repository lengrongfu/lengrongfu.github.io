{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/2022-08-05-distribution-auth/",
    "result": {"data":{"site":{"siteMetadata":{"title":"LRF"}},"markdownRemark":{"id":"dc932fdd-1014-5e3e-9ed3-b1ee13bdfd90","excerpt":"是一个按照  的规范实现的一个制品库管理工具，它提供了三种的认证方式，、、，在  项目中采用的是策略模式。 它的认证流程如下图所示：  htpasswd…","html":"<p><a href=\"https://github.com/distribution/distribution\"><code class=\"language-text\">Distribution</code></a> 是一个按照 <code class=\"language-text\">OCI</code> 的规范实现的一个制品库管理工具，它提供了三种的认证方式，<code class=\"language-text\">htpasswd</code>、<code class=\"language-text\">silly</code>、<code class=\"language-text\">token</code>，在 <code class=\"language-text\">Distribution</code> 项目中采用的是策略模式。</p>\n<p>它的认证流程如下图所示：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 610px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f07c3b4ac5a97ea0d8b3507df6a165bf/5aae9/auth.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 127.84810126582278%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAaCAIAAAA44esqAAAACXBIWXMAAAsTAAALEwEAmpwYAAACNUlEQVQ4y5WU227qMBBF+/+fhtQ+tKoEpZAInEJjcvHdHnvwkTKqgUArnfWQq3dmvL2dp/yIEAIA5JzP5/P922EY6OLpoRgm8i/0ff+XOMbY9z3nXEr53+KU0vf3N2NMCPGX+HxHztkYY62lOd9zEYcQ4g+I+PX1tVqt1uv1ZrN5e3trmialFK8AgIs43gEAcgIAYowzMSI+rgwAdV2v1+u6rj8mqqry3l/rqTL1P69sJoQQ4zjSNdUvpJQula/fAUDbtofDYb/f73a7ZuK6NRK3bcsYa5rmie4LXddxzunY933XdbMBiNi27fF45JzfiGOMWmul1Ol04pwrpYQQIYR0y41hAEBPvfeMse12yxjb7/fVhHOuGEaxnSdMa+2c894DACIqpbTWiAgA3nvnnNY6xkixmSfselVDCNQ8NUwF7QTl70bcdV3btqfTCREp2FJKpVRKKeeMiCEEzjkt+Fw8jmPTNJzzIiarihgAOOfW2gdiRKTcFXFZUpok6cuAuWHGGDdhrfXeU7ZDCO4HpdSvWxIRqU75ljGm3FLNsmEv4rI8Xdc9Pz9vt9vNZrNcLt/f3+u6rqpquVwej0eybb7OJTfOuXEchRBSymEY+r4n22iHlCDebEk6CSGoBUqblJLchh9owHzO1M8wDM45MhMAKGFltHPOGCOlpJDdVN7tdovF4vX1lcTOudVEcZgx9vLy8vn5SZ+7/LcRkX53WmsyPMZIeaY6OWdrrVKK4omIjDES/wMzRuQjHW68iQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"auth\"\n        title=\"auth\"\n        src=\"/static/f07c3b4ac5a97ea0d8b3507df6a165bf/5aae9/auth.png\"\n        srcset=\"/static/f07c3b4ac5a97ea0d8b3507df6a165bf/c26ae/auth.png 158w,\n/static/f07c3b4ac5a97ea0d8b3507df6a165bf/6bdcf/auth.png 315w,\n/static/f07c3b4ac5a97ea0d8b3507df6a165bf/5aae9/auth.png 610w\"\n        sizes=\"(max-width: 610px) 100vw, 610px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>htpasswd</h2>\n<p><code class=\"language-text\">htpasswd</code> 是一种在系统中，它包含一个 <code class=\"language-text\">htpasswd</code> 的文件（文件内容是初始的用户名<code class=\"language-text\">docker</code>，以及一个使用特定算法随机生成的密码）以及如何解析这个文件的算法（目前只能使用 <code class=\"language-text\">bcrypt</code> 加密算法）。</p>\n<p>配置格式如下：</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">auth</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">htpasswd</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">realm</span><span class=\"token punctuation\">:</span> harbor<span class=\"token punctuation\">-</span>registry<span class=\"token punctuation\">-</span>basic<span class=\"token punctuation\">-</span>realm\n    <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> /etc/registry/passwd</code></pre></div>\n<ol>\n<li>\n<p>启动过程中会校验 <code class=\"language-text\">path</code> 对应的文件是否存在，如果不存在，就创建并写入内容，内容为用户：<code class=\"language-text\">docker</code>, 密码为随机生成并加密存储。</p>\n</li>\n<li>\n<p>用户在请求过程中，每个请求都会进入配置好的访问控制器中，进行权限验证。</p>\n</li>\n<li>\n<p>会首先判断 <code class=\"language-text\">Header</code> 中是否存在 <code class=\"language-text\">Authorization</code> 字段值，并正确解析；如果不存在，则认为无效认证。</p>\n</li>\n<li>\n<p>如果存在用户密码则会和文件中写入的内容进行对比，确保是一致的（提示：在对比之前系统会先校验这个文件是否被修改过，如果被修改过就会从新生成文件内容）。</p>\n</li>\n</ol>\n<h2>silly</h2>\n<p>这个主要是用于测试的，是简单功能的实现；它主要是检查 <code class=\"language-text\">Header</code> 中是否存在 <code class=\"language-text\">Authorization</code> 并且值非空，如果是就进行授权通过。</p>\n<h2>token</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 472px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d03298b459888a8e45422e5b361ebe5b/3c5de/v2-registry-auth.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.58227848101265%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAADmUlEQVQ4y4VUaWhcVRQ+M28maZNMO5O0Js4UhRIiLVroNJlAFKXQX4pQUEFIKmkSbaG1WCku5I/iAqIwxV+2IG2tVYvJTDpLmsns+77kzb68TDJbYiZ7ahZbe+S+poIY9MDh3HvPd77zzuV+Dy5/f7teZZ84pXXF+8e8qT6dL92ndcVPa5yxMz+POlq1rjjc9SQ5P6otnJsqM9xQGlvUjmi/zp9hsWPeNBs1jmjfNYW+GW6qzNJAfgnDhTX0ZufRk5nD4NQKhqZXUR/Ifl7YQKjcR0rnS1Pj/iyMeVM9fmYRPZkqutNzbPTm5jEwuYRqB90DtzS2DlIcrWyiPV5GUziPkdLvSJfX0Rie/GoeEVYQKX0gxzOF82AIMqcJoYUuoIWeZqOVLmAgv4yj7kQvXP1FK7bQhV/vepIGc2RK40rNKkfdCZ0hxFhGLKFX/cwi+CeXuEpzkDgMGXzHrNGi2hotqvSBnM6RqIw4U7NKK11Q39a5pWCLlWALEQCAAgABAHDx0X4PAPBh21S2CUjM3Yf8GsKDR3mSqyPYx+5OzwHcsUbIhksQrc8cFjzRIt5Pkkeksvq9osZ9pAHJPX2w9e/C/vOX+OIDT4mOyrp2IyLnsfuYRQ68++EncOGjT9nuBExRlJBfUyMk69pdu4U1NbWii4NfwGfyq9A9cI5DyBsEewV19Q3CtsPPsc0Gv7wM314fYnn+YVyKAh6PT0AiANh14uWT5FhIRut84Ti8cWoAtr+4gYwsbGyCBsEeaDv0LPyf1QHAgW3iRg6XKwGAfU37m2sBoAUAntzG/Lcxq0jllhF0vvRF8rY8meqmL7ewYY0W/7DFSg9ssdKmJ1Pd8marmz5mATWOaG9oehUixXvUjoTRygZ3orwOajt93JGoXHEmZ7620AW5IcTI1Q76O0OQkdtiJbkzOfONPV6+ojAFOz3ZKviYRe6OhNLO5+GorAs6ul6seb2nX/Jm71nJW+9cEJ9572PJiVdOtp19f1DcPXCOPX+tu0/S0fUS/4hUxtbsaPk15DErCPpg7gMixXBh7SFRgDM5g77cArpSv7GyjBTvsdIcdSfepssbEJvd2nnk3DLyyB2O+zOXiE4tdOFPa7SItmgRSTRF8qzMzJGph67ULJIfCiGky+v/JuRwufCT1g63tDa4rtA3DRv9ncPGwDGFKdCuNIfaFaZgO1kPG4n724cMPtm14XHhjRET/HDHBKKmZpboL5SJL4lty4BsAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"auth\"\n        title=\"auth\"\n        src=\"/static/d03298b459888a8e45422e5b361ebe5b/3c5de/v2-registry-auth.png\"\n        srcset=\"/static/d03298b459888a8e45422e5b361ebe5b/c26ae/v2-registry-auth.png 158w,\n/static/d03298b459888a8e45422e5b361ebe5b/6bdcf/v2-registry-auth.png 315w,\n/static/d03298b459888a8e45422e5b361ebe5b/3c5de/v2-registry-auth.png 472w\"\n        sizes=\"(max-width: 472px) 100vw, 472px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">auth</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">token</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">realm</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//localhost<span class=\"token punctuation\">:</span>5011/auth\n    <span class=\"token key atrule\">service</span><span class=\"token punctuation\">:</span> Authentication\n    <span class=\"token key atrule\">issuer</span><span class=\"token punctuation\">:</span> Sample Issuer\n    <span class=\"token key atrule\">rootCertBundle</span><span class=\"token punctuation\">:</span> /mnt/local/certs/RootCA.crt</code></pre></div>\n<p><code class=\"language-text\">token</code> 认证需要借助外部认证服务，可以实现资源、权限的管理，<code class=\"language-text\">distribution</code> 的响应的时候会返回给用户 <code class=\"language-text\">scope</code> 就是资源权限</p>\n<ol>\n<li>启动过程会校验 <code class=\"language-text\">token</code> 配置的参数是否正确，并且校验 <code class=\"language-text\">tls</code> 证书。</li>\n<li>用户请求时，会从 <code class=\"language-text\">Header</code> 中获取认证信息，如果没有认证，则会根据是否配置 <code class=\"language-text\">autoRedirect</code> 以及重定向地址 <code class=\"language-text\">realm</code>。</li>\n<li><code class=\"language-text\">distribution</code> 会返回 <code class=\"language-text\">401</code> 的请求，并携带<code class=\"language-text\">WWW-Authenticate</code> 告诉客户端改如何向认证服务进行认证。</li>\n</ol>\n<blockquote>\n<p>如：一个未授权的用户正在 <code class=\"language-text\">Push</code>镜像到 <code class=\"language-text\">samalba/my-app</code> repoName 中，就会返回</p>\n<ul>\n<li>scope: 授权范围</li>\n<li>service: 授权服务</li>\n<li>realm: 认证服务</li>\n</ul>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">HTTP/1.1 <span class=\"token number\">401</span> Unauthorized\nContent-Type: application/json<span class=\"token punctuation\">;</span> <span class=\"token assign-left variable\">charset</span><span class=\"token operator\">=</span>utf-8\nDocker-Distribution-Api-Version: registry/2.0\nWww-Authenticate: Bearer <span class=\"token assign-left variable\">realm</span><span class=\"token operator\">=</span><span class=\"token string\">\"https://auth.docker.io/token\"</span>,service<span class=\"token operator\">=</span><span class=\"token string\">\"registry.docker.io\"</span>,scope<span class=\"token operator\">=</span><span class=\"token string\">\"repository:samalba/my-app:pull,push\"</span>\nDate: Thu, <span class=\"token number\">10</span> Sep <span class=\"token number\">2015</span> <span class=\"token number\">19</span>:32:31 GMT\nContent-Length: <span class=\"token number\">235</span>\nStrict-Transport-Security: max-age<span class=\"token operator\">=</span><span class=\"token number\">31536000</span>\n\n<span class=\"token punctuation\">{</span><span class=\"token string\">\"errors\"</span>:<span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"code\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"UNAUTHORIZED\"</span>,<span class=\"token string\">\"message\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"access to the requested resource is not authorized\"</span>,<span class=\"token string\">\"detail\"</span>:<span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"Type\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"repository\"</span>,<span class=\"token string\">\"Name\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"samalba/my-app\"</span>,<span class=\"token string\">\"Action\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"pull\"</span><span class=\"token punctuation\">}</span>,<span class=\"token punctuation\">{</span><span class=\"token string\">\"Type\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"repository\"</span>,<span class=\"token string\">\"Name\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"samalba/my-app\"</span>,<span class=\"token string\">\"Action\"</span><span class=\"token builtin class-name\">:</span><span class=\"token string\">\"push\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">}</span></code></pre></div>\n<ol start=\"4\">\n<li>如果开启自动重定向，则请求的就是 <code class=\"language-text\">distribution</code> host 的接口：<code class=\"language-text\">https://%s/auth/token</code>，没有则走用户配置<code class=\"language-text\">realm</code></li>\n</ol>","frontmatter":{"title":"Distribution Auth Type","date":"August 05, 2022","description":null}},"previous":{"fields":{"slug":"/2022-07-25-Goland2022.01激活/"},"frontmatter":{"title":"IntelliJ Goland 2022.1.4 最新激活破解教程"}},"next":{"fields":{"slug":"/2022-08-28-github-contribute/"},"frontmatter":{"title":"Github Contribute 注意事项"}}},"pageContext":{"id":"dc932fdd-1014-5e3e-9ed3-b1ee13bdfd90","previousPostId":"04b6e113-6f64-5770-bc03-b21d08d9a883","nextPostId":"96b18959-d632-5a8e-a604-a68a40914af6"}},
    "staticQueryHashes": ["2841359383","3257411868"]}