{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/2021-12-30 gRPC 学习之中级知识/",
    "result": {"data":{"site":{"siteMetadata":{"title":"LRF"}},"markdownRemark":{"id":"6599b40c-659d-546e-a496-bc5dfd06a04b","excerpt":"中级知识 借助 gRPC 可以实现不同的进程间通信模式（也称RPC风格）；本章将讨论 gRPC 应用的四种通信模式，一元RPC、服务端流RPC、客户端流RPC、以及双向RPC。 一元RPC 一元RPC：一元RPC模式也被称为简单RPC…","html":"<h2>中级知识</h2>\n<p>借助 gRPC 可以实现不同的进程间通信模式（也称RPC风格）；本章将讨论 gRPC 应用的四种通信模式，一元RPC、服务端流RPC、客户端流RPC、以及双向RPC。</p>\n<h3>一元RPC</h3>\n<p>一元RPC：一元RPC模式也被称为简单RPC模式，当客户端调用服务端的远程方法时，客户端发送请求到服务端并获得一个响应，与响应一起发送还有元数据。</p>\n<h3>服务器端流 RPPC 模式</h3>\n<p>一元RPC模式：gRPC 服务器端和 gRPC 客户端在通信时始终只有一个请求和一个响应。\n服务器端流 RPC 模式：gRPC 服务器端在接收到客户端的请求消息后，会发回一个响应序列（简单说就是会发回多个响应）。这种多个响应所组成的序列也被称为流。</p>\n<p>例如：</p>\n<blockquote>\n<p>在 OrderManagement 服务中，假设需要实现一个订单搜索功能；利用服务器端流 gRPC 模式时 OrderManagement 服务不会将所有匹配的订单一次性的发送给客户端，而是在找到匹配的订单时，逐步将其发送出去。</p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/27fc9ff7fae6a0d78cdd6f4e0e20ba80/ca3c3/grpc-server-stream.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.9746835443038%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsTAAALEwEAmpwYAAABeklEQVQY0z2QWU/CQBRG+e2S8KBxi+iLgahR44txBRFXTEwMoC0grWxlKbTQYaYUlC6zmbbKeZq5mTO53xdBaFIqy2JJEsVqq9XFPgRjsmBxrjWUwnu5+F4uFIQxgJ7nRZpKL5E4im/txncSN5knxjjnnDFOKWUB/J/Ti3QsthpdWo5GVySpyTmPtNvqXvL4YP8kmTi8zTyHjykhU2s2Ma3pdEYwCeWLy8zaanxjfXtlebP2Fciqqt1ln58eXx7uc/m3DxrAGLUdt90Z2nOXMX8FD+Nc7jV1lU1dZ8/P0orS9WVdHwEDAgAta1at1tpKFyETADAyQL+vQ2giZELTVAeaJDcQmui6oWnDnjrw5fEYiWJFECrCR0Wq1j0PBzmZ7XjN5qBeV7URcl1/KMuNYrFULIj5vDAygC+HeWzHwUE2xhghlBB/eULIxPru9Y2fuROWhzG25zaljFLqum5kDKAs18ufNVXVW60OhKZf2F/VNPw6NBf9/9/oL5wUroIOo73RAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"grpc-server-stream\"\n        title=\"grpc-server-stream\"\n        src=\"/static/27fc9ff7fae6a0d78cdd6f4e0e20ba80/f058b/grpc-server-stream.png\"\n        srcset=\"/static/27fc9ff7fae6a0d78cdd6f4e0e20ba80/c26ae/grpc-server-stream.png 158w,\n/static/27fc9ff7fae6a0d78cdd6f4e0e20ba80/6bdcf/grpc-server-stream.png 315w,\n/static/27fc9ff7fae6a0d78cdd6f4e0e20ba80/f058b/grpc-server-stream.png 630w,\n/static/27fc9ff7fae6a0d78cdd6f4e0e20ba80/40601/grpc-server-stream.png 945w,\n/static/27fc9ff7fae6a0d78cdd6f4e0e20ba80/78612/grpc-server-stream.png 1260w,\n/static/27fc9ff7fae6a0d78cdd6f4e0e20ba80/ca3c3/grpc-server-stream.png 1850w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ul>\n<li>grpc server</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">*</span>server<span class=\"token punctuation\">)</span> <span class=\"token function\">SearchOrders</span><span class=\"token punctuation\">(</span>searchQuery <span class=\"token operator\">*</span>wrappers<span class=\"token punctuation\">.</span>StringValue<span class=\"token punctuation\">,</span>stream pb<span class=\"token punctuation\">.</span>OrderManagement_SearchOrdersServer<span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">for</span> key<span class=\"token punctuation\">,</span> order <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> orderMap <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Print</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> order<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">for</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> itemStr <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> order<span class=\"token punctuation\">.</span>Items <span class=\"token punctuation\">{</span>\n\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Print</span><span class=\"token punctuation\">(</span>itemStr<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">if</span> strings<span class=\"token punctuation\">.</span><span class=\"token function\">Contains</span><span class=\"token punctuation\">(</span>itemStr<span class=\"token punctuation\">,</span> searchQuery<span class=\"token punctuation\">.</span>Value<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t<span class=\"token comment\">// Send the matching orders in a stream</span>\n\t\t\t\terr <span class=\"token operator\">:=</span> stream<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>order<span class=\"token punctuation\">)</span>\n\t\t\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t<span class=\"token keyword\">return</span> fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Errorf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"error sending message to stream : %v\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Matching Order Found : \"</span> <span class=\"token operator\">+</span> key<span class=\"token punctuation\">)</span>\n\t\t\t\t<span class=\"token keyword\">break</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>grpc clinet</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span><span class=\"token punctuation\">.</span>\n    searchStream<span class=\"token punctuation\">,</span> \t<span class=\"token boolean\">_</span> <span class=\"token operator\">:=</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">SearchOrders</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>wrappers<span class=\"token punctuation\">.</span>StringValue<span class=\"token punctuation\">{</span>Value<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Google\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">{</span>\n\t\tsearchOrder<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> searchStream<span class=\"token punctuation\">.</span><span class=\"token function\">Recv</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">==</span> io<span class=\"token punctuation\">.</span>EOF <span class=\"token punctuation\">{</span>\n\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"EOF\"</span><span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">break</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Search Result : \"</span><span class=\"token punctuation\">,</span> searchOrder<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n    <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>上述就是 <code class=\"language-text\">gRPC</code> 服务器端流模式，服务在检索到订单时，通过以流的形式发送给客户端 <code class=\"language-text\">err := stream.Send(&amp;order)</code> ; 客户端在调用时，返回一个客户端流，它有一个 <code class=\"language-text\">Recv</code> 方法，调用客户端的 <code class=\"language-text\">Recv</code> 方法，可以逐个读取服务端写入的数据。当发现流结束时， <code class=\"language-text\">Recv</code> 会返回 <code class=\"language-text\">io.EOF</code>。</p>\n<h3>客户端流 RPC 模式</h3>\n<p>客户端流RPC模式：客户端会发起多个请求给服务端，而不再是单个请求，服务器端则会发送一个响应给客户端。但是，服务端不一定要等到从客户端接受到所有消息后才发送响应。</p>\n<p>例如：</p>\n<blockquote>\n<p>在 OrderManagement 服务中希望添加 updateOrders 方法，从而更新一个订单集合。</p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e1d7a8a2ac0462cbea1e2e9aa4c9cd52/81ebd/grpc-client-stream.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.60759493670886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsTAAALEwEAmpwYAAABdUlEQVQY002R20vCUBzH93fXQ0FQFHSlB30JLLpg9RBJIZEvdjedTh3Z1Lm1uZ2dbV4qtJ3LL84U6wsHzvfwu36O5Ae9WlVTqlpFadg24pwRQimljDEai8R++PlVKteLZaUkK2/vrZ8oIiSSmi0jtXeWTBwnE+mnxzIAcM7ZVKIE5xwAXNdbW91ZXFiZn1vaT51wzimlUls3jw4uTtO3+6nrwksVYoW9AfKCfr8/Ho8YYwCAEN7eSmys764sbx4dnk+TTct5uC8+PVfzd7KqNpnoSrE/7JjYsPy2icc/EQDobSNzmb26uslksrlcnoi9qGS7HnI9hDyEA1V9dxHy/SAMQ+Rh0+raXdfD2MdYlpVWU7dtx3FQ400bjUacMyno9dWaJpjVNNN0AGAyZzj4ttzezA6Hn6Vi5bVQei3Iar0xISIxEDwIoywGQ2lMSRzGOROWTuGLMEIml0jQJpIfhm3daOlGx7LND1uwjjXB/c/NvuDv/Re38LExsOZTMAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"grpc client stream\"\n        title=\"grpc client stream\"\n        src=\"/static/e1d7a8a2ac0462cbea1e2e9aa4c9cd52/f058b/grpc-client-stream.png\"\n        srcset=\"/static/e1d7a8a2ac0462cbea1e2e9aa4c9cd52/c26ae/grpc-client-stream.png 158w,\n/static/e1d7a8a2ac0462cbea1e2e9aa4c9cd52/6bdcf/grpc-client-stream.png 315w,\n/static/e1d7a8a2ac0462cbea1e2e9aa4c9cd52/f058b/grpc-client-stream.png 630w,\n/static/e1d7a8a2ac0462cbea1e2e9aa4c9cd52/40601/grpc-client-stream.png 945w,\n/static/e1d7a8a2ac0462cbea1e2e9aa4c9cd52/78612/grpc-client-stream.png 1260w,\n/static/e1d7a8a2ac0462cbea1e2e9aa4c9cd52/81ebd/grpc-client-stream.png 1868w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ul>\n<li>grpc server : 如下方法定义了一个服务端接收客户端流的方法</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">*</span>server<span class=\"token punctuation\">)</span> <span class=\"token function\">UpdateOrders</span><span class=\"token punctuation\">(</span>stream pb<span class=\"token punctuation\">.</span>OrderManagement_UpdateOrdersServer<span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n\tordersStr <span class=\"token operator\">:=</span> <span class=\"token string\">\"Updated Order IDs : \"</span>\n\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">{</span>\n\t\torder<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> stream<span class=\"token punctuation\">.</span><span class=\"token function\">Recv</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">==</span> io<span class=\"token punctuation\">.</span>EOF <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token comment\">// 客户端发送完流数据</span>\n\t\t\t<span class=\"token keyword\">return</span> stream<span class=\"token punctuation\">.</span><span class=\"token function\">SendAndClose</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>wrappers<span class=\"token punctuation\">.</span>StringValue<span class=\"token punctuation\">{</span>Value<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Orders processed \"</span> <span class=\"token operator\">+</span> ordersStr<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">return</span> err\n\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token comment\">// Update order</span>\n\t\torderMap<span class=\"token punctuation\">[</span>order<span class=\"token punctuation\">.</span>Id<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token operator\">*</span>order\n\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Order ID : %s - %s\"</span><span class=\"token punctuation\">,</span> order<span class=\"token punctuation\">.</span>Id<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Updated\"</span><span class=\"token punctuation\">)</span>\n\t\tordersStr <span class=\"token operator\">+=</span> order<span class=\"token punctuation\">.</span>Id <span class=\"token operator\">+</span> <span class=\"token string\">\", \"</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>grpc client</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span><span class=\"token punctuation\">.</span>省略\n    <span class=\"token comment\">// =========================================</span>\n\t<span class=\"token comment\">// Update Orders : Client streaming scenario</span>\n\tupdOrder1 <span class=\"token operator\">:=</span> pb<span class=\"token punctuation\">.</span>Order<span class=\"token punctuation\">{</span>Id<span class=\"token punctuation\">:</span> <span class=\"token string\">\"102\"</span><span class=\"token punctuation\">,</span> Items<span class=\"token punctuation\">:</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"Google Pixel 3A\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Google Pixel Book\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> Destination<span class=\"token punctuation\">:</span><span class=\"token string\">\"Mountain View, CA\"</span><span class=\"token punctuation\">,</span> Price<span class=\"token punctuation\">:</span><span class=\"token number\">1100.00</span><span class=\"token punctuation\">}</span>\n\tupdOrder2 <span class=\"token operator\">:=</span> pb<span class=\"token punctuation\">.</span>Order<span class=\"token punctuation\">{</span>Id<span class=\"token punctuation\">:</span> <span class=\"token string\">\"103\"</span><span class=\"token punctuation\">,</span> Items<span class=\"token punctuation\">:</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"Apple Watch S4\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Mac Book Pro\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"iPad Pro\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> Destination<span class=\"token punctuation\">:</span><span class=\"token string\">\"San Jose, CA\"</span><span class=\"token punctuation\">,</span> Price<span class=\"token punctuation\">:</span><span class=\"token number\">2800.00</span><span class=\"token punctuation\">}</span>\n\tupdOrder3 <span class=\"token operator\">:=</span> pb<span class=\"token punctuation\">.</span>Order<span class=\"token punctuation\">{</span>Id<span class=\"token punctuation\">:</span> <span class=\"token string\">\"104\"</span><span class=\"token punctuation\">,</span> Items<span class=\"token punctuation\">:</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"Google Home Mini\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Google Nest Hub\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"iPad Mini\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> Destination<span class=\"token punctuation\">:</span><span class=\"token string\">\"Mountain View, CA\"</span><span class=\"token punctuation\">,</span> Price<span class=\"token punctuation\">:</span><span class=\"token number\">2200.00</span><span class=\"token punctuation\">}</span>\n\n\tupdateStream<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">UpdateOrders</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">)</span>\n\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Fatalf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%v.UpdateOrders(_) = _, %v\"</span><span class=\"token punctuation\">,</span> client<span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token comment\">// Updating order 1</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> updateStream<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>updOrder1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Fatalf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%v.Send(%v) = %v\"</span><span class=\"token punctuation\">,</span> updateStream<span class=\"token punctuation\">,</span> updOrder1<span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token comment\">// Updating order 2</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> updateStream<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>updOrder2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Fatalf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%v.Send(%v) = %v\"</span><span class=\"token punctuation\">,</span> updateStream<span class=\"token punctuation\">,</span> updOrder2<span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token comment\">// Updating order 3</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> updateStream<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>updOrder3<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Fatalf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%v.Send(%v) = %v\"</span><span class=\"token punctuation\">,</span> updateStream<span class=\"token punctuation\">,</span> updOrder3<span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\n\tupdateRes<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> updateStream<span class=\"token punctuation\">.</span><span class=\"token function\">CloseAndRecv</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Fatalf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%v.CloseAndRecv() got error %v, want %v\"</span><span class=\"token punctuation\">,</span> updateStream<span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">,</span> <span class=\"token boolean\">nil</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Update Orders Res : %s\"</span><span class=\"token punctuation\">,</span> updateRes<span class=\"token punctuation\">)</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>客户端以流的形式发送<code class=\"language-text\">updateStream.Send(&amp;updOrder2)</code>给服务端，一旦所有消息都以流的形式发送出去，客户端就可以将流标记为已完成，并通过 <code class=\"language-text\">CloseAndRecv</code> 方法来读取服务端的响应。</p>\n<h3>双向流 RPC 模式</h3>\n<p>双向流RPC模式：客户端以消息流的形式发送请求到服务器端，服务器端也以消息流的形式进行响应。调用必须由客户端发起，但在此之后，通信完全基于 gRPC 客户端和服务器端的应用程序逻辑。</p>\n<p>例如：</p>\n<blockquote>\n<p>在 OrderManagement 服务中，假设需要一个订单处理功能，通过该功能，用户可以发送连续的订单集合，并根据投递地址对它们进行组合发货。</p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/eda84444fa6e8513ced7d10c96265f38/1f6b7/grpc-double-stream.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.50632911392405%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsTAAALEwEAmpwYAAABlklEQVQY02WRSW/TUACE/f8JcAgItQlpBQgQSFxQE7VKihBqKTRr2zjx7mc7Trwlfvazjd+KmnDj02hGmsscRsIYZ3luAU+3PdVygx0sa1pVGFOKCa0J+UNIVdcVxuZqszSAZjm241dVTSmRhBA28E46H46PTlutt6PZgglBMM1QCVGBirImlHJOhfj45exJo9loNDud9wWqOOcS50LXneOj03brzauX7V/DuwLzJMqCMA2TNIzTGOZbiCosPn3++qzRfP70xev2O4RKxpjEmADA73YH5+ffet3L0VR2/NhbRZsw9YKtH6VukLjreBXsLi6vznqDbm9w0f+eo4IzJnHOV36oWZ5lry2wuboZzxVTUe2FZhvOemm4sg5MN5A18HMyN92NAXxFs7MMCS4kRtl2ByfT+e3w7nZ077gB8IJ+/8dwfB/v8uub2fXvWbLNwwSquj2ePExn8lIxMCbssCz2HJIIgQkPI4jKmgmRQgQzJP6Dc04plVzPD8LoQVZV01koJkQFppSQf2J7KH2syN4O0McH+F8l8avRBBmqyQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"grpc-double-stream\"\n        title=\"grpc-double-stream\"\n        src=\"/static/eda84444fa6e8513ced7d10c96265f38/f058b/grpc-double-stream.png\"\n        srcset=\"/static/eda84444fa6e8513ced7d10c96265f38/c26ae/grpc-double-stream.png 158w,\n/static/eda84444fa6e8513ced7d10c96265f38/6bdcf/grpc-double-stream.png 315w,\n/static/eda84444fa6e8513ced7d10c96265f38/f058b/grpc-double-stream.png 630w,\n/static/eda84444fa6e8513ced7d10c96265f38/40601/grpc-double-stream.png 945w,\n/static/eda84444fa6e8513ced7d10c96265f38/78612/grpc-double-stream.png 1260w,\n/static/eda84444fa6e8513ced7d10c96265f38/1f6b7/grpc-double-stream.png 1909w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>这个业务用例的关键步骤如下所示：</p>\n<ul>\n<li>每个订单以独立的 gRPC 消息的形式发送至服务器端。</li>\n<li>每个发货组合可能会包含多个订单，它们应该被投递到相同的目的地。</li>\n<li>订单是成批处理的，当达到指定的批次大小时，当前创建的所有发货组合都会被发送至客户端。</li>\n<li>假设：流中有4个订单，其中有两个订单要发送至X，两个要发送至Y，则可以将其表示为：X、Y、X、Y。如果批次大小为3，那么所创建的订单发货组合会是[X，X],[Y],[Y]。</li>\n</ul>\n<p>gRpc Server：主要逻辑就是通过客户端发送过来的订单ID按照指定批次大小以及发货地址进行分组，再把分组后的信息返回给客户端。</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">const</span> orderBatchSize <span class=\"token operator\">=</span> <span class=\"token number\">3</span>\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>s <span class=\"token operator\">*</span>server<span class=\"token punctuation\">)</span> <span class=\"token function\">ProcessOrders</span><span class=\"token punctuation\">(</span>stream pb<span class=\"token punctuation\">.</span>OrderManagement_ProcessOrdersServer<span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span> <span class=\"token punctuation\">{</span>\n\tbatchMarker <span class=\"token operator\">:=</span> <span class=\"token number\">1</span>\n\t<span class=\"token keyword\">var</span> combinedShipmentMap <span class=\"token operator\">=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span>pb<span class=\"token punctuation\">.</span>CombinedShipment<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">{</span>\n\t\torderId<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> stream<span class=\"token punctuation\">.</span><span class=\"token function\">Recv</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Reading Proc order : %s\"</span><span class=\"token punctuation\">,</span> orderId<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">==</span> io<span class=\"token punctuation\">.</span>EOF <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token comment\">// 客户端发送关闭时，需要把服务端已经接收到的进行发送</span>\n\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"EOF : %s\"</span><span class=\"token punctuation\">,</span> orderId<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">for</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> shipment <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> combinedShipmentMap <span class=\"token punctuation\">{</span>\n\t\t\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> stream<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>shipment<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t<span class=\"token keyword\">return</span> err\n\t\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t<span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">return</span> err\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\tdestination <span class=\"token operator\">:=</span> orderMap<span class=\"token punctuation\">[</span>orderId<span class=\"token punctuation\">.</span><span class=\"token function\">GetValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Destination\n\t\tshipment<span class=\"token punctuation\">,</span> found <span class=\"token operator\">:=</span> combinedShipmentMap<span class=\"token punctuation\">[</span>destination<span class=\"token punctuation\">]</span>\n\n\t\t<span class=\"token keyword\">if</span> found <span class=\"token punctuation\">{</span>\n\t\t\tord <span class=\"token operator\">:=</span> orderMap<span class=\"token punctuation\">[</span>orderId<span class=\"token punctuation\">.</span><span class=\"token function\">GetValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n\t\t\tshipment<span class=\"token punctuation\">.</span>OrdersList <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>shipment<span class=\"token punctuation\">.</span>OrdersList<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>ord<span class=\"token punctuation\">)</span>\n\t\t\tcombinedShipmentMap<span class=\"token punctuation\">[</span>destination<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> shipment\n\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n\t\t\tcomShip <span class=\"token operator\">:=</span> pb<span class=\"token punctuation\">.</span>CombinedShipment<span class=\"token punctuation\">{</span>Id<span class=\"token punctuation\">:</span> <span class=\"token string\">\"cmb - \"</span> <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span>orderMap<span class=\"token punctuation\">[</span>orderId<span class=\"token punctuation\">.</span><span class=\"token function\">GetValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Destination<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> Status<span class=\"token punctuation\">:</span> <span class=\"token string\">\"Processed!\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">}</span>\n\t\t\tord <span class=\"token operator\">:=</span> orderMap<span class=\"token punctuation\">[</span>orderId<span class=\"token punctuation\">.</span><span class=\"token function\">GetValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n\t\t\tcomShip<span class=\"token punctuation\">.</span>OrdersList <span class=\"token operator\">=</span> <span class=\"token function\">append</span><span class=\"token punctuation\">(</span>shipment<span class=\"token punctuation\">.</span>OrdersList<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>ord<span class=\"token punctuation\">)</span>\n\t\t\tcombinedShipmentMap<span class=\"token punctuation\">[</span>destination<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> comShip\n\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Print</span><span class=\"token punctuation\">(</span><span class=\"token function\">len</span><span class=\"token punctuation\">(</span>comShip<span class=\"token punctuation\">.</span>OrdersList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> comShip<span class=\"token punctuation\">.</span><span class=\"token function\">GetId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t<span class=\"token keyword\">if</span> batchMarker <span class=\"token operator\">==</span> orderBatchSize <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">for</span> <span class=\"token boolean\">_</span><span class=\"token punctuation\">,</span> comb <span class=\"token operator\">:=</span> <span class=\"token keyword\">range</span> combinedShipmentMap <span class=\"token punctuation\">{</span>\n\t\t\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Shipping : %v -> %v\"</span> <span class=\"token punctuation\">,</span> comb<span class=\"token punctuation\">.</span>Id<span class=\"token punctuation\">,</span> <span class=\"token function\">len</span><span class=\"token punctuation\">(</span>comb<span class=\"token punctuation\">.</span>OrdersList<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\t\t\t\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> stream<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>comb<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t\t<span class=\"token keyword\">return</span> err\n\t\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\t\t\tbatchMarker <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n\t\t\tcombinedShipmentMap <span class=\"token operator\">=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">map</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">]</span>pb<span class=\"token punctuation\">.</span>CombinedShipment<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n\t\t\tbatchMarker<span class=\"token operator\">++</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>gRpc Client：主要逻辑就是发送订单ID给服务端，之后开启 Go协程来读取服务端返回的消息。</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>\n    <span class=\"token comment\">// =========================================</span>\n\t<span class=\"token comment\">// Process Order : Bi-di streaming scenario</span>\n\tstreamProcOrder<span class=\"token punctuation\">,</span> err <span class=\"token operator\">:=</span> client<span class=\"token punctuation\">.</span><span class=\"token function\">ProcessOrders</span><span class=\"token punctuation\">(</span>ctx<span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Fatalf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%v.ProcessOrders(_) = _, %v\"</span><span class=\"token punctuation\">,</span> client<span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> streamProcOrder<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>wrappers<span class=\"token punctuation\">.</span>StringValue<span class=\"token punctuation\">{</span>Value<span class=\"token punctuation\">:</span><span class=\"token string\">\"102\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Fatalf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%v.Send(%v) = %v\"</span><span class=\"token punctuation\">,</span> client<span class=\"token punctuation\">,</span> <span class=\"token string\">\"102\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> streamProcOrder<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>wrappers<span class=\"token punctuation\">.</span>StringValue<span class=\"token punctuation\">{</span>Value<span class=\"token punctuation\">:</span><span class=\"token string\">\"103\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Fatalf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%v.Send(%v) = %v\"</span><span class=\"token punctuation\">,</span> client<span class=\"token punctuation\">,</span> <span class=\"token string\">\"103\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> streamProcOrder<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>wrappers<span class=\"token punctuation\">.</span>StringValue<span class=\"token punctuation\">{</span>Value<span class=\"token punctuation\">:</span><span class=\"token string\">\"104\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Fatalf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%v.Send(%v) = %v\"</span><span class=\"token punctuation\">,</span> client<span class=\"token punctuation\">,</span> <span class=\"token string\">\"104\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> streamProcOrder<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>wrappers<span class=\"token punctuation\">.</span>StringValue<span class=\"token punctuation\">{</span>Value<span class=\"token punctuation\">:</span><span class=\"token string\">\"101\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Fatalf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"%v.Send(%v) = %v\"</span><span class=\"token punctuation\">,</span> client<span class=\"token punctuation\">,</span> <span class=\"token string\">\"101\"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\n    channel <span class=\"token operator\">:=</span> <span class=\"token function\">make</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">chan</span> <span class=\"token keyword\">struct</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">go</span> <span class=\"token function\">asncClientBidirectionalRPC</span><span class=\"token punctuation\">(</span>streamProcOrder<span class=\"token punctuation\">,</span> channel<span class=\"token punctuation\">)</span>\n\t\n\t<span class=\"token keyword\">if</span> err <span class=\"token operator\">:=</span> streamProcOrder<span class=\"token punctuation\">.</span><span class=\"token function\">CloseSend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> err <span class=\"token operator\">!=</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Fatal</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\tchannel <span class=\"token operator\">&lt;-</span> <span class=\"token keyword\">struct</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token function\">asncClientBidirectionalRPC</span><span class=\"token punctuation\">(</span>streamProcOrder pb<span class=\"token punctuation\">.</span>OrderManagement_ProcessOrdersClient<span class=\"token punctuation\">,</span> c <span class=\"token keyword\">chan</span> <span class=\"token keyword\">struct</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">for</span> <span class=\"token punctuation\">{</span>\n\t\tcombinedShipment<span class=\"token punctuation\">,</span> errProcOrder <span class=\"token operator\">:=</span> streamProcOrder<span class=\"token punctuation\">.</span><span class=\"token function\">Recv</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token keyword\">if</span> errProcOrder <span class=\"token operator\">==</span> io<span class=\"token punctuation\">.</span>EOF <span class=\"token punctuation\">{</span> <span class=\"token comment\">// 判断服务端流是否结束；服务端方法只要有return就意味着流结束流了，可能是因为正常结束，也可能是错误导致结束，总之只要return之后双向流就断开了。</span>\n\t\t\t<span class=\"token keyword\">break</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\tlog<span class=\"token punctuation\">.</span><span class=\"token function\">Printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Combined shipment : \"</span><span class=\"token punctuation\">,</span> combinedShipment<span class=\"token punctuation\">.</span>OrdersList<span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token operator\">&lt;-</span>c\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>在双向流中可以通过定义客户端流和服务端流的方式来实现，客户端和服务端都定义了 <code class=\"language-text\">Send</code> 和 <code class=\"language-text\">Recv</code> 方法。可以实现双向传输。</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token comment\">// 客户端流</span>\n<span class=\"token keyword\">type</span> OrderManagement_ProcessOrdersClient <span class=\"token keyword\">interface</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">Send</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>wrappers<span class=\"token punctuation\">.</span>StringValue<span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span>\n\t<span class=\"token function\">Recv</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>CombinedShipment<span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span>\n\tgrpc<span class=\"token punctuation\">.</span>ClientStream\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 服务端流</span>\n<span class=\"token keyword\">type</span> OrderManagement_ProcessOrdersServer <span class=\"token keyword\">interface</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">Send</span><span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>CombinedShipment<span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span>\n\t<span class=\"token function\">Recv</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>wrappers<span class=\"token punctuation\">.</span>StringValue<span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span>\n\tgrpc<span class=\"token punctuation\">.</span>ServerStream\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>客户端可以并发读取和写入同一个流，输入流和输出流可以独立进行操作。</p>","frontmatter":{"title":"gRPC 学习之-中级知识","date":"December 25, 2021","description":"我把 `gRPC`  共划分为四个级别来学习，有浅入深的展开，对应不同阶段的人进行学习。"}},"previous":{"fields":{"slug":"/2021-12-25 gRPC 学习之初级知识/"},"frontmatter":{"title":"gRPC 学习之-初级知识"}},"next":{"fields":{"slug":"/2022-01-01 gRPC 学习之高级知识/"},"frontmatter":{"title":"gRPC 学习之-高级知识"}}},"pageContext":{"id":"6599b40c-659d-546e-a496-bc5dfd06a04b","previousPostId":"ba3c9598-4f9e-5dac-a758-7415e9c7d46e","nextPostId":"20dad7a7-ca51-555f-b384-6509115a774e"}},
    "staticQueryHashes": ["2841359383","3257411868"]}