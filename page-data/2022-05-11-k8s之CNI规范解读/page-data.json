{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/2022-05-11-k8s之CNI规范解读/",
    "result": {"data":{"site":{"siteMetadata":{"title":"LRF"}},"markdownRemark":{"id":"c9d34b82-e40f-54f2-9ab5-df07216db4c3","excerpt":"CNI 简介 容器网络接口（Container Network Interface），简称 CNI，是 CNCF 旗下的一个项目，由一组用于配置 Linux 容器的网络接口的规范和库组成，同时还包含了一些插件。CNI 仅关心容器创建时的网络分配，和当容器被删除时释放网络资源。 使用CNI…","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/337b43fbb65a6a700d1b27fe59098fa7/7e111/cni-horizontal-color.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.60759493670886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAC4jAAAuIwF4pT92AAAB1ElEQVQoz12SXUuTYRjH/8+cvUgKpYhQKwkCBwbSQeh9aVMpvK+hlbnpIivC917AYSAVxDqwEA8M+gJiR7L7Yc+tbNXWcltuTYI66tAP0LeI5wVTDy7+Nxf39bteAUsBlroAbcahzUFYqtbzGZidB7rDBgQDxICQrpL8/3b0gEGbV6HNKCzVC0uFoM1JWOqSA32V8KE7bAfWgTgAIU+6QDZcmK3SdwDotyt5ilSyDR/XYGizA5YagTYjSCnCmyWg/1YrBM+AeAyCezzQYxBf9+ARkGxwgfwaNWk94d9KXYO5EUQqOXo8rYeR0QNYX2vEyH370wOnOrdVv9fqOIgXIPgMSEZAtjqJ3uNsLhO6mMtEA5nN6dbPW1Mt2XQs+PVTaFEl606HR+3ghxCyeX92blVREJ+H4DEQPwHJeieR4FXEy4Vzj8oF3C7kemKlfKB3O4vxUn5oOP+lv+PdCvx9N4MgngbJARCTB4xBSHuuLRC8DOJjzuIEv0W8UryR2N3pfFYp4u/eH9+L6veh+XKx/e63LNoWXvq8Fhsh5GUQN3gbPwHiGg9eu78k4lNYrJaw9LPc/uF39d7qrx93Ers7Tc8rRcyV8sCVPqBLGodORhw5myP2D/59qIrWophFAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image\"\n        title=\"image\"\n        src=\"/static/337b43fbb65a6a700d1b27fe59098fa7/f058b/cni-horizontal-color.png\"\n        srcset=\"/static/337b43fbb65a6a700d1b27fe59098fa7/c26ae/cni-horizontal-color.png 158w,\n/static/337b43fbb65a6a700d1b27fe59098fa7/6bdcf/cni-horizontal-color.png 315w,\n/static/337b43fbb65a6a700d1b27fe59098fa7/f058b/cni-horizontal-color.png 630w,\n/static/337b43fbb65a6a700d1b27fe59098fa7/40601/cni-horizontal-color.png 945w,\n/static/337b43fbb65a6a700d1b27fe59098fa7/78612/cni-horizontal-color.png 1260w,\n/static/337b43fbb65a6a700d1b27fe59098fa7/7e111/cni-horizontal-color.png 1627w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>CNI 简介</h2>\n<p>容器网络接口（Container Network Interface），简称 CNI，是 CNCF 旗下的一个项目，由一组用于配置 Linux 容器的网络接口的规范和库组成，同时还包含了一些插件。CNI 仅关心容器创建时的网络分配，和当容器被删除时释放网络资源。</p>\n<p>使用CNI的容器运行时有：</p>\n<ul>\n<li>Kubernetes</li>\n<li>ContainerD</li>\n<li>Mesos</li>\n<li>Cloud Foundry</li>\n<li>OpenShift</li>\n</ul>\n<p>实现了CNI规范的网络插件有：</p>\n<ul>\n<li>Flannel</li>\n<li>Calico</li>\n<li>Weave</li>\n<li>Cilium</li>\n<li><a href=\"https://www.cni.dev/docs/#3rd-party-plugins\">等等</a></li>\n</ul>\n<h2>CNI插件</h2>\n<p>CNI 插件必须实现一个可执行文件，这个文件可以被容器管理系统（例如 rkt 或 Kubernetes）调用。</p>\n<p>CNI 插件负责将网络接口插入容器网络命名空间（例如，veth 对的一端），并在主机上进行任何必要的改变（例如将 veth 的另一端连接到网桥）。然后将 IP 分配给接口，并通过调用适当的 IPAM 插件来设置与 “IP 地址管理” 部分一致的路由。</p>\n<h2>CNI规范</h2>\n<h5>1. CNI定义规范版本，用来控制版本兼容性问题，但是版本不是一尘不变的。</h5>\n<h4>2. 概念：</h4>\n<ul>\n<li>容器是一个网络隔离域。</li>\n<li>网络是指一组可以唯一寻址的端点，它们可以相互通信。</li>\n<li>Container Runtime是负责执行CNI插件的地方。</li>\n<li>Plugin是指网络配置的程序。</li>\n</ul>\n<h4>3. 规范</h4>\n<p>CNI规范定义了5点：</p>\n<ul>\n<li>\n<ol>\n<li>系统管理员去定义网络配置的格式。</li>\n</ol>\n</li>\n<li>\n<ol start=\"2\">\n<li>Container Runtime向网络插件发起请求的协议。</li>\n</ol>\n</li>\n<li>\n<ol start=\"3\">\n<li>基于系统管理员提供的配置执行插件，由第2步发起调用。</li>\n</ol>\n</li>\n<li>\n<ol start=\"4\">\n<li>CNI插件会将功能委托给其他插件。</li>\n</ol>\n</li>\n<li>\n<ol start=\"5\">\n<li>插件返回result到container runtime的数据类型。</li>\n</ol>\n</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/897ecc9258c093d3c1289dd26099d60f/a6d36/cni.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 46.835443037974684%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAABG0lEQVQoz22Ra26DMBCEuX7v0Vv0AA0SUV6FSKgQJOwaRbbBBLqw+FHJVqMk4vu10u7seNZR0zT7/T5Jku12u9lsmqZZtHbOZUy+x99UqB9KCSHDMFhrjUdrPc+zcy5CxOmBYRgm3/gsr28fX9f+l1Fa16Tve2ut1toY45zT3iByz4QJrTWMt45fWynneQ6jAJDneZqmx+PxcDjUdb0iDgUhJDufa0KqqtrtdnmeM8amabp5lFIAEL3IiqKI41gpxTkvimJZFiFEVVVlWXLOrbVt255OJ0rpyrPvAMDlcsmyLE3TsCVENcZYz3pmRDTGAICUsus6IYT0yRExnAMRw65XcfiJxyDjODLGHs9hrV0XB+fFg/8sz9yd/wAh+wLhskj1NwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"CNI Arch\"\n        title=\"CNI Arch\"\n        src=\"/static/897ecc9258c093d3c1289dd26099d60f/f058b/cni.png\"\n        srcset=\"/static/897ecc9258c093d3c1289dd26099d60f/c26ae/cni.png 158w,\n/static/897ecc9258c093d3c1289dd26099d60f/6bdcf/cni.png 315w,\n/static/897ecc9258c093d3c1289dd26099d60f/f058b/cni.png 630w,\n/static/897ecc9258c093d3c1289dd26099d60f/a6d36/cni.png 650w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h5>3.1 网络配置</h5>\n<p>网络配置是具有如下字段的json格式：</p>\n<ul>\n<li><code class=\"language-text\">cniVersion</code>: 指定CNI规范的版本。</li>\n<li><code class=\"language-text\">Name</code>: 网络名字，这在主机的网络配置中应该唯一。</li>\n<li><code class=\"language-text\">disableCheck</code>: 是否禁用检查网络，如果为true,则 <code class=\"language-text\">container runtime</code> 不会调用 Check 方法进行网络检查。</li>\n<li><code class=\"language-text\">plugin</code>: cni插件及其配置列表，可以配置多个插件。</li>\n</ul>\n<h5>3.2 执行协议</h5>\n<p>CNI协议基于容器运行时调用插件二进制程序。CNI程序逻辑本身被封装在了<code class=\"language-text\">libcni</code>中，会被其他容器运行时调用。在<code class=\"language-text\">libcni</code>中总共暴露了 4 个核心方法：</p>\n<div class=\"gatsby-highlight\" data-language=\"go\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">type</span> CNI <span class=\"token keyword\">interface</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 添加网络</span>\n    <span class=\"token function\">AddNetwork</span><span class=\"token punctuation\">(</span>ctx context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> net <span class=\"token operator\">*</span>NetworkConfig<span class=\"token punctuation\">,</span> rt <span class=\"token operator\">*</span>RuntimeConf<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>types<span class=\"token punctuation\">.</span>Result<span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 检查网络</span>\n\t<span class=\"token function\">CheckNetwork</span><span class=\"token punctuation\">(</span>ctx context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> net <span class=\"token operator\">*</span>NetworkConfig<span class=\"token punctuation\">,</span> rt <span class=\"token operator\">*</span>RuntimeConf<span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span>\n    <span class=\"token comment\">// 删除网络</span>\n\t<span class=\"token function\">DelNetwork</span><span class=\"token punctuation\">(</span>ctx context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> net <span class=\"token operator\">*</span>NetworkConfig<span class=\"token punctuation\">,</span> rt <span class=\"token operator\">*</span>RuntimeConf<span class=\"token punctuation\">)</span> <span class=\"token builtin\">error</span>\n    <span class=\"token comment\">// 获取网络缓存结果</span>\n\t<span class=\"token function\">GetNetworkCachedResult</span><span class=\"token punctuation\">(</span>net <span class=\"token operator\">*</span>NetworkConfig<span class=\"token punctuation\">,</span> rt <span class=\"token operator\">*</span>RuntimeConf<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>types<span class=\"token punctuation\">.</span>Result<span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 获取网络缓存配置</span>\n\t<span class=\"token function\">GetNetworkCachedConfig</span><span class=\"token punctuation\">(</span>net <span class=\"token operator\">*</span>NetworkConfig<span class=\"token punctuation\">,</span> rt <span class=\"token operator\">*</span>RuntimeConf<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">byte</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>RuntimeConf<span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 校验网络</span>\n\t<span class=\"token function\">ValidateNetwork</span><span class=\"token punctuation\">(</span>ctx context<span class=\"token punctuation\">.</span>Context<span class=\"token punctuation\">,</span> net <span class=\"token operator\">*</span>NetworkConfig<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">string</span><span class=\"token punctuation\">,</span> <span class=\"token builtin\">error</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">CNI</code>插件负责以某种方式配置容器的网络接口，通过标准输入提供配置，标准输出上返回结果，标准错误上返回error。</p>\n<h5>3.3 CNI操作</h5>\n<p>CNI插件定义了4个操作：ADD、DEL、CHECK、Version。</p>\n<ol>\n<li>ADD：添加容器到网络中，插件收到ADD命令执行如下步骤；不支持多次调用。</li>\n</ol>\n<ul>\n<li>在CNI_NETNS的容器中创建CNI_IFNAME的接口。</li>\n<li>调整CNI_NETNS容器内CNI_IFNAME的配置。</li>\n</ul>\n<ol start=\"2\">\n<li>DEL：从容器中删除网络，插件收到DEL命令执行如下步骤；支持多次调用。</li>\n</ol>\n<ul>\n<li>删除CNI_NETNS容器内的CNI_IFNAME定义的接口。</li>\n<li>撤销插件ADD功能中应用的修改。</li>\n</ul>\n<ol start=\"3\">\n<li>\n<p>Check：检查容器的网络是否符合预期。</p>\n</li>\n<li>\n<p>Version：探测CNI插件版本是否支持。</p>\n</li>\n</ol>\n<h2>CNI Plugin 项目</h2>\n<p>Plugin中提供了3个维度的插件，一个是main，用户创建网络接口的插件，一个ipam，用于管理ip地址的插件，可以被main插件调用，一个meta插件，就是其它插件。</p>","frontmatter":{"title":"Kubernetes网络之CNI规范解读","date":"May 11, 2022","description":null}},"previous":{"fields":{"slug":"/2022-05-10-k8s网络之Flannel原理/"},"frontmatter":{"title":"Kubernetes网络之Flannel原理介绍"}},"next":{"fields":{"slug":"/2022-05-12-Linux-Network-Namespace/"},"frontmatter":{"title":"Linux网络虚拟化:探索NetWork Namespace"}}},"pageContext":{"id":"c9d34b82-e40f-54f2-9ab5-df07216db4c3","previousPostId":"107feb9c-579b-5ff9-becb-a2a38ef1e478","nextPostId":"73c57c26-06fd-5dd0-8ba8-7ac5d58e7737"}},
    "staticQueryHashes": ["2841359383","3257411868"]}