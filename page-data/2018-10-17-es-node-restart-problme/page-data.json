{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/2018-10-17-es-node-restart-problme/",
    "result": {"data":{"site":{"siteMetadata":{"title":"LRF"}},"markdownRemark":{"id":"6c4d6dfe-fe0a-5535-8d4a-e89892c367ec","excerpt":"ES 节点离线并重启之后，发现本级上的分片已经再开始在平衡了，就会把本级上的所有分片删除，从新从其他集群上拉取，这样就会出现大量的数据迁移。占用超级多的网络资源。 之前已经讲过破解和安装x-pack的教程。本文涉及到的是安装成功之后重启服务的问题。ES…","html":"<p><strong>ES 节点离线并重启之后，发现本级上的分片已经再开始在平衡了，就会把本级上的所有分片删除，从新从其他集群上拉取，这样就会出现大量的数据迁移。占用超级多的网络资源。</strong></p>\n<p><strong>之前已经讲过破解和安装x-pack的教程。本文涉及到的是安装成功之后重启服务的问题。ES集群在其中任何一个节点离线之后都会进行数据再平衡，就是把现有的数据进行重新分片,以达到高可用的目的。但是这样也会有很多问题，比如是因为网络抖动引起节点之间通信阻断，本来马上就能好的，可是就出现大量的数据迁移。</strong></p>\n<p><strong>生产环境下建议关闭自动平衡。因为集群中集群的节点数是定的，所以分片也是固定的，如果是添加了新节点，就需要打开自动平衡功能，先把分片平衡了再关闭这个功能。</strong></p>\n<h2>停机维护时操作步骤</h2>\n<h3>1、关闭分片分配</h3>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"># 此操作会停止所有的分片动作，以及分片的数据移动。\nPUT _cluster/settings\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"transient\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"cluster.routing.allocation.enable\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"none\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>2、执行同步刷新</h3>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">POST _flush/synced</code></pre></div>\n<h3>3、关闭自动平衡(重要)</h3>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"># 这一项很重要，如果配置了关闭分片分配，没有关闭自平衡，也会在打开分片分配之后出现集群自平衡\nPUT /_cluster/settings?pretty\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"transient\"</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"cluster.routing.rebalance.enable\"</span> <span class=\"token operator\">:</span> <span class=\"token string\">\"none\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n# 设置以后需要手动验证一下\ncurl http<span class=\"token operator\">:</span><span class=\"token comment\">//{host}:9200/_cluster/settings?pretty</span></code></pre></div>\n<h3>4、延迟副本分片的分配</h3>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">PUT /_all/_settings\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"settings\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"index.unassigned.node_left.delayed_timeout\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"5m\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>上面的步骤都做完了，集群自平衡关闭了，分片功能关闭了，就可以停机维护服务</strong></p>\n<h3>5、重启之后</h3>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"># 打开分片分配，就会把分片上数据不一致的进行同步，不会出现再平衡\nPUT _cluster/settings\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"transient\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"cluster.routing.allocation.enable\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"all\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>参考文档</h2>\n<ul>\n<li><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/5.4/shards-allocation.html#shards-allocation\">https://www.elastic.co/guide/en/elasticsearch/reference/5.4/shards-allocation.html#shards-allocation</a></li>\n<li><a href=\"https://juejin.im/post/5ab5f53f518825556b6cbdea\">https://juejin.im/post/5ab5f53f518825556b6cbdea</a></li>\n<li><a href=\"https://www.elastic.co/guide/en/elasticsearch/reference/5.4/rolling-upgrades.html\">https://www.elastic.co/guide/en/elasticsearch/reference/5.4/rolling-upgrades.html</a></li>\n</ul>","frontmatter":{"title":"ES 节点重启问题","date":"October 17, 2018","description":null}},"previous":{"fields":{"slug":"/2018-10-17-es-xpack-watch-user/"},"frontmatter":{"title":"es-xpack-watch-user"}},"next":{"fields":{"slug":"/2018-10-17-es-dynamic-index-create/"},"frontmatter":{"title":"es 索引按时间自动创建"}}},"pageContext":{"id":"6c4d6dfe-fe0a-5535-8d4a-e89892c367ec","previousPostId":"a5dbd2cc-2d87-5816-90b7-c112ccb62043","nextPostId":"a2e0aa7a-6b0a-5740-80d8-f57da60004b6"}},
    "staticQueryHashes": ["2841359383","3257411868"]}