{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/2018-10-17-linux-recording-user-log/",
    "result": {"data":{"site":{"siteMetadata":{"title":"LRF"}},"markdownRemark":{"id":"49ad70d5-0913-567f-b6f3-a18390510a54","excerpt":"记录操作记录 方案一 方案二","html":"<h1>记录操作记录</h1>\n<h2>方案一</h2>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">vim</span> /etc/profile\n<span class=\"token comment\"># 把如下内容加入/etc/profile文件里面</span>\n<span class=\"token assign-left variable\"><span class=\"token environment constant\">PS1</span></span><span class=\"token operator\">=</span><span class=\"token string\">\"<span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">whoami</span><span class=\"token variable\">`</span></span>@<span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">hostname</span><span class=\"token variable\">`</span></span>:\"</span><span class=\"token string\">'[\\u@\\h \\W]\\$'</span>\n<span class=\"token assign-left variable\"><span class=\"token environment constant\">PS1</span></span><span class=\"token operator\">=</span><span class=\"token string\">\"[\\u@\\h \\W]\\$\"</span> <span class=\"token comment\"># 和上面的线上不一样，这种比较常规</span>\n<span class=\"token function\">history</span>\n<span class=\"token assign-left variable\">USER_IP</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">who</span> -u am i <span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span>/dev/null<span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'{print $NF}'</span><span class=\"token operator\">|</span><span class=\"token function\">sed</span> -e <span class=\"token string\">'s/[()]//g'</span><span class=\"token variable\">`</span></span> \n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$USER_IP</span>\"</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span> <span class=\"token punctuation\">]</span> \n<span class=\"token keyword\">then</span>\n<span class=\"token assign-left variable\">USER_IP</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">hostname</span><span class=\"token variable\">`</span></span> \n<span class=\"token keyword\">fi</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token operator\">!</span> -d /tmp/history <span class=\"token punctuation\">]</span> \n<span class=\"token keyword\">then</span>\n<span class=\"token function\">mkdir</span> /tmp/history\n<span class=\"token function\">chmod</span> <span class=\"token number\">777</span> /tmp/history\n<span class=\"token keyword\">fi</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token operator\">!</span> -d /tmp/history/<span class=\"token variable\">${<span class=\"token environment constant\">LOGNAME</span>}</span> <span class=\"token punctuation\">]</span> \n<span class=\"token keyword\">then</span>\n<span class=\"token function\">mkdir</span> /tmp/history/<span class=\"token variable\">${<span class=\"token environment constant\">LOGNAME</span>}</span> \n<span class=\"token function\">chmod</span> <span class=\"token number\">300</span> /tmp/history/<span class=\"token variable\">${<span class=\"token environment constant\">LOGNAME</span>}</span> \n<span class=\"token keyword\">fi</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">HISTSIZE</span></span><span class=\"token operator\">=</span><span class=\"token number\">4096</span> \n<span class=\"token assign-left variable\">DT</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">date</span> +<span class=\"token string\">\"%Y%m%d_%H%M%S\"</span><span class=\"token variable\">`</span></span> \n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\"><span class=\"token environment constant\">HISTFILE</span></span><span class=\"token operator\">=</span><span class=\"token string\">\"/tmp/history/<span class=\"token variable\">${<span class=\"token environment constant\">LOGNAME</span>}</span>/<span class=\"token variable\">${USER_IP}</span> history.<span class=\"token variable\">$DT</span>\"</span>\n<span class=\"token function\">chmod</span> <span class=\"token number\">600</span> /tmp/history/<span class=\"token variable\">${<span class=\"token environment constant\">LOGNAME</span>}</span>/*history* <span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span>/dev/null\n\n<span class=\"token comment\"># source一下</span>\n<span class=\"token builtin class-name\">source</span> /etc/profile\n<span class=\"token comment\"># 日志记录在 /tmp/history 目录下</span>\n</code></pre></div>\n<h2>方案二</h2>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">vim</span> /etc/profile\n<span class=\"token comment\"># 把如下内容加入到/etc/profile中</span>\n<span class=\"token comment\">#设置history格式</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">HISTTIMEFORMAT</span><span class=\"token operator\">=</span><span class=\"token string\">\"[%Y-%m-%d %H:%M:%S] [<span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token function\">who</span> am i <span class=\"token operator\"><span class=\"token file-descriptor important\">2</span>></span>/dev/null<span class=\"token operator\">|</span> <span class=\"token punctuation\">\\</span>\n<span class=\"token function\">awk</span> <span class=\"token string\">'{print $NF}'</span><span class=\"token operator\">|</span><span class=\"token function\">sed</span> -e <span class=\"token string\">'s/[()]//g'</span><span class=\"token variable\">`</span></span>] \"</span>\n\n<span class=\"token comment\">#登录时清空当前缓存</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"\"</span> <span class=\"token operator\">></span> .bash_history\n\n<span class=\"token comment\">#记录shell执行的每一条命令</span>\n<span class=\"token builtin class-name\">export</span> <span class=\"token assign-left variable\">PROMPT_COMMAND</span><span class=\"token operator\">=</span><span class=\"token string\">'\\\nif [ -z \"$OLD_PWD\" ];then\nexport OLD_PWD=$PWD;\nfi;\nif [ ! -z \"$LAST_CMD\" ] &amp;&amp; [ \"$(history 1)\" != \"$LAST_CMD\" ]; then\nlogger -t `whoami`_shell_cmd \"[$OLD_PWD]$(history 1)\";\nfi ;\nexport LAST_CMD=\"$(history 1)\";\nexport OLD_PWD=$PWD;'</span>\n<span class=\"token comment\">#source一下</span>\n<span class=\"token builtin class-name\">source</span> /etc/profile\n<span class=\"token comment\"># 日志记录</span>\n/var/log/messages</code></pre></div>","frontmatter":{"title":"linux 记录操作记录","date":"October 17, 2018","description":null}},"previous":{"fields":{"slug":"/2018-10-17-linux-Firewall/"},"frontmatter":{"title":"linux-Firewall 配置"}},"next":{"fields":{"slug":"/2018-10-17-linux-crond/"},"frontmatter":{"title":"linux-crond"}}},"pageContext":{"id":"49ad70d5-0913-567f-b6f3-a18390510a54","previousPostId":"7856ea72-5488-5d61-8b47-b6ee3a50a642","nextPostId":"975bd264-0d13-588d-86b1-ca0ac6a3e2bf"}},
    "staticQueryHashes": ["2841359383","3257411868"]}