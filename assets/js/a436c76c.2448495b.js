"use strict";(self.webpackChunkblogs=self.webpackChunkblogs||[]).push([[7288],{6470:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>t,contentTitle:()=>d,default:()=>u,frontMatter:()=>r,metadata:()=>l,toc:()=>c});var i=s(4848),a=s(8453);const r={slug:"k8s-nvidia-dra-test",title:"kubernetes 1.31 DRA Nvidia GPU\u6d4b\u8bd5",authors:["rongfu"],tags:["Kubernetes DRA"]},d="\u524d\u7f6e\u51c6\u5907",l={permalink:"/blog/k8s-nvidia-dra-test",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/2024-11-26-k8s-nvidia-dra-test.md",source:"@site/blog/2024-11-26-k8s-nvidia-dra-test.md",title:"kubernetes 1.31 DRA Nvidia GPU\u6d4b\u8bd5",description:"\u6211\u4eec\u901a\u8fc7\u4f7f\u7528 Nvidia \u6765\u9a8c\u8bc1 DRA \u76f8\u5173\u7684\u80fd\u529b\u3002",date:"2024-11-26T00:00:00.000Z",tags:[{inline:!0,label:"Kubernetes DRA",permalink:"/blog/tags/kubernetes-dra"}],readingTime:3.125,hasTruncateMarker:!0,authors:[{name:"Leng",title:"Softwore Developer",url:"https://github.com/lengrongfu",image_hrl:"https://avatars.githubusercontent.com/u/15009201?v=4",socials:{github:"https://github.com/lengrongfu"},key:"rongfu",page:null}],frontMatter:{slug:"k8s-nvidia-dra-test",title:"kubernetes 1.31 DRA Nvidia GPU\u6d4b\u8bd5",authors:["rongfu"],tags:["Kubernetes DRA"]},unlisted:!1,prevItem:{title:"kubernetes 1.32 DRA \u539f\u7406\u89e3\u6790",permalink:"/blog/k8s-dra"},nextItem:{title:"\u5f00\u53d1 Kubernetes debug \u7684\u51e0\u79cd\u624b\u6bb5",permalink:"/blog/k8s-debug"}},t={authorsImageUrls:[void 0]},c=[{value:"\u5b89\u88c5 docker",id:"\u5b89\u88c5-docker",level:3},{value:"\u5b89\u88c5 <code>kind</code>",id:"\u5b89\u88c5-kind",level:3},{value:"\u901a\u8fc7 apt \u5b89\u88c5 NVIDIA Container Toolkit",id:"\u901a\u8fc7-apt-\u5b89\u88c5-nvidia-container-toolkit",level:3},{value:"\u914d\u7f6edocker \u8fd0\u884c\u65f6",id:"\u914d\u7f6edocker-\u8fd0\u884c\u65f6",level:3},{value:"Case1: \u540c\u4e00\u4e2aPod\u7684\u4e24\u4e2a\u5bb9\u5668\u5171\u4eab\u4e00\u4e2a\u8bbe\u5907",id:"case1-\u540c\u4e00\u4e2apod\u7684\u4e24\u4e2a\u5bb9\u5668\u5171\u4eab\u4e00\u4e2a\u8bbe\u5907",level:3},{value:"Case2: \u521b\u5efa\u4e24\u4e2aPod\u5171\u7528\u540c\u4e00\u5f20\u5361",id:"case2-\u521b\u5efa\u4e24\u4e2apod\u5171\u7528\u540c\u4e00\u5f20\u5361",level:3},{value:"Case3: \u4e24\u4e2aPod\u5171\u4eab\u540c\u4e00\u7c7b\u578b\u7684\u5361\uff0c\u6307\u5b9a\u578b\u53f7",id:"case3-\u4e24\u4e2apod\u5171\u4eab\u540c\u4e00\u7c7b\u578b\u7684\u5361\u6307\u5b9a\u578b\u53f7",level:3}];function o(e){const n={a:"a",code:"code",h1:"h1",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",...(0,a.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:["\u6211\u4eec\u901a\u8fc7\u4f7f\u7528 ",(0,i.jsx)(n.code,{children:"Nvidia"})," \u6765\u9a8c\u8bc1 DRA \u76f8\u5173\u7684\u80fd\u529b\u3002"]}),"\n",(0,i.jsxs)(n.p,{children:["\u539f\u6587\uff1a(kubernetes 1.31 DRA Nvidia GPU\u6d4b\u8bd5)[",(0,i.jsx)(n.a,{href:"https://mp.weixin.qq.com/s/PZ6FYLlr9eveqL0M0q4rmg",children:"https://mp.weixin.qq.com/s/PZ6FYLlr9eveqL0M0q4rmg"}),"]"]}),"\n",(0,i.jsx)(n.p,{children:"\u64cd\u4f5c\u7cfb\u7edf\uff1aubuntu 22.04"}),"\n",(0,i.jsx)(n.p,{children:"runtime\uff1adocker"}),"\n",(0,i.jsx)(n.h3,{id:"\u5b89\u88c5-docker",children:"\u5b89\u88c5 docker"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"\u4f7f\u7528\u4fbf\u6377\u811a\u672c\u6765\u5b89\u88c5 docker"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:" $ curl -fsSL https://get.docker.com -o get-docker.sh\n $ sudo sh get-docker.sh\n"})}),"\n",(0,i.jsxs)(n.h3,{id:"\u5b89\u88c5-kind",children:["\u5b89\u88c5 ",(0,i.jsx)(n.code,{children:"kind"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# For AMD64 / x86_64\n[ $(uname -m) = x86_64 ] && curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.25.0/kind-linux-amd64\nchmod +x ./kind\nsudo mv ./kind /usr/local/bin/kind\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u901a\u8fc7-apt-\u5b89\u88c5-nvidia-container-toolkit",children:"\u901a\u8fc7 apt \u5b89\u88c5 NVIDIA Container Toolkit"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"\u914d\u7f6e repository"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg \\\n  && curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \\\n    sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \\\n    sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list\n"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"\u66f4\u65b0 package"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ sudo apt-get update\n"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"\u5b89\u88c5 NVIDIA Container Toolkit"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ sudo apt-get install -y nvidia-container-toolkit\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u914d\u7f6edocker-\u8fd0\u884c\u65f6",children:"\u914d\u7f6edocker \u8fd0\u884c\u65f6"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\u5c06 NVIDIA \u5bb9\u5668\u8fd0\u884c\u65f6\u914d\u7f6e\u4e3a",(0,i.jsx)(n.strong,{children:"\u9ed8\u8ba4"}),"Docker \u8fd0\u884c\u65f6."]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ sudo nvidia-ctk runtime configure --runtime=docker --set-as-default\n"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"\u91cd\u65b0\u542f\u52a8 Docker \u4ee5\u5e94\u7528\u66f4\u6539"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ sudo systemctl restart docker\n"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"\u914d\u7f6e NVIDIA \u5bb9\u5668\u8fd0\u884c\u65f6\u4f7f\u7528\u5377\u6302\u8f7d\u6765\u9009\u62e9\u8981\u6ce8\u5165\u5bb9\u5668\u7684\u8bbe\u5907."}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# /etc/nvidia-container-runtime/config.toml\nsudo nvidia-ctk config --in-place --set accept-nvidia-visible-devices-as-volume-mounts=true\n"})}),"\n",(0,i.jsx)(n.h1,{id:"\u5b89\u88c5-k8s-\u96c6\u7fa4\u548c-nvidia-dra",children:"\u5b89\u88c5 k8s \u96c6\u7fa4\u548c Nvidia DRA"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"\u514b\u9686\u6b64\u5b58\u50a8\u5e93\u5e76\u5b89\u88c5\u96c6\u7fa4"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ git clone https://github.com/NVIDIA/k8s-dra-driver.git\n$ cd k8s-dra-driver\n"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\u4f7f\u7528",(0,i.jsx)(n.code,{children:"kind"}),"\u521b\u5efa\u4e00\u4e2a\u96c6\u7fa4\u6765\u8fd0\u884c\u6f14\u793a"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ ./demo/clusters/kind/create-cluster.sh\n"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\u5b89\u88c5 ",(0,i.jsx)(n.code,{children:"kubectl"})," \u547d\u4ee4\u548c ",(0,i.jsx)(n.code,{children:"helm"})]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'# \u5b89\u88c5kubectl\n$ curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"\n# \u5b89\u88c5helm\n$ curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3\n$ chmod 700 get_helm.sh\n$ ./get_helm.sh\n\n'})}),"\n",(0,i.jsxs)(n.ol,{start:"4",children:["\n",(0,i.jsx)(n.li,{children:"\u6784\u5efa nvidia dra \u56fe\u50cf"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# \u5982\u679c\u4e0a\u9762\u7684\u547d\u4ee4\u6267\u884c\u9519\u8bef\uff0c\u5c31\u5148\u6267\u884c\u8fd9\u4e2a\u547d\u4ee4\n$ make build-image\n\n$ ./demo/clusters/kind/build-dra-driver.sh\n# \u628a\u6784\u5efa\u51fa\u6765\u7684\u955c\u50cfload\u5230kind\u4e2d\n$ k8s-dra-driver-cluster-image nvcr.io/nvidia/cloud-native/k8s-dra-driver:v0.1.0-ubuntu20.04 --name k8s-dra-driver-cluster\n"})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"\u5b89\u88c5 DRA \u5230\u96c6\u7fa4\u4e2d"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ ./demo/clusters/kind/install-dra-driver.sh\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u5b89\u88c5\u6210\u529f\u4e4b\u540e\uff0c\u5e94\u8be5\u663e\u793a",(0,i.jsx)(n.code,{children:"nvidia-dra-driver"}),"\u547d\u540d\u7a7a\u95f4\u4e2d\u8fd0\u884c\u7684\u4e24\u4e2a pod\uff1a"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ kubectl get pods -n nvidia-dra-driver\nNAME                                         READY   STATUS    RESTARTS   AGE\nnvidia-k8s-dra-driver-kubelet-plugin-t5qgz   1/1     Running   0          44s\n"})}),"\n",(0,i.jsx)(n.h1,{id:"\u8fd0\u884cdemo",children:"\u8fd0\u884cDemo"}),"\n",(0,i.jsx)(n.h3,{id:"case1-\u540c\u4e00\u4e2apod\u7684\u4e24\u4e2a\u5bb9\u5668\u5171\u4eab\u4e00\u4e2a\u8bbe\u5907",children:"Case1: \u540c\u4e00\u4e2aPod\u7684\u4e24\u4e2a\u5bb9\u5668\u5171\u4eab\u4e00\u4e2a\u8bbe\u5907"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ kubectl apply --filename=demo/specs/quickstart/gpu-test2.yaml\n"})}),"\n",(0,i.jsx)(n.h3,{id:"case2-\u521b\u5efa\u4e24\u4e2apod\u5171\u7528\u540c\u4e00\u5f20\u5361",children:"Case2: \u521b\u5efa\u4e24\u4e2aPod\u5171\u7528\u540c\u4e00\u5f20\u5361"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ kubectl apply --filename=demo/specs/quickstart/gpu-test3.yaml\n"})}),"\n",(0,i.jsx)(n.h3,{id:"case3-\u4e24\u4e2apod\u5171\u4eab\u540c\u4e00\u7c7b\u578b\u7684\u5361\u6307\u5b9a\u578b\u53f7",children:"Case3: \u4e24\u4e2aPod\u5171\u4eab\u540c\u4e00\u7c7b\u578b\u7684\u5361\uff0c\u6307\u5b9a\u578b\u53f7"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'---\napiVersion: v1\nkind: Namespace\nmetadata:\n  name: gpu-test3\n\n---\napiVersion: resource.k8s.io/v1alpha3\nkind: ResourceClaim\nmetadata:\n  namespace: gpu-test3\n  name: single-gpu\nspec:\n  devices:\n    requests:\n    - name: gpu\n      deviceClassName: gpu.nvidia.com\n      selectors:\n      - cel:\n          expression: |\n            device.attributes[\'gpu.nvidia.com\'].productName==\'Tesla T4\'\n\n---\napiVersion: v1\nkind: Pod\nmetadata:\n  namespace: gpu-test3\n  name: pod1\n  labels:\n    app: pod\nspec:\n  containers:\n  - name: ctr\n    image: ubuntu:22.04\n    command: ["bash", "-c"]\n    args: ["nvidia-smi -L; trap \'exit 0\' TERM; sleep 9999 & wait"]\n    resources:\n      claims:\n      - name: shared-gpu\n  resourceClaims:\n  - name: shared-gpu\n    resourceClaimName: single-gpu\n\n---\napiVersion: v1\nkind: Pod\nmetadata:\n  namespace: gpu-test3\n  name: pod2\n  labels:\n    app: pod\nspec:\n  containers:\n  - name: ctr\n    image: ubuntu:22.04\n    command: ["bash", "-c"]\n    args: ["nvidia-smi -L; trap \'exit 0\' TERM; sleep 9999 & wait"]\n    resources:\n      claims:\n      - name: shared-gpu\n  resourceClaims:\n  - name: shared-gpu\n    resourceClaimName: single-gpu\n'})})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>d,x:()=>l});var i=s(6540);const a={},r=i.createContext(a);function d(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:d(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);