"use strict";(self.webpackChunkblogs=self.webpackChunkblogs||[]).push([[3426],{6333:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>c,default:()=>u,frontMatter:()=>o,metadata:()=>d,toc:()=>i});var r=t(4848),s=t(8453);const o={slug:"kubelet-one-analyze",title:"kubelet\u6e90\u7801\u5206\u6790 syncLoopIteration\uff08\u4e00\uff09 podUpdateCh",authors:["rongfu"],tags:["kubernetes","Kubelet"]},c=void 0,d={permalink:"/blog/kubelet-one-analyze",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/2024-08-28-kubelet-two-analyze.md",source:"@site/blog/2024-08-28-kubelet-two-analyze.md",title:"kubelet\u6e90\u7801\u5206\u6790 syncLoopIteration\uff08\u4e00\uff09 podUpdateCh",description:"podUpdateCh \u4e3b\u8981\u662f\u8d1f\u8d23\u63a5\u6536 Pod \u7684\u6570\u636e\uff0c\u5206\u522b\u4ece\u6587\u4ef6\u3001URL\u3001Kube-APIServer \u4e09\u4e2a\u5730\u65b9\u6765\uff0c\u4e0b\u9762\u5c06\u8be6\u7ec6\u5206\u6790\u8fd9\u4e2a chan \u7684\u8bfb\u5199\u6d41\u7a0b\u3002",date:"2024-08-28T00:00:00.000Z",tags:[{inline:!0,label:"kubernetes",permalink:"/blog/tags/kubernetes"},{inline:!1,label:"Kubelet",permalink:"/blog/tags/Kubelet",description:"Kubelet"}],readingTime:4.975,hasTruncateMarker:!0,authors:[{name:"Leng",title:"Softwore Developer",url:"https://github.com/lengrongfu",image_hrl:"https://avatars.githubusercontent.com/u/15009201?v=4",socials:{github:"https://github.com/lengrongfu"},key:"rongfu",page:null}],frontMatter:{slug:"kubelet-one-analyze",title:"kubelet\u6e90\u7801\u5206\u6790 syncLoopIteration\uff08\u4e00\uff09 podUpdateCh",authors:["rongfu"],tags:["kubernetes","Kubelet"]},unlisted:!1,nextItem:{title:"kubelet\u6e90\u7801\u5206\u6790(\u4e00)\uff1a\u5de5\u4f5c\u539f\u7406",permalink:"/blog/kubelet-one-analyze"}},l={authorsImageUrls:[void 0]},i=[{value:"File",id:"file",level:3},{value:"URL",id:"url",level:3},{value:"API",id:"api",level:3},{value:"Merge",id:"merge",level:2}];function a(e){const n={code:"code",h2:"h2",h3:"h3",img:"img",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"podUpdateCh"})," \u4e3b\u8981\u662f\u8d1f\u8d23\u63a5\u6536 ",(0,r.jsx)(n.code,{children:"Pod"})," \u7684\u6570\u636e\uff0c\u5206\u522b\u4ece\u6587\u4ef6\u3001URL\u3001Kube-APIServer \u4e09\u4e2a\u5730\u65b9\u6765\uff0c\u4e0b\u9762\u5c06\u8be6\u7ec6\u5206\u6790\u8fd9\u4e2a ",(0,r.jsx)(n.code,{children:"chan"})," \u7684\u8bfb\u5199\u6d41\u7a0b\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"Pod"})," \u7684 ",(0,r.jsx)(n.code,{children:"source"})," \u5b9a\u4e49\u4e86\u56db\u79cd\u8868\u73b0\u65b9\u5f0f\uff0c\u5728\u4ee3\u7801 ",(0,r.jsx)(n.code,{children:"pod_update.go"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:'// These constants identify the sources of pods.\nconst (\n\t// Filesource idenitified updates from a file.\n\tFileSource = "file"\n\t// HTTPSource identifies updates from querying a web page.\n\tHTTPSource = "http"\n\t// ApiserverSource identifies updates from Kubernetes API Server.\n\tApiserverSource = "api"\n\t// AllSource identifies updates from all sources.\n\tAllSource = "*"\n)\n'})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://firebasestorage.googleapis.com/v0/b/notiondiagram.appspot.com/o/diagram%2Fm5smUNzLG7NDZmSPY82qhFvWnsu1%2F7182ab7e-9b66-4472-b508-6ce8abb3bd7e.svg?alt=media&token=dc26e818-bbd5-4c18-8070-70649d577ad7",alt:"a"})}),"\n",(0,r.jsx)(n.h3,{id:"file",children:"File"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"file"})," Watch \u529f\u80fd\u53ea\u5728 ",(0,r.jsx)(n.code,{children:"linux"})," \u64cd\u4f5c\u7cfb\u7edf\u4e0a\u652f\u6301\uff0c\u5176\u5b83\u64cd\u4f5c\u7cfb\u7edf\u90fd\u4e0d\u652f\u6301\u3002"]}),"\n",(0,r.jsxs)(n.p,{children:["\u4f1a\u628a ",(0,r.jsx)(n.code,{children:"fsnotify"})," \u76d1\u542c\u7684\u6587\u4ef6\u4e8b\u4ef6\u8f6c\u6362\u4e3a ",(0,r.jsx)(n.code,{children:"Pod"})," \u7684\u64cd\u4f5c\u7c7b\u578b\uff1b"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:"func (s *sourceFile) produceWatchEvent(e *fsnotify.Event) error {\n\tvar eventType podEventType\n\tswitch {\n\tcase (e.Op & fsnotify.Create) > 0:\n\t\teventType = podAdd\n\tcase (e.Op & fsnotify.Write) > 0:\n\t\teventType = podModify\n\tcase (e.Op & fsnotify.Chmod) > 0:\n\t\teventType = podModify\n\tcase (e.Op & fsnotify.Remove) > 0:\n\t\teventType = podDelete\n\tcase (e.Op & fsnotify.Rename) > 0:\n\t\teventType = podDelete\n\tdefault:\n\t\t// Ignore rest events\n\t\treturn nil\n\t}\n\n\ts.watchEvents <- &watchEvent{e.Name, eventType}\n\treturn nil\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u7136\u540e\u6839\u636e\u76d1\u542c\u5230\u7684\u6587\u4ef6\u540d\u7684\u53d8\u5316\uff0c\u6765\u8bfb\u53d6 ",(0,r.jsx)(n.code,{children:"Pod"})," \u7684\u5185\u5bb9\uff0c\u4e4b\u540e\u66f4\u65b0 ",(0,r.jsx)(n.code,{children:"store"})," \u5bf9\u8c61\uff1b\u8fd9\u91cc\u662f\u4ee4\u6211\u5947\u602a\u7684\uff0c\u6211\u4ee5\u4e3a\u5b83\u4f1a\u5f80 ",(0,r.jsx)(n.code,{children:"chan"})," \u91cc\u9762\u53d1\u9001\u4e00\u4e2a\u4e8b\u4ef6\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:'func (s *sourceFile) consumeWatchEvent(e *watchEvent) error {\n\tswitch e.eventType {\n\tcase podAdd, podModify:\n\t\tpod, _ := s.extractFromFile(e.fileName)\n\t\treturn s.store.Add(pod)\n\tcase podDelete:\n\t\tif objKey, keyExist := s.fileKeyMapping[e.fileName]; keyExist {\n\t\t\tpod, podExist, err := s.store.GetByKey(objKey)\n\t\t\tif err = s.store.Delete(pod); err != nil {\n\t\t\t\treturn fmt.Errorf("failed to remove deleted pod from cache: %v", err)\n\t\t\t}\n\t\t\t...\n\t\t}\n\t}\n\treturn nil\n}\n\n'})}),"\n",(0,r.jsxs)(n.p,{children:["\u9664\u4e86 ",(0,r.jsx)(n.code,{children:"Watch"})," \u6587\u4ef6\u53d8\u5316\u4e4b\u540e\uff0c\u5b83\u8fd8\u6709\u4e00\u4e2a ",(0,r.jsx)(n.code,{children:"time.Ticker"})," \u6bcf\u9694 ",(0,r.jsx)(n.code,{children:"10s"})," \u4f1a\u6267\u884c\u4e00\u904d\u5168\u91cf\u8bfb\u53d6\u76ee\u5f55\u4e0b ",(0,r.jsx)(n.code,{children:"Pod"})," \u7684\u64cd\u4f5c\uff1b"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:'func (s *sourceFile) run() {\n\tlistTicker := time.NewTicker(s.period) #\u9ed8\u8ba4\u914d\u7f6e\u662f10s\n\tgo func() {\n\t\t// \u542f\u52a8\u4e4b\u540e\u5148\u8bfb\u53d6\u4e00\u904d\u6240\u6709\u7684\n\t\tif err := s.listConfig(); err != nil {\n\t\t\tklog.ErrorS(err, "Unable to read config path", "path", s.path)\n\t\t}\n\t\tfor {\n\t\t\tselect {\n\t\t\tcase <-listTicker.C:\n\t\t\t\tif err := s.listConfig(); err != nil {\n\t\t\t\t\tklog.ErrorS(err, "Unable to read config path", "path", s.path)\n\t\t\t\t}\n\t\t\tcase e := <-s.watchEvents:\n\t\t\t\tif err := s.consumeWatchEvent(e); err != nil {\n\t\t\t\t\tklog.ErrorS(err, "Unable to process watch event")\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}()\n\ts.startWatch()\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["\u4e0a\u9762\u6709\u4e00\u4e2a\u7591\u95ee\uff1a\u8fd9\u91cc\u662f\u4ee4\u6211\u5947\u602a\u7684\uff0c\u6211\u4ee5\u4e3a\u5b83\u4f1a\u5f80 ",(0,r.jsx)(n.code,{children:"chan"})," \u91cc\u9762\u53d1\u9001\u4e00\u4e2a\u4e8b\u4ef6\u3002\u53d1\u73b0\u5b83\u7684 ",(0,r.jsx)(n.code,{children:"send"})," \u662f\u5199\u5728 ",(0,r.jsx)(n.code,{children:"store.Add\u3001store.Delete"}),"  \u91cc\u9762\u7684\uff0c\u5b83\u4f1a\u5728\u6bcf\u6b21\u89e6\u53d1\u8fd9\u4e2a\u51fd\u6570\u7684\u65f6\u5019\uff0c\u628a\u5b58\u50a8\u8d77\u6765\u7684 ",(0,r.jsx)(n.code,{children:"pod"})," \u5168\u91cf\u7684\u53d1\u9001\u5230 ",(0,r.jsx)(n.code,{children:"chan"})," \u91cc\u9762. ",(0,r.jsx)(n.code,{children:"undelta_store.go#45"})]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:"func (u *UndeltaStore) Add(obj interface{}) error {\n\tif err := u.Store.Add(obj); err != nil {\n\t\treturn err\n\t}\n\tu.PushFunc(u.Store.List())\n\treturn nil\n}\nfunc (u *UndeltaStore) Update(obj interface{}) error {\n\t...\n\tu.PushFunc(u.Store.List())\n\treturn nil\n}\nfunc (u *UndeltaStore) Delete(obj interface{}) error {\n\t...\n\tu.PushFunc(u.Store.List())\n\treturn nil\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"url",children:"URL"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"URL"})," \u7684\u65b9\u5f0f\u662f\u901a\u8fc7\u7528\u6237\u914d\u7f6e\u7684\u5916\u90e8\u670d\u52a1\u5730\u5740\uff0c\u7136\u540e\u6bcf ",(0,r.jsx)(n.code,{children:"20s"})," \u53bb\u8bbf\u95ee\u4e00\u6b21\u5916\u90e8\u670d\u52a1\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:"func (s *sourceURL) run() {\n\tif err := s.extractFromURL(); err != nil {\n\t  ...\n\t}\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u5728 ",(0,r.jsx)(n.code,{children:"extractFromURL"})," \u4f1a\u901a\u8fc7\u8bbf\u95ee ",(0,r.jsx)(n.code,{children:"HTTP"})," GET \u7684\u65b9\u5f0f\u89e3\u6790\u8fd4\u56de\u503c\uff0c\u8fd4\u56de\u5f53\u4e2a\u5bf9\u8c61\u6216\u8005\u662f\u6570\u7ec4\u90fd\u53ef\u4ee5\u89e3\u6790\u6210\u529f\uff0c\u89e3\u6790\u6210\u529f\u4e4b\u540e\u4e5f\u662f\u4f1a\u53d1\u9001\u5230 ",(0,r.jsx)(n.code,{children:"merge"})," \u4e2d\u8fdb\u884c\u5408\u5e76\u5904\u7406\u3002"]}),"\n",(0,r.jsx)(n.h3,{id:"api",children:"API"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"API"})," \u7684\u65b9\u5f0f\u662f\u901a\u8fc7 ",(0,r.jsx)(n.code,{children:"list-watch"})," \u53bb\u8bfb\u53d6 ",(0,r.jsx)(n.code,{children:"kube-apiserver"})," \u7684\u6570\u636e\uff0c\u5e76\u4e14\u901a\u8fc7 ",(0,r.jsx)(n.code,{children:"field"})," \u8fdb\u884c\u8fc7\u6ee4\u5f53\u524d\u7684\u8282\u70b9\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:'lw := cache.NewListWatchFromClient(c.CoreV1().RESTClient(), "pods", metav1.NamespaceAll, fields.OneTermEqualSelector("spec.nodeName", string(nodeName)))\n'})}),"\n",(0,r.jsxs)(n.p,{children:["\u4f20\u9012\u7684 ",(0,r.jsx)(n.code,{children:"store"})," \u5bf9\u8c61\u91cc\u9762\u6709 ",(0,r.jsx)(n.code,{children:"send"})," \u7684\u529f\u80fd\uff0c\u548c ",(0,r.jsx)(n.code,{children:"file"})," \u5904\u7406\u903b\u8f91\u4e00\u6837\uff0c\u4e00\u4e2a ",(0,r.jsx)(n.code,{children:"pod"})," \u53d1\u751f\u53d8\u66f4\uff0c\u5c31\u4f1a\u8981\u53d1\u9001\u6240\u6709\u7684 ",(0,r.jsx)(n.code,{children:"pod"})," \u53bb\u6267\u884c ",(0,r.jsx)(n.code,{children:"merge"})," \u64cd\u4f5c\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:"r := cache.NewReflector(lw, &v1.Pod{}, cache.NewUndeltaStore(send, cache.MetaNamespaceKeyFunc), 0)\n"})}),"\n",(0,r.jsx)(n.h2,{id:"merge",children:"Merge"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"merge"})," \u662f\u4e3a\u4e86\u628a\u4ece\u4e0d\u540c\u7684 ",(0,r.jsx)(n.code,{children:"source"})," \u8fc7\u6765\u7684 ",(0,r.jsx)(n.code,{children:"pod"})," \u8fdb\u4e00\u6b65\u5408\u5e76\uff0c\u907f\u514d\u51fa\u73b0\u91cd\u590d\u3001\u51b2\u7a81\u7684\u64cd\u4f5c\uff0c\u6700\u7ec8\u5f97\u5230\u4e00\u4e2a\u4e00\u81f4\u7684\u64cd\u4f5c\uff0c\u6700\u7ec8\u5408\u5e76\u540e\u4f1a\u5f97\u5230\u5404\u79cd\u4e8b\u4ef6\u7684\u7ed3\u679c\uff1a"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:"adds, updates, deletes, removes, reconciles := s.merge(source, change)\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u5408\u5e76\u7684\u96be\u70b9\u5728\u4e8e\u5224\u65ad\u662f\u4e0d\u662f\u8981\u66f4\u65b0\uff0c\u6dfb\u52a0\u3001\u5220\u9664\u8fd9\u79cd\u573a\u666f\u90fd\u6bd4\u8f83\u7b80\u5355\uff0c\u4e4b\u524d\u4e0d\u5b58\u5728\u5c31\u6dfb\u52a0\uff0c\u4e4b\u524d\u5b58\u5728\uff0c\u73b0\u5728\u4e0d\u5b58\u5728\u5c31\u5220\u9664\uff0c\u4f46\u662f\u8981\u4e0d\u8981\u66f4\u65b0\u662f\u6bd4\u8f83\u96be\u5224\u65ad\u7684\uff0c\u91cc\u9762\u6709\u4e00\u4e2a ",(0,r.jsx)(n.code,{children:"checkAndUpdatePod"})," \u65b9\u6cd5\u3002"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-go",children:"func checkAndUpdatePod(existing, ref *v1.Pod) (needUpdate, needReconcile, needGracefulDelete bool) {\n\n   1. \u68c0\u67e5Spec\u3001Labels\u3001DeletionTimestamp\u3001DeletionGracePeriodSeconds\u3001Annotations\u8fd9\u4e9b\u662f\u5426\u53d1\u751f\u53d8\u66f4\n   2. \u5982\u679c\u90fd\u6ca1\u6709\u53d1\u751f\u53d8\u66f4\u5224\u65adStatus\u662f\u5426\u53d1\u751f\u53d8\u66f4\uff0c\u5982\u679c\u6709\u5219\u66f4\u65b0\uff0c\u6ca1\u6709\u5219\u4e0d\u66f4\u65b0\u3002\n   3. \u5982\u679cDeletionTimestamp\u4e0d\u4e3a\u7a7a\uff0c\u5219\u9700\u8981\u5220\u9664\n   ....\n}\n"})})]})}function u(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(a,{...e})}):a(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>c,x:()=>d});var r=t(6540);const s={},o=r.createContext(s);function c(e){const n=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:c(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);