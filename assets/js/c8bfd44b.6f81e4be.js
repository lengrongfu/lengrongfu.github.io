"use strict";(self.webpackChunkblogs=self.webpackChunkblogs||[]).push([[8708],{8368:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>m,frontMatter:()=>r,metadata:()=>s,toc:()=>a});var d=n(4848),o=n(8453);const r={slug:"kubelet-podadmit",title:"Kubelet\u6e90\u7801\u5206\u6790\uff1aPodAdmit",authors:["rongfu"],tags:["Kubernetes","Kubelet"]},i=void 0,s={permalink:"/blog/kubelet-podadmit",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/2024-09-27-kubelet-podadmit.md",source:"@site/blog/2024-09-27-kubelet-podadmit.md",title:"Kubelet\u6e90\u7801\u5206\u6790\uff1aPodAdmit",description:"\u4e4b\u524d\u8bb2\u8fc7 Kubelet \u7ed3\u6784\u4f53\u4e2d\u7684 syncLoopIteration \u65b9\u6cd5\u63a5\u6536\u591a\u4e2a channel \u6570\u636e\u6e90\u7684\u4fe1\u606f\uff0c\u5e76\u8c03\u7528\u76f8\u5e94\u7684 handler \u5904\u7406\uff0c\u5176\u4e2d configCh \u662f kubelet \u83b7\u53d6 pod \u7684\u6570\u636e\u6e90\uff0c\u6bd4\u5982\u901a\u8fc7 informer \u4ece api \u4e2d\u62c9\u53d6\u5230\u4e00\u4e2a\u65b0\u7684 Pod \uff0c\u5bf9\u5e94\u7684 handler \u4e3a HandlePodAdditions .",date:"2024-09-27T00:00:00.000Z",tags:[{inline:!1,label:"Kubernetes",permalink:"/blog/tags/kubernetes",description:"kubernetes"},{inline:!1,label:"Kubelet",permalink:"/blog/tags/Kubelet",description:"Kubelet"}],readingTime:10.16,hasTruncateMarker:!0,authors:[{name:"Leng",title:"Softwore Developer",url:"https://github.com/lengrongfu",image_hrl:"https://avatars.githubusercontent.com/u/15009201?v=4",socials:{github:"https://github.com/lengrongfu"},key:"rongfu",page:null}],frontMatter:{slug:"kubelet-podadmit",title:"Kubelet\u6e90\u7801\u5206\u6790\uff1aPodAdmit",authors:["rongfu"],tags:["Kubernetes","Kubelet"]},unlisted:!1,prevItem:{title:"\u5f00\u53d1 Kubernetes debug \u7684\u51e0\u79cd\u624b\u6bb5",permalink:"/blog/k8s-debug"},nextItem:{title:"kubelet \u6e90\u7801\u5206\u6790 devicemanager",permalink:"/blog/kubelet-devicemanage"}},l={authorsImageUrls:[void 0]},a=[{value:"Admit \u63a5\u53e3",id:"admit-\u63a5\u53e3",level:3},{value:"Eviction Admit",id:"eviction-admit",level:3},{value:"System Allowlist Admit",id:"system-allowlist-admit",level:3},{value:"Allocate Resources Admit",id:"allocate-resources-admit",level:3},{value:"Predicate Admit",id:"predicate-admit",level:3},{value:"AppArmor Admit",id:"apparmor-admit",level:3},{value:"Shutdown Admit",id:"shutdown-admit",level:3}];function c(e){const t={code:"code",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,d.jsxs)(d.Fragment,{children:[(0,d.jsxs)(t.p,{children:["\u4e4b\u524d\u8bb2\u8fc7 ",(0,d.jsx)(t.code,{children:"Kubelet"})," \u7ed3\u6784\u4f53\u4e2d\u7684 ",(0,d.jsx)(t.code,{children:"syncLoopIteration"})," \u65b9\u6cd5\u63a5\u6536\u591a\u4e2a ",(0,d.jsx)(t.code,{children:"channel"})," \u6570\u636e\u6e90\u7684\u4fe1\u606f\uff0c\u5e76\u8c03\u7528\u76f8\u5e94\u7684 ",(0,d.jsx)(t.code,{children:"handler"})," \u5904\u7406\uff0c\u5176\u4e2d ",(0,d.jsx)(t.code,{children:"configCh"})," \u662f ",(0,d.jsx)(t.code,{children:"kubelet"})," \u83b7\u53d6 ",(0,d.jsx)(t.code,{children:"pod"})," \u7684\u6570\u636e\u6e90\uff0c\u6bd4\u5982\u901a\u8fc7 ",(0,d.jsx)(t.code,{children:"informer"})," \u4ece ",(0,d.jsx)(t.code,{children:"api"})," \u4e2d\u62c9\u53d6\u5230\u4e00\u4e2a\u65b0\u7684 ",(0,d.jsx)(t.code,{children:"Pod"})," \uff0c\u5bf9\u5e94\u7684 ",(0,d.jsx)(t.code,{children:"handler"})," \u4e3a ",(0,d.jsx)(t.code,{children:"HandlePodAdditions"})," ."]}),"\n",(0,d.jsxs)(t.p,{children:[(0,d.jsx)(t.code,{children:"configCh"})," \u7684\u6570\u636e\u6765\u6e90\u6709\u4e09\u4e2a\uff0c\u5176\u4e2d\u4e00\u4e2a\u5c31\u662f ",(0,d.jsx)(t.code,{children:"api"})," \uff0c\u901a\u8fc7\u914d\u7f6e ",(0,d.jsx)(t.code,{children:"spec.nodeName FieldSelector"})," \u7684 ",(0,d.jsx)(t.code,{children:"ListOptions"})," \u6765\u5411 ",(0,d.jsx)(t.code,{children:"api"})," \u83b7\u53d6\u6240\u6709 ",(0,d.jsx)(t.code,{children:"ns"})," \u4e0b\u6307\u5b9a ",(0,d.jsx)(t.code,{children:"nodeName"})," \u7684 ",(0,d.jsx)(t.code,{children:"pod"}),"."]}),"\n",(0,d.jsxs)(t.p,{children:[(0,d.jsx)(t.code,{children:"HandlePodAdditions"})," \u63a5\u4e0b\u6765\u901a\u8fc7 ",(0,d.jsx)(t.code,{children:"canAdmitPod"})," \u65b9\u6cd5\u5224\u65ad\u8be5 ",(0,d.jsx)(t.code,{children:"Po"})," d\u662f\u5426\u53ef\u4ee5\u88ab ",(0,d.jsx)(t.code,{children:"kubelet"})," \u521b\u5efa\uff0c\u5176\u901a\u8fc7 ",(0,d.jsx)(t.code,{children:"kubelet"})," \u5bf9\u8c61\u7684 ",(0,d.jsx)(t.code,{children:"admitHandlers"})," \u83b7\u53d6\u6ce8\u518c\u597d\u7684 ",(0,d.jsx)(t.code,{children:"handler"})," \u5bf9\u8c61\uff0c\u5e76\u9010\u4e00\u8c03\u7528\u8fd9\u4e9b\u5bf9\u8c61\u7684 ",(0,d.jsx)(t.code,{children:"Admit"}),"\u65b9\u6cd5\u68c0\u67e5 ",(0,d.jsx)(t.code,{children:"pod"})," ."]}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-go",children:'// pods\u4e3akubelet\u4e2d \u6b63\u5728\u8fd0\u884c\u7684 && \u5df2\u7ecf\u88abadmit\u786e\u8ba4\u8fc7\u6ca1\u95ee\u9898\u7684 && \u4e0d\u662fterminated\u7684 pod\nfunc (kl *Kubelet) canAdmitPod(pods []*v1.Pod, pod *v1.Pod) (bool, string, string) {\n\t// the kubelet will invoke each pod admit handler in sequence\n\t// if any handler rejects, the pod is rejected.\n\t// TODO: move out of disk check into a pod admitter\n\t// TODO: out of resource eviction should have a pod admitter call-out\n\tattrs := &lifecycle.PodAdmitAttributes{Pod: pod, OtherPods: pods}\n\t// \u5982\u679c\u5f00\u542f\u539f\u5730\u66f4\u65b0\uff0c\u8fd8\u9700\u8981\u628a pod \u7684\u8d44\u6e90\u8fdb\u884c\u7528\u65b0\u6570\u636e\u66f4\u65b0\u4e00\u4e0b\u3002\n\tif utilfeature.DefaultFeatureGate.Enabled(features.InPlacePodVerticalScaling) {\n\t\t// Use allocated resources values from checkpoint store (source of truth) to determine fit\n\t\totherPods := make([]*v1.Pod, 0, len(pods))\n\t\tfor _, p := range pods {\n\t\t\top := p.DeepCopy()\n\t\t\tkl.updateContainerResourceAllocation(op)\n\n\t\t\totherPods = append(otherPods, op)\n\t\t}\n\t\tattrs.OtherPods = otherPods\n\t}\n\tfor _, podAdmitHandler := range kl.admitHandlers {\n\t\tif result := podAdmitHandler.Admit(attrs); !result.Admit {\n\n\t\t\tklog.InfoS("Pod admission denied", "podUID", attrs.Pod.UID, "pod", klog.KObj(attrs.Pod), "reason", result.Reason, "message", result.Message)\n\n\t\t\treturn false, result.Reason, result.Message\n\t\t}\n\t}\n\n\treturn true, "", ""\n}\n'})}),"\n",(0,d.jsx)(t.p,{children:(0,d.jsx)(t.img,{alt:"image.png",src:n(8731).A+"",width:"686",height:"976"})}),"\n",(0,d.jsxs)(t.p,{children:["\u800c ",(0,d.jsx)(t.code,{children:"kubelet"})," \u5bf9\u8c61\u7684 ",(0,d.jsx)(t.code,{children:"admitHandlers"})," \u662f\u5728\u5982\u4e0b ",(0,d.jsx)(t.code,{children:"NewMainKubelet"})," \u65b9\u6cd5\u4e2d\u6ce8\u518c\uff0c\u603b\u8ba1\u6ce8\u518c\u4e86\u516d\u4e2a ",(0,d.jsx)(t.code,{children:"Admit"})," ."]}),"\n",(0,d.jsxs)(t.ul,{children:["\n",(0,d.jsx)(t.li,{children:"Eviction Admit"}),"\n"]}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-go",children:"klet.admitHandlers.AddPodAdmitHandler(evictionAdmitHandler)\n"})}),"\n",(0,d.jsxs)(t.ul,{children:["\n",(0,d.jsx)(t.li,{children:"System Allowlist Admit"}),"\n"]}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-go",children:"klet.admitHandlers.AddPodAdmitHandler(sysctlsAllowlist)\n"})}),"\n",(0,d.jsxs)(t.ul,{children:["\n",(0,d.jsx)(t.li,{children:"Allocate Resources Admit"}),"\n"]}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-go",children:"klet.admitHandlers.AddPodAdmitHandler(klet.containerManager.GetAllocateResourcesPodAdmitHandler())\n"})}),"\n",(0,d.jsxs)(t.ul,{children:["\n",(0,d.jsx)(t.li,{children:"Predicate Admit"}),"\n"]}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-go",children:"klet.admitHandlers.AddPodAdmitHandler(lifecycle.NewPredicateAdmitHandler(klet.getNodeAnyWay, criticalPodAdmissionHandler, klet.containerManager.UpdatePluginResources))\n"})}),"\n",(0,d.jsxs)(t.ul,{children:["\n",(0,d.jsx)(t.li,{children:"AppArmor Admit"}),"\n"]}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-go",children:"klet.admitHandlers.AddPodAdmitHandler(lifecycle.NewAppArmorAdmitHandler(klet.appArmorValidator))\n"})}),"\n",(0,d.jsxs)(t.ul,{children:["\n",(0,d.jsx)(t.li,{children:"Shutdown Admit"}),"\n"]}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-go",children:"klet.admitHandlers.AddPodAdmitHandler(shutdownAdmitHandler)\n"})}),"\n",(0,d.jsx)(t.h3,{id:"admit-\u63a5\u53e3",children:"Admit \u63a5\u53e3"}),"\n",(0,d.jsxs)(t.p,{children:[(0,d.jsx)(t.code,{children:"Admit"})," \u8bc4\u4f30\u4e00\u4e2a ",(0,d.jsx)(t.code,{children:"pod"})," \u662f\u5426\u53ef\u4ee5\u88ab\u63a5\u7eb3\u3002"]}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-go",children:"type PodAdmitHandler interface {\n\tAdmit(attrs *PodAdmitAttributes) PodAdmitResult\n}\n"})}),"\n",(0,d.jsxs)(t.p,{children:[(0,d.jsx)(t.code,{children:"Admit"})," \u7684\u53c2\u6570\u7ed3\u6784\u5982\u4e0b\uff1a"]}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-go",children:"type PodAdmitAttributes struct {\n\t// \u5f53\u524d\u6b63\u5219\u8bc4\u4f30\u7684 Pod\n\tPod *v1.Pod\n\t// \u9664\u53bb\u8bc4\u4f30\u4e4b\u5916 kubelet \u63a5\u6536\u7684\u6240\u6709 Pod\n\tOtherPods []*v1.Pod\n}\n"})}),"\n",(0,d.jsxs)(t.p,{children:[(0,d.jsx)(t.code,{children:"Admit"}),"  \u7684\u8fd4\u56de\u503c\u5982\u4e0b\uff1a"]}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-go",children:"// PodAdmitResult provides the result of a pod admission decision.\ntype PodAdmitResult struct {\n\t// \u5982\u679ctrue\uff0c\u5219\u8bc4\u4f30\u901a\u8fc7\n\tAdmit bool\n\t// \u7b80\u77ed\u5730\u8bf4\u660e\u4e3a\u4ec0\u4e48\u8be5 Pod \u4e0d\u80fd\u88ab\u63a5\u7eb3.\n\tReason string\n\t// \u4e00\u6761\u7b80\u77ed\u6d88\u606f\uff0c\u89e3\u91ca\u4e3a\u4ec0\u4e48\u8be5 Pod \u65e0\u6cd5\u8fdb\u5165\n\tMessage string\n}\n"})}),"\n",(0,d.jsx)(t.h3,{id:"eviction-admit",children:"Eviction Admit"}),"\n",(0,d.jsxs)(t.p,{children:["\u5982\u679c\u4e3a\u4e86\u8282\u70b9\u7a33\u5b9a\u6027\u800c\u4e0d\u5141\u8bb8\u8fdb\u5165\uff0c\u5219 ",(0,d.jsx)(t.code,{children:"Admit"})," \u4f1a\u62d2\u7edd\u8be5 ",(0,d.jsx)(t.code,{children:"pod"}),"\u3002"]}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-go",children:"func (m *managerImpl) Admit(ctx context.Context, attrs *lifecycle.PodAdmitAttributes) lifecycle.PodAdmitResult {\n\tm.RLock()\n\tdefer m.RUnlock()\n\t// node \u6ca1\u6709 condition \u5c31\u76f4\u63a5\u901a\u8fc7\uff0c\u53ef\u4ee5\u4e0d\u7528\u5224\u5b9a Readay \u7684 Condition \u5417\uff1f\n\tif len(m.nodeConditions) == 0 {\n\t\treturn lifecycle.PodAdmitResult{Admit: true}\n\t}\n\t// \u5373\u4f7f\u5728\u8d44\u6e90\u538b\u529b\u4e0b\u4e5f\u8981\u63a5\u7eb3\u5173\u952e pod\uff0c\u56e0\u4e3a\u5b83\u4eec\u662f\u7cfb\u7edf\u7a33\u5b9a\u6027\u6240\u5fc5\u9700\u7684\u3002\n\t// \u5224\u5b9apod\u662f\u5426\u662fstatic pod\u3001\u9ad8\u4f18\u5148\u7ea7pod\uff0c\u9700\u8981 >= 2000000000\n\tif kubelettypes.IsCriticalPod(attrs.Pod) {\n\t\treturn lifecycle.PodAdmitResult{Admit: true}\n\t}\n\n\t// \u9664\u5185\u5b58\u538b\u529b\u4e4b\u5916\u7684\u5176\u4ed6\u6761\u4ef6\u4f1a\u62d2\u7edd\u6240\u6709 Pod\n\tnodeOnlyHasMemoryPressureCondition := hasNodeCondition(m.nodeConditions, v1.NodeMemoryPressure) && len(m.nodeConditions) == 1\n\tif nodeOnlyHasMemoryPressureCondition {\n\t\tnotBestEffort := v1.PodQOSBestEffort != v1qos.GetPodQOS(attrs.Pod)\n\t\tif notBestEffort {\n\t\t\treturn lifecycle.PodAdmitResult{Admit: true}\n\t\t}\n\n\t\t// When node has memory pressure, check BestEffort Pod's toleration:\n\t\t// admit it if tolerates memory pressure taint, fail for other tolerations, e.g. DiskPressure.\n\t\tif corev1helpers.TolerationsTolerateTaint(attrs.Pod.Spec.Tolerations, &v1.Taint{\n\t\t\tKey:    v1.TaintNodeMemoryPressure,\n\t\t\tEffect: v1.TaintEffectNoSchedule,\n\t\t}) {\n\t\t\treturn lifecycle.PodAdmitResult{Admit: true}\n\t\t}\n\t}\n\n\treturn lifecycle.PodAdmitResult{\n\t\tAdmit:   false,\n\t\tReason:  Reason,\n\t\tMessage: fmt.Sprintf(nodeConditionMessageFmt, m.nodeConditions),\n\t}\n}\n"})}),"\n",(0,d.jsx)(t.h3,{id:"system-allowlist-admit",children:"System Allowlist Admit"}),"\n",(0,d.jsxs)(t.p,{children:["\u4e3b\u8981\u662f\u770b\u7528\u6237\u5199\u7684 ",(0,d.jsx)(t.code,{children:"Sysctls"})," \u662f\u5426\u662f\u51c6\u5165\u7684\u64cd\u4f5c\uff1a"]}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-go",children:'func (w *patternAllowlist) Admit(_ context.Context, attrs *lifecycle.PodAdmitAttributes) lifecycle.PodAdmitResult {\n\tpod := attrs.Pod\n\t// \u5982\u679c\u6ca1\u6709\u8bbe\u7f6eSecurityContext \u6216\u8005 SecurityContext.Sysctls \u5b57\u6bb5\uff0c\u5219\u76f4\u63a5\u901a\u8fc7\n\tif pod.Spec.SecurityContext == nil || len(pod.Spec.SecurityContext.Sysctls) == 0 {\n\t\treturn lifecycle.PodAdmitResult{\n\t\t\tAdmit: true,\n\t\t}\n\t}\n\n\tfor _, s := range pod.Spec.SecurityContext.Sysctls {\n\t\tif err := w.validateSysctl(s.Name, pod.Spec.HostNetwork, pod.Spec.HostIPC); err != nil {\n\t\t\treturn lifecycle.PodAdmitResult{\n\t\t\t\tAdmit:   false,\n\t\t\t\tReason:  ForbiddenReason,\n\t\t\t\tMessage: fmt.Sprintf("forbidden sysctl: %v", err),\n\t\t\t}\n\t\t}\n\t}\n\n\treturn lifecycle.PodAdmitResult{\n\t\tAdmit: true,\n\t}\n}\n'})}),"\n",(0,d.jsxs)(t.p,{children:["\u8bbe\u7f6e\u7684\u56fa\u5b9a ",(0,d.jsx)(t.code,{children:"Sysctls"})," \u7684 ",(0,d.jsx)(t.code,{children:"Key"}),", \u6216\u8005\u4e5f\u53ef\u4ee5\u901a\u8fc7\u914d\u7f6e\u7684 ",(0,d.jsx)(t.code,{children:"prefix"})," \u6765\u8fdb\u884c\u5224\u5b9a\uff0c\u6bd4\u5982: ",(0,d.jsx)(t.code,{children:"net.ipv6.neigh.*"})," \u8fd9\u79cd\u3002"]}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-go",children:'var safeSysctls = []sysctl{\n\t{\n\t\tname: "kernel.shm_rmid_forced",\n\t}, {\n\t\tname: "net.ipv4.ip_local_port_range",\n\t}, {\n\t\tname: "net.ipv4.tcp_syncookies",\n\t}, {\n\t\tname: "net.ipv4.ping_group_range",\n\t}, {\n\t\tname: "net.ipv4.ip_unprivileged_port_start",\n\t}, {\n\t\tname:   "net.ipv4.ip_local_reserved_ports",\n\t\tkernel: utilkernel.IPLocalReservedPortsNamespacedKernelVersion,\n\t}, {\n\t\tname:   "net.ipv4.tcp_keepalive_time",\n\t\tkernel: utilkernel.TCPKeepAliveTimeNamespacedKernelVersion,\n\t}, {\n\t\tname:   "net.ipv4.tcp_fin_timeout",\n\t\tkernel: utilkernel.TCPFinTimeoutNamespacedKernelVersion,\n\t},\n\t{\n\t\tname:   "net.ipv4.tcp_keepalive_intvl",\n\t\tkernel: utilkernel.TCPKeepAliveIntervalNamespacedKernelVersion,\n\t},\n\t{\n\t\tname:   "net.ipv4.tcp_keepalive_probes",\n\t\tkernel: utilkernel.TCPKeepAliveProbesNamespacedKernelVersion,\n\t},\n}\n'})}),"\n",(0,d.jsx)(t.h3,{id:"allocate-resources-admit",children:"Allocate Resources Admit"}),"\n",(0,d.jsxs)(t.p,{children:["\u4e3b\u8981\u8fdb\u884c\u8d44\u6e90\u5206\u914d\u51c6\u5165\uff0c\u6bd4\u5982\u8bbe\u5907\u63d2\u4ef6\u3001cpu\u3001memory\u7b49\uff0c\u6838\u5fc3\u5b9e\u73b0\u5728 ",(0,d.jsx)(t.code,{children:"topologyManager"})," \u4e2d\uff1a"]}),"\n",(0,d.jsxs)(t.ul,{children:["\n",(0,d.jsxs)(t.li,{children:["\u6dfb\u52a0\u8bbe\u5907\u63d2\u4ef6 ",(0,d.jsx)(t.code,{children:"Allocate"})," \u51c6\u5165\u6821\u9a8c"]}),"\n"]}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-go",children:"cm.deviceManager, err = devicemanager.NewManagerImpl(machineInfo.Topology, cm.topologyManager, tp)\ncm.topologyManager.AddHintProvider(cm.deviceManager)\n"})}),"\n",(0,d.jsxs)(t.ul,{children:["\n",(0,d.jsxs)(t.li,{children:["\u6dfb\u52a0 ",(0,d.jsx)(t.code,{children:"CPU"})," \u51c6\u5165\u6821\u9a8c"]}),"\n"]}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-go",children:"cm.cpuManager, err = cpumanager.NewManager(\n\t\tnodeConfig.CPUManagerPolicy,\n\t\tnodeConfig.CPUManagerPolicyOptions,\n\t\tnodeConfig.CPUManagerReconcilePeriod,\n\t\tmachineInfo,\n\t\tnodeConfig.NodeAllocatableConfig.ReservedSystemCPUs,\n\t\tcm.GetNodeAllocatableReservation(),\n\t\tnodeConfig.KubeletRootDir,\n\t\tcm.topologyManager,\n\t)\n\tcm.topologyManager.AddHintProvider(cm.cpuManager)\n"})}),"\n",(0,d.jsxs)(t.ul,{children:["\n",(0,d.jsxs)(t.li,{children:["\u6dfb\u52a0 ",(0,d.jsx)(t.code,{children:"Memory"})," \u51c6\u5165\u6821\u9a8c"]}),"\n"]}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-go",children:"cm.memoryManager, err = memorymanager.NewManager(\n\t\t\tnodeConfig.ExperimentalMemoryManagerPolicy,\n\t\t\tmachineInfo,\n\t\t\tcm.GetNodeAllocatableReservation(),\n\t\t\tnodeConfig.ExperimentalMemoryManagerReservedMemory,\n\t\t\tnodeConfig.KubeletRootDir,\n\t\t\tcm.topologyManager,\n\t\t)\n\t\tcm.topologyManager.AddHintProvider(cm.memoryManager)\n"})}),"\n",(0,d.jsxs)(t.p,{children:["\u56e0\u4e3a ",(0,d.jsx)(t.code,{children:"topologyManager"})," \u6709\u4e09\u79cd ",(0,d.jsx)(t.code,{children:"topology"})," \u7b56\u7565\u914d\u7f6e, \u5206\u522b\u662f ",(0,d.jsx)(t.code,{children:"none"})," ",(0,d.jsx)(t.code,{children:"pod"})," ",(0,d.jsx)(t.code,{children:"container"})," . \u6b64\u5904\u8fd9\u91cc\u5c31\u4e0d\u5c55\u5f00\u8bb2\uff0c\u6211\u4eec\u9ed8\u8ba4\u6309\u7167 ",(0,d.jsx)(t.code,{children:"none"})," \u7684\u7ef4\u5ea6\u6765\u8ba8\u8bba\u3002"]}),"\n",(0,d.jsxs)(t.p,{children:["\u6bcf\u4e2a\u5bb9\u5668\uff08initContainer \u548c containers \uff09\u6bcf\u4e2a\u90fd\u9700\u8981\u8fdb\u884c\u8d44\u6e90\u51c6\u5165\u6821\u9a8c\uff0c\u6bcf\u4e2a\u5bb9\u5668\u90fd\u9700\u8981\u6700\u5c11\u8fdb\u884c ",(0,d.jsx)(t.code,{children:"cpu"})," \u548c ",(0,d.jsx)(t.code,{children:"memory"})," \u6821\u9a8c\uff0c\u5982\u679c\u8fd8\u6d89\u53ca\u5230 ",(0,d.jsx)(t.code,{children:"device-plugin"})," \u7684\u8bdd\u4e5f\u9700\u8981\u6821\u9a8c\u3002"]}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-go",children:"func (s *scope) allocateAlignedResources(ctx context.Context, pod *v1.Pod, container *v1.Container) error {\n\tfor _, provider := range s.hintProviders {\n\t\terr := provider.Allocate(ctx, pod, container)\n\t\tif err != nil {\n\t\t\treturn err\n\t\t}\n\t}\n\treturn nil\n}\n"})}),"\n",(0,d.jsx)(t.p,{children:"\u8fd9\u91cc\u6d89\u53ca\u5230\u7684\u5177\u4f53\u6bcf\u4e2a\u8d44\u6e90\u5206\u914d\u6821\u9a8c\u5c31\u4e0d\u518d\u8fdb\u884c\u5c55\u5f00\uff0c\u6838\u5fc3\u5c31\u662f\u770b\u7528\u6237\u8bf7\u6c42\u7684\u8d44\u6e90\u80fd\u4e0d\u80fd\u5206\u914d\u6210\u529f\uff0c\u5982\u679c\u5206\u914d\u5931\u8d25\u5c31\u4f1a\u62d2\u7edd\uff1b"}),"\n",(0,d.jsxs)(t.p,{children:["\u5f97\u51fa\u4e00\u4e2a\u7ed3\u8bba ",(0,d.jsx)(t.code,{children:"Pod"})," \u7684\u8d44\u6e90\u5206\u914d\u662f\u5728 ",(0,d.jsx)(t.code,{children:"kubelet"})," \u63a5\u6536\u5230\u4e4b\u540e\u8fdb\u5165 ",(0,d.jsx)(t.code,{children:"syncLoopIteration"})," \u4e4b\u540e\u5c31\u4f1a\u540c\u6b65\u8fdb\u884c\u5206\u914d\uff0c\u5176\u6b21\u5728 ",(0,d.jsx)(t.code,{children:"syncPod"})," \u7684\u5904\u7406\u903b\u8f91\u4e2d\u4f1a\u6709\u4e00\u6b21\u8865\u507f\u673a\u5236\u3002"]}),"\n",(0,d.jsx)(t.h3,{id:"predicate-admit",children:"Predicate Admit"}),"\n",(0,d.jsxs)(t.p,{children:["\u9884\u9009 ",(0,d.jsx)(t.code,{children:"Admit"})," \uff0c\u4e3b\u8981\u518d\u6b21\u5224\u5b9a\u8c03\u5ea6\u5668\u9884\u9009\u7684\u6570\u636e\u662f\u5426\u6ee1\u8db3\u3002"]}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-go",children:'func (w *predicateAdmitHandler) Admit(_ context.Context, attrs *PodAdmitAttributes) PodAdmitResult {\n\tnode, err := w.getNodeAnyWayFunc()\n\tif err != nil {\n\t\tklog.ErrorS(err, "Cannot get Node info")\n\t\treturn PodAdmitResult{\n\t\t\tAdmit:   false,\n\t\t\tReason:  "InvalidNodeInfo",\n\t\t\tMessage: "Kubelet cannot get node info.",\n\t\t}\n\t}\n\tadmitPod := attrs.Pod\n\n\t// node select \u76f8\u5173\u7684\u8fd9\u4e9blabel\uff0c\u8fdb\u884c\u5224\u5b9a\u662f\u5426\u6ee1\u8db3\uff0c\u5982\u679c\u4e0d\u6ee1\u8db3\uff0c\u5c31\u8fdb\u884c\u62d2\u7edd\u3002\n\tif rejectPodAdmissionBasedOnOSSelector(admitPod, node)\n\t// \u5224\u5b9a pod.Spec.OS.Name \u8fd9\u4e2a\u5b57\u6bb5\u662f\u5426\u6ee1\u8db3\u8981\u6c42\n\tif rejectPodAdmissionBasedOnOSField(admitPod)\n\n\tpods := attrs.OtherPods\n\tnodeInfo := schedulerframework.NewNodeInfo(pods...)\n\tnodeInfo.SetNode(node)\n\n\t// TODO: Remove this after the SidecarContainers feature gate graduates to GA.\n\tif !utilfeature.DefaultFeatureGate.Enabled(features.SidecarContainers) {\n\t  // \u5982\u679c\u6ca1\u6709\u5f00\u542fSidecar\u5bb9\u5668\uff0c\u5c31\u68c0\u67e5init\u5bb9\u5668\u7684\u91cd\u542f\u7b56\u7565\u662f\u5426\u8bbe\u7f6e\n\t\tfor _, c := range admitPod.Spec.InitContainers {\n\t\t\tif types.IsRestartableInitContainer(&c) {\n\t\t\t\tmessage := fmt.Sprintf("Init container %q may not have a non-default restartPolicy", c.Name)\n\t\t\t\tklog.InfoS("Failed to admit pod", "pod", klog.KObj(admitPod), "message", message)\n\t\t\t\treturn PodAdmitResult{\n\t\t\t\t\tAdmit:   false,\n\t\t\t\t\tReason:  "InitContainerRestartPolicyForbidden",\n\t\t\t\t\tMessage: message,\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t// \u786e\u4fdd\u8282\u70b9\u5177\u6709\u8db3\u591f\u7684\u63d2\u4ef6\u8d44\u6e90\uff0c\u4ee5\u6ee1\u8db3 Pod \u6240\u9700\u7684\u8d44\u6e90\n\tif err = w.pluginResourceUpdateFunc(nodeInfo, attrs); err != nil {\n\t\tmessage := fmt.Sprintf("Update plugin resources failed due to %v, which is unexpected.", err)\n\t\tklog.InfoS("Failed to admit pod", "pod", klog.KObj(admitPod), "message", message)\n\t\treturn PodAdmitResult{\n\t\t\tAdmit:   false,\n\t\t\tReason:  "UnexpectedAdmissionError",\n\t\t\tMessage: message,\n\t\t}\n\t}\n\n\t// Remove the requests of the extended resources that are missing in the\n\t// node info. This is required to support cluster-level resources, which\n\t// are extended resources unknown to nodes.\n\t//\n\t// Caveat: If a pod was manually bound to a node (e.g., static pod) where a\n\t// node-level extended resource it requires is not found, then kubelet will\n\t// not fail admission while it should. This issue will be addressed with\n\t// the Resource Class API in the future.\n\tpodWithoutMissingExtendedResources := removeMissingExtendedResources(admitPod, nodeInfo)\n\n\treasons := generalFilter(podWithoutMissingExtendedResources, nodeInfo)\n\tfit := len(reasons) == 0\n\tif !fit {\n\t\treasons, err = w.admissionFailureHandler.HandleAdmissionFailure(admitPod, reasons)\n\t\tfit = len(reasons) == 0 && err == nil\n\t\tif err != nil {\n\t\t\tmessage := fmt.Sprintf("Unexpected error while attempting to recover from admission failure: %v", err)\n\t\t\tklog.InfoS("Failed to admit pod, unexpected error while attempting to recover from admission failure", "pod", klog.KObj(admitPod), "err", err)\n\t\t\treturn PodAdmitResult{\n\t\t\t\tAdmit:   fit,\n\t\t\t\tReason:  "UnexpectedAdmissionError",\n\t\t\t\tMessage: message,\n\t\t\t}\n\t\t}\n\t}\n\tif !fit {\n\t\tvar reason string\n\t\tvar message string\n\t\tif len(reasons) == 0 {\n\t\t\tmessage = fmt.Sprint("GeneralPredicates failed due to unknown reason, which is unexpected.")\n\t\t\tklog.InfoS("Failed to admit pod: GeneralPredicates failed due to unknown reason, which is unexpected", "pod", klog.KObj(admitPod))\n\t\t\treturn PodAdmitResult{\n\t\t\t\tAdmit:   fit,\n\t\t\t\tReason:  "UnknownReason",\n\t\t\t\tMessage: message,\n\t\t\t}\n\t\t}\n\t\t// If there are failed predicates, we only return the first one as a reason.\n\t\tr := reasons[0]\n\t\tswitch re := r.(type) {\n\t\tcase *PredicateFailureError:\n\t\t\treason = re.PredicateName\n\t\t\tmessage = re.Error()\n\t\t\tklog.V(2).InfoS("Predicate failed on Pod", "pod", klog.KObj(admitPod), "err", message)\n\t\tcase *InsufficientResourceError:\n\t\t\treason = fmt.Sprintf("OutOf%s", re.ResourceName)\n\t\t\tmessage = re.Error()\n\t\t\tklog.V(2).InfoS("Predicate failed on Pod", "pod", klog.KObj(admitPod), "err", message)\n\t\tdefault:\n\t\t\treason = "UnexpectedPredicateFailureType"\n\t\t\tmessage = fmt.Sprintf("GeneralPredicates failed due to %v, which is unexpected.", r)\n\t\t\tklog.InfoS("Failed to admit pod", "pod", klog.KObj(admitPod), "err", message)\n\t\t}\n\t\treturn PodAdmitResult{\n\t\t\tAdmit:   fit,\n\t\t\tReason:  reason,\n\t\t\tMessage: message,\n\t\t}\n\t}\n\treturn PodAdmitResult{\n\t\tAdmit: true,\n\t}\n}\n'})}),"\n",(0,d.jsx)(t.h3,{id:"apparmor-admit",children:"AppArmor Admit"}),"\n",(0,d.jsx)(t.p,{children:"AppArmor \u662f Linux \u5185\u6838\u5b89\u5168\u6a21\u5757\uff0c\u5141\u8bb8\u7cfb\u7edf\u7ba1\u7406\u5458\u901a\u8fc7\u6bcf\u4e2a\u7a0b\u5e8f\u7684\u914d\u7f6e\u6587\u4ef6\u9650\u5236\u7a0b\u5e8f\u7684\u529f\u80fd\u3002"}),"\n",(0,d.jsxs)(t.p,{children:["\u5982\u679c\u662f ",(0,d.jsx)(t.code,{children:"Linux"})," \u64cd\u4f5c\u7cfb\u7edf\uff0c\u5219\u9700\u8981\u8fdb\u884c\u51c6\u5165\u6821\u9a8c"]}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-go",children:'func (a *appArmorAdmitHandler) Admit(_ context.Context, attrs *PodAdmitAttributes) PodAdmitResult {\n\t// \u5982\u679cpod\u662f running or terminated, \u5219\u4e0d\u9700\u8981\u5224\u5b9a\u3002\n\tif attrs.Pod.Status.Phase != v1.PodPending {\n\t\treturn PodAdmitResult{Admit: true}\n\t}\n\n\terr := a.Validate(attrs.Pod)\n\tif err == nil {\n\t\treturn PodAdmitResult{Admit: true}\n\t}\n\treturn PodAdmitResult{\n\t\tAdmit:   false,\n\t\tReason:  "AppArmor",\n\t\tMessage: fmt.Sprintf("Cannot enforce AppArmor: %v", err),\n\t}\n}\n'})}),"\n",(0,d.jsx)(t.h3,{id:"shutdown-admit",children:"Shutdown Admit"}),"\n",(0,d.jsxs)(t.p,{children:["\u8282\u70b9\u505c\u673a\u7ba1\u7406\uff0c\u5982\u679c ",(0,d.jsx)(t.code,{children:"node"})," \u5df2\u7ecf ",(0,d.jsx)(t.code,{children:"shutdown"})," \u5219\u62d2\u7edd\u6240\u6709\u7684 ",(0,d.jsx)(t.code,{children:"Pod"}),"."]}),"\n",(0,d.jsx)(t.pre,{children:(0,d.jsx)(t.code,{className:"language-go",children:"func (m *managerImpl) Admit(ctx context.Context, attrs *lifecycle.PodAdmitAttributes) lifecycle.PodAdmitResult {\n\tnodeShuttingDown := m.ShutdownStatus() != nil\n\n\tif nodeShuttingDown {\n\t\treturn lifecycle.PodAdmitResult{\n\t\t\tAdmit:   false,\n\t\t\tReason:  nodeShutdownNotAdmittedReason,\n\t\t\tMessage: nodeShutdownNotAdmittedMessage,\n\t\t}\n\t}\n\treturn lifecycle.PodAdmitResult{Admit: true}\n}\n"})})]})}function m(e={}){const{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,d.jsx)(t,{...e,children:(0,d.jsx)(c,{...e})}):c(e)}},8731:(e,t,n)=>{n.d(t,{A:()=>d});const d=n.p+"assets/images/pod-admit-dfdaffa7a2853d42eeb146a2cd2ad0ce.png"},8453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>s});var d=n(6540);const o={},r=d.createContext(o);function i(e){const t=d.useContext(r);return d.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),d.createElement(r.Provider,{value:t},e.children)}}}]);