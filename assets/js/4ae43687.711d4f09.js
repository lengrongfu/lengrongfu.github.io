"use strict";(self.webpackChunkblogs=self.webpackChunkblogs||[]).push([[6893],{7655:(e,n,c)=>{c.r(n),c.d(n,{assets:()=>s,contentTitle:()=>d,default:()=>h,frontMatter:()=>t,metadata:()=>l,toc:()=>o});var i=c(4848),r=c(8453);const t={slug:"kubelet-devicemanage",title:"kubelet \u6e90\u7801\u5206\u6790 devicemanager",authors:["rongfu"],tags:["Kubernetes","Kubelet"]},d=void 0,l={permalink:"/blog/kubelet-devicemanage",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/2024-09-05-kubelet-devicemanager.md",source:"@site/blog/2024-09-05-kubelet-devicemanager.md",title:"kubelet \u6e90\u7801\u5206\u6790 devicemanager",description:"device-plugin  \u662f Kubernetes \u7528\u6765\u6269\u5c55\u9664 CPU Memory  \u4e4b\u5916\u7684\u786c\u4ef6\u8bbe\u5907\uff0c\u6bd4\u5982\u5e38\u89c1\u7684 Nvidia GPU .",date:"2024-09-05T00:00:00.000Z",tags:[{inline:!1,label:"Kubernetes",permalink:"/blog/tags/kubernetes",description:"kubernetes"},{inline:!1,label:"Kubelet",permalink:"/blog/tags/Kubelet",description:"Kubelet"}],readingTime:4.26,hasTruncateMarker:!0,authors:[{name:"Leng",title:"Softwore Developer",url:"https://github.com/lengrongfu",image_hrl:"https://avatars.githubusercontent.com/u/15009201?v=4",socials:{github:"https://github.com/lengrongfu"},key:"rongfu",page:null}],frontMatter:{slug:"kubelet-devicemanage",title:"kubelet \u6e90\u7801\u5206\u6790 devicemanager",authors:["rongfu"],tags:["Kubernetes","Kubelet"]},unlisted:!1,nextItem:{title:"Kubelet\u6e90\u7801\u5206\u6790 Configmap/Secret volume",permalink:"/blog/kubelet-configmap"}},s={authorsImageUrls:[void 0]},o=[{value:"kubelet \u8c03\u7528\u6d41\u7a0b",id:"kubelet-\u8c03\u7528\u6d41\u7a0b",level:2},{value:"ListAndWatch",id:"listandwatch",level:3},{value:"Allocate",id:"allocate",level:3},{value:"GetDevicePluginOption",id:"getdevicepluginoption",level:3},{value:"PreStartContainer",id:"prestartcontainer",level:3},{value:"GetPreferredAllocation",id:"getpreferredallocation",level:3}];function a(e){const n={code:"code",h2:"h2",h3:"h3",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"device-plugin"}),"  \u662f ",(0,i.jsx)(n.code,{children:"Kubernetes"})," \u7528\u6765\u6269\u5c55\u9664 ",(0,i.jsx)(n.code,{children:"CPU"})," ",(0,i.jsx)(n.code,{children:"Memory"}),"  \u4e4b\u5916\u7684\u786c\u4ef6\u8bbe\u5907\uff0c\u6bd4\u5982\u5e38\u89c1\u7684 ",(0,i.jsx)(n.code,{children:"Nvidia GPU"})," ."]}),"\n",(0,i.jsxs)(n.p,{children:["\u4e0b\u9762\u4e3b\u8981\u6765\u5206\u6790\u4e00\u4e0b\u5728 ",(0,i.jsx)(n.code,{children:"Kubelet"})," \u4e2d\u662f\u5982\u4f55\u8c03\u7528 ",(0,i.jsx)(n.code,{children:"device-plugin"})," \u7684\uff0c\u4ee5\u53ca\u5982\u4f55\u751f\u6210 ",(0,i.jsx)(n.code,{children:"OCI Spec"})," \u5185\u5bb9\u3002"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"device-plugin"})," \u4e5f\u5b58\u5728\u4e00\u4e9b\u9650\u5236\uff0c\u56e0\u4e3a\u5b83\u4e0d\u611f\u77e5 ",(0,i.jsx)(n.code,{children:"Pod"})," \u548c ",(0,i.jsx)(n.code,{children:"Container"})," \uff0c\u5c31\u5bfc\u81f4\u6ca1\u529e\u6cd5\u505a\u4e00\u4e9b\u52a8\u6001\u7684\u8d44\u6e90\u5206\u914d\uff0c\u6bd4\u5982\u6839\u636e\u7528\u6237\u8bbe\u7f6e\u9009\u7528\u67d0\u4e2a ",(0,i.jsx)(n.code,{children:"GPU"})," \u578b\u53f7\u6216\u8005\u662f\u6307\u5b9a\u4f7f\u7528\u67d0\u4e2a\u8bbe\u5907\u7684 ",(0,i.jsx)(n.code,{children:"UUID"})," \uff1b\u76ee\u524d\u793e\u533a\u4e3b\u8981\u662f\u5728\u63a8\u8fdb ",(0,i.jsx)(n.code,{children:"DRA"})," \u6765\u89e3\u51b3\u8fd9\u4e9b\u95ee\u9898\u3002"]}),"\n",(0,i.jsx)(n.h2,{id:"kubelet-\u8c03\u7528\u6d41\u7a0b",children:"kubelet \u8c03\u7528\u6d41\u7a0b"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"device plugin"})," \u7684\u5de5\u4f5c\u539f\u7406\u5176\u5b9e\u4e0d\u590d\u6742\u3002\u4e3b\u8981\u6709\u4ee5\u4e0b\u6b65\u9aa4\uff1a"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u9996\u5148 ",(0,i.jsx)(n.code,{children:"device plugin"})," \u53ef\u4ee5\u901a\u8fc7 ",(0,i.jsx)(n.code,{children:"daemonset"})," \u90e8\u7f72\u5230\u9700\u8981\u7684\u8282\u70b9\u4e0a\u3002"]}),"\n",(0,i.jsxs)(n.li,{children:["\u4e3a\u4e86\u8ba9 ",(0,i.jsx)(n.code,{children:"Kubernetes"})," \u53d1\u73b0 ",(0,i.jsx)(n.code,{children:"device plugin"}),"\uff0c\u9700\u8981\u5411 ",(0,i.jsx)(n.code,{children:"kubelet"})," \u7684 ",(0,i.jsx)(n.code,{children:"unix socket"}),"\u3002 \u8fdb\u884c\u6ce8\u518c\uff0c\u6ce8\u518c\u7684\u4fe1\u606f\u5305\u62ec ",(0,i.jsx)(n.code,{children:"device plugin"})," \u7684 ",(0,i.jsx)(n.code,{children:"unix socket"})," ",(0,i.jsx)(n.code,{children:"API Version"})," ",(0,i.jsx)(n.code,{children:"ResourceName"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"kubelet"})," \u901a\u8fc7 ",(0,i.jsx)(n.code,{children:"grpc"})," \u5411 ",(0,i.jsx)(n.code,{children:"device plugin"})," \u8c03\u7528 ",(0,i.jsx)(n.code,{children:"ListAndWatch"}),"\uff0c \u83b7\u53d6\u5f53\u524d\u8282\u70b9\u4e0a\u7684\u8d44\u6e90\u3002"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"kubelet"})," \u5411 ",(0,i.jsx)(n.code,{children:"api server"})," \u66f4\u65b0\u8282\u70b9\u72b6\u6001\u6765\u901a\u77e5\u8d44\u6e90\u53d8\u66f4\u3002"]}),"\n",(0,i.jsxs)(n.li,{children:["\u7528\u6237\u521b\u5efa ",(0,i.jsx)(n.code,{children:"pod"}),"\uff0c\u8bf7\u6c42\u8d44\u6e90\u5e76\u8c03\u5ea6\u5230\u8282\u70b9\u4e0a\u540e, ",(0,i.jsx)(n.code,{children:"kubelet"})," \u8c03\u7528 ",(0,i.jsx)(n.code,{children:"device plugin"})," \u7684 ",(0,i.jsx)(n.code,{children:"Allocate"})," \u8fdb\u884c\u8d44\u6e90\u5206\u914d\u3002"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u65f6\u5e8f\u56fe\u5982\u4e0b:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"image.png",src:c(41).A+"",width:"1442",height:"578"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"device-plugin"})," \u6e90\u7801\u6a21\u5757\u5728 ",(0,i.jsx)(n.code,{children:"pkg/kubelet/cm/devicemanager"})," \u76ee\u5f55\u4e0b\uff0c\u662f ",(0,i.jsx)(n.code,{children:"ContainerManager"})," \u6a21\u5757\u7684\u4e00\u90e8\u5206\uff0c\u4e3b\u8981\u662f\u7528\u6765\u5728\u521b\u5efa ",(0,i.jsx)(n.code,{children:"Container"})," \u8fc7\u7a0b\u4e2d\uff0c\u751f\u6210 ",(0,i.jsx)(n.code,{children:"OCI Spec"})," \u5185\u5bb9\u7684\u3002"]}),"\n",(0,i.jsx)(n.p,{children:"\u4e0b\u9762\u6309\u7167\u4e24\u4e2a\u6d41\u7a0b\u6765\u8bb2\u89e3\u6e90\u7801\uff0c\u4e00\u4e2a\u662f\u6ce8\u518c\u6d41\u7a0b\u548c\u83b7\u53d6\u8282\u70b9\u8bbe\u5907\uff0c\u8fd8\u6709\u4e00\u4e2a\u662f\u5206\u914d\u6d41\u7a0b\uff1b"}),"\n",(0,i.jsx)(n.p,{children:"\u6ce8\u518c\u548c\u83b7\u53d6\u53ef\u7528\u8bbe\u5907\u6d41\u7a0b\uff1a"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"https://firebasestorage.googleapis.com/v0/b/notiondiagram.appspot.com/o/diagram%2Fm5smUNzLG7NDZmSPY82qhFvWnsu1%2F0d36a640-61c1-4773-ab12-29c5ff176a94.svg?alt=media&token=c5d24a2f-911c-4fc3-b73a-d11a700438fa",alt:""})}),"\n",(0,i.jsx)(n.p,{children:"\u8d44\u6e90\u5206\u914d\u6d41\u7a0b"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"https://firebasestorage.googleapis.com/v0/b/notiondiagram.appspot.com/o/diagram%2Fm5smUNzLG7NDZmSPY82qhFvWnsu1%2F411db6c6-133a-4029-a3f2-913498df5331.svg?alt=media&token=7a942296-b51f-40e9-aa16-91b8cbe537e3",alt:""})}),"\n",(0,i.jsxs)(n.p,{children:["\u4ece ",(0,i.jsx)(n.code,{children:"ContainerManager"})," \u7684 ",(0,i.jsx)(n.code,{children:"GetResources"})," \u65b9\u6cd5\u8fdb\u5165 ",(0,i.jsx)(n.code,{children:"devicemanager"})," \u6a21\u5757\u4e2d\uff0c\u5f00\u59cb\u83b7\u53d6\u5206\u914d\u7684\u8bbe\u5907\uff0c\u6700\u540e\u8fd4\u56de\u4e00\u4e2a ",(0,i.jsx)(n.code,{children:"DeviceRunContainerOptions"})," \u5bf9\u8c61\uff1a"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type DeviceRunContainerOptions struct {\n\t// The environment variables list.\n\tEnvs []kubecontainer.EnvVar\n\t// The mounts for the container.\n\tMounts []kubecontainer.Mount\n\t// The host devices mapped into the container.\n\tDevices []kubecontainer.DeviceInfo\n\t// The Annotations for the container\n\tAnnotations []kubecontainer.Annotation\n\t// CDI Devices for the container\n\tCDIDevices []kubecontainer.CDIDevice\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u5982\u679c\u542f\u7528\u4e86 ",(0,i.jsx)(n.code,{children:"CDI"})," \u5219 ",(0,i.jsx)(n.code,{children:"CDIDevices"})," \u8fd9\u4e2a\u5b57\u6bb5\u975e\u7a7a\uff0c\u6b64\u65f6\u9700\u8981\u6302\u8f7d\u54ea\u4e9b\u8bbe\u5907\u5c31\u9700\u8981\u7b49\u5bb9\u5668\u8fd0\u884c\u65f6\u89e3\u6790 ",(0,i.jsx)(n.code,{children:"CDI"})," \u6587\u4ef6\u7136\u540e ",(0,i.jsx)(n.code,{children:"Merge"})," \u5230 ",(0,i.jsx)(n.code,{children:"OCI Spec"})," \u6587\u4ef6\u4e2d\u4e86\u3002"]}),"\n",(0,i.jsx)(n.p,{children:"\u4e0b\u9762\u4e3b\u8981\u8bb2\u4e00\u4e0b\u51e0\u4e2a\u51fd\u6570\u7684\u5b9e\u73b0\u903b\u8f91\uff1b"}),"\n",(0,i.jsx)(n.h3,{id:"listandwatch",children:"ListAndWatch"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"ListAndWatch"})," \u4e3b\u8981\u5728\u542f\u52a8\u7684\u65f6\u5019\u53d1\u9001 ",(0,i.jsx)(n.code,{children:"Send"})," \u4e00\u6b21\u8bbe\u5907\uff0c\u4e4b\u540e\u8fdb\u5165\u76d1\u542c\u672c\u5730\u8bbe\u5907\u7684\u73af\u8282\uff0c\u5982\u679c\u51fa\u73b0\u8bbe\u5907\u4e0d\u5065\u5eb7\uff0c\u5219\u91cd\u65b0 ",(0,i.jsx)(n.code,{children:"Send"})," \u6240\u6709\u5065\u5eb7\u7684\u8bbe\u5907\u3002"]}),"\n",(0,i.jsx)(n.h3,{id:"allocate",children:"Allocate"}),"\n",(0,i.jsxs)(n.p,{children:["\u5728\u7528\u6237\u521b\u5efa\u7684 ",(0,i.jsx)(n.code,{children:"Pod"})," \u8bf7\u6c42\u8d44\u6e90\u65f6\uff0c",(0,i.jsx)(n.code,{children:"Kubernetes"})," \u7684\u8c03\u5ea6\u5668\u4f1a\u8fdb\u884c\u8c03\u5ea6\uff0c\u5e76\u901a\u8fc7 ",(0,i.jsx)(n.code,{children:"kubelet"})," \u5411 ",(0,i.jsx)(n.code,{children:"device plugin"})," \u53d1\u51fa ",(0,i.jsx)(n.code,{children:"Allocate"})," \u8c03\u7528\uff0c\u8fd9\u4e00\u6b65\u7684\u8c03\u7528\u4e3b\u8981\u662f\u4e3a\u4e86\u8ba9 ",(0,i.jsx)(n.code,{children:"device plugin"})," \u4e3a\u5bb9\u5668\u8c03\u5ea6\u8d44\u6e90\u3002 \u5728\u8c03\u5ea6\u6210\u529f\u540e\u5411 ",(0,i.jsx)(n.code,{children:"kubelet"})," \u8fd4\u56de\u8c03\u5ea6\u7ed3\u679c\u5373\u53ef\u3002"]}),"\n",(0,i.jsx)(n.h3,{id:"getdevicepluginoption",children:"GetDevicePluginOption"}),"\n",(0,i.jsxs)(n.p,{children:["\u4e3b\u8981\u8fd4\u56de\u4e0e ",(0,i.jsx)(n.code,{children:"Device Manager"})," \u901a\u4fe1\u7684\u4e00\u4e9b\u53ef\u9009\u53c2\u6570\u8bbe\u7f6e\uff0c\u4e3b\u8981\u8fd4\u56de\u5982\u4e0b\u7ed3\u6784\uff1a"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-go",children:"type DevicePluginOptions struct {\n    // \u6bcf\u4e2a\u5bb9\u5668\u542f\u52a8\u524d\u662f\u5426\u9700\u8981\u8c03\u7528 PreStartContainer\n    PreStartRequired bool\n    // GetPreferredAllocationAvailable: \u662f\u5426\u63d0\u4f9b\u4f18\u9009\u65b9\u6cd5\n    GetPreferredAllocationAvailable bool\n}\n"})}),"\n",(0,i.jsx)(n.h3,{id:"prestartcontainer",children:"PreStartContainer"}),"\n",(0,i.jsxs)(n.p,{children:["\u5982\u679c\u8bbe\u5907\u63d2\u4ef6\u5728\u6ce8\u518c\u9636\u6bb5\u8bbe\u7f6e ",(0,i.jsx)(n.code,{children:"PreStartRequired=true"})," \u4e86\u8981\u8c03\u7528\uff0c\u5219\u5728\u6bcf\u4e2a\u5bb9\u5668\u542f\u52a8\u4e4b\u524d\u8c03\u7528 ",(0,i.jsx)(n.code,{children:"PreStartContainer"}),"\u3002 \u8bbe\u5907\u63d2\u4ef6\u53ef\u4ee5\u8fd0\u884c\u8bbe\u5907\u7279\u5b9a\u7684\u64cd\u4f5c\uff0c\u4f8b\u5982\u5728\u4f7f\u8bbe\u5907\u53ef\u4f9b\u5bb9\u5668\u4f7f\u7528\u4e4b\u524d\u91cd\u7f6e\u8bbe\u5907\u3002"]}),"\n",(0,i.jsx)(n.h3,{id:"getpreferredallocation",children:"GetPreferredAllocation"}),"\n",(0,i.jsxs)(n.p,{children:["\u5982\u679c\u8bbe\u5907\u63d2\u4ef6\u5728\u6ce8\u518c\u9636\u6bb5\u8bbe\u7f6e ",(0,i.jsx)(n.code,{children:"PreStartRequired=true"})," \u4e86\u8981\u8c03\u7528\uff0c\u53ef\u4ee5\u9488\u5bf9\u6307\u5b9a\u7684\u8bbe\u5907\u5217\u8868\u505a\u4e8c\u6b21\u6700\u4f18\u5206\u914d\u3002"]}),"\n",(0,i.jsxs)(n.p,{children:["\u5b98\u65b9\u7684 ",(0,i.jsx)(n.code,{children:"nvidia-device-plugin"})," \u5728 ",(0,i.jsx)(n.code,{children:"GetPreferredAllocation"})," \u5185\u90e8\u5b9e\u73b0\u4e86\u8282\u70b9\u5185\u591a\u5361\u6700\u4f18\u9009\u62e9\u7684\u903b\u8f91\uff0c\u901a\u8fc7\u786e\u5b9a\u591a\u5361\u4e4b\u95f4\u7684\u62d3\u6251\u4fe1\u606f\u6765\u51b3\u5b9a\u901a\u4fe1\u91cf\u3002"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},41:(e,n,c)=>{c.d(n,{A:()=>i});const i=c.p+"assets/images/image-e526919fba362e3d08f171b6b4fc3672.png"},8453:(e,n,c)=>{c.d(n,{R:()=>d,x:()=>l});var i=c(6540);const r={},t=i.createContext(r);function d(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:d(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);