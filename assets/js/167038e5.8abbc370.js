"use strict";(self.webpackChunkblogs=self.webpackChunkblogs||[]).push([[6200],{5825:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>a,contentTitle:()=>l,default:()=>p,frontMatter:()=>s,metadata:()=>i,toc:()=>o});var t=n(4848),c=n(8453);const s={slug:"gRPC \u5b66\u4e60\u4e4b-\u9ad8\u7ea7\u77e5\u8bc6",title:"gRPC \u5b66\u4e60\u4e4b-\u9ad8\u7ea7\u77e5\u8bc6",authors:["rongfu"],tags:["gRPC"]},l=void 0,i={permalink:"/blog/gRPC \u5b66\u4e60\u4e4b-\u9ad8\u7ea7\u77e5\u8bc6",editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/blog/2022-01-01 gRPC \u5b66\u4e60\u4e4b\u9ad8\u7ea7\u77e5\u8bc6.md",source:"@site/blog/2022-01-01 gRPC \u5b66\u4e60\u4e4b\u9ad8\u7ea7\u77e5\u8bc6.md",title:"gRPC \u5b66\u4e60\u4e4b-\u9ad8\u7ea7\u77e5\u8bc6",description:"gRPC \u5b66\u4e60\u901a\u4fe1\u57fa\u7840",date:"2022-01-01T00:00:00.000Z",tags:[{inline:!1,label:"golang",permalink:"/blog/tags/gRPC",description:"gRPC"}],readingTime:5.69,hasTruncateMarker:!0,authors:[{name:"Leng Student",title:"Softwore Developer",url:"https://github.com/lengrongfu",image_hrl:"https://avatars.githubusercontent.com/u/15009201?v=4",socials:{github:"https://github.com/lengrongfu"},key:"rongfu",page:null}],frontMatter:{slug:"gRPC \u5b66\u4e60\u4e4b-\u9ad8\u7ea7\u77e5\u8bc6",title:"gRPC \u5b66\u4e60\u4e4b-\u9ad8\u7ea7\u77e5\u8bc6",authors:["rongfu"],tags:["gRPC"]},unlisted:!1,prevItem:{title:"Serverless \u57fa\u7840\u77e5\u8bc6",permalink:"/blog/serverless\u57fa\u7840\u77e5\u8bc6"},nextItem:{title:"gRPC \u5b66\u4e60\u4e4b-\u4e2d\u7ea7\u77e5\u8bc6",permalink:"/blog/gRPC \u5b66\u4e60\u4e4b-\u4e2d\u7ea7\u77e5\u8bc6"}},a={authorsImageUrls:[void 0]},o=[{value:"\u9ad8\u7ea7\u77e5\u8bc6",id:"\u9ad8\u7ea7\u77e5\u8bc6",level:2},{value:"gRPC \u5e95\u5c42\u539f\u7406",id:"grpc-\u5e95\u5c42\u539f\u7406",level:3},{value:"gRPC \u8d85\u8d8a\u57fa\u7840\u77e5\u8bc6",id:"grpc-\u8d85\u8d8a\u57fa\u7840\u77e5\u8bc6",level:3},{value:"\u62e6\u622a\u5668",id:"\u62e6\u622a\u5668",level:4},{value:"\u670d\u52a1\u7aef\u62e6\u622a\u5668",id:"\u670d\u52a1\u7aef\u62e6\u622a\u5668",level:5},{value:"\u5ba2\u6237\u7aef\u62e6\u622a\u5668",id:"\u5ba2\u6237\u7aef\u62e6\u622a\u5668",level:5}];function d(e){const r={code:"code",h2:"h2",h3:"h3",h4:"h4",h5:"h5",img:"img",li:"li",p:"p",pre:"pre",ul:"ul",...(0,c.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.p,{children:"gRPC \u5b66\u4e60\u901a\u4fe1\u57fa\u7840"}),"\n",(0,t.jsx)(r.h2,{id:"\u9ad8\u7ea7\u77e5\u8bc6",children:"\u9ad8\u7ea7\u77e5\u8bc6"}),"\n",(0,t.jsx)(r.p,{children:"\u4e4b\u524d\u7684\u6587\u7ae0\u4e2d\u8bb0\u5f55\u4e86\u5bf9 gRPC \u7684\u4f7f\u7528\uff0c\u4f46\u662f\u90fd\u6ca1\u6709\u6d89\u53ca\u5e95\u5c42\u7684\u901a\u4fe1\u57fa\u7840\u77e5\u8bc6\u3002\u8fd9\u7bc7\u6587\u7ae0\u4e3b\u8981\u4ecb\u7ecd gRPC \u7684\u9ad8\u7ea7\u77e5\u8bc6\uff0c\u6d89\u53ca\u5230 gRPC \u7684\u5e95\u5c42\u539f\u7406\u3001"}),"\n",(0,t.jsx)(r.h3,{id:"grpc-\u5e95\u5c42\u539f\u7406",children:"gRPC \u5e95\u5c42\u539f\u7406"}),"\n",(0,t.jsx)(r.h3,{id:"grpc-\u8d85\u8d8a\u57fa\u7840\u77e5\u8bc6",children:"gRPC \u8d85\u8d8a\u57fa\u7840\u77e5\u8bc6"}),"\n",(0,t.jsx)(r.p,{children:"\u8fd9\u90e8\u5206\u4e3b\u8981\u8bb2\u8ff0\u5728\u6784\u5efa\u771f\u6b63\u7684gRPC\u5e94\u7528\u65f6\uff0c\u5bf9\u4e8e\u9700\u8981\u589e\u5f3a\u5b83\u4eec\u7684\u5404\u79cd\u80fd\u529b\uff0c\u6bd4\u5982\uff1a\u62e6\u622agRPC\u7684\u8f93\u5165\u548c\u8f93\u51fa\u3001\u5f39\u6027\u5904\u7406\u7f51\u7edc\u5ef6\u8fdf\u3001\u5904\u7406\u9519\u8bef\u3001\u5728\u670d\u52a1\u548c\u6d88\u8d39\u8005\u4e4b\u95f4\u5171\u4eab\u5143\u6570\u636e\u3002"}),"\n",(0,t.jsx)(r.h4,{id:"\u62e6\u622a\u5668",children:"\u62e6\u622a\u5668"}),"\n",(0,t.jsxs)(r.p,{children:["\u5728 ",(0,t.jsx)(r.code,{children:"gRPC"})," \u4e2d\uff0c\u53ef\u4ee5\u62e6\u622a ",(0,t.jsx)(r.code,{children:"gRPC"})," \u7684\u6267\u884c.\u6765\u6ee1\u8db3\u7279\u5b9a\u7684\u9700\u6c42\uff0c\u5982\u65e5\u5fd7\u3001\u8ba4\u8bc1\u3001\u6027\u80fd\u5ea6\u76d0\u6307\u6807\u7b49\uff0c\u8fd9\u4f1a\u4f7f\u7528\u4e00\u79cd\u540d\u4e3a\u62e6\u622a\u5668\u7684\u6269\u5c55\u673a\u5236\u3002\u5b83\u662f ",(0,t.jsx)(r.code,{children:"gRPC"})," \u6838\u5fc3\u6269\u5c55\u673a\u5236\u4e4b\u4e00 \uff0c\u5728\u4e00\u4e9b\u4f7f\u7528\u573a\u5446\u4e2d\u975e\u5e38\u6709\u7528\uff0c\u6bd4\u5982\u65e5\u5fd7\u3001\u8eab\u4efd\u9a8c\u8bc1\u3001\u6388\u6743\u3001\u6027\u80fd\u5ea6\u76d8\u6307\u6807\u3001\u8ddf\u8e2a\u4ee5\u53ca\u5176\u4ed6\u4e00\u4e9b\u81ea\u5b9a\u4e49\u9519\u6c42."]}),"\n",(0,t.jsxs)(r.p,{children:["\u6839\u636e\u6240\u62e6\u622a\u7684 ",(0,t.jsx)(r.code,{children:"RPC"})," \u8c03\u7528\u7c7b\u578b\uff0c",(0,t.jsx)(r.code,{children:"gRPC"})," \u62e6\u622a\u53ef\u4ee5\u5206\u4e3a\u4e24\u7c7b\uff0c\u5bf9\u4e8e\u4e00\u5143",(0,t.jsx)(r.code,{children:"RPC"}),"\uff0c\u4f7f\u7528\u4e00\u5143\u62e6\u622a\u5668\uff0c\u5bf9\u4e8e\u6d41",(0,t.jsx)(r.code,{children:"RPC"}),"\uff0c\u4f7f\u7528\u6d41\u62e6\u622a\u5668\uff1b\u8fd9\u4e9b\u62e6\u622a\u5668\u65e2\u53ef\u4ee5\u7528\u5728\u670d\u52a1\u7aef\u4e5f\u53ef\u4ee5\u7528\u5728\u5ba2\u6237\u7aef\u3002"]}),"\n",(0,t.jsx)(r.h5,{id:"\u670d\u52a1\u7aef\u62e6\u622a\u5668",children:"\u670d\u52a1\u7aef\u62e6\u622a\u5668"}),"\n",(0,t.jsx)(r.p,{children:"\u5f53\u5ba2\u6237\u7aef\u8c03\u7528 gRPC\u670d\u52a1\u7684\u8fdc\u7a0b\u65b9\u6cd5\u8098\uff0c\u901a\u8fc7\u4f7f\u7528\u670d\u52a1\u5668\u7aef\u62e6\u622a\u5668\uff0c\u53ef\u4ee5\u5728\u6267\u884c\u8fdc\u7a0b\u65b9\u6cd5 \u4e4b\u524d\uff0c\u6267\u884c\u4e00\u4e2a\u901a\u7528\u7684\u903b\u8f91\u3002"}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.img,{alt:"grpc-server-intercepter",src:n(5760).A+"",width:"2294",height:"1399"})}),"\n",(0,t.jsx)(r.p,{children:"\u5728\u670d\u52a1\u5668\u9500\uff0c \u4e00\u5143\u62e6\u622a\u5668\u62e6\u622a\u4e00\u5143 RPC\uff0c\u68b3\u62e6iliV:\xecI\u552e\u51fa1\u62e6\u622a\u6d41 RPC. \u4e0b\u56de\u6765\u53f3\u4e00\u4e0b\u670d\u52a1\u5668\u63e3\n\u4e00\u5143\u62e6\u6572\u5668."}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"\u4e00\u5143\u62e6\u622a"}),"\n"]}),"\n",(0,t.jsxs)(r.p,{children:["\u8981\u5b9e\u73b0\u8fd9\u4e00\u70b9 \uff0c\u9700\u8981\u5148\u5b9e\u73b0 ",(0,t.jsx)(r.code,{children:"UnaryServerlnterceptor"})," \u7c7b\u578b\u7684\u51fd\u6570\uff0c \u5e76\u5728\u521b ",(0,t.jsx)(r.code,{children:"gRPC"})," \u670d\u52a1\u5668\u7aef\u65f6\u5c06\u51fd\u6570\u6ce8\u518c\u8fdb\u6765\u3002 ",(0,t.jsx)(r.code,{children:"UnaryServerlnterceptor"})," \u662f\u7528\u4e8e\u670d\u52a1\u5668\u7aef\u4e00\u5143\u62e6\u622a\u7684\u7c7b\u578b\u3002\u51fd\u6570\u5b9a\u4e49\u7c7b\u578b\u5982\u4e0b\u3002"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:"func(ctx context.Context, req interface{}, info \u53ebJnaryServerlnfo\uff0c\nhand1er UnaryHand1er) (re5p interface{}, err error)\n"})}),"\n",(0,t.jsx)(r.p,{children:"\u4f8b\u5982\uff1a\u8fdb\u884c\u4e00\u5143\u62e6\u622a\uff0c\u6253\u5370\u65e5\u5fd7\u3002"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:'func orderUnaryServerlnterceptor(ctx context.Context, req interface{},\n\tinfo *grpc.UnaryServerInfo, handler grpc.UnaryHandler) (interface{}, error) {\n\tlog.Println("======= [Server Interceptor1 ", info.FullMethod)\n\tm, err := handler(ctx, req)\n\tlog.Printf("post proc mess: %s", m)\n    // \u53ef\u4ee5\u62e6\u622a\u4fee\u6539\u8fd4\u56de\u5185\u5bb9\n    if order, ok := m.(*pb.Order); ok {\n\t\torder.Price = 100\n\t\treturn order, err\n\t}\n\treturn m, err\n}\n\nfunc main() {\n    ....\u7701\u7565\n\ts := grpc.NewServer(grpc.UnaryInterceptor(orderUnaryServerlnterceptor))\n\tpb.RegisterOrderManagementServer(s, &server{})\n\tif err := s.Serve(listen); err != nil {\n\t\tpanic(err)\n\t}\n}\n\n'})}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"\u6d41\u62e6\u622a"}),"\n"]}),"\n",(0,t.jsxs)(r.p,{children:["\u670d\u52a1\u5668\u7aef\u6d41\u62e6\u622a\u5668\u4f1a\u62e6\u622a ",(0,t.jsx)(r.code,{children:"gRPC"})," \u670d\u52a1\u5668\u6240\u5904\u7406\u7684\u6240\u6709\u6d41",(0,t.jsx)(r.code,{children:"RPC"}),"\u3002 \u6d41\u62e6\u622a\u5668\u5305\u62ec\u524d\u7f6e\u5904\u7406\u9636\u6bb5\u548c\u6d41\u64cd\u4f5c\u62e6\u622a\u9636\u6bb5\u3002"]}),"\n",(0,t.jsxs)(r.p,{children:["\u8981\u5b9e\u73b0\u6d41\u62e6\u622a\uff0c\u9700\u8981\u5b9e\u73b0",(0,t.jsx)(r.code,{children:"Streal'1Serverlnterceptor"})," \u51fd\u6570\uff1a"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:"func (srv interface{}, ss grpc.ServerStream,info *grpc.StreamServerInfo,handler grpc.StreamHandler) error  {\n\n}\n"})}),"\n",(0,t.jsxs)(r.p,{children:[(0,t.jsx)(r.code,{children:"grpc.ServerStream"})," \u7684\u5305\u88c5\u5668\u53ef\u4ee5\u62e6\u622a ",(0,t.jsx)(r.code,{children:"gRPC"})," \u670d\u52a1\u53d1\u9001\u6216\u63a5\u6536\u5230\u7684\u6570\u636e\uff0c\u5b83\u5b9e\u73b0\u4e86 ",(0,t.jsx)(r.code,{children:"SendMsg"})," \u51fd\u6570\u548c ",(0,t.jsx)(r.code,{children:"RecvMsg"})," \u51fd\u6570\uff0c\u8fd9\u4e24\u4e2a\u51fd\u6570\u5206\u522b\u4f1a\u5728\u670d\u52a1\u53d1\u9001\u548c\u63a5\u6536 ",(0,t.jsx)(r.code,{children:"RPC"})," \u6d41\u6d88\u606f\u7684\u65f6\u5019\u8c03\u7528\u3002"]}),"\n",(0,t.jsxs)(r.p,{children:["\u5728\u6d41 ",(0,t.jsx)(r.code,{children:"RPC"})," \u8fdb\u5165\u670d\u52a1\u524d\uff0c\u53ef\u4ee5\u901a\u8fc7 ",(0,t.jsx)(r.code,{children:"grpc.ServeStream"})," \u8fdb\u884c\u6d41\u7684\u5904\u7406\uff0c\u518d\u901a\u8fc7 ",(0,t.jsx)(r.code,{children:"grpc.StreamHandler"})," \u6765\u8fdb\u884c\u8c03\u7528\u3002"]}),"\n",(0,t.jsxs)(r.p,{children:["\u4f8b\u5982\uff1a\u5728 ",(0,t.jsx)(r.code,{children:"OrderManager"})," \u7684\u6d41\u63a5\u53e3\u4e2d\u5148\u8fdb\u884c\u8f93\u5165\u6d41\u7684\u5904\u7406\uff0c\u518d\u8c03\u7528 ",(0,t.jsx)(r.code,{children:"RPC"}),"."]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:'type wrappedSteam struct {\n\tgrpc.ServerStream\n}\n\nvar _ grpc.ServerStream = &wrappedSteam{}\n\nfunc (w *wrappedSteam) RecvMsg(m interface{}) error {\n\tlog.Printf("=====RecvMSg==== %T", m)\n\treturn w.ServerStream.RecvMsg(m)\n}\n\nfunc (w *wrappedSteam) SendMsg(m interface{}) error {\n\tlog.Println("====SendMsg====", m)\n\treturn w.ServerStream.SendMsg(m)\n}\n\nfunc newWrappedStream(s grpc.ServerStream) grpc.ServerStream {\n\treturn &wrappedSteam{s}\n}\n\nfunc orderServerStreamInterceptor(srv interface{}, ss grpc.ServerStream, info *grpc.StreamServerInfo, handler grpc.StreamHandler) error {\n\tlog.Println("===== [Server Steam Interceptor ]", info.FullMethod) \n\terr := handler(srv, newWrappedStream(ss))\n\tif err != nil {\n\t\tlog.Fatalf("RPC failed with error %v", err)\n\t}\n\treturn err\n}\n\nfunc main() {\n\t...\n\ts := grpc.NewServer(grpc.StreamInterceptor(orderServerStreamInterceptor))\n\tpb.RegisterOrderManagementServer(s, &server{})\n\tif err := s.Serve(listen); err != nil {\n\t\tpanic(err)\n\t}\n}\n'})}),"\n",(0,t.jsxs)(r.p,{children:["\u5728\u6d41\u5f00\u59cb\u65f6\u4f1a\u8fdb\u5165 ",(0,t.jsx)(r.code,{children:"orderServerStreamInterceptor"})," \u65b9\u6cd5\uff0c\u6d41\u7ed3\u675f\u540e\u624d\u4f1a\u63a8\u51fa\uff0c\u5728\u6d41\u6bcf\u6b21 ",(0,t.jsx)(r.code,{children:"RecvMsg"})," \u65f6\u4f1a\u8fdb\u5165\u5230\u6d41\u62e6\u622a\u7684 ",(0,t.jsx)(r.code,{children:"(w *wrappedSteam) RecvMsg"})," \u65b9\u6cd5\u4e2d\uff0c",(0,t.jsx)(r.code,{children:"SendMsg"})," \u540c\u7406\u3002"]}),"\n",(0,t.jsx)(r.h5,{id:"\u5ba2\u6237\u7aef\u62e6\u622a\u5668",children:"\u5ba2\u6237\u7aef\u62e6\u622a\u5668"}),"\n",(0,t.jsx)(r.p,{children:(0,t.jsx)(r.img,{alt:"grpc-client-interceptor",src:n(3678).A+"",width:"2328",height:"1395"})}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"\u4e00\u5143\u62e6\u622a"}),"\n"]}),"\n",(0,t.jsx)(r.p,{children:"\u4e00\u5143\u62e6\u622a\u7684\u51fd\u6570\u7b7e\u540d\uff1a"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:"type UnaryClientInterceptor func(ctx context.Context, method string, req, reply interface{}, cc *ClientConn, invoker UnaryInvoker, opts ...CallOption) error\n\n"})}),"\n",(0,t.jsx)(r.p,{children:"\u4e0e\u670d\u52a1\u7aef\u62e6\u622a\u4e00\u5143\u62e6\u622a\u5668\u4e00\u6837\uff0c\u5ba2\u6237\u7aef\u4e00\u5143\u62e6\u622a\u5668\u4e5f\u6709\u4e0d\u540c\u7684\u9636\u6bb5\u3002"}),"\n",(0,t.jsx)(r.p,{children:"\u4f8b\u5b50\uff1a"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:'func orderClientInterceptor(ctx context.Context, method string, req, apply interface{}, cc *grpc.ClientConn, invoker grpc.UnaryInvoker, opts ...grpc.CallOption) error {\n\tlog.Println("Method :" + method)\n\tstart := time.Now()\n\terr := invoker(ctx, method, req, apply, cc, opts...)\n\tlog.Printf("cost is [%d]ms",time.Now().Sub(start).Milliseconds())\n\treturn err\n}\n\nfunc main(){\n\tconn, err := grpc.Dial(address, grpc.WithInsecure(),grpc.WithUnaryInterceptor(orderClientInterceptor))\n}\n'})}),"\n",(0,t.jsxs)(r.ul,{children:["\n",(0,t.jsx)(r.li,{children:"\u6d41\u62e6\u622a"}),"\n"]}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:"type StreamClientInterceptor func(ctx context.Context, desc *StreamDesc, cc *ClientConn, method string, streamer Streamer, opts ...CallOption) (ClientStream, error)\n\n"})}),"\n",(0,t.jsx)(r.p,{children:"\u4f8b\u5b50\uff1a"}),"\n",(0,t.jsx)(r.pre,{children:(0,t.jsx)(r.code,{className:"language-go",children:'type wrappedSteam struct {\n\tgrpc.ClientStream\n}\n\nfunc (w *wrappedSteam) RecvMsg(m interface{}) error {\n\tlog.Printf("===== [ Client Stream Interceptor ] Receive a message (Type :%T) at %v", m, time.Now().Format(time.RFC3339))\n\treturn w.ClientStream.RecvMsg(m)\n}\n\nfunc (w *wrappedSteam) SendMsg(m interface{}) error {\n\tlog.Printf("===== [Client Stream Interceptor ] Send a message (Type :%T) at %v",m, time.Now().Format(time.RFC3339))\n\treturn w.ClientStream.SendMsg(m)\n}\n\nfunc newWrappedStream(cs grpc.ClientStream) grpc.ClientStream {\n\treturn &wrappedSteam{cs}\n}\n\nfunc orderClientStreamInterceptor(ctx context.Context, desc *grpc.StreamDesc, cc *grpc.ClientConn, method string, streamer grpc.Streamer, opts ...grpc.CallOption) (grpc.ClientStream, error) {\n\tlog.Println("===== [Client Interceptor] ",method)\n\ts, err := streamer(ctx, desc, cc, method, opts...)\n\treturn newWrappedStream(s), err\n}\n\nfunc main(){\n\tconn, err := grpc.Dial(address, grpc.WithInsecure(),grpc.WithStreamInterceptor(orderClientStreamInterceptor))\n}\n'})})]})}function p(e={}){const{wrapper:r}={...(0,c.R)(),...e.components};return r?(0,t.jsx)(r,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},3678:(e,r,n)=>{n.d(r,{A:()=>t});const t=n.p+"assets/images/grpc-client-interceptor-4ade8737b7230d0b2141eb661e0811ad.png"},5760:(e,r,n)=>{n.d(r,{A:()=>t});const t=n.p+"assets/images/grpc-server-intercepter-f68440ad8d9a6174631a19af9d37f663.png"},8453:(e,r,n)=>{n.d(r,{R:()=>l,x:()=>i});var t=n(6540);const c={},s=t.createContext(c);function l(e){const r=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function i(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:l(e.components),t.createElement(s.Provider,{value:r},e.children)}}}]);