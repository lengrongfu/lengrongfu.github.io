<?xml version="1.0" encoding="utf-8"?><?xml-stylesheet type="text/xsl" href="rss.xsl"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>My Site Blog</title>
        <link>https://lengrongfu.github.io/blog</link>
        <description>My Site Blog</description>
        <lastBuildDate>Fri, 27 Sep 2024 00:00:00 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[Kubelet源码分析：PodAdmit]]></title>
            <link>https://lengrongfu.github.io/blog/kubelet-podadmit</link>
            <guid>https://lengrongfu.github.io/blog/kubelet-podadmit</guid>
            <pubDate>Fri, 27 Sep 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[之前讲过 Kubelet 结构体中的 syncLoopIteration 方法接收多个 channel 数据源的信息，并调用相应的 handler 处理，其中 configCh 是 kubelet 获取 pod 的数据源，比如通过 informer 从 api 中拉取到一个新的 Pod ，对应的 handler 为 HandlePodAdditions .]]></description>
            <content:encoded><![CDATA[<p>之前讲过 <code>Kubelet</code> 结构体中的 <code>syncLoopIteration</code> 方法接收多个 <code>channel</code> 数据源的信息，并调用相应的 <code>handler</code> 处理，其中 <code>configCh</code> 是 <code>kubelet</code> 获取 <code>pod</code> 的数据源，比如通过 <code>informer</code> 从 <code>api</code> 中拉取到一个新的 <code>Pod</code> ，对应的 <code>handler</code> 为 <code>HandlePodAdditions</code> .</p>
<p><code>configCh</code> 的数据来源有三个，其中一个就是 <code>api</code> ，通过配置 <code>spec.nodeName FieldSelector</code> 的 <code>ListOptions</code> 来向 <code>api</code> 获取所有 <code>ns</code> 下指定 <code>nodeName</code> 的 <code>pod</code>.</p>
<p><code>HandlePodAdditions</code> 接下来通过 <code>canAdmitPod</code> 方法判断该 <code>Po</code> d是否可以被 <code>kubelet</code> 创建，其通过 <code>kubelet</code> 对象的 <code>admitHandlers</code> 获取注册好的 <code>handler</code> 对象，并逐一调用这些对象的 <code>Admit</code>方法检查 <code>pod</code> .</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// pods为kubelet中 正在运行的 &amp;&amp; 已经被admit确认过没问题的 &amp;&amp; 不是terminated的 pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kl </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Kubelet</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">canAdmitPod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pods </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pod </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// the kubelet will invoke each pod admit handler in sequence</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// if any handler rejects, the pod is rejected.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// TODO: move out of disk check into a pod admitter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// TODO: out of resource eviction should have a pod admitter call-out</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	attrs </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">lifecycle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodAdmitAttributes</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> OtherPods</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> pods</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 如果开启原地更新，还需要把 pod 的资源进行用新数据更新一下。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> utilfeature</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultFeatureGate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Enabled</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">features</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InPlacePodVerticalScaling</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// Use allocated resources values from checkpoint store (source of truth) to determine fit</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		otherPods </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pods</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> pods </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			op </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">DeepCopy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			kl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">updateContainerResourceAllocation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">op</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			otherPods </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">otherPods</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> op</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		attrs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OtherPods </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> otherPods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> podAdmitHandler </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> kl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">admitHandlers </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> podAdmitHandler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Admit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">attrs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Admit </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InfoS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Pod admission denied"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"podUID"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> attrs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"pod"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">KObj</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">attrs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"reason"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Reason</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"message"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Reason</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">""</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="image.png" src="https://lengrongfu.github.io/assets/images/pod-admit-dfdaffa7a2853d42eeb146a2cd2ad0ce.png" width="686" height="976" class="img_ev3q"></p>
<p>而 <code>kubelet</code> 对象的 <code>admitHandlers</code> 是在如下 <code>NewMainKubelet</code> 方法中注册，总计注册了六个 <code>Admit</code> .</p>
<ul>
<li>Eviction Admit</li>
</ul>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">klet</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">admitHandlers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddPodAdmitHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">evictionAdmitHandler</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>System Allowlist Admit</li>
</ul>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">klet</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">admitHandlers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddPodAdmitHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sysctlsAllowlist</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>Allocate Resources Admit</li>
</ul>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">klet</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">admitHandlers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddPodAdmitHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">klet</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">containerManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetAllocateResourcesPodAdmitHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>Predicate Admit</li>
</ul>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">klet</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">admitHandlers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddPodAdmitHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lifecycle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewPredicateAdmitHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">klet</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getNodeAnyWay</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> criticalPodAdmissionHandler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> klet</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">containerManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UpdatePluginResources</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>AppArmor Admit</li>
</ul>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">klet</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">admitHandlers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddPodAdmitHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lifecycle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewAppArmorAdmitHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">klet</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">appArmorValidator</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>Shutdown Admit</li>
</ul>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">klet</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">admitHandlers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddPodAdmitHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shutdownAdmitHandler</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="admit-接口">Admit 接口<a href="https://lengrongfu.github.io/blog/kubelet-podadmit#admit-%E6%8E%A5%E5%8F%A3" class="hash-link" aria-label="Direct link to Admit 接口" title="Direct link to Admit 接口">​</a></h3>
<p><code>Admit</code> 评估一个 <code>pod</code> 是否可以被接纳。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> PodAdmitHandler </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">Admit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">attrs </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">PodAdmitAttributes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> PodAdmitResult</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>Admit</code> 的参数结构如下：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> PodAdmitAttributes </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 当前正则评估的 Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Pod </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 除去评估之外 kubelet 接收的所有 Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	OtherPods </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>Admit</code>  的返回值如下：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// PodAdmitResult provides the result of a pod admission decision.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> PodAdmitResult </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 如果true，则评估通过</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Admit </span><span class="token builtin">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 简短地说明为什么该 Pod 不能被接纳.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Reason </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 一条简短消息，解释为什么该 Pod 无法进入</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Message </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="eviction-admit">Eviction Admit<a href="https://lengrongfu.github.io/blog/kubelet-podadmit#eviction-admit" class="hash-link" aria-label="Direct link to Eviction Admit" title="Direct link to Eviction Admit">​</a></h3>
<p>如果为了节点稳定性而不允许进入，则 <code>Admit</code> 会拒绝该 <code>pod</code>。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">managerImpl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Admit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> attrs </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">lifecycle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodAdmitAttributes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> lifecycle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodAdmitResult </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RLock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RUnlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// node 没有 condition 就直接通过，可以不用判定 Readay 的 Condition 吗？</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">nodeConditions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> lifecycle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodAdmitResult</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Admit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 即使在资源压力下也要接纳关键 pod，因为它们是系统稳定性所必需的。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 判定pod是否是static pod、高优先级pod，需要 &gt;= 2000000000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> kubelettypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">IsCriticalPod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">attrs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> lifecycle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodAdmitResult</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Admit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 除内存压力之外的其他条件会拒绝所有 Pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	nodeOnlyHasMemoryPressureCondition </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">hasNodeCondition</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">nodeConditions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NodeMemoryPressure</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">nodeConditions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> nodeOnlyHasMemoryPressureCondition </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		notBestEffort </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodQOSBestEffort </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> v1qos</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetPodQOS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">attrs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> notBestEffort </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> lifecycle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodAdmitResult</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Admit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// When node has memory pressure, check BestEffort Pod's toleration:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// admit it if tolerates memory pressure taint, fail for other tolerations, e.g. DiskPressure.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> corev1helpers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">TolerationsTolerateTaint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">attrs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tolerations</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Taint</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			Key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">    v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TaintNodeMemoryPressure</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			Effect</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TaintEffectNoSchedule</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> lifecycle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodAdmitResult</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Admit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> lifecycle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodAdmitResult</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		Admit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		Reason</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  Reason</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		Message</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nodeConditionMessageFmt</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">nodeConditions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="system-allowlist-admit">System Allowlist Admit<a href="https://lengrongfu.github.io/blog/kubelet-podadmit#system-allowlist-admit" class="hash-link" aria-label="Direct link to System Allowlist Admit" title="Direct link to System Allowlist Admit">​</a></h3>
<p>主要是看用户写的 <code>Sysctls</code> 是否是准入的操作：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">w </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">patternAllowlist</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Admit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> attrs </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">lifecycle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodAdmitAttributes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> lifecycle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodAdmitResult </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pod </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> attrs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 如果没有设置SecurityContext 或者 SecurityContext.Sysctls 字段，则直接通过</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> pod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SecurityContext </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SecurityContext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Sysctls</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> lifecycle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodAdmitResult</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			Admit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> pod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SecurityContext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Sysctls </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> w</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">validateSysctl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HostNetwork</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">HostIPC</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> lifecycle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodAdmitResult</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				Admit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				Reason</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  ForbiddenReason</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				Message</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"forbidden sysctl: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> lifecycle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodAdmitResult</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		Admit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>设置的固定 <code>Sysctls</code> 的 <code>Key</code>, 或者也可以通过配置的 <code>prefix</code> 来进行判定，比如: <code>net.ipv6.neigh.*</code> 这种。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> safeSysctls </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">sysctl</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"kernel.shm_rmid_forced"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"net.ipv4.ip_local_port_range"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"net.ipv4.tcp_syncookies"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"net.ipv4.ping_group_range"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"net.ipv4.ip_unprivileged_port_start"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token string" style="color:#e3116c">"net.ipv4.ip_local_reserved_ports"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		kernel</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> utilkernel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">IPLocalReservedPortsNamespacedKernelVersion</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token string" style="color:#e3116c">"net.ipv4.tcp_keepalive_time"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		kernel</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> utilkernel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TCPKeepAliveTimeNamespacedKernelVersion</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token string" style="color:#e3116c">"net.ipv4.tcp_fin_timeout"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		kernel</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> utilkernel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TCPFinTimeoutNamespacedKernelVersion</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token string" style="color:#e3116c">"net.ipv4.tcp_keepalive_intvl"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		kernel</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> utilkernel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TCPKeepAliveIntervalNamespacedKernelVersion</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token string" style="color:#e3116c">"net.ipv4.tcp_keepalive_probes"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		kernel</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> utilkernel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TCPKeepAliveProbesNamespacedKernelVersion</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="allocate-resources-admit">Allocate Resources Admit<a href="https://lengrongfu.github.io/blog/kubelet-podadmit#allocate-resources-admit" class="hash-link" aria-label="Direct link to Allocate Resources Admit" title="Direct link to Allocate Resources Admit">​</a></h3>
<p>主要进行资源分配准入，比如设备插件、cpu、memory等，核心实现在 <code>topologyManager</code> 中：</p>
<ul>
<li>添加设备插件 <code>Allocate</code> 准入校验</li>
</ul>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">deviceManager</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> devicemanager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewManagerImpl</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">machineInfo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Topology</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">topologyManager</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">topologyManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddHintProvider</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">deviceManager</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>添加 <code>CPU</code> 准入校验</li>
</ul>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cpuManager</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> cpumanager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewManager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		nodeConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CPUManagerPolicy</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		nodeConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CPUManagerPolicyOptions</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		nodeConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CPUManagerReconcilePeriod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		machineInfo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		nodeConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NodeAllocatableConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ReservedSystemCPUs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		cm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetNodeAllocatableReservation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		nodeConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">KubeletRootDir</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		cm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">topologyManager</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	cm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">topologyManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddHintProvider</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cpuManager</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>添加 <code>Memory</code> 准入校验</li>
</ul>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">memoryManager</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> memorymanager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewManager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			nodeConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ExperimentalMemoryManagerPolicy</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			machineInfo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			cm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetNodeAllocatableReservation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			nodeConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ExperimentalMemoryManagerReservedMemory</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			nodeConfig</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">KubeletRootDir</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			cm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">topologyManager</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		cm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">topologyManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddHintProvider</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">memoryManager</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>因为 <code>topologyManager</code> 有三种 <code>topology</code> 策略配置, 分别是 <code>none</code> <code>pod</code> <code>container</code> . 此处这里就不展开讲，我们默认按照 <code>none</code> 的维度来讨论。</p>
<p>每个容器（initContainer 和 containers ）每个都需要进行资源准入校验，每个容器都需要最少进行 <code>cpu</code> 和 <code>memory</code> 校验，如果还涉及到 <code>device-plugin</code> 的话也需要校验。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">scope</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">allocateAlignedResources</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pod </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> container </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Container</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> provider </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hintProviders </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> provider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Allocate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> container</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里涉及到的具体每个资源分配校验就不再进行展开，核心就是看用户请求的资源能不能分配成功，如果分配失败就会拒绝；</p>
<p>得出一个结论 <code>Pod</code> 的资源分配是在 <code>kubelet</code> 接收到之后进入 <code>syncLoopIteration</code> 之后就会同步进行分配，其次在 <code>syncPod</code> 的处理逻辑中会有一次补偿机制。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="predicate-admit">Predicate Admit<a href="https://lengrongfu.github.io/blog/kubelet-podadmit#predicate-admit" class="hash-link" aria-label="Direct link to Predicate Admit" title="Direct link to Predicate Admit">​</a></h3>
<p>预选 <code>Admit</code> ，主要再次判定调度器预选的数据是否满足。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">w </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">predicateAdmitHandler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Admit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> attrs </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">PodAdmitAttributes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> PodAdmitResult </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	node</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> w</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getNodeAnyWayFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ErrorS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Cannot get Node info"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> PodAdmitResult</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			Admit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			Reason</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token string" style="color:#e3116c">"InvalidNodeInfo"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			Message</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Kubelet cannot get node info."</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	admitPod </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> attrs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// node select 相关的这些label，进行判定是否满足，如果不满足，就进行拒绝。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rejectPodAdmissionBasedOnOSSelector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">admitPod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 判定 pod.Spec.OS.Name 这个字段是否满足要求</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rejectPodAdmissionBasedOnOSField</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">admitPod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pods </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> attrs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OtherPods</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	nodeInfo </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> schedulerframework</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewNodeInfo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pods</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	nodeInfo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetNode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">node</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// TODO: Remove this after the SidecarContainers feature gate graduates to GA.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">utilfeature</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultFeatureGate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Enabled</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">features</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SidecarContainers</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	  </span><span class="token comment" style="color:#999988;font-style:italic">// 如果没有开启Sidecar容器，就检查init容器的重启策略是否设置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> admitPod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InitContainers </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">IsRestartableInitContainer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				message </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Init container %q may not have a non-default restartPolicy"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InfoS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Failed to admit pod"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"pod"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">KObj</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">admitPod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"message"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> PodAdmitResult</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					Admit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					Reason</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token string" style="color:#e3116c">"InitContainerRestartPolicyForbidden"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					Message</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 确保节点具有足够的插件资源，以满足 Pod 所需的资源</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> w</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">pluginResourceUpdateFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nodeInfo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> attrs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		message </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Update plugin resources failed due to %v, which is unexpected."</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InfoS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Failed to admit pod"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"pod"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">KObj</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">admitPod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"message"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> PodAdmitResult</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			Admit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			Reason</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token string" style="color:#e3116c">"UnexpectedAdmissionError"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			Message</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Remove the requests of the extended resources that are missing in the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// node info. This is required to support cluster-level resources, which</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// are extended resources unknown to nodes.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">//</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Caveat: If a pod was manually bound to a node (e.g., static pod) where a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// node-level extended resource it requires is not found, then kubelet will</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// not fail admission while it should. This issue will be addressed with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// the Resource Class API in the future.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	podWithoutMissingExtendedResources </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">removeMissingExtendedResources</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">admitPod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nodeInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	reasons </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">generalFilter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">podWithoutMissingExtendedResources</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nodeInfo</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	fit </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">reasons</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">fit </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		reasons</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> w</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">admissionFailureHandler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HandleAdmissionFailure</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">admitPod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reasons</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		fit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">reasons</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			message </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Unexpected error while attempting to recover from admission failure: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InfoS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Failed to admit pod, unexpected error while attempting to recover from admission failure"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"pod"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">KObj</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">admitPod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"err"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> PodAdmitResult</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				Admit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   fit</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				Reason</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token string" style="color:#e3116c">"UnexpectedAdmissionError"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				Message</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">fit </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> reason </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> message </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">reasons</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			message </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"GeneralPredicates failed due to unknown reason, which is unexpected."</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InfoS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Failed to admit pod: GeneralPredicates failed due to unknown reason, which is unexpected"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"pod"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">KObj</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">admitPod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> PodAdmitResult</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				Admit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   fit</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				Reason</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token string" style="color:#e3116c">"UnknownReason"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				Message</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// If there are failed predicates, we only return the first one as a reason.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		r </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> reasons</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> re </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">type</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">PredicateFailureError</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> re</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PredicateName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			message </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> re</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">V</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InfoS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Predicate failed on Pod"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"pod"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">KObj</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">admitPod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"err"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">InsufficientResourceError</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"OutOf%s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> re</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ResourceName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			message </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> re</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">V</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InfoS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Predicate failed on Pod"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"pod"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">KObj</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">admitPod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"err"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">default</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			reason </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"UnexpectedPredicateFailureType"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			message </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"GeneralPredicates failed due to %v, which is unexpected."</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> r</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InfoS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Failed to admit pod"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"pod"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">KObj</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">admitPod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"err"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> PodAdmitResult</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			Admit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   fit</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			Reason</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  reason</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			Message</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> PodAdmitResult</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		Admit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="apparmor-admit">AppArmor Admit<a href="https://lengrongfu.github.io/blog/kubelet-podadmit#apparmor-admit" class="hash-link" aria-label="Direct link to AppArmor Admit" title="Direct link to AppArmor Admit">​</a></h3>
<p>AppArmor 是 Linux 内核安全模块，允许系统管理员通过每个程序的配置文件限制程序的功能。</p>
<p>如果是 <code>Linux</code> 操作系统，则需要进行准入校验</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">a </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">appArmorAdmitHandler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Admit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> attrs </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">PodAdmitAttributes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> PodAdmitResult </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 如果pod是 running or terminated, 则不需要判定。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> attrs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Status</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Phase </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodPending </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> PodAdmitResult</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Admit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Validate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">attrs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> PodAdmitResult</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Admit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> PodAdmitResult</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		Admit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		Reason</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token string" style="color:#e3116c">"AppArmor"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		Message</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Cannot enforce AppArmor: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="shutdown-admit">Shutdown Admit<a href="https://lengrongfu.github.io/blog/kubelet-podadmit#shutdown-admit" class="hash-link" aria-label="Direct link to Shutdown Admit" title="Direct link to Shutdown Admit">​</a></h3>
<p>节点停机管理，如果 <code>node</code> 已经 <code>shutdown</code> 则拒绝所有的 <code>Pod</code>.</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">managerImpl</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Admit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> attrs </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">lifecycle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodAdmitAttributes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> lifecycle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodAdmitResult </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	nodeShuttingDown </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ShutdownStatus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> nodeShuttingDown </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> lifecycle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodAdmitResult</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			Admit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">   </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			Reason</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  nodeShutdownNotAdmittedReason</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			Message</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nodeShutdownNotAdmittedMessage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> lifecycle</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodAdmitResult</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Admit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>Kubernetes</category>
            <category>Kubelet</category>
        </item>
        <item>
            <title><![CDATA[kubelet 源码分析 devicemanager]]></title>
            <link>https://lengrongfu.github.io/blog/kubelet-devicemanage</link>
            <guid>https://lengrongfu.github.io/blog/kubelet-devicemanage</guid>
            <pubDate>Thu, 05 Sep 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[device-plugin  是 Kubernetes 用来扩展除 CPU Memory  之外的硬件设备，比如常见的 Nvidia GPU .]]></description>
            <content:encoded><![CDATA[<p><code>device-plugin</code>  是 <code>Kubernetes</code> 用来扩展除 <code>CPU</code> <code>Memory</code>  之外的硬件设备，比如常见的 <code>Nvidia GPU</code> .</p>
<p>下面主要来分析一下在 <code>Kubelet</code> 中是如何调用 <code>device-plugin</code> 的，以及如何生成 <code>OCI Spec</code> 内容。</p>
<p><code>device-plugin</code> 也存在一些限制，因为它不感知 <code>Pod</code> 和 <code>Container</code> ，就导致没办法做一些动态的资源分配，比如根据用户设置选用某个 <code>GPU</code> 型号或者是指定使用某个设备的 <code>UUID</code> ；目前社区主要是在推进 <code>DRA</code> 来解决这些问题。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="kubelet-调用流程">kubelet 调用流程<a href="https://lengrongfu.github.io/blog/kubelet-devicemanage#kubelet-%E8%B0%83%E7%94%A8%E6%B5%81%E7%A8%8B" class="hash-link" aria-label="Direct link to kubelet 调用流程" title="Direct link to kubelet 调用流程">​</a></h2>
<p><code>device plugin</code> 的工作原理其实不复杂。主要有以下步骤：</p>
<ul>
<li>首先 <code>device plugin</code> 可以通过 <code>daemonset</code> 部署到需要的节点上。</li>
<li>为了让 <code>Kubernetes</code> 发现 <code>device plugin</code>，需要向 <code>kubelet</code> 的 <code>unix socket</code>。 进行注册，注册的信息包括 <code>device plugin</code> 的 <code>unix socket</code> <code>API Version</code> <code>ResourceName</code></li>
<li><code>kubelet</code> 通过 <code>grpc</code> 向 <code>device plugin</code> 调用 <code>ListAndWatch</code>， 获取当前节点上的资源。</li>
<li><code>kubelet</code> 向 <code>api server</code> 更新节点状态来通知资源变更。</li>
<li>用户创建 <code>pod</code>，请求资源并调度到节点上后, <code>kubelet</code> 调用 <code>device plugin</code> 的 <code>Allocate</code> 进行资源分配。</li>
</ul>
<p>时序图如下:</p>
<p><img decoding="async" loading="lazy" alt="image.png" src="https://lengrongfu.github.io/assets/images/image-e526919fba362e3d08f171b6b4fc3672.png" width="1442" height="578" class="img_ev3q"></p>
<p><code>device-plugin</code> 源码模块在 <code>pkg/kubelet/cm/devicemanager</code> 目录下，是 <code>ContainerManager</code> 模块的一部分，主要是用来在创建 <code>Container</code> 过程中，生成 <code>OCI Spec</code> 内容的。</p>
<p>下面按照两个流程来讲解源码，一个是注册流程和获取节点设备，还有一个是分配流程；</p>
<p>注册和获取可用设备流程：</p>
<p><img decoding="async" loading="lazy" src="https://firebasestorage.googleapis.com/v0/b/notiondiagram.appspot.com/o/diagram%2Fm5smUNzLG7NDZmSPY82qhFvWnsu1%2F0d36a640-61c1-4773-ab12-29c5ff176a94.svg?alt=media&amp;token=c5d24a2f-911c-4fc3-b73a-d11a700438fa" alt="" class="img_ev3q"></p>
<p>资源分配流程</p>
<p><img decoding="async" loading="lazy" src="https://firebasestorage.googleapis.com/v0/b/notiondiagram.appspot.com/o/diagram%2Fm5smUNzLG7NDZmSPY82qhFvWnsu1%2F411db6c6-133a-4029-a3f2-913498df5331.svg?alt=media&amp;token=7a942296-b51f-40e9-aa16-91b8cbe537e3" alt="" class="img_ev3q"></p>
<p>从 <code>ContainerManager</code> 的 <code>GetResources</code> 方法进入 <code>devicemanager</code> 模块中，开始获取分配的设备，最后返回一个 <code>DeviceRunContainerOptions</code> 对象：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> DeviceRunContainerOptions </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// The environment variables list.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Envs </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">kubecontainer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EnvVar</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// The mounts for the container.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Mounts </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">kubecontainer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Mount</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// The host devices mapped into the container.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Devices </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">kubecontainer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DeviceInfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// The Annotations for the container</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Annotations </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">kubecontainer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Annotation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// CDI Devices for the container</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	CDIDevices </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">kubecontainer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CDIDevice</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果启用了 <code>CDI</code> 则 <code>CDIDevices</code> 这个字段非空，此时需要挂载哪些设备就需要等容器运行时解析 <code>CDI</code> 文件然后 <code>Merge</code> 到 <code>OCI Spec</code> 文件中了。</p>
<p>下面主要讲一下几个函数的实现逻辑；</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="listandwatch">ListAndWatch<a href="https://lengrongfu.github.io/blog/kubelet-devicemanage#listandwatch" class="hash-link" aria-label="Direct link to ListAndWatch" title="Direct link to ListAndWatch">​</a></h3>
<p><code>ListAndWatch</code> 主要在启动的时候发送 <code>Send</code> 一次设备，之后进入监听本地设备的环节，如果出现设备不健康，则重新 <code>Send</code> 所有健康的设备。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="allocate">Allocate<a href="https://lengrongfu.github.io/blog/kubelet-devicemanage#allocate" class="hash-link" aria-label="Direct link to Allocate" title="Direct link to Allocate">​</a></h3>
<p>在用户创建的 <code>Pod</code> 请求资源时，<code>Kubernetes</code> 的调度器会进行调度，并通过 <code>kubelet</code> 向 <code>device plugin</code> 发出 <code>Allocate</code> 调用，这一步的调用主要是为了让 <code>device plugin</code> 为容器调度资源。 在调度成功后向 <code>kubelet</code> 返回调度结果即可。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="getdevicepluginoption">GetDevicePluginOption<a href="https://lengrongfu.github.io/blog/kubelet-devicemanage#getdevicepluginoption" class="hash-link" aria-label="Direct link to GetDevicePluginOption" title="Direct link to GetDevicePluginOption">​</a></h3>
<p>主要返回与 <code>Device Manager</code> 通信的一些可选参数设置，主要返回如下结构：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> DevicePluginOptions </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 每个容器启动前是否需要调用 PreStartContainer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    PreStartRequired </span><span class="token builtin">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// GetPreferredAllocationAvailable: 是否提供优选方法</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GetPreferredAllocationAvailable </span><span class="token builtin">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="prestartcontainer">PreStartContainer<a href="https://lengrongfu.github.io/blog/kubelet-devicemanage#prestartcontainer" class="hash-link" aria-label="Direct link to PreStartContainer" title="Direct link to PreStartContainer">​</a></h3>
<p>如果设备插件在注册阶段设置 <code>PreStartRequired=true</code> 了要调用，则在每个容器启动之前调用 <code>PreStartContainer</code>。 设备插件可以运行设备特定的操作，例如在使设备可供容器使用之前重置设备。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="getpreferredallocation">GetPreferredAllocation<a href="https://lengrongfu.github.io/blog/kubelet-devicemanage#getpreferredallocation" class="hash-link" aria-label="Direct link to GetPreferredAllocation" title="Direct link to GetPreferredAllocation">​</a></h3>
<p>如果设备插件在注册阶段设置 <code>PreStartRequired=true</code> 了要调用，可以针对指定的设备列表做二次最优分配。</p>
<p>官方的 <code>nvidia-device-plugin</code> 在 <code>GetPreferredAllocation</code> 内部实现了节点内多卡最优选择的逻辑，通过确定多卡之间的拓扑信息来决定通信量。</p>]]></content:encoded>
            <category>Kubernetes</category>
            <category>Kubelet</category>
        </item>
        <item>
            <title><![CDATA[Kubelet源码分析 Configmap/Secret volume]]></title>
            <link>https://lengrongfu.github.io/blog/kubelet-configmap</link>
            <guid>https://lengrongfu.github.io/blog/kubelet-configmap</guid>
            <pubDate>Tue, 03 Sep 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[在 Pod 经常会出现将 Configmap/Secret 挂载到 Pod 中，今天我们来分析 Kubelet  是如何实现这个能力，特别是在 Configmap/Secret 内容发送改变、被删除等操作的时候如何影响 Pod 内挂载好的文件。]]></description>
            <content:encoded><![CDATA[<p>在 <code>Pod</code> 经常会出现将 <code>Configmap/Secret</code> 挂载到 <code>Pod</code> 中，今天我们来分析 <code>Kubelet</code>  是如何实现这个能力，特别是在 <code>Configmap/Secret</code> 内容发送改变、被删除等操作的时候如何影响 <code>Pod</code> 内挂载好的文件。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="configmap的manager">ConfigMap的Manager<a href="https://lengrongfu.github.io/blog/kubelet-configmap#configmap%E7%9A%84manager" class="hash-link" aria-label="Direct link to ConfigMap的Manager" title="Direct link to ConfigMap的Manager">​</a></h3>
<p><code>Configmap</code> 管理这块代码实现主要在 <code>pkg/kubelet/configmap</code> 目录下，提供了一个统一的管理接口 <code>Manager</code> ,下面我们来看下它定义的方法：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Manager </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Get configmap by configmap namespace and name.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">GetConfigMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">namespace</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> name </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ConfigMap</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// RegisterPod registers all configmaps from a given pod.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">RegisterPod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pod </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// UnregisterPod unregisters configmaps from a given pod that are not</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// used by any other registered pod.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">UnregisterPod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pod </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个 <code>Manager</code>  接口会根据配置的 <code>ConfigMapAndSecretChangeDetectionStrategy</code> 类型来决定使用那种方式管理，它提供了三种，分别是：</p>
<ul>
<li><code>GET</code> :  不会缓存，直接从 <code>apiserver</code> 出获取。</li>
<li><code>Cache</code> : 会通过 <code>apiserver</code> 直接获取对象，并通过 <code>TTL</code> 缓存起来。</li>
<li><code>Watch</code>: 会通过 <code>list-watch</code> 的方式监视资源的变更，并通过 <code>TTL</code> 缓存起来。</li>
</ul>
<p>下图描述了对这三个方法调用的上层函数：</p>
<p><img decoding="async" loading="lazy" src="https://firebasestorage.googleapis.com/v0/b/notiondiagram.appspot.com/o/diagram%2Fm5smUNzLG7NDZmSPY82qhFvWnsu1%2F1f53ecf5-6f63-4d06-a159-fee904341383.svg?alt=media&amp;token=9bddba43-f6c5-48d7-ac89-ea5aead3396b" alt="" class="img_ev3q"></p>
<p><code>Secret</code>  管理这块代码实现主要在 <code>pkg/kubelet/secret</code> 目录下，提供了一个统一的管理接口 <code>Manager</code> ,下面我们来看下它定义的方法：</p>
<p>它的定义和使用的原理都差不多。</p>
<p>下面我们来分析它是如何保存到宿主机上的，如何自动更新到容器中的；</p>
<p>首先我们要清楚容器里面的文件不是 <code>kubelet</code> 挂载到容器内部，是由容器运行时如 <code>Containerd</code> 这些组件在启动容器的时候 <code>Mount</code> 到容器内部的。</p>
<p><code>Kubelet</code> 这边能做到就是修改 <code>runtime spec</code> 中的内容， 就是描述容器运行时启动时的 <code>json</code> 文件。</p>
<p>所以热更新这里面涉及到两个东西，一个是把修改到 <code>ETCD</code> 中的 <code>Configmap</code> 或者 <code>Secret</code> 文件更新到容器所在的节点；第二个就是把更新到节点上的文件更新到容器里面。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="热更新到node">热更新到Node<a href="https://lengrongfu.github.io/blog/kubelet-configmap#%E7%83%AD%E6%9B%B4%E6%96%B0%E5%88%B0node" class="hash-link" aria-label="Direct link to 热更新到Node" title="Direct link to 热更新到Node">​</a></h3>
<p>这块主要是 <code>VolumeManager</code> 和 <code>ConfigMap Manager</code> 协调处理的结果，但是最终实现更新还是由 <code>SyncPod</code> 触发的。</p>
<p>![]<a href="https://firebasestorage.googleapis.com/v0/b/notiondiagram.appspot.com/o/diagram%2Fm5smUNzLG7NDZmSPY82qhFvWnsu1%2Fcf250449-1337-455b-9459-55962081d92f.svg?alt=media&amp;token=e5434e4c-3173-42b0-90ec-2e91600e4796" target="_blank" rel="noopener noreferrer">https://firebasestorage.googleapis.com/v0/b/notiondiagram.appspot.com/o/diagram%2Fm5smUNzLG7NDZmSPY82qhFvWnsu1%2Fcf250449-1337-455b-9459-55962081d92f.svg?alt=media&amp;token=e5434e4c-3173-42b0-90ec-2e91600e4796</a></p>
<p>从这个流程上可以看出即使 <code>ConfigMap</code> 更新了也不会马上更新到宿主机上，主要还是受 <code>SyncPod</code> 的周期影响，每执行一次 <code>SyncPod</code> 就会让 <code>reconciler</code> 有一次更新的机会。</p>
<p>在 <code>WaitForAttachAndMount</code> 中主要就是把 <code>processedPods</code> 中的一个处理标志改为 <code>false</code> . <code>Map</code> 的 <code>Key</code> 是 <code>Pod UID</code>.</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vm </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">volumeManager</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">WaitForAttachAndMount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pod </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	 vm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">desiredStateOfWorldPopulator</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ReprocessPod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uniquePodName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dswp </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">desiredStateOfWorldPopulator</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">markPodProcessingFailed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	podName volumetypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UniquePodName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	dswp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pods</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	dswp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pods</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">processedPods</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">podName</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	dswp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pods</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在 <a href="http://reconciler.run/" target="_blank" rel="noopener noreferrer"><code>reconciler.Run</code></a> 中定时进行协调，代码中配置的是 <code>100ms</code> 且不可修改，它会不断遍历 <code>desiredStateOfWorld</code> 和 <code>actualStateOfWorld</code> ，然后执行一系列的 <code>attach/detach</code> 和 <code>mount(remount)/unmount</code>等操作。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rc </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">reconciler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stopCh </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	rc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">reconstructVolumes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InfoS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Reconciler: start to sync state"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	wait</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Until</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reconcile</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 100ms</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> stopCh</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rc </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">reconciler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">reconcile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Next we mount required volumes. This function could also trigger</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// attach if kubelet is responsible for attaching volumes.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// If underlying PVC was resized while in-use then this function also handles volume</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// resizing.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	rc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">mountOrAttachVolumes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>接下来，我们挂载所需的卷。如果 <code>kubelet</code> 负责 <code>Attach</code> 卷，则此函数还可以触发 <code>Attach</code> 。如果在使用过程中调整了底层 <code>PVC</code> 的大小，则此函数还会处理卷大小调整。</p>
<p><code>VolumesToMount</code> 会被 <a href="http://desiredstateofworldpopulator.run/" target="_blank" rel="noopener noreferrer"><code>DesiredStateOfWorldPopulator.Run</code></a> 方法改变，这个方法执行过程会被 <code>processedPods</code> 影响，它主要找出 <code>desiredStateOfWorld</code> 期望处理的 <code>Volume</code> 和实际 <code>actualStateOfWorld</code> 状态的 <code>Volume</code> 。</p>
<p>之后调用 <code>PodExistsInVolume</code> 函数，根据返回的 <code>err</code> 来决定后续流程，如果是更新 <code>Mounte</code> 流程就进入 <code>mountAttachedVolumes</code> 方法中。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rc </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">reconciler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">mountOrAttachVolumes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Ensure volumes that should be attached/mounted are attached/mounted.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> volumeToMount </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> rc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">desiredStateOfWorld</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetVolumesToMount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		volMounted</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> devicePath</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> rc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">actualStateOfWorld</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">PodExistsInVolume</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">volumeToMount</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> volumeToMount</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VolumeName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> volumeToMount</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DesiredPersistentVolumeSize</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> volumeToMount</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SELinuxLabel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		volumeToMount</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DevicePath </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> devicePath</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">IsSELinuxMountMismatchError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">// The volume is mounted, but with an unexpected SELinux context.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">// It will get unmounted in unmountVolumes / unmountDetachDevices and</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">// then removed from actualStateOfWorld.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			rc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">desiredStateOfWorld</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">AddErrorToPod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">volumeToMount</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">continue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">IsVolumeNotAttachedError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			rc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">waitForVolumeAttach</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">volumeToMount</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">volMounted </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">IsRemountRequiredError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			rc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">mountAttachedVolumes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">volumeToMount</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">IsFSResizeRequiredError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			fsResizeRequiredErr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FsResizeRequiredError</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			rc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">expandVolume</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">volumeToMount</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fsResizeRequiredErr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CurrentSize</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这里面创建了一个 <code>NestedPendingOperations</code> 执行器，它会启动一个协程调用 <a href="http://generatedoperations.run/" target="_blank" rel="noopener noreferrer"><code>generatedOperations.Run</code></a> 方法来处理 <code>Mount</code>.</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">grm </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">nestedPendingOperations</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	volumeName v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UniqueVolumeName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	podName volumetypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UniquePodName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	nodeName types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NodeName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	generatedOperations volumetypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">GeneratedOperations</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	opExists</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> previousOpIndex </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> grm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">isOperationExists</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">opKey</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> opExists </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">//已经存在操作，</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// Create a new operation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		grm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">operations </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">grm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">operations</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			operation</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				key</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">              opKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				operationPending</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				operationName</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">    generatedOperations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OperationName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				expBackoff</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">       exponentialbackoff</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ExponentialBackoff</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 启动协程</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">eventErr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> detailedErr </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// Handle unhandled panics (very unlikely)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> k8sRuntime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">HandleCrash</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// Handle completion of and error, if any, from operationFunc()</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> grm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">operationComplete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">opKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">detailedErr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> generatedOperations</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在 <code>GeneratedOperations</code> 的结构体中定义了三个函数, <code>OperationFunc</code> 这是操作调用函数, <code>EventRecorderFunc</code> 事件记录函数, <code>CompleteFunc</code> 完成函数。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> GeneratedOperations </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Name of operation - could be used for resetting shared exponential backoff</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	OperationName     </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	OperationFunc     </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context OperationContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	EventRecorderFunc </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	CompleteFunc      </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CompleteFuncParam</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">o </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">GeneratedOperations</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">eventErr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> detailedErr </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> context OperationContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CompleteFunc </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		c </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> CompleteFuncParam</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			Err</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">      </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DetailedErr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			Migrated</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Migrated</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">CompleteFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EventRecorderFunc </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">EventRecorderFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">eventErr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Handle panic, if any, from operationFunc()</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RecoverFromPanic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">detailedErr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	context </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">OperationFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EventErr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DetailedErr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>下面我们看下这三个函数是怎么定义的：</p>
<ul>
<li><code>eventRecorderFunc</code> : 主要就是把 <code>Mount</code> 的错误信息发送到 <code>Pod</code> 的事件记录中去。</li>
</ul>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">eventRecorderFunc </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err </span><span class="token operator" style="color:#393A34">*</span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			og</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recorder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Eventf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">volumeToMount</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EventTypeWarning</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> kevents</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FailedMountVolume</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Error</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><code>CompleteFunc</code>: 主要就是记录一些 <code>Metric</code></li>
</ul>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">OperationCompleteHook</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">plugin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> operationName </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CompleteFuncParam</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	requestTime </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	opComplete </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CompleteFuncParam</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		timeTaken </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Since</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">requestTime</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Seconds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// Create metric with operation name and plugin name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		status </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> statusSuccess</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">// TODO: Establish well-known error codes to be able to distinguish</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">// user configuration errors from system errors.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			status </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> statusFailUnknown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		migrated </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Migrated </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			migrated </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Migrated</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		StorageOperationMetric</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithLabelValues</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">plugin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> operationName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> status</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> strconv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FormatBool</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">migrated</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Observe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">timeTaken</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> opComplete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><code>OperationFunc</code> : 这个函数里面逻辑很复杂，下面会删除很多不重要的代码，核心的就是调用 <code>Volume</code> 的 <code>SetUp</code> 方法。</li>
</ul>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mountVolumeFunc </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> volumetypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OperationContext </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// Get mounter plugin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		volumePlugin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> og</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">volumePluginMgr</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FindPluginBySpec</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">volumeToMount</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VolumeSpec</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		volumeMounter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newMounterErr </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> volumePlugin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewMounter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			volumeToMount</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VolumeSpec</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			volumeToMount</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// Execute mount</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		mountErr </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> volumeMounter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetUp</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">volume</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MounterArgs</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			FsUser</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">              util</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FsUserFrom</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">volumeToMount</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			FsGroup</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">             fsGroup</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			DesiredSize</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">         volumeToMount</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DesiredSizeLimit</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			FSGroupChangePolicy</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> fsGroupChangePolicy</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			SELinuxLabel</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">        volumeToMount</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SELinuxLabel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> volumetypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewOperationContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> migrated</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>SetUp</code>这个方法每个存储类型都有实现，这里我们重点看下 <code>Configmap</code> 是如何实现的；</p>
<p>在讨论实现之前我们先分析一下它存储在宿主机上什么位置？代码主要由下面的函数实现，它主要是由各种值组合而成，最后得到的存储路径是：</p>
<p><code>/var/lib/kubelet/pods/&lt;pod的UUI&gt;/volumes/kubernetes.io~configmap/&lt;卷名&gt;</code></p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sv </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">configMapVolume</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetPath</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> sv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plugin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">host</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetPodVolumeDir</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">podUID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> utilstrings</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">EscapeQualifiedName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">configMapPluginName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">volName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>最后我们再来看 <code>SetUpAt</code> 的实现</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">configMapVolumeMounter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SetUpAt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dir </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mounterArgs volume</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MounterArgs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">V</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Infof</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Setting up volume %v for pod %v at %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">volName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dir</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	configMap</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">getConfigMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Namespace</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	totalBytes </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">totalBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">configMap</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	payload</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">MakePayload</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Items</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> configMap</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">source</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DefaultMode</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> optional</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	setupSuccess </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">setupSuccess </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		  </span><span class="token comment" style="color:#999988;font-style:italic">// setup 失败就清理目录</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			unmounter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> unmountCreateErr </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plugin</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewUnmounter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">volName</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">podUID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			tearDownErr </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> unmounter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">TearDown</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	writerContext </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"pod %v/%v volume %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Namespace</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pod</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">volName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 这里创建了一个原子 Writer 对象，可以保证修改宿主机上的configmap文件是原子的。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	writer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> volumeutil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewAtomicWriter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dir</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> writerContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	setPerms </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// This may be the first time writing and new files get created outside the timestamp subdirectory:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// change the permissions on the whole volume and not only in the timestamp directory.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> volume</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SetVolumeOwnership</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dir</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mounterArgs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FsGroup</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/*fsGroupChangePolicy*/</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> volumeutil</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FSGroupCompleteHook</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plugin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> writer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">payload</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> setPerms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	setupSuccess </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>AtomicWriter</code> 的实现代码路径 <code>atomic_writer.go</code> , 这里面保证了原子更新 <code>Configmap</code> ; 这里不再赘述具体实现，详细可以看代码注释；这里简单总结一下；</p>
<ol>
<li>在<code>/var/lib/kubelet/pods/&lt;pod的UUI&gt;/volumes/kubernetes.io~configmap/&lt;卷名&gt;</code> 目录下看到的文件是软链到 <code>..data/</code> 目录下的真实文件；</li>
<li><code>Write</code> 在写的时候会写入到一个 <code>..data_tmp</code>  目录下；</li>
<li>然后执行 <code>os.Rename</code> 操作，把 <code>..data_tmp</code> 重命名为 <code>..data</code> ; 因为这个动作是原子的，所以能保证 <code>Mount</code> 的 <code>Configmap</code> 的文件是原子更新的。</li>
</ol>
<p><img decoding="async" loading="lazy" src="https://firebasestorage.googleapis.com/v0/b/notiondiagram.appspot.com/o/diagram%2Fm5smUNzLG7NDZmSPY82qhFvWnsu1%2F54d877c6-73d0-4169-9368-d3b3b14a7eee.svg?alt=media&amp;token=a473ed92-3dee-4b8f-8155-2afd06db647c" alt="" class="img_ev3q"></p>
<p>只要更新到宿主机的 <code>mount</code> 目录下之后，容器内部就会自动获取最新的文件内容。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="热更新到容器">热更新到容器<a href="https://lengrongfu.github.io/blog/kubelet-configmap#%E7%83%AD%E6%9B%B4%E6%96%B0%E5%88%B0%E5%AE%B9%E5%99%A8" class="hash-link" aria-label="Direct link to 热更新到容器" title="Direct link to 热更新到容器">​</a></h3>
<p>把宿主机上的文件热更新到容器内部这是容器运行时具备的能力，这里先不深入赘述；下面我们以一个例子来说明这一功能。</p>
<p><img decoding="async" loading="lazy" src="https://firebasestorage.googleapis.com/v0/b/notiondiagram.appspot.com/o/diagram%2Fm5smUNzLG7NDZmSPY82qhFvWnsu1%2Fa6fe7a11-6563-4c60-ae26-4f3ead66413e.svg?alt=media&amp;token=d747c3e4-93bd-4262-90f7-c0280fbf54ac" alt="" class="img_ev3q"></p>
<p>按上图来看我们启动一个容器，把宿主机上的 <code>/tmp/test.json</code> 文件挂载到容器的 <code>/config/test.json</code> 文件上；</p>
<p>然后我们通过修改宿主机上的文件可以观察到容器内部的文件自动发送了改变。</p>
<ul>
<li><code>/tmp/test.json</code></li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat /tmp/test.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "name":"test"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>启动容器</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ nerdctl run -it --mount type=bind,source=/tmp/test.json,target=/config/test.json docker.io/library/ubuntu:22.04 /bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cat /config/test.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "name":"test"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>修改宿主机上的文件</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ vim /tmp/test.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "name":"abc"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>再次查看容器中文件</li>
</ul>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ cat /config/test.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  "name":"abc"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上面只是以 <code>ConfigMap</code> 为例讲了原理，但是 <code>Secret</code> 也是一样的实现；</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="configmap-在env使用">ConfigMap 在Env使用<a href="https://lengrongfu.github.io/blog/kubelet-configmap#configmap-%E5%9C%A8env%E4%BD%BF%E7%94%A8" class="hash-link" aria-label="Direct link to ConfigMap 在Env使用" title="Direct link to ConfigMap 在Env使用">​</a></h3>
<p><code>ConfigMap</code> 和 <code>Secret</code> 除了可以在 <code>Volume</code> 中使用，还可以在 <code>Env</code> 中使用，当时区别就是在 <code>Env</code> 中使用不能实现热更新。</p>
<p>它在生成运行时的 <code>Option</code> 的时候就会读取 <code>ConfigMap</code> 的值替换到 <code>Env</code> 变量中去，具体的看 <code>makeEnvironmentVariables</code> 这个方法就清楚了。</p>]]></content:encoded>
            <category>Kubernetes</category>
            <category>Kubelet</category>
        </item>
        <item>
            <title><![CDATA[Kubelet 源码分析 volumeManager]]></title>
            <link>https://lengrongfu.github.io/blog/kubelet-volumemanager</link>
            <guid>https://lengrongfu.github.io/blog/kubelet-volumemanager</guid>
            <pubDate>Sun, 01 Sep 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[VolumeManager 运行一组异步循环，根据该节点上调度的 pod 确定需要 attached/mounted/unmounted/detached 哪些卷，并执行此操作。]]></description>
            <content:encoded><![CDATA[<p><code>VolumeManager</code> 运行一组异步循环，根据该节点上调度的 <code>pod</code> 确定需要 <code>attached/mounted/unmounted/detached</code> 哪些卷，并执行此操作。</p>
<p>下面我们来分析 <code>VolumeManager</code> 定义的接口，</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> VolumeManager </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Starts the volume manager and all the asynchronous loops that it controls</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 启动这个volume manager和异步循环控制器</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">Run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sourcesReady config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SourcesReady</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// WaitForAttachAndMount 处理指定 pod 中引用的卷并阻塞，直到它们全部连接并挂载（反映在实际状态中）。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 如果未在 podAttachAndMountTimeout 定义的持续时间内连接并挂载所有卷，则会返回错误。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">WaitForAttachAndMount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pod </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// WaitForUnmount 处理指定 pod 中引用的卷并阻塞，直到它们全部卸载（反映在实际状态中）。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 如果未在 podAttachAndMountTimeout 定义的持续时间内卸载所有卷，则会返回错误。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">WaitForUnmount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pod </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// GetMountedVolumesForPod 返回一个 VolumeMap，其中包含指定 pod 引用的已成功附加和挂载的卷。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 映射中的键是 OuterVolumeSpecName（即 pod.Spec.Volumes[x].Name）。如果 pod 没有卷，则返回一个空的 VolumeMap。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">GetMountedVolumesForPod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">podName types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UniquePodName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> container</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VolumeMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// GetPossiblyMountedVolumesForPod 返回一个 VolumeMap，其中包含指定 pod 引用的卷，</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 这些卷要么已成功连接并挂载，要么“不确定”，即卷插件可能正在挂载它们。映射中的键是 OuterVolumeSpecName（即 pod.Spec.Volumes[x].Name）。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 如果 pod 没有卷，则返回一个空的 VolumeMap。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">GetPossiblyMountedVolumesForPod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">podName types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UniquePodName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> container</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VolumeMap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// GetExtraSupplementalGroupsForPod 返回 Pod 的额外补充组列表。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 这些额外的补充组来自 Pod 所依赖的持久卷上的注释。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">GetExtraSupplementalGroupsForPod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pod </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">int64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// GetVolumesInUse 返回所有实现 volume.Attacher 接口的卷的列表，这些卷当前根据缓存的实际状态和期望状态处于使用状态。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 卷一旦添加到期望的状态，即被视为“正在使用”，表明它*应该*连接到此节点并保持“正在使用”状态，直到它从期望的状态和实际的状态中移除，</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 或者它已被卸载（如实际的世界状态所示）。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">GetVolumesInUse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UniqueVolumeName</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 仅当 kubelet 启动后协调器中的实际状态至少同步一次后，ReconcilerStatesHasBeenSynced 才会返回 true，</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 以便可以安全地更新从实际状态检索到的已挂载卷列表。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">ReconcilerStatesHasBeenSynced</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 如果给定的卷已附加到此节点，则 VolumeIsAttached 返回 true。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">VolumeIsAttached</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">volumeName v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UniqueVolumeName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 将指定卷标记为已在节点的卷状态中成功报告为“正在使用”。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">MarkVolumesAsReportedInUse</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">volumesReportedAsInUse </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UniqueVolumeName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>启动 <code>VolumeManager</code> 是在 <code>Kubelet.go</code> 的 <code>Run</code> 方法中：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kl </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Kubelet</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">updates </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> kubetypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodUpdate</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> kl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">volumeManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> kl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sourcesReady</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>WaitForAttachAndMount</code> 是在 <code>Pod</code> 同步的时候会调用，如果当前同步的 <code>Pod</code> 没有 <code>Attach</code> 和 <code>Mount</code> 成功，则会进行返回继续让 <code>podWorkerLoop</code> 进行执行。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kl </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Kubelet</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SyncPod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updateType kubetypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SyncPodType</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mirrorPod </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> podStatus </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">kubecontainer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodStatus</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">isTerminal </span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Wait for volumes to attach/mount</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> kl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">volumeManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WaitForAttachAndMount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">wait</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Interrupted</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			kl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recorder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Eventf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EventTypeWarning</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> events</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FailedMountVolume</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Unable to attach or mount volumes: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ErrorS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Unable to attach or mount volumes for pod; skipping pod"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"pod"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">KObj</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>WaitForUnmount</code> 是在 <code>Pod</code> 已终止时进行调用，需要等待 <code>Unmount</code> . 这里会阻塞进行等待，直到成功或者错误，但是在 <code>SyncTerminatedPod</code> 并没有处理返回错误的类型，也就意味着即使 <code>Unmount</code> 失败了也会执行 <code>Pod</code> 删除。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">kl </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Kubelet</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SyncTerminatedPod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pod </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> podStatus </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">kubecontainer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodStatus</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> kl</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">volumeManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WaitForUnmount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>下面我们来分析下 <code>volumeManager</code> 结构体的定义，和具体的 <code>VolumeManager</code> 的实现</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> volumeManager </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// volumePluginMgr 是用于访问卷插件的卷插件管理器。它必须预先初始化。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	volumePluginMgr </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">volume</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VolumePluginMgr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// desireStateOfWorld 是一个数据结构，包含管理器所定义的期望状态：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 即应附加哪些卷以及哪些 pod 正在引用这些卷。数据结构由 kubelet pod 管理器使用的状态填充器填充。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	desiredStateOfWorld cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DesiredStateOfWorld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// actualStateOfWorld 是一个数据结构，包含管理器所定义的实际状态：</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 即哪些卷连接到此节点以及这些卷挂载到哪些 pod。协调器触发的挂载、分离、挂载和卸载操作成功完成后，将填充该数据结构。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	actualStateOfWorld cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ActualStateOfWorld</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// operationExecutor 用于启动异步附加、分离、挂载和卸载操作。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	operationExecutor operationexecutor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OperationExecutor</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// reconciler runs an asynchronous periodic loop to reconcile the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// desiredStateOfWorld with the actualStateOfWorld by triggering attach,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// detach, mount, and unmount operations using the operationExecutor.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	reconciler reconciler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Reconciler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// desireStateOfWorldPopulator 运行一个异步周期循环，使用 kubelet PodManager 填充 desireStateOfWorld。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	desiredStateOfWorldPopulator populator</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DesiredStateOfWorldPopulator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// csiMigratedPluginManager 跟踪插件的 CSI 迁移状态</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	csiMigratedPluginManager csimigration</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PluginManager</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// intreeToCSITranslator 将树内卷规范转换为 CSI</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	intreeToCSITranslator csimigration</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InTreeToCSITranslator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在调用 <code>volumeManager.run</code>  之后会启动三个协程，分别是 <code>List-Watch</code> 资源 <code>CSIDrivers</code> , 一个是启动一个 <code>dswp</code> 的协程，去更新 <code>desiredStateOfWorld</code> 和 <code>actualStateOfWorld</code> , 一个是协调协程，它会根据当前 <code>Pod</code> 期望的 <code>Volume</code> 状态和实际状态进行处理，决定是需要 <code>Mount</code> 还是 <code>UnMount</code>.</p>
<p><img decoding="async" loading="lazy" src="https://firebasestorage.googleapis.com/v0/b/notiondiagram.appspot.com/o/diagram%2Fm5smUNzLG7NDZmSPY82qhFvWnsu1%2Fe27e3b5b-dbcb-40eb-b33c-0cefa08335b9.svg?alt=media&amp;token=8aaa9c51-1cce-4905-acff-6644eb79ac32" alt="" class="img_ev3q"></p>
<p><code>volumePluginMgr</code> 需要通过注册的 <code>Volume</code> 插件进行初始化，默认注册的插件如下：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ProbeVolumePlugins</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">featureGate featuregate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FeatureGate</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">volume</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VolumePlugin</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	allPlugins </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">volume</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VolumePlugin</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	allPlugins </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">allPlugins</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> emptydir</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ProbeVolumePlugins</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	allPlugins </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">allPlugins</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> git_repo</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ProbeVolumePlugins</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	allPlugins </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">allPlugins</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hostpath</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ProbeVolumePlugins</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">volume</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VolumeConfig</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	allPlugins </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">allPlugins</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nfs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ProbeVolumePlugins</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">volume</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">VolumeConfig</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	allPlugins </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">allPlugins</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> secret</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ProbeVolumePlugins</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	allPlugins </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">allPlugins</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> iscsi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ProbeVolumePlugins</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	allPlugins </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">allPlugins</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> downwardapi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ProbeVolumePlugins</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	allPlugins </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">allPlugins</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ProbeVolumePlugins</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	allPlugins </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">allPlugins</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> configmap</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ProbeVolumePlugins</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	allPlugins </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">allPlugins</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> projected</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ProbeVolumePlugins</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	allPlugins </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">allPlugins</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> local</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ProbeVolumePlugins</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	allPlugins </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">allPlugins</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> csi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ProbeVolumePlugins</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> featureGate</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Enabled</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">features</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ImageVolume</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		allPlugins </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">allPlugins</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> image</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ProbeVolumePlugins</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> allPlugins</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>每个插件都需要实现 <code>VolumePlugin</code>  接口中的方法，特别是 <code>Init</code> 方法需要在初始化 <code>VolumePluginMgr</code> 时候调用 <code>InitPlugins</code> 循环的把所有注册的插件都初始化。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> VolumePlugin </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Init initializes the plugin.  This will be called exactly once</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// before any New* calls are made - implementations of plugins may</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// depend on this.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">Init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">host VolumeHost</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// NewMounter creates a new volume.Mounter from an API specification.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Ownership of the spec pointer in *not* transferred.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// - spec: The v1.Volume spec</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// - pod: The enclosing pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">NewMounter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">spec </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> podRef </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Mounter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// NewUnmounter creates a new volume.Unmounter from recoverable state.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// - name: The volume name, as per the v1.Volume spec.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// - podUID: The UID of the enclosing pod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">NewUnmounter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">name </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> podUID types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Unmounter</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>总结：</p>
<p><code>volumeManager</code> 通过 <code>actualStateOfWorld</code> 和 <code>desiredStateOfWorld</code> 来表明当前的 <code>volume</code> 挂载状态和期望的 <code>volume</code> 挂载状态。然后由 <code>desiredStateOfWorldPopulator</code> 维护 <code>desireedStateOfWorld</code> 和 <code>podManager</code> 的一致性；</p>
<p>由 <code>reconcile</code> 维护 <code>actualStateOfWorld</code> 和 <code>desiredStateOfWorld</code> 的一致性及磁盘 <code>volume</code> 挂载和 <code>actualStateOfWorld</code> 的一致性。通过这些机制，<code>volumeManager</code> 完成了 <code>volume</code> 挂载生命周期的管理。</p>]]></content:encoded>
            <category>Kubernetes</category>
            <category>Kubelet</category>
        </item>
        <item>
            <title><![CDATA[kubelet源码分析 podManager和podWorkers、workQueue]]></title>
            <link>https://lengrongfu.github.io/blog/kubelet-five-analyze</link>
            <guid>https://lengrongfu.github.io/blog/kubelet-five-analyze</guid>
            <pubDate>Sat, 31 Aug 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[在 Kubelet 源码分析工作原理中介绍过, Kubelet 中有两个核心的数据结构字段, podManager 和 podWorkers, 现在我们来一探究竟。]]></description>
            <content:encoded><![CDATA[<p>在 <code>Kubelet</code> 源码分析工作原理中介绍过, <code>Kubelet</code> 中有两个核心的数据结构字段, <strong><code>podManager</code></strong> 和 <strong><code>podWorkers</code></strong>, 现在我们来一探究竟。</p>
<p><strong><code>podManager</code></strong> 和 <strong><code>podWorkers</code></strong> 里面保存的 <code>Pod</code> 内容可能不一样，比如：</p>
<ul>
<li>强制删除 <code>Pod</code> 时，会把 <strong><code>podManager</code></strong>  中的记录删除掉，但是**<code>podWorkers</code>**  中的 <code>Pod</code> 会执行正常的删除流程；此时就出现 <strong><code>podManager</code></strong> 不存在**，<code>podWorkers</code>** 存在的问题**。**</li>
<li>新创建的 <code>Pod</code> 会先保存到 <code>podManager</code> 中，启动时再保存到 <code>podWorkers</code> 中。</li>
</ul>
<p>它们要做的就是无限趋近于一样。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="mirrorpod">MirrorPod<a href="https://lengrongfu.github.io/blog/kubelet-five-analyze#mirrorpod" class="hash-link" aria-label="Direct link to MirrorPod" title="Direct link to MirrorPod">​</a></h2>
<p>在 <code>PodManager</code> 中存在 <code>podByFullName</code> 和 <code>mirrorPodByFullName</code> 的两个字段，分别保存 <code>Pod</code> 信息和 <code>MirrorPod</code> 的。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">	podByFullName       </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mirrorPodByFullName </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>pod</code> 来源分为 <code>file</code>  <code>http</code>  <code>apiserver</code> 三个 <code>source</code> , 其中 <code>apiserver</code> 中的 <code>pod</code> 称为普通<code>pod</code>，其他来源的 <code>pod</code> 称为 <code>static pod</code>, 为了管理 <code>pod</code> 方便, <code>kubelet</code> 会在 <code>apiserver</code> 上为<code>static pod</code> 生成对应的 <code>pod</code>，这类型 <code>pod</code> 称为 <code>mirror pod</code> .</p>
<p>即可以理解是这个 <code>pod</code> 的替身, 基本上跟 <code>static pod</code>一模一样，只有 <code>uid</code> 不一样和 <code>annotations</code> 里多了 <code>kubernetes.io/config.mirror</code> .</p>
<p><code>mirror pod</code> 是保存在 <code>apiserver</code> 中的 <code>static pod</code> 的一个镜像，但是操作 <code>mirror pod</code> 对 <code>static pod</code> 的影响是不一样的。</p>
<p><img decoding="async" loading="lazy" alt="image.png" src="https://lengrongfu.github.io/assets/images/mirror-delete-pod-35079e6f8ad51f2f5e61e1b69c42566f.png" width="1025" height="382" class="img_ev3q"></p>
<p>如果要删除 <code>static pod</code> ,比如是从文件创建的，则需要删除文件才能删除这个 <code>static pod</code> 和 <code>mirror pod</code> .</p>
<p><strong>static pod移除流程:</strong></p>
<ol>
<li><code>podConfig</code> 感知到 <code>static</code> 文件的移除，触发 <code>SyncLoop REMOVE</code></li>
<li><code>podWoker</code> 执行 <code>syncTerminatingPod</code>（执行停止容器和 <code>sandbox</code>）</li>
<li><code>PLEG</code> 感知到 <code>sanbox</code> 和 <code>container</code> 的退出</li>
<li><code>podWoker</code> 执行 <code>syncTerminatedPod</code>（移除 <code>cgroup</code>，更新 <code>mirror pod</code>的 <code>status</code>，等待pod 的 <code>volume umount</code> 完成）</li>
<li>感知到 <code>mirror pod</code> 的 <code>status</code> 更新</li>
<li><code>housekeeping</code> 触发，执行清理工作（ <code>podWorker</code> 的移除 <code>mirror pod</code> 的删除 <code>pod volume</code> 目录移除）</li>
<li>感知到 <code>mirror pod</code> 的删除和从 <code>apiserver</code>上移除</li>
<li><code>garbageCollector</code> 执行 <code>sandbox</code> 和容器的清理，并移除 <code>pod</code> 日志目录</li>
</ol>
<p><img decoding="async" loading="lazy" alt="image.png" src="https://lengrongfu.github.io/assets/images/static-delete-pod-376d5405cb5a938fb9dcdd8e5a6019a8.png" width="1495" height="513" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="podmanager">podManager<a href="https://lengrongfu.github.io/blog/kubelet-five-analyze#podmanager" class="hash-link" aria-label="Direct link to podManager" title="Direct link to podManager">​</a></h2>
<p><code>podManager</code> 主要是存储应该在 <code>kubelet</code> 上运行的 <code>Pod</code> 的集合，它包括 <code>admitted pods</code> 和 <code>mirror pods</code> .</p>
<p><code>podManager</code> 的数据由 <code>kubelet</code> 写入，主要是接收不同来源  <code>API</code> <code>URL</code> <code>Static Fiel</code> ，最后写入到 <strong><code>podUpdateCh</code></strong> 这个 <strong><code>chan</code>.</strong></p>
<p>我们把 <code>Manager</code> 这个接口的方法按功能划分</p>
<ul>
<li>
<p>读</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">GetPodByFullName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">podFullName </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">GetPodByName</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">namespace</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> name </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">GetPodByUID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">GetPodByMirrorPod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">GetMirrorPodByPod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">GetPodAndMirrorPod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mirrorPod </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> wasMirror </span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">GetPods</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">GetPodsAndMirrorPods</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">allPods </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> allMirrorPods </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> orphanedMirrorPodFullnames </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">TranslatePodUID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">uid types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UID</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> kubetypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ResolvedPodUID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">GetUIDTranslations</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">podToMirror </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kubetypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ResolvedPodUID</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">kubetypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MirrorPodUID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mirrorToPod </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">kubetypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MirrorPodUID</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">kubetypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ResolvedPodUID</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>写</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token function" style="color:#d73a49">SetPods</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pods </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> #已经未使用了，不分析</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">AddPod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pod </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">UpdatePod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pod </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">RemovePod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pod </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ul>
<p>我们主要来分析下写的这几个操作流程：</p>
<p><img decoding="async" loading="lazy" src="https://firebasestorage.googleapis.com/v0/b/notiondiagram.appspot.com/o/diagram%2Fm5smUNzLG7NDZmSPY82qhFvWnsu1%2F22b7bc7d-7fc7-4db3-be5e-edefe4f87cfd.svg?alt=media&amp;token=a917d00f-1d65-4b82-8fa6-d0f33595f64d" alt="a" class="img_ev3q"></p>
<p>它从 <code>PodUpdate</code> 接收到操作之后会按照 <code>PodOperation</code> 类型来区分操作方法，目前使用了五种操作方法，最终对应到 <code>podManager</code> 上有三个操作方法。</p>
<p>主执行上述四种方法的时候会执行 <code>podWorkers</code> 的 <code>UpdatePod</code> 方法,就是调用不同的 <code>UpdatePodOptions</code> 操作类型，分别对应四种 <code>Option</code> , 其中需要根据这个 <code>Pod</code> 是否是 <code>MirrorPod</code> 来决定它的操作类型。</p>
<p><img decoding="async" loading="lazy" src="https://firebasestorage.googleapis.com/v0/b/notiondiagram.appspot.com/o/diagram%2Fm5smUNzLG7NDZmSPY82qhFvWnsu1%2F2fed5e50-56ef-4e06-9e72-4f107bd08551.svg?alt=media&amp;token=96e8476f-98a9-43ce-97c9-239599e59c1e" alt="a" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="podworkers">podWorkers<a href="https://lengrongfu.github.io/blog/kubelet-five-analyze#podworkers" class="hash-link" aria-label="Direct link to podWorkers" title="Direct link to podWorkers">​</a></h2>
<p><code>podWorkers</code> 简单说就是通过控制 <code>Pod</code> 的生命周期来更新 <code>Pod</code> 的真实状态，每个 <code>Pod</code> 会有一个协程执行 <code>podWorkerLoop</code> 。</p>
<p>我们来分析下 <code>PodWorkers</code> 的方法：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> PodWorkers </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 通过 podworker pod 发送改变，然后pod会按照FIFO的顺序进入自己的协程处理，podUID是协程的key，</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 然后进入 syncPod 方法会直到被kubelet驱逐或者是标记deleted、Succeeded、Failed，一旦发生驱逐或者delete</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// syncTerminatingPod 方法将被调用，后续的UpdatePod调用都将被忽略，直到它成功，终止的pod不会被启动。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">UpdatePod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">options UpdatePodOptions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>UpdatePodOptions</code> 结构体分析：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> UpdatePodOptions </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">//更新类型(create, update, sync, kill).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	UpdateType kubetypes</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">SyncPodType</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Pod to update. Required.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Pod </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// MirrorPod is the mirror pod if Pod is a static pod. Optional when UpdateType</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// is kill or terminated.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	MirrorPod </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// RunningPod 不再存在的运行时 pod，只有执行PodCleanup的时候才会不为空</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	RunningPod </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">kubecontainer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// KillPodOptions 用于覆盖 pod 的默认终止行为或在操作完成后更新 pod 状态。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	KillPodOptions </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">KillPodOptions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们来分析 <code>podWorkers</code> 的结构体：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> podWorkers </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	podUpdates </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UID</span><span class="token punctuation" style="color:#393A34">]</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// WorkQueue 允许使用时间戳对项目进行排队。如果时间戳已过期，则项目将被视为已准备好进行处理。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	workQueue queue</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">WorkQueue</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 这个函数名字就叫podSyncer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	podSyncer podSyncer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="https://firebasestorage.googleapis.com/v0/b/notiondiagram.appspot.com/o/diagram%2Fm5smUNzLG7NDZmSPY82qhFvWnsu1%2Fd3660f8b-b079-48a3-935f-f409c3745cfc.svg?alt=media&amp;token=2c2cf998-a701-41f9-a923-78e7d6757c63" alt="a" class="img_ev3q"></p>
<p><code>syncPod</code> 是整个 <code>kubelet</code> 的核心，pod 的创建与删除都由它来处理。由于 <code>syncPod()</code> 涉及到太多的 <code>kubelet</code> 中功能包，所以等 <code>volumeManager</code>, <code>podManager</code> 等介绍完毕再详细分析。现在只需知道 <code>syncPod()</code> 会处理传进来的 <code>pod</code>，维护物理机上的 <code>pod</code> 和 <code>etcd</code> 中的 <code>pod</code> 的一致性。</p>
<p>存在一个疑问：Pod 是被夺协程并行的处理的，那针对资源分配是否会存在竞争关系。这个留到后面去分析。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="workqueue">workQueue<a href="https://lengrongfu.github.io/blog/kubelet-five-analyze#workqueue" class="hash-link" aria-label="Direct link to workQueue" title="Direct link to workQueue">​</a></h2>
<p><code>workQueu</code> 是一个允许使用时间戳对项目进行排队的 <code>Queue</code> , 如果时间戳已过期，则项目将被视为已准备好进行处理。</p>
<p><code>WorkQueue</code> 只包括两个核心的方法, <code>GetWork()</code> 返回的是所有已经准备好的 <code>Worker</code> .</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> WorkQueue </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// GetWork dequeues and returns all ready items.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">GetWork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Enqueue inserts a new item or overwrites an existing item.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">Enqueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">item types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> delay time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Duration</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>basicWorkQueue</code> 的内部结构是一个 <code>Map</code>: <code>key</code> 是一个 <code>UID</code>, <code>value</code> 时一个 <code>Time</code>.</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> basicWorkQueue </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	clock clock</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Clock</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	lock  sync</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Mutex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	queue </span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UID</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Time</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>Kubernetes</category>
            <category>Kubelet</category>
        </item>
        <item>
            <title><![CDATA[kubelet源码分析 syncLoopIteration（三） probeCH]]></title>
            <link>https://lengrongfu.github.io/blog/kubelet-fore-analyze</link>
            <guid>https://lengrongfu.github.io/blog/kubelet-fore-analyze</guid>
            <pubDate>Fri, 30 Aug 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[在代码中是没有 probeCh 这个 chan 的，主要是由 livenessManager readinessManager startupManager 这三个探针的 chan 构成的。]]></description>
            <content:encoded><![CDATA[<p>在代码中是没有 <code>probeCh</code> 这个 <code>chan</code> 的，主要是由 <code>livenessManager</code> <code>readinessManager</code> <code>startupManager</code> 这三个探针的 <code>chan</code> 构成的。</p>
<p>它们的核心实现在  <code>probeManager prober.Manager</code> 上。</p>
<p><img decoding="async" loading="lazy" src="https://firebasestorage.googleapis.com/v0/b/notiondiagram.appspot.com/o/diagram%2Fm5smUNzLG7NDZmSPY82qhFvWnsu1%2Ff8dcda60-944c-4a62-8c8f-61fcd9f9dfcd.svg?alt=media&amp;token=c0378f71-cc9c-4c0a-b023-86555e7fbe37" alt="probch.png" class="img_ev3q"></p>
<p><code>probeCh</code> 是分别代表三个  <code>chan</code> ,分别是 <code>livenessCh</code> <code>readinessCh</code> <code>startupCh</code> ,在图中进行了统一，但是 <code>code</code> 中是三个通道。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="probemanager">ProbeManager<a href="https://lengrongfu.github.io/blog/kubelet-fore-analyze#probemanager" class="hash-link" aria-label="Direct link to ProbeManager" title="Direct link to ProbeManager">​</a></h3>
<p>Manager会为每个指定了探测的容器创建一个探测“worker”（AddPod方法）。这些worker会定期对其分配的容器进行探测，并将结果缓存起来。当需要更新Pod的状态（PodStatus）时，Manager会利用这些缓存的探测结果来设置Pod的Ready状态（UpdatePodStatus方法）。需要注意的是，目前不支持更新探测参数。</p>
<p><code>Manager</code> 会为每个指定来探测的容器都创建一个 <code>worker</code>, 这些 <code>worker</code> 会定期对其分配的容器进行探测，并缓存结果，更新 <code>pod</code> 状态时会利用这些参数来更新。</p>
<div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">type Manager interface {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// AddPod creates new probe workers for every container probe. This should be called for every</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// pod created.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	AddPod(pod *v1.Pod)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// StopLivenessAndStartup handles stopping liveness and startup probes during termination.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	StopLivenessAndStartup(pod *v1.Pod)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// RemovePod handles cleaning up the removed pod state, including terminating probe workers and</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// deleting cached results.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	RemovePod(pod *v1.Pod)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// CleanupPods handles cleaning up pods which should no longer be running.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// It takes a map of "desired pods" which should not be cleaned up.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	CleanupPods(desiredPods map[types.UID]sets.Empty)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// UpdatePodStatus modifies the given PodStatus with the appropriate Ready state for each</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	// container based on container running status, cached probe results and worker states.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	UpdatePodStatus(*v1.Pod, *v1.PodStatus)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在 <code>AddPod</code> 方法中实现了遍历所有 <code>container</code> ，然后挣对配置的不同探针，启动 <code>work</code>,每个探针使用一个协程运行。</p>
<div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func (m *manager) AddPod(pod *v1.Pod) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	m.workerLock.Lock()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	defer m.workerLock.Unlock()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	key := probeKey{podUID: pod.UID}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	for _, c := range append(pod.Spec.Containers, getRestartableInitContainers(pod)...) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		key.containerName = c.Name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if c.StartupProbe != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			key.probeType = startup</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			if _, ok := m.workers[key]; ok {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			w := newWorker(m, startup, pod, c)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			m.workers[key] = w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			go w.run()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if c.ReadinessProbe != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			key.probeType = readiness</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			if _, ok := m.workers[key]; ok {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			w := newWorker(m, readiness, pod, c)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			m.workers[key] = w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			go w.run()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if c.LivenessProbe != nil {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			key.probeType = liveness</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			if _, ok := m.workers[key]; ok {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				return</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			w := newWorker(m, liveness, pod, c)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			m.workers[key] = w</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			go w.run()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>往下就是根据配置的探针类型调用探测逻辑：</p>
<div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func (pb *prober) runProbe(ctx context.Context, probeType probeType, p *v1.Probe, pod *v1.Pod, status v1.PodStatus, container v1.Container, containerID kubecontainer.ContainerID) (probe.Result, string, error) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	switch {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	case p.Exec != nil:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		command := kubecontainer.ExpandContainerCommandOnlyStatic(p.Exec.Command, container.Env)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return pb.exec.Probe(pb.newExecInContainer(ctx, container, containerID, command, timeout))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	case p.HTTPGet != nil:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		req, err := httpprobe.NewRequestForHTTPGetAction(p.HTTPGet, &amp;container, status.PodIP, "probe")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return pb.http.Probe(req, timeout)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	case p.TCPSocket != nil:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		port, err := probe.ResolveContainerPort(p.TCPSocket.Port, &amp;container)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return pb.tcp.Probe(host, port, timeout)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	case p.GRPC != nil:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		host := status.PodIP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return pb.grpc.Probe(host, service, int(p.GRPC.Port), timeout)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	default:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		klog.InfoS("Failed to find probe builder for container", "containerName", container.Name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		return probe.Unknown, "", fmt.Errorf("missing probe handler for %s:%s", format.Pod(pod), container.Name)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="livenessmanagerreadinessmanagerstartupmanager">livenessManager、readinessManager、startupManager<a href="https://lengrongfu.github.io/blog/kubelet-fore-analyze#livenessmanagerreadinessmanagerstartupmanager" class="hash-link" aria-label="Direct link to livenessManager、readinessManager、startupManager" title="Direct link to livenessManager、readinessManager、startupManager">​</a></h3>
<p>这三个探针的 <code>result</code> 都是从 <code>prober.Manager</code> 中写入的，只是每个探针有一个 <code>chan</code> , <code>syncLoopIteration</code> 接收到就是执行 <code>handler.HandlePodSyncs</code> 操作。</p>
<div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func (kl *Kubelet) syncLoopIteration(ctx context.Context, configCh &lt;-chan kubetypes.PodUpdate, handler SyncHandler,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	syncCh &lt;-chan time.Time, housekeepingCh &lt;-chan time.Time, plegCh &lt;-chan *pleg.PodLifecycleEvent) bool {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	select {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	case update := &lt;-kl.livenessManager.Updates():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if update.Result == proberesults.Failure {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			handleProbeSync(kl, update, handler, "liveness", "unhealthy")</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	case update := &lt;-kl.readinessManager.Updates():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		ready := update.Result == proberesults.Success</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		kl.statusManager.SetContainerReadiness(update.PodUID, update.ContainerID, ready)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		status := ""</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if ready {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			status = "ready"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		handleProbeSync(kl, update, handler, "readiness", status)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	case update := &lt;-kl.startupManager.Updates():</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		started := update.Result == proberesults.Success</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		kl.statusManager.SetContainerStartup(update.PodUID, update.ContainerID, started)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		status := "unhealthy"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if started {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			status = "started"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		handleProbeSync(kl, update, handler, "startup", status)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	return true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>Kubernetes</category>
            <category>Kubelet</category>
        </item>
        <item>
            <title><![CDATA[kubelet源码分析 syncLoopIteration（二） plegCH]]></title>
            <link>https://lengrongfu.github.io/blog/kubelet-three-analyze</link>
            <guid>https://lengrongfu.github.io/blog/kubelet-three-analyze</guid>
            <pubDate>Thu, 29 Aug 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[PLEG 全称是 Pod Lifecycle Event Generator ，它主要通过读取 container 的 Event 来更新 Pod 的状态，目前提供了 GenericPLEG 和 EventedPLEG 两种模式，不同点 GenericPLEG 是定时去读取事件，EventedPLEG 时通过主动接受事件的推送。]]></description>
            <content:encoded><![CDATA[<p><code>PLEG</code> 全称是 <code>Pod Lifecycle Event Generator</code> ，它主要通过读取 <code>container</code> 的 <code>Event</code> 来更新 <code>Pod</code> 的状态，目前提供了 <code>GenericPLEG</code> 和 <code>EventedPLEG</code> 两种模式，不同点 <code>GenericPLEG</code> 是定时去读取事件，<code>EventedPLEG</code> 时通过主动接受事件的推送。</p>
<p><img decoding="async" loading="lazy" src="https://firebasestorage.googleapis.com/v0/b/notiondiagram.appspot.com/o/diagram%2Fm5smUNzLG7NDZmSPY82qhFvWnsu1%2F46bd1519-3feb-409c-96b3-98e02692f488.svg?alt=media&amp;token=0f26310c-2165-4755-80c0-d2acc8682ed7" alt="a" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="genericpleg">GenericPLEG<a href="https://lengrongfu.github.io/blog/kubelet-three-analyze#genericpleg" class="hash-link" aria-label="Direct link to GenericPLEG" title="Direct link to GenericPLEG">​</a></h2>
<p>通用 <code>PLEG</code> 配置的是每秒中读取一次。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">genericPlegRelistPeriod    </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Second </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>调用 <code>Start</code> 方法之后就会进入间隔 <code>1s</code> 执行一次 <code>g.Relist</code> 这个方法中。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">g </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">GenericPLEG</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">g</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isRunning </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> wait</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Until</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">g</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Relist</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> g</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">relistDuration</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RelistPeriod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> g</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stopCh</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>g.Relist</code> 方法核心执行流程：</p>
<ol>
<li>获取当前机器上的所有 <code>Pod</code>, 主要通过 <code>CRI-API</code> 中定义的 <code>ListPodSandbox</code> 和 <code>ListContainers</code> 两个方法获取。</li>
</ol>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// Get all the pods.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">podList</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> g</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">runtime</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetPods</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li>更新当前的 <code>podRecord</code>，podRecord 中两个对象，一个 <code>old</code> ,一个 <code>current</code> .</li>
</ol>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">g</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">podRecords</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">setCurrent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pods</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li>
<p>所有的新老 <code>pod</code> 的容器组到一起进行遍历。进行新老的对比,如果有 <code>event</code> 变化,则记录.</p>
<ol>
<li>首先根据容器状态转换为 <code>pleg</code> 状态</li>
</ol>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">convertState</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state kubecontainer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">State</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> plegContainerState </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> state </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> kubecontainer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ContainerStateCreated</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// kubelet doesn't use the "created" state yet, hence convert it to "unknown".</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> plegContainerUnknown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> kubecontainer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ContainerStateRunning</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> plegContainerRunning</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> kubecontainer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ContainerStateExited</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> plegContainerExited</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> kubecontainer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ContainerStateUnknown</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> plegContainerUnknown</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">default</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">panic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"unrecognized container state: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>b. 之后根据 <code>old</code> 和 <code>current</code> 生成的 <code>pleg</code> 状态生成 <code>PLEGEvent</code></p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">generateEvents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">podID types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cid </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> oldState</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newState plegContainerState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">PodLifecycleEvent </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> newState </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> plegContainerRunning</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">PodLifecycleEvent</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">ID</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> podID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ContainerStarted</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cid</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> plegContainerExited</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">PodLifecycleEvent</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">ID</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> podID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ContainerDied</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cid</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> plegContainerUnknown</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">PodLifecycleEvent</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">ID</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> podID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ContainerChanged</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cid</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> plegContainerNonExistent</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> oldState </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> plegContainerExited</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">// We already reported that the container died before.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">PodLifecycleEvent</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">ID</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> podID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ContainerRemoved</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cid</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">default</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">PodLifecycleEvent</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">ID</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> podID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ContainerDied</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cid</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">ID</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> podID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ContainerRemoved</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> cid</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">default</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">panic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"unrecognized container state: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> newState</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>会遍历所有 <code>Pod</code> 的事件，然后发往 <code>eventChannel</code> 中，之后就会被 <code>syncLoopIteration</code> 接收到进行处理。</p>
</li>
</ol>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> pid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> events </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> eventsByPodID </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> events </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">// Filter out events that are not reliable and no other components use yet.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> events</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Type </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> ContainerChanged </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">continue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> g</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">eventChannel </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> events</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">default</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				metrics</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PLEGDiscardEvents</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Inc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ErrorS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Event channel is full, discard this relist() cycle event"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="eventedpleg">EventedPLEG<a href="https://lengrongfu.github.io/blog/kubelet-three-analyze#eventedpleg" class="hash-link" aria-label="Direct link to EventedPLEG" title="Direct link to EventedPLEG">​</a></h2>
<p>事件 <code>PLEG</code> 会创建一个 <code>GenericPLEG</code> ,在接受事件失败次数达到上限之后就会退回到 <code>GenericPLEG</code> 类型，但是它读取一次的时间间隔是 <code>300s</code>.</p>
<p>调用 <code>Start</code> 方法之后就会创建两个协程一致接收数据，这里和<code>GenericPLEG</code> 的区别还有不需要调用 <code>Watch</code> 方法。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">EventedPLEG</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> wait</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Until</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">watchEventsChannel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stopCh</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> wait</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Until</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">updateGlobalCache</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> globalCacheUpdatePeriod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stopCacheUpdateCh</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>e.watchEventsChannel</code> 方法核心执行流程：</p>
<ol>
<li>首先判断是否超过最大尝试次数，默认是 <code>e.eventedPlegMaxStreamRetries=5</code> 次。如果超过了会回退到<code>GenericPLEG</code> 上。</li>
</ol>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">EventedPLEG</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">watchEventsChannel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		numAttempts </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> numAttempts </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">eventedPlegMaxStreamRetries </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				  e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Stop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">genericPleg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Stop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">// Stop the existing Generic PLEG which runs with longer relisting period when Evented PLEG is in use.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">relistDuration</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Update the relisting period to the default value for the Generic PLEG.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">genericPleg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Start</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token keyword" style="color:#00009f">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">runtimeService</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetContainerEvents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Background</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> containerEventsResponseCh</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">runtimeapi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RuntimeService_GetContainerEventsClient</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				metrics</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EventedPLEGConn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Inc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			  </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				numAttempts</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li>
<p><code>runtimeService.GetContainerEvents</code> 获取容器的 <code>Events</code> , 我们看 <code>proto</code> 中的定义就明白，为什么这里可以主动监听这个事件的变化，因为它的返回值是一个 <code>steam</code> 类型</p>
<p><code>steam</code> 在 <code>gRPC</code> 中是一个双向流的过程，可以实现数据的双向传输。</p>
</li>
</ol>
<div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rpc GetContainerEvents(GetEventsRequest) returns (stream ContainerEventResponse) {}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">remoteRuntimeService</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">GetContainerEvents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> containerEventsCh </span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">runtimeapi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ContainerEventResponse</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> connectionEstablishedCallback </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">runtimeapi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RuntimeService_GetContainerEventsClient</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	containerEventsStreamingClient</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">runtimeClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetContainerEvents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">runtimeapi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">GetEventsRequest</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		resp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> containerEventsStreamingClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Recv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EOF </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">logErr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"container events stream is closed"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">logErr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"failed to receive streaming container event"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> resp </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			containerEventsCh </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> resp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">log</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"container event received"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"resp"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li>处理 <code>Event</code> , 它接收到 <code>Event</code> 之后会根据类型发送到 <code>GenericPLEG</code> 结构中的 <code>eventChannel</code> chan 中。</li>
</ol>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">EventedPLEG</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">processCRIEvents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">containerEventsResponseCh </span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">runtimeapi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ContainerEventResponse</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> event </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> containerEventsResponseCh </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ContainerEventType </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> runtimeapi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ContainerEventType_CONTAINER_DELETED_EVENT </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			shouldSendPLEGEvent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">podID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> status</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Unix</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetCreatedAt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				shouldSendPLEGEvent </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> shouldSendPLEGEvent </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">processCRIEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">EventedPLEG</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">processCRIEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">runtimeapi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ContainerEventResponse</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ContainerEventType </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> runtimeapi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ContainerEventType_CONTAINER_STOPPED_EVENT</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sendPodLifecycleEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">PodLifecycleEvent</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">ID</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">UID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodSandboxStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Metadata</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Uid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ContainerDied</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ContainerId</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">V</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InfoS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Received Container Stopped Event"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"event"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> runtimeapi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ContainerEventType_CONTAINER_CREATED_EVENT</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">V</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InfoS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Received Container Created Event"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"event"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> runtimeapi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ContainerEventType_CONTAINER_STARTED_EVENT</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sendPodLifecycleEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">PodLifecycleEvent</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">ID</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">UID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodSandboxStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Metadata</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Uid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ContainerStarted</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ContainerId</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">V</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InfoS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Received Container Started Event"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"event"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">String</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> runtimeapi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ContainerEventType_CONTAINER_DELETED_EVENT</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sendPodLifecycleEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">PodLifecycleEvent</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">ID</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">UID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodSandboxStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Metadata</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Uid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ContainerDied</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ContainerId</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">sendPodLifecycleEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">PodLifecycleEvent</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">ID</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">UID</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">PodSandboxStatus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Metadata</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Uid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Type</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ContainerRemoved</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ContainerId</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">V</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InfoS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Received Container Deleted Event"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"event"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="syncloopiteration">syncLoopIteration<a href="https://lengrongfu.github.io/blog/kubelet-three-analyze#syncloopiteration" class="hash-link" aria-label="Direct link to syncLoopIteration" title="Direct link to syncLoopIteration">​</a></h2>
<p>下面我们来看在 <code>syncLoopIteration</code> 中是如何处理这个 <code>Event</code> 的。</p>
<div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">func (kl *Kubelet) syncLoopIteration(ctx context.Context, configCh &lt;-chan kubetypes.PodUpdate, handler SyncHandler,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	syncCh &lt;-chan time.Time, housekeepingCh &lt;-chan time.Time, plegCh &lt;-chan *pleg.PodLifecycleEvent) bool {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	select {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	case e := &lt;-plegCh:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if isSyncPodWorthy(e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			// PLEG event for a pod; sync it.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			if pod, ok := kl.podManager.GetPodByUID(e.ID); ok {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				klog.V(2).InfoS("SyncLoop (PLEG): event for pod", "pod", klog.KObj(pod), "event", e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				handler.HandlePodSyncs([]*v1.Pod{pod})</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			} else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				// If the pod no longer exists, ignore the event.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				klog.V(4).InfoS("SyncLoop (PLEG): pod does not exist, ignore irrelevant event", "event", e)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		if e.Type == pleg.ContainerDied {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			if containerID, ok := e.Data.(string); ok {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				kl.cleanUpContainersInPod(e.ID, containerID)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	return true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>核心执行流程如下：</p>
<ol>
<li>如果不是 <code>event.Type != pleg.ContainerRemoved</code> 移除事件，则进入执行，如果 <code>Pod</code> 还在 <code>PodManager</code> 中，则执行 <code>HandlePodSyncs</code> ,否则跳过。</li>
<li><code>HandlePodSyncs</code> 中主要是往 <code>podWorkers</code> 中发送 <code>UpdatePod</code> 的 <code>SyncPodSync</code> 操作。</li>
<li>如果是 <code>e.Type == pleg.ContainerDied</code> 退出事件，则清除容器。</li>
</ol>]]></content:encoded>
            <category>Kubernetes</category>
            <category>Kubelet</category>
        </item>
        <item>
            <title><![CDATA[kubelet源码分析 syncLoopIteration（一） podUpdateCh]]></title>
            <link>https://lengrongfu.github.io/blog/kubelet-two-analyze</link>
            <guid>https://lengrongfu.github.io/blog/kubelet-two-analyze</guid>
            <pubDate>Wed, 28 Aug 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[podUpdateCh 主要是负责接收 Pod 的数据，分别从文件、URL、Kube-APIServer 三个地方来，下面将详细分析这个 chan 的读写流程。]]></description>
            <content:encoded><![CDATA[<p><code>podUpdateCh</code> 主要是负责接收 <code>Pod</code> 的数据，分别从文件、URL、Kube-APIServer 三个地方来，下面将详细分析这个 <code>chan</code> 的读写流程。</p>
<p><code>Pod</code> 的 <code>source</code> 定义了四种表现方式，在代码 <code>pod_update.go</code></p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// These constants identify the sources of pods.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Filesource idenitified updates from a file.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	FileSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"file"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// HTTPSource identifies updates from querying a web page.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	HTTPSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"http"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// ApiserverSource identifies updates from Kubernetes API Server.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ApiserverSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"api"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// AllSource identifies updates from all sources.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	AllSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"*"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="https://firebasestorage.googleapis.com/v0/b/notiondiagram.appspot.com/o/diagram%2Fm5smUNzLG7NDZmSPY82qhFvWnsu1%2F7182ab7e-9b66-4472-b508-6ce8abb3bd7e.svg?alt=media&amp;token=dc26e818-bbd5-4c18-8070-70649d577ad7" alt="a" class="img_ev3q"></p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="file">File<a href="https://lengrongfu.github.io/blog/kubelet-two-analyze#file" class="hash-link" aria-label="Direct link to File" title="Direct link to File">​</a></h3>
<p><code>file</code> Watch 功能只在 <code>linux</code> 操作系统上支持，其它操作系统都不支持。</p>
<p>会把 <code>fsnotify</code> 监听的文件事件转换为 <code>Pod</code> 的操作类型；</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sourceFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">produceWatchEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">fsnotify</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> eventType podEventType</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Op </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> fsnotify</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Create</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		eventType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> podAdd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Op </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> fsnotify</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Write</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		eventType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> podModify</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Op </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> fsnotify</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Chmod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		eventType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> podModify</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Op </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> fsnotify</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Remove</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		eventType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> podDelete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Op </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> fsnotify</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Rename</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		eventType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> podDelete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">default</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// Ignore rest events</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">watchEvents </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">watchEvent</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> eventType</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后根据监听到的文件名的变化，来读取 <code>Pod</code> 的内容，之后更新 <code>store</code> 对象；这里是令我奇怪的，我以为它会往 <code>chan</code> 里面发送一个事件。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sourceFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">consumeWatchEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">watchEvent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">eventType </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> podAdd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> podModify</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">extractFromFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fileName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> podDelete</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> objKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> keyExist </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fileKeyMapping</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fileName</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> keyExist </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> podExist</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetByKey</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">objKey</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"failed to remove deleted pod from cache: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>除了 <code>Watch</code> 文件变化之后，它还有一个 <code>time.Ticker</code> 每隔 <code>10s</code> 会执行一遍全量读取目录下 <code>Pod</code> 的操作；</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sourceFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	listTicker </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewTicker</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">period</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> #默认配置是10s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// 启动之后先读取一遍所有的</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">listConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ErrorS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Unable to read config path"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"path"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain">listTicker</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">C</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">listConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ErrorS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Unable to read config path"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"path"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> e </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">watchEvents</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">consumeWatchEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ErrorS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Unable to process watch event"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">startWatch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上面有一个疑问：这里是令我奇怪的，我以为它会往 <code>chan</code> 里面发送一个事件。发现它的 <code>send</code> 是写在 <code>store.Add、store.Delete</code>  里面的，它会在每次触发这个函数的时候，把存储起来的 <code>pod</code> 全量的发送到 <code>chan</code> 里面. <code>undelta_store.go#45</code></p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">UndeltaStore</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">PushFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">List</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">UndeltaStore</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">PushFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">List</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">UndeltaStore</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">PushFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">List</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="url">URL<a href="https://lengrongfu.github.io/blog/kubelet-two-analyze#url" class="hash-link" aria-label="Direct link to URL" title="Direct link to URL">​</a></h3>
<p><code>URL</code> 的方式是通过用户配置的外部服务地址，然后每 <code>20s</code> 去访问一次外部服务。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sourceURL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">extractFromURL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	  </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在 <code>extractFromURL</code> 会通过访问 <code>HTTP</code> GET 的方式解析返回值，返回当个对象或者是数组都可以解析成功，解析成功之后也是会发送到 <code>merge</code> 中进行合并处理。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="api">API<a href="https://lengrongfu.github.io/blog/kubelet-two-analyze#api" class="hash-link" aria-label="Direct link to API" title="Direct link to API">​</a></h3>
<p><code>API</code> 的方式是通过 <code>list-watch</code> 去读取 <code>kube-apiserver</code> 的数据，并且通过 <code>field</code> 进行过滤当前的节点。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">lw </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewListWatchFromClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">CoreV1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RESTClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"pods"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NamespaceAll</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fields</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">OneTermEqualSelector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"spec.nodeName"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nodeName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>传递的 <code>store</code> 对象里面有 <code>send</code> 的功能，和 <code>file</code> 处理逻辑一样，一个 <code>pod</code> 发生变更，就会要发送所有的 <code>pod</code> 去执行 <code>merge</code> 操作。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">r </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewReflector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewUndeltaStore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">send</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MetaNamespaceKeyFunc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="merge">Merge<a href="https://lengrongfu.github.io/blog/kubelet-two-analyze#merge" class="hash-link" aria-label="Direct link to Merge" title="Direct link to Merge">​</a></h2>
<p><code>merge</code> 是为了把从不同的 <code>source</code> 过来的 <code>pod</code> 进一步合并，避免出现重复、冲突的操作，最终得到一个一致的操作，最终合并后会得到各种事件的结果：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">adds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updates</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> deletes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> removes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reconciles </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">merge</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">source</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> change</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>合并的难点在于判断是不是要更新，添加、删除这种场景都比较简单，之前不存在就添加，之前存在，现在不存在就删除，但是要不要更新是比较难判断的，里面有一个 <code>checkAndUpdatePod</code> 方法。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">checkAndUpdatePod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">existing</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ref </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">needUpdate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> needReconcile</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> needGracefulDelete </span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">1.</span><span class="token plain"> 检查Spec、Labels、DeletionTimestamp、DeletionGracePeriodSeconds、Annotations这些是否发生变更</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">2.</span><span class="token plain"> 如果都没有发生变更判断Status是否发生变更，如果有则更新，没有则不更新。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">3.</span><span class="token plain"> 如果DeletionTimestamp不为空，则需要删除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>Kubernetes</category>
            <category>Kubelet</category>
        </item>
        <item>
            <title><![CDATA[kubelet源码分析(一)：工作原理]]></title>
            <link>https://lengrongfu.github.io/blog/kubelet-one-analyze</link>
            <guid>https://lengrongfu.github.io/blog/kubelet-one-analyze</guid>
            <pubDate>Sun, 25 Aug 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[从 kubelet 源码来分析它的工作原理.]]></description>
            <content:encoded><![CDATA[<p>从 <code>kubelet</code> 源码来分析它的工作原理.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="kubelet-工作原理"><strong>kubelet 工作原理</strong><a href="https://lengrongfu.github.io/blog/kubelet-one-analyze#kubelet-%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86" class="hash-link" aria-label="Direct link to kubelet-工作原理" title="Direct link to kubelet-工作原理">​</a></h2>
<p><img decoding="async" loading="lazy" alt="image.png" src="https://lengrongfu.github.io/assets/images/kubelet-flow-4ca563abbd2633858a5edff9bb4bd281.png" width="1333" height="954" class="img_ev3q"></p>
<p><code>Kubelet</code> 的工作核心就是一个控制循环 <code>syncLoop</code> ，驱动这个控制循环运行的事件，包括: <code>Pod</code> 更新事件, <code>Pod</code> 生命周期变化, <code>Kubelet</code> 本身设置的执行周期、定时的清理任务(<code>GC</code> ).</p>
<p>在这个大循环 <code>syncLoop</code> 之外, <code>kubelet</code> 还维护着许多其他的字控制循环，就是图中的小圆圈, 比如：</p>
<ul>
<li><code>podManager</code> :  主要用于存储和管理期望的 <code>Pod</code> 集合，包括被接受的常规 <code>pod</code> 和镜像 <code>pod（mirror pods）</code>.</li>
<li><code>podWorkers</code>: 主要负责管理 <code>pod</code> 生命周期状态机的关键组件, 它会处理 <code>pod</code> 的几个状态<!-- -->
<ul>
<li><strong>syncing</strong>：pod 应该正在运行（调用<code>syncPod</code>方法）。</li>
<li><strong>terminating</strong>：pod应该正在停止（调用<code>syncTerminatingPod</code>方法）。</li>
<li><strong>terminated</strong>：pod应该已经清理了所有资源（调用<code>syncTerminatedPod</code>方法）。</li>
</ul>
</li>
<li><code>evictionManager</code>: 负责监控节点的状态，以识别可能影响节点稳定性的情况，并通过驱逐pod（将 <code>pod</code> 状态设置为 <code>Failed</code> ，并给出原因 <code>Evicted</code> ）来减轻资源压力; 并依赖<code>podWorker</code>的权威性来执行驱逐操作。这样可以确保在资源压力过大或其他影响节点稳定性的情况下，能够及时采取措施，恢复节点的正常运行</li>
<li><code>probeManager</code> : 会定时去监控 <code>Pod</code> 中容器的健康状况，当前支持两种类型的探针: <code>livenessProbe</code> 和 <code>readinessProbe</code> .</li>
<li><code>secretManager</code>: 是 <code>kubelet</code> 中负责缓存和管理运行在节点上的 <code>pod</code> 所使用的 <code>secret</code> 的组件，它通过与<code>podWorkers</code>&nbsp;的协作，确保在 <code>pod</code> 启动和终止时正确地获取和清理 <code>secret</code>，并保持 <code>secret</code> 的最新状态。</li>
<li><code>configMapManager</code>: 是 <code>kubelet</code> 中负责缓存和管理运行在节点上的 <code>pod</code> 所使用的 <code>configmap</code> 的组件。它通过与<code>podWorkers</code>&nbsp;的协作，确保在 <code>pod</code> 启动和终止时正确地获取和清理 <code>configmap</code>, 并保持 <code>configmap</code> 的最新状态。</li>
<li><code>volumeManager</code> : 是 <code>kubelet</code> 中负责管理运行在节点上的 <code>pod</code> 所使用的卷的组件。它通过观察 <code>pod</code> 的生命周期，执行必要的卷操作，并定期同步卷状态以确保与实际期望的卷集合一致，并管理这些 <code>pod</code> 的生命周期中涉及的卷（volumes）操作，包括：<!-- -->
<ul>
<li>挂载（attaching）：将卷连接到节点。</li>
<li>挂载（mounting）：将卷挂载到pod的文件系统。</li>
<li>卸载（unmounting）：从pod的文件系统卸载卷。</li>
<li>分离（detaching）：从节点断开卷的连接。</li>
</ul>
</li>
<li><code>statusManager</code>: 是 <code>kubelet</code> 中负责更新和管理 <code>pod</code> 状态的组件。它从<code>podWorker</code>接收状态更新，并将这些更新同步到 <code>API</code> 服务器中。<code>statusManager</code>&nbsp;对于 <code>kubelet</code> 合成的 <code>pod</code> 状态具有权威性，其他组件应该咨询它以获取正确的状态信息。同时，由于<code>statusManager</code>&nbsp;依赖于<code>podWorker</code>，因此需要检查 <code>pod</code> 运行状态的组件应该直接咨询<code>podWorker</code>。这样可以确保 <code>pod</code> 状态的一致性和准确性，从而保证整个系统的正常运行。</li>
<li><code>imageManager</code> : 是kubelet中负责管理镜像垃圾回收的组件。它通过定期检查和清理不再使用的镜像，帮助维护节点的磁盘空间，确保节点有足够的资源来运行新的pod</li>
<li><code>containerLogManager</code> : 是kubelet中负责管理容器日志的组件。它通过收集、存储、轮转和清理容器日志，确保日志数据的可用性和节点的磁盘空间不会被过度消耗。</li>
<li><code>serverCertificateManager</code>: 是kubelet中负责处理证书轮换的组件。它通过监控证书的有效期，自动进行证书轮换，并确保所有相关组件能够使用新的证书。这个组件对于维护集群的安全通信和防止证书过期导致的服务中断非常重要。</li>
<li><code>cloudResourceSyncManager</code>: 是kubelet中负责处理向云服务提供商发送请求的组件。它通过设置请求的超时时间，确保请求在预定的时间内完成，并处理请求过程中可能出现的错误。</li>
<li><code>Runtime</code> 相关的字段：<!-- -->
<ul>
<li><code>containerRuntime</code>: 是kubelet中负责管理容器生命周期的组件。它与底层的容器运行时（如Docker、containerd、CRI-O等）进行通信，执行以下任务</li>
<li><strong><code>streamingRuntime</code>:</strong> 负责处理容器的流式操作，如日志流、exec命令和端口转发等</li>
<li><strong><code>runtimeService</code> :</strong>  是一个内部API服务，它提供了与容器运行时进行交互的接口。这个服务通常是容器运行时接口（Container Runtime Interface, CRI）的一部分；在内部主要是调用 <code>containerRuntime</code> 这个对象去管理容器。</li>
</ul>
</li>
<li><code>PLEG</code> 相关的字段：<strong>PLEG</strong>&nbsp;是基于轮询的定期检查机制，用于检测和报告容器状态的变化, <strong>eventedPleg</strong>&nbsp;是基于事件驱动的实时响应机制，用于以低延迟提供容器状态的变化。<!-- -->
<ul>
<li><code>PLEG（Pod Lifecycle Event Generator）</code>:<!-- -->
<ol>
<li><strong>定期检查</strong>：PLEG 定期（通常是每隔几秒钟）检查所有pod和容器的状态，并将状态变化生成事件。</li>
<li><strong>轮询机制</strong>：PLEG 使用轮询机制来检测容器状态的变化，这意味着它需要定期扫描所有容器，即使没有状态变化也会进行检查。</li>
<li><strong>延迟</strong>：由于是定期检查，PLEG 可能会有一定的延迟，因为它需要等待下一个检查周期才能发现状态变化。</li>
</ol>
</li>
<li><code>eventedPleg</code> :<!-- -->
<ol>
<li><strong>事件驱动</strong>：<code>eventedPleg</code>&nbsp;通过监听容器运行时的事件来实时获取容器状态的变化，而不是定期检查。</li>
<li><strong>低延迟</strong>：<code>eventedPleg</code>&nbsp;可以在容器状态发生变化时立即响应，因此具有更低的延迟。</li>
<li><strong>边缘驱动</strong>：<code>eventedPleg</code>&nbsp;在容器状态变化的边缘（即事件发生时）触发响应，而不是在周期性的检查点。</li>
</ol>
</li>
</ul>
</li>
<li><code>containerRefManager</code> : 容器引用的管理，用来报告容器的创建、失败事件等.</li>
</ul>
<p>上述描述了 <code>Kubelet</code> 结构体中定义的核心的字段，除此之外还有很多字段，一些字段比较简单，这里不一一描述。</p>
<p><img decoding="async" loading="lazy" alt="kubelet-arch.drawio.png" src="https://lengrongfu.github.io/assets/images/kubelet-arch-8f1969a6bde0633f0cf5decdc7ee7e77.png" width="2000" height="836" class="img_ev3q"></p>
<p><code>Kubelet</code> 启动之后会创建 <code>syncLoopIteration</code> 的循环，它接受一个 <code>podUpdate</code> 的 <code>chan</code> ,分别从静态文件、HTTP URL、List-Watch(API) 三个来源写入创建、更新、删除的 <code>Pod</code> ;</p>
<p>接收到 <code>podUpdate</code> 对象之后，会进入 <code>podWorkers.UpdatePod</code> 的方法中进行处理，之后发往 <code>podWork</code> chan 里面，在 <code>podWorkLoop</code> 中，针对每个 <code>pod</code> 会创建一个协程，然后在 <code>syncPod</code> 中处理，里面主要就是把 <code>pod</code> 发往 <code>podStatus</code> 中进行状态处理，还有就是创建容器，然后就是调用 <code>CRI</code> 的接口拉镜像、调用 <code>device-plugin</code> 的接口进行设备的分配，以及 <code>CRI</code> 的容器服务接口创建容器等。</p>
<p>在 <code>syncLoopIteration</code> 中还会通过 <code>syncCh</code> 和 <code>cleanupCh</code> 配置的 <code>time.Ticker</code> 定期的处理 <code>pod</code>,以及在 <code>containerCh</code> chan 中接受 <code>device-plguin</code> 上报的设备健康信息，还有 <code>probeCh</code> 这个根据 <code>livenessManager、readinessManager、startupManager</code>  这三个探针的结果影响 <code>pod</code> 的状态更新；</p>
<p><code>plegCh</code> 会接受 <code>Pod</code> 的 <code>Lifecycle Event</code> ,根据 <code>Event</code> 来决定 <code>pod</code> 的 sync.</p>]]></content:encoded>
            <category>Kubernetes</category>
            <category>Kubelet</category>
        </item>
        <item>
            <title><![CDATA[JSON Patch and JSON Merge Patch]]></title>
            <link>https://lengrongfu.github.io/blog/jsonpatch-jsonmergepatch</link>
            <guid>https://lengrongfu.github.io/blog/jsonpatch-jsonmergepatch</guid>
            <pubDate>Thu, 22 Sep 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[JSON Patch vs JSON Merge Patch]]></description>
            <content:encoded><![CDATA[<p>JSON Patch vs JSON Merge Patch</p>
<p><code>PATCH</code> 作为 <code>HTTP</code> 的一种 <code>Method</code>, 近年来受到较多的关注，于是便提出关于使用 <code>JSON</code> 驱动 <code>PATCH</code> 格式的想法，这种格式用声明式的形式来描述两个<code>JSON</code>文档之间的差异，<code>IETF</code>发布了两种格式来解决这个问题： <a href="https://tools.ietf.org/html/rfc6902" target="_blank" rel="noopener noreferrer">RFC 6902 (JSON Patch)</a>和&nbsp;<a href="https://www.rfc-editor.org/rfc/rfc7396" target="_blank" rel="noopener noreferrer">RFC 7396 (JSON Merge Patch)</a>，两者各有优缺点，没有一种是可以适用于任何人的，让我们来看下他们的区别。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="json-patch">JSON PATCH<a href="https://lengrongfu.github.io/blog/jsonpatch-jsonmergepatch#json-patch" class="hash-link" aria-label="Direct link to JSON PATCH" title="Direct link to JSON PATCH">​</a></h2>
<p><code>JSON PATCH</code> 的格式类似于数据库事物，它是一个 <code>JSON Document,</code>它基本上是由<code>ADD</code>、<code>REMOVE</code>、<code>REPLACE</code>、<code>MOVE</code>、<code>COPY</code> 一系列操作组成的。</p>
<p>下面一个简单的示例描述了一个 <code>JSON</code> 的内容：</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	"users" : [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		{ "name" : "Alice" , "email" : "alice@example.org" },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		{ "name" : "Bob" , "email" : "bob@example.org" }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在这个 <code>JSON</code>中执行<code>JSON PATCH</code>操作，更改<code>Alice</code>的电子邮件，并且添加一个新的<code>user</code>到数组中：</p>
<div class="language-Json language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"op" : "replace" ,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"path" : "/users/0/email" ,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"value" : "alice@wonderland.org"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"op" : "add" ,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"path" : "/users/-" ,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"value" : {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			"name" : "Christine",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			"email" : "christine@example.org"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>它的结果将是：</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	"users" : [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		{ "name" : "Alice" , "email" : "alice@wonderland.org" },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		{ "name" : "Bob" , "email" : "bob@example.org" },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		{ "name" : "Christine" , "email" : "christine@example.org" }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>一个<code>JSON PATCH</code> 有以下几个基本元素描述而成：</p>
<ul>
<li><code>op </code>健表示操作类型。</li>
<li>操作的参数由其他元素描述。</li>
<li><code>path</code>是指向作为操作目标的<code>JSON</code>中的指针，是一个必须存在的参数。</li>
</ul>
<p><code>JSON PATCH</code> 操作提供了一个 <code>test</code> 操作类型，它没有任何坏处，所以它不是一个数据操作运算符，它可以用来对执行过程进行断言，如果<code>test</code>评估结果为<code>false</code>,则可以中断执行。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="json-merge-patch">JSON MERGE PATCH<a href="https://lengrongfu.github.io/blog/jsonpatch-jsonmergepatch#json-merge-patch" class="hash-link" aria-label="Direct link to JSON MERGE PATCH" title="Direct link to JSON MERGE PATCH">​</a></h2>
<p><code>JSON MERGE PATCH</code> 它描述了 <code>json document</code>的更改版本，与<code>JSON PATCH</code> 类似，区别在于它类似<code>diff</code>文件，只包含执行后应该不同的<code>document</code>节点。</p>
<p>如下是一个简单的<code>JSON</code>文档，来说明<code>JSON MERGE PATCH</code>的格式：</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	"a": "b",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	"c": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"d": "e",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"f": "g"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们可以在上述的<code>JSON</code>中运行如下的<code>MERGE PATCH</code>:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	"a":"z",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	"c": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"f": null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个将 <code>a</code> 的值改为 <code>z</code> ,并且将删除 <code>c</code>。</p>
<p>它看着很简单，但是这种简单性也带来了限制：</p>
<ul>
<li>通过将<code>key</code>的值设置为<code>null</code>来进行删除，这本质上就导致用户不能主动设置<code>null</code>值。</li>
<li>数组不能被<code>PATCH</code>操作，如果想将一个元素添加到数组中，或者改变它的任何元素，那么必须要提供一个完整的数据才能执行。</li>
<li><code>MERGE PATCH</code>操作永远不会导致错误，任何格式错误的补丁都会被<code>PATCH</code>,所以它是一种自由的格式，这不一定是好的，因为我们可能需要在执行完<code>MEGER PATCH</code> 之后进行<code>JSON SCHEMA</code>的验证，错误就撤销<code>PATCH</code>，但是目前实现不了。</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="总结">总结<a href="https://lengrongfu.github.io/blog/jsonpatch-jsonmergepatch#%E6%80%BB%E7%BB%93" class="hash-link" aria-label="Direct link to 总结" title="Direct link to 总结">​</a></h2>
<p><code>JOSN MERGE PATCH</code> 是一种非常简单的格式，可用性有限，对于更复杂的用户，请使用<code>JSON PATCH</code>,由于它使用与任何<code>JSON</code>文档，该规范还提供了原子执行和执行前后执行<code>test</code>检查。</p>
<p><code>Kubernetes</code> 的 <code>PATCH</code>是支持<code>JSON MERGER PATCH</code> 和 <code>MERGE PATCH</code>的，但是使用<code>JSON MERGE PATCH</code>的场景较少，也是建议使用<code>JSON PATCH</code>，最根本原因就是<code>JSON MERGE PATCH</code>的协议格式过于简单，难以应用在复杂场景。</p>]]></content:encoded>
            <category>Kubernetes</category>
        </item>
        <item>
            <title><![CDATA[Vscode Remote Golang开发环境打造]]></title>
            <link>https://lengrongfu.github.io/blog/remote-golang-developer-env</link>
            <guid>https://lengrongfu.github.io/blog/remote-golang-developer-env</guid>
            <pubDate>Wed, 31 Aug 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[通过Vscode打造远程开发环境，可以加快工作效率.]]></description>
            <content:encoded><![CDATA[<p>通过<code>Vscode</code>打造远程开发环境，可以加快工作效率.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="背景">背景<a href="https://lengrongfu.github.io/blog/remote-golang-developer-env#%E8%83%8C%E6%99%AF" class="hash-link" aria-label="Direct link to 背景" title="Direct link to 背景">​</a></h2>
<p>我之前的开发环境一直都是使用 <code>Mac + Goland</code>，但是最近在编译一个程序的时候发现编译不通过，经过排查发现是 <code>Mac</code>上的 <code>Make</code> 语法出现了不兼容，于是想到了打造一套 <code>Remote Linux + Vscode</code> 的开发环境。</p>
<p>刚好有一个大学时候的笔记本，重装为了 <code>Ubuntu</code> 系统，就用这个电脑来打造就可以，远程开发环境和本地开发环境相比，有利有弊；</p>
<table><thead><tr><th>对比</th><th>本地环境</th><th>远程环境</th></tr></thead><tbody><tr><td>优点</td><td>1.程序启动快，环境加载快。<br> 2.不会受限于网络环境和地域环境。</td><td>1. 可以使用较多资源，如内存、CPU、磁盘等。<br>2. 减少对Mac环境的影响，使用Linux开发环境。</td></tr><tr><td>缺点</td><td>1. 和本地系统绑定，有些软件在Mac下不能很好的执行和编辑<br>2. 内存、资源这些都受限</td><td>1. 这个原创环境只能在家里私有化网络环境下使用<br>2.因为操作都是网络传输，所以初始化的时候比较慢。``</td></tr></tbody></table>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="基本环境">基本环境<a href="https://lengrongfu.github.io/blog/remote-golang-developer-env#%E5%9F%BA%E6%9C%AC%E7%8E%AF%E5%A2%83" class="hash-link" aria-label="Direct link to 基本环境" title="Direct link to 基本环境">​</a></h2>
<ul>
<li>有一个远程的<code>Linux</code>环境，可以是<code>Ubuntu</code>，也可以是<code>Centos</code>，并打开远程连接<code>ssh 22</code>端口。</li>
<li>本地机器安装<code>Vscode</code>。</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="远程环境">远程环境<a href="https://lengrongfu.github.io/blog/remote-golang-developer-env#%E8%BF%9C%E7%A8%8B%E7%8E%AF%E5%A2%83" class="hash-link" aria-label="Direct link to 远程环境" title="Direct link to 远程环境">​</a></h2>
<p>按照如下的流程配置开发环境；</p>
<ol>
<li>
<p>本地Vscode安装扩展插件：在<code>Vscode</code>的扩展中搜索<code>ssh</code>插件，选择安装<code>Remote - SSH</code>这个插件。</p>
</li>
<li>
<p>创建<code>ssh</code>密钥：</p>
</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 执行如下的命令，就会在~/.ssh目录下生成 id_rsa_goland_developer_com、id_rsa_goland_developer_com.pub 两个文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ssh-keygen -f id_rsa_goland_developer_com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="3">
<li>在<code>Remote Linux</code>上配置本地公钥，实现免密登录</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 把本地id_rsa_goland_developer_com.pub文件上传到远程机器上，并写入到 ~/.ssh/authorized_keys 文件中，也可以直接复制通过vim编辑写入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cat id_rsa_goland_developer_com.pub &gt; ~/.ssh/authorized_keys</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="4">
<li>
<p>点击<code>remote ssh</code>的<code>Configure</code>，选择第一个配置文件;
<img decoding="async" loading="lazy" alt="image-20220507210602712" src="https://lengrongfu.github.io/assets/images/image-20220507210602712-a5caf451431e4895398ac73be0be7157.png" width="1747" height="390" class="img_ev3q"></p>
</li>
<li>
<p>添加远程主机配置：</p>
</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Host GoDev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    User {user}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HostName {ip}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IdentityFile ~/.ssh/id_rsa_goland_developer_com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><code>GoDev</code>：远程主机的标示名称，可以随意取，方便识别就可以。</li>
<li><code>{user}</code>：远程主机的用户，最好不要使用<code>root</code>，可以通过<code>useradd</code>命令新添加一个用户。</li>
<li><code>{ip}</code>：远程主机的地址。</li>
<li><code>IdentityFile</code>：用于远程登录的秘钥</li>
</ul>
<ol start="6">
<li>使用 <code>VS CODE</code> 连接远程开发机器</li>
</ol>
<ul>
<li>
<p>连接远程主机
<img decoding="async" loading="lazy" alt="image-20220507211751447.png" src="https://lengrongfu.github.io/assets/images/image-20220507211751447-ce2d9cac3eaf63bc351b85d4c9c26930.png" width="2163" height="426" class="img_ev3q"></p>
</li>
<li>
<p>连接成功后可以选择打开的工作目录
<img decoding="async" loading="lazy" alt="image-20220507212224603.png" src="https://lengrongfu.github.io/assets/images/image-20220507212224603-b045fa239539a9c2ac833a7abf33e22e.png" width="1771" height="418" class="img_ev3q"></p>
</li>
</ul>
<p>这样远程环境就配置好了，下面就开始配置开发环境。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="开发环境">开发环境<a href="https://lengrongfu.github.io/blog/remote-golang-developer-env#%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83" class="hash-link" aria-label="Direct link to 开发环境" title="Direct link to 开发环境">​</a></h2>
<p>如果这是一个新的<code>Linue</code>环境，所以我上面没有<code>go</code>环境这些，需要新进行安装<code>go</code>环境。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="go环境安装">Go环境安装<a href="https://lengrongfu.github.io/blog/remote-golang-developer-env#go%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85" class="hash-link" aria-label="Direct link to Go环境安装" title="Direct link to Go环境安装">​</a></h3>
<ul>
<li><code>Go</code>源码包下载地址：<a href="https://go.dev/doc/install" target="_blank" rel="noopener noreferrer">https://go.dev/doc/install</a></li>
</ul>
<ol>
<li>Go download.</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ wget -c https://dl.google.com/go/go1.19.linux-amd64.tar.gz</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>Go install.</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo tar -C /usr/local -xzf go1.19.linux-amd64.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ vim /etc/profile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export PATH=$PATH:/usr/local/go/bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ source /etc/profile</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="3">
<li>设置 go env</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ go env -w GO111MODULE=on</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ go env -w GOPROXY=https://goproxy.cn</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="vscode-go环境配置">Vscode Go环境配置<a href="https://lengrongfu.github.io/blog/remote-golang-developer-env#vscode-go%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE" class="hash-link" aria-label="Direct link to Vscode Go环境配置" title="Direct link to Vscode Go环境配置">​</a></h3>
<ol>
<li>
<p>在打开远程连接的<code>Vscode</code>中安装<code>go</code>插件
<img decoding="async" loading="lazy" alt="image-20220507212648391" src="https://lengrongfu.github.io/assets/images/image-20220507212648391-e5cc19d1225d86856018143e361dee8b.png" width="864" height="483" class="img_ev3q"></p>
</li>
<li>
<p>安装其他Go插件</p>
</li>
</ol>
<blockquote>
<p>按快捷键ctrl+shift+p ，选择go install/update tools（安装所有相关包）。</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="image-20220507212945157" src="https://lengrongfu.github.io/assets/images/image-20220507212945157-eb34b09c75585b3e8a452721c0ab5ef1.png" width="1099" height="324" class="img_ev3q"></p>
<ol start="3">
<li>选择全部进行安装</li>
</ol>
<blockquote>
<p>最新版的Tools只有7个了，网上有些文章里面看着有10几个，那是很久之前的版本，在新版本中做了很多整合，比如：golint和goimports都整合到staticcheck中了。</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="image-20220507213258802" src="https://lengrongfu.github.io/assets/images/image-20220507213258802-cc83851190040f52b70a441ff6d969f3.png" width="1141" height="299" class="img_ev3q"></p>
<ol start="4">
<li>安装 <code>Code Run</code> 插件</li>
</ol>
<blockquote>
<p>搜索关键词code，安装Code Runner插件，这样就可以使用快捷键Ctrl+Alt+N运行代码了。</p>
</blockquote>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="其他设置">其他设置<a href="https://lengrongfu.github.io/blog/remote-golang-developer-env#%E5%85%B6%E4%BB%96%E8%AE%BE%EF%BF%BD%EF%BF%BD%E7%BD%AE" class="hash-link" aria-label="Direct link to 其他设置" title="Direct link to 其他设置">​</a></h2>
<p>因为使用的笔记本做为远程环境，所以为了避免屏幕一直亮着，可以配置让屏幕关闭显示。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 在如下文件中加入或者修改如下两个变量值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo vim /etc/systemd/logind.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HandleLidSwitch=ignore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HandleLidSwitchExternalPower=ignore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 之后重启就可以了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo service systemd-logind restart</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="未来">未来<a href="https://lengrongfu.github.io/blog/remote-golang-developer-env#%E6%9C%AA%E6%9D%A5" class="hash-link" aria-label="Direct link to 未来" title="Direct link to 未来">​</a></h2>
<p>目前暂时使用笔记本，但是笔记本受限于内存大小、磁盘大小、<code>CPU</code> 性能，并且没有<code>GPU</code>,未来主要朝着家庭低功耗服务器去演进。</p>
<ul>
<li><a href="https://www.reddit.com/r/homelab/comments/rlouof/trying_to_build_a_small_low_power_server/" target="_blank" rel="noopener noreferrer">https://www.reddit.com/r/homelab/comments/rlouof/trying_to_build_a_small_low_power_server/</a></li>
<li><a href="https://kit.co/TechnoTim/efficient-low-power-powerful-virtualization-server" target="_blank" rel="noopener noreferrer">https://kit.co/TechnoTim/efficient-low-power-powerful-virtualization-server</a></li>
<li><a href="https://www.proxmox.com/en/" target="_blank" rel="noopener noreferrer">https://www.proxmox.com/en/</a></li>
</ul>]]></content:encoded>
            <category>Developer Env</category>
        </item>
        <item>
            <title><![CDATA[Github Contribute 注意事项]]></title>
            <link>https://lengrongfu.github.io/blog/github-contribute</link>
            <guid>https://lengrongfu.github.io/blog/github-contribute</guid>
            <pubDate>Sun, 28 Aug 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[当我们在Github上贡献代码时要注意些什么？如下是个人贡献时总结的一些小心得，欢迎轻拍。]]></description>
            <content:encoded><![CDATA[<p>当我们在<code>Github</code>上贡献代码时要注意些什么？如下是个人贡献时总结的一些小心得，欢迎轻拍。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="代码提交流程">代码提交流程<a href="https://lengrongfu.github.io/blog/github-contribute#%E4%BB%A3%E7%A0%81%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B" class="hash-link" aria-label="Direct link to 代码提交流程" title="Direct link to 代码提交流程">​</a></h2>
<p>如下以以<code>kubernetes</code>为例，核心操作步骤如下图：
<img decoding="async" loading="lazy" alt="git_workflow.png" src="https://lengrongfu.github.io/assets/images/git_workflow-a05c064048d6c2754123c6510faef769.png" width="1280" height="720" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="签署贡献协议">签署贡献协议<a href="https://lengrongfu.github.io/blog/github-contribute#%E7%AD%BE%E7%BD%B2%E8%B4%A1%E7%8C%AE%E5%8D%8F%E8%AE%AE" class="hash-link" aria-label="Direct link to 签署贡献协议" title="Direct link to 签署贡献协议">​</a></h2>
<p>目前大多数开源项目都需要签署贡献协议，比如<code>DCO</code>协议，签署使用的就是当前<code>github</code>账号的账号和邮箱，所以在项目提交代码的时候需要先进行配置：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ git config --local user.name lengrongfu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ git config --local user.email 1275177125@qq.com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一个pr尽量只用一个commit">一个PR尽量只用一个Commit<a href="https://lengrongfu.github.io/blog/github-contribute#%E4%B8%80%E4%B8%AApr%E5%B0%BD%E9%87%8F%E5%8F%AA%E7%94%A8%E4%B8%80%E4%B8%AAcommit" class="hash-link" aria-label="Direct link to 一个PR尽量只用一个Commit" title="Direct link to 一个PR尽量只用一个Commit">​</a></h2>
<p>单发生多次代码修改的时候，在<code>commit</code>的时候使用最开始的<code>commit</code>，使用命令如下：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ git commit -s --amend --no-edit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -s 后会在PR中加入签名信息：Signed-off-by: lengrongfu 1275177125@qq.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># --amend 追加commit，使用同一个commit ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># --no-edit 不进行任何更改，如果要修改commit 信息就不要使用这个标签</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="go项目开发要注意什么">Go项目开发要注意什么<a href="https://lengrongfu.github.io/blog/github-contribute#go%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E8%A6%81%E6%B3%A8%E6%84%8F%E4%BB%80%E4%B9%88" class="hash-link" aria-label="Direct link to Go项目开发要注意什么" title="Direct link to Go项目开发要注意什么">​</a></h2>
<p><code>go</code>开源项目目前大多都是使用的<code>golangci-lint</code>、<code>goimports</code>来做代码格式等相关静态检查，在提交<code>PR</code>的时候都会检查是否符合这些工具的规范。</p>
<p>在<code>golangd</code>中配置上述工具，在文件产生变更的时候自动执行上述命令，进行格式校验，下面以<code>Mac Goland</code>为例讲解配置 ：</p>
<ul>
<li>通过<code>command+,</code>快捷键打开系统配置，或者点击左上角<code>preferences</code>菜单。</li>
<li>搜索<code>File Watchers</code></li>
<li>点击添加按钮，选择对应工具即可：
<img decoding="async" loading="lazy" alt="file-watcher.png" src="https://lengrongfu.github.io/assets/images/file-watcher-f877ea9658d79dce06211b14b3052467.png" width="1198" height="604" class="img_ev3q"></li>
<li>添加后可以选择所有项目生效或者当前项目生效。</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="gitignore是否可以不修改">.gitignore是否可以不修改<a href="https://lengrongfu.github.io/blog/github-contribute#gitignore%E6%98%AF%E5%90%A6%E5%8F%AF%E4%BB%A5%E4%B8%8D%E4%BF%AE%E6%94%B9" class="hash-link" aria-label="Direct link to .gitignore是否可以不修改" title="Direct link to .gitignore是否可以不修改">​</a></h2>
<p>很多编辑器都有对应的隐藏文件<code>.vscode</code>、<code>.idea</code>等，我们通过编辑器首次打开项目后都会生成这个文件，如果我们不想让这个文件提交，就只能往<code>.gitignore</code>里面加入忽略文件的信息。</p>
<p>但是从代码仓库管理员的角度看，如果每个人都把特定于个人的配置加入到<code>.gitignore</code>中，那整体维护起来将会很难。</p>
<p>有一个更好的解决办法：为您的所有存储库创建一个个人的全局<code>.gitignore</code>文件。</p>
<ul>
<li>选择一个地方存储全局<code>.gitignore</code>的文件，大多数人选择主目录</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ touch ~/.gitignore</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>在里面加入自己需要忽略的文件或者文件夹</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ vim ~/.gitignore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.DS_Store</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.idea</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.vscode</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>最后，配置git使用我们新创建的~/.gitignore文件</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ git config --global core.excludesfile ~/.gitignore</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>如果您是 Windows 用户，则需要以不同方式格式化路径</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ git config --global core.excludesfile %USERPROFILE%\.gitignore</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="引用">引用<a href="https://lengrongfu.github.io/blog/github-contribute#%E5%BC%95%E7%94%A8" class="hash-link" aria-label="Direct link to 引用" title="Direct link to 引用">​</a></h2>
<ul>
<li><a href="https://github.com/kubernetes/community/blob/master/contributors/guide/github-workflow.md" target="_blank" rel="noopener noreferrer">github-workflow.md</a></li>
</ul>]]></content:encoded>
            <category>Github</category>
        </item>
        <item>
            <title><![CDATA[Distribution Auth Type]]></title>
            <link>https://lengrongfu.github.io/blog/distribution-auth</link>
            <guid>https://lengrongfu.github.io/blog/distribution-auth</guid>
            <pubDate>Fri, 05 Aug 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[Distribution Auth认证流程介绍]]></description>
            <content:encoded><![CDATA[<p>Distribution Auth认证流程介绍</p>
<p><a href="https://github.com/distribution/distribution" target="_blank" rel="noopener noreferrer"><code>Distribution</code></a> 是一个按照 <code>OCI</code> 的规范实现的一个制品库管理工具，它提供了三种的认证方式，<code>htpasswd</code>、<code>silly</code>、<code>token</code>，在 <code>Distribution</code> 项目中采用的是策略模式。</p>
<p>它的认证流程如下图所示：</p>
<p><img decoding="async" loading="lazy" alt="auth" src="https://lengrongfu.github.io/assets/images/auth-02304b74ba61487a8263ce6a891a474d.png" width="610" height="781" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="htpasswd">htpasswd<a href="https://lengrongfu.github.io/blog/distribution-auth#htpasswd" class="hash-link" aria-label="Direct link to htpasswd" title="Direct link to htpasswd">​</a></h2>
<p><code>htpasswd</code> 是一种在系统中，它包含一个 <code>htpasswd</code> 的文件（文件内容是初始的用户名<code>docker</code>，以及一个使用特定算法随机生成的密码）以及如何解析这个文件的算法（目前只能使用 <code>bcrypt</code> 加密算法）。</p>
<p>配置格式如下：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">auth</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">htpasswd</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">realm</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> harbor</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">registry</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">basic</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">realm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /etc/registry/passwd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li>
<p>启动过程中会校验 <code>path</code> 对应的文件是否存在，如果不存在，就创建并写入内容，内容为用户：<code>docker</code>, 密码为随机生成并加密存储。</p>
</li>
<li>
<p>用户在请求过程中，每个请求都会进入配置好的访问控制器中，进行权限验证。</p>
</li>
<li>
<p>会首先判断 <code>Header</code> 中是否存在 <code>Authorization</code> 字段值，并正确解析；如果不存在，则认为无效认证。</p>
</li>
<li>
<p>如果存在用户密码则会和文件中写入的内容进行对比，确保是一致的（提示：在对比之前系统会先校验这个文件是否被修改过，如果被修改过就会从新生成文件内容）。</p>
</li>
</ol>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="silly">silly<a href="https://lengrongfu.github.io/blog/distribution-auth#silly" class="hash-link" aria-label="Direct link to silly" title="Direct link to silly">​</a></h2>
<p>这个主要是用于测试的，是简单功能的实现；它主要是检查 <code>Header</code> 中是否存在 <code>Authorization</code> 并且值非空，如果是就进行授权通过。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="token">token<a href="https://lengrongfu.github.io/blog/distribution-auth#token" class="hash-link" aria-label="Direct link to token" title="Direct link to token">​</a></h2>
<p><img decoding="async" loading="lazy" alt="auth" src="https://lengrongfu.github.io/assets/images/v2-registry-auth-df4a5006246cd127c0d0c30510537f50.png" width="472" height="360" class="img_ev3q"></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">auth</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">token</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">realm</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">5011/auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Authentication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">issuer</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Sample Issuer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">rootCertBundle</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /mnt/local/certs/RootCA.crt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>token</code> 认证需要借助外部认证服务，可以实现资源、权限的管理，<code>distribution</code> 的响应的时候会返回给用户 <code>scope</code> 就是资源权限</p>
<ol>
<li>启动过程会校验 <code>token</code> 配置的参数是否正确，并且校验 <code>tls</code> 证书。</li>
<li>用户请求时，会从 <code>Header</code> 中获取认证信息，如果没有认证，则会根据是否配置 <code>autoRedirect</code> 以及重定向地址 <code>realm</code>。</li>
<li><code>distribution</code> 会返回 <code>401</code> 的请求，并携带<code>WWW-Authenticate</code> 告诉客户端改如何向认证服务进行认证。</li>
</ol>
<blockquote>
<p>如：一个未授权的用户正在 <code>Push</code>镜像到 <code>samalba/my-app</code> repoName 中，就会返回</p>
<ul>
<li>scope: 授权范围</li>
<li>service: 授权服务</li>
<li>realm: 认证服务</li>
</ul>
</blockquote>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/1.1 401 Unauthorized</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: application/json; charset=utf-8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Docker-Distribution-Api-Version: registry/2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Www-Authenticate: Bearer realm="https://auth.docker.io/token",service="registry.docker.io",scope="repository:samalba/my-app:pull,push"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Date: Thu, 10 Sep 2015 19:32:31 GMT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Length: 235</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Strict-Transport-Security: max-age=31536000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{"errors":[{"code":"UNAUTHORIZED","message":"access to the requested resource is not authorized","detail":[{"Type":"repository","Name":"samalba/my-app","Action":"pull"},{"Type":"repository","Name":"samalba/my-app","Action":"push"}]}]}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="4">
<li>如果开启自动重定向，则请求的就是 <code>distribution</code> host 的接口：<code>https://%s/auth/token</code>，没有则走用户配置<code>realm</code></li>
</ol>]]></content:encoded>
            <category>镜像仓库</category>
        </item>
        <item>
            <title><![CDATA[Kubernetes Scheduler]]></title>
            <link>https://lengrongfu.github.io/blog/Kubernetes-Scheduler</link>
            <guid>https://lengrongfu.github.io/blog/Kubernetes-Scheduler</guid>
            <pubDate>Mon, 11 Jul 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[Kubernetes Scheduler 基本使用概念]]></description>
            <content:encoded><![CDATA[<p>Kubernetes Scheduler 基本使用概念</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="scheduler-workflow">Scheduler Workflow<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#scheduler-workflow" class="hash-link" aria-label="Direct link to Scheduler Workflow" title="Direct link to Scheduler Workflow">​</a></h2>
<p><img decoding="async" loading="lazy" alt="schedule-workflow" src="https://lengrongfu.github.io/assets/images/schedule-workflow-258bff258660b628d176de7fd4f26c2e.jpeg" width="1643" height="863" class="img_ev3q"></p>
<p><code>Scheduler WorkFlow</code>定义了<code>Scheduler Cycle</code>和<code>Binding Cycle</code>，在<code>Scheduler Cycle</code>中有串行<code>Filter </code>和<code>Score</code>两个阶段，<code>Bind</code>是异步并行阶段。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="scheduler-framework">Scheduler FrameWork<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#scheduler-framework" class="hash-link" aria-label="Direct link to Scheduler FrameWork" title="Direct link to Scheduler FrameWork">​</a></h2>
<p><code>Scheduler FrameWork</code>是通过在<code>Scheduler  Cycle</code>中通过预留扩展点来进行扩展调度流程，<code>FrameWork</code>预留了多个扩展点:</p>
<ul>
<li><code>QueueSortFunc() LessFunc</code>： <code>Pod</code> 从队列中获取的优先级</li>
<li><code>PreFilter</code>： 在过滤之前执行</li>
<li><code>Filter</code>： 执行过滤函数</li>
<li><code>PostFilter</code>: 执行抢占</li>
<li><code>PreScore</code>：执行`Score之前执行</li>
<li><code>Score</code>: 执行<code>Node</code>打分</li>
<li><code>PreBind</code>: 执行<code>Binding</code>之前</li>
<li><code>Bind</code>： 执行<code>Binding</code>动作</li>
<li><code>PostBind</code>：执行<code>Binding</code>之后</li>
</ul>
<p>自定义<code>Schedlue</code>可以通过直接实现<code>Scheduler FrameWork</code>中暴露的接口，然后在启动过程中进行<code>Plugin</code>注册即可。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	rand</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Seed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">UTC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">UnixNano</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	logs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InitLogs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> logs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FlushLogs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	cmd </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewSchedulerCommand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithPlugin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sample</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sample</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">New</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> cmd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Stderr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"%v\n"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="scheduler-plugin">Scheduler Plugin<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#scheduler-plugin" class="hash-link" aria-label="Direct link to Scheduler Plugin" title="Direct link to Scheduler Plugin">​</a></h2>
<p>如下的<code>Scheduler Plugin</code>是<code>kube-scheduler</code>里面内嵌的插件，涵盖了<code>WorkFlow</code>里面的所有流程。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="sort排序">Sort(排序)<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#sort%E6%8E%92%E5%BA%8F" class="hash-link" aria-label="Direct link to Sort(排序)" title="Direct link to Sort(排序)">​</a></h3>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1prioritysort">1.PrioritySort<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#1prioritysort" class="hash-link" aria-label="Direct link to 1.PrioritySort" title="Direct link to 1.PrioritySort">​</a></h4>
<p><code>PrioritySort</code>优先队列是进行<code>Pod</code>在入队时的排序函数，按找<code>Pod</code>的优先级进行排序，通过读取<code>pod.Spec.Priority</code>字段值进行排序，如果未设置<code>Pod</code>的优先级则按照添加到队列的时间先后进行排序。</p>
<div class="language-Go language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">p1 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> pod1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Priority </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> ? </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pod1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Priority </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p2 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> pod2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Priority </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> ? </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pod2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Priority </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p1 </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> p2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p1 </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> p2 </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> pInfo1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Timestamp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Before</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pInfo2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Timestamp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="filter预选">Filter(预选)<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#filter%E9%A2%84%E9%80%89" class="hash-link" aria-label="Direct link to Filter(预选)" title="Direct link to Filter(预选)">​</a></h3>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-interpodaffinity">1. InterPodAffinity<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#1-interpodaffinity" class="hash-link" aria-label="Direct link to 1. InterPodAffinity" title="Direct link to 1. InterPodAffinity">​</a></h4>
<p><code>InterPodAffinity</code> 检查<code>Pod</code>的亲和性是否满足，实现了<code>PreFilterPlugin</code>和<code>FilterPlugin</code>两个插件；</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2-nodeaffinity">2. NodeAffinity<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#2-nodeaffinity" class="hash-link" aria-label="Direct link to 2. NodeAffinity" title="Direct link to 2. NodeAffinity">​</a></h4>
<p><code>NodeAffinity</code>是<code>Node</code>亲和性的过滤，通过<code>pod.Spec.Affinity.NodeAffinity </code>是否配置<code>Node</code>亲和性和<code>Node</code>进行<code>Match</code>动作。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3nodename">3.NodeName<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#3nodename" class="hash-link" aria-label="Direct link to 3.NodeName" title="Direct link to 3.NodeName">​</a></h4>
<p><code>NodeName</code>用于在对<code>pod.Spec.NodeName</code>字段值的判断，判断是否是当前的<code>Node</code>，如果指定了<code>pod.Spec.NodeName</code>并且不是当前的节点，则返回<code>UnschedulableAndUnresolvable</code>状态。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4nodeports">4.NodePorts<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#4nodeports" class="hash-link" aria-label="Direct link to 4.NodePorts" title="Direct link to 4.NodePorts">​</a></h4>
<p><code>NodePorts</code>用于检查要启用的端口是否已经在<code>Node</code>上使用过，如果使用过则返回<code>Unschedulable</code>状态。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="5noderesourcesfit">5.NodeResourcesFit<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#5noderesourcesfit" class="hash-link" aria-label="Direct link to 5.NodeResourcesFit" title="Direct link to 5.NodeResourcesFit">​</a></h4>
<p><code>NodeResourcesFit</code> 检查节点是否有足够的资源，如:<code>cpu</code>、<code>memory</code>、<code>gpu</code>等，通过那取<code>max_resource(sum_pod, any_init_container)</code>和<code>node</code>可分配的资源来判断节点是否资源足够。如果有任一资源不够，此节点则会返回资源不足被过滤。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="6nodeunschedulable">6.NodeUnschedulable<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#6nodeunschedulable" class="hash-link" aria-label="Direct link to 6.NodeUnschedulable" title="Direct link to 6.NodeUnschedulable">​</a></h4>
<p><code>NodeUnschedulable</code> 插件过滤设置<code>node.Spec.Unschedulable=true</code>的节点，但是如果<code>Pod</code>设置了容忍<code>Unschedulable</code>的污点则不过滤。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7nodevolumelimits">7.NodeVolumeLimits<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#7nodevolumelimits" class="hash-link" aria-label="Direct link to 7.NodeVolumeLimits" title="Direct link to 7.NodeVolumeLimits">​</a></h4>
<p><code>NodeVolumeLimits</code>是一个节点检查<code>volume</code>容量的插件； 校验PVC指定的Provision在CSI plugin或非CSI Plugin（后三个）上报的单机最大挂盘数（存储插件提供方一般对每个节点的单机最大挂载磁盘数是有限制的）</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="8podtopologyspread">8.PodTopologySpread<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#8podtopologyspread" class="hash-link" aria-label="Direct link to 8.PodTopologySpread" title="Direct link to 8.PodTopologySpread">​</a></h4>
<p><code>PodTopologySpread</code> 是用于检查<code>Pod</code>的拓扑逻辑是否满足条件，</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9tainttoleration">9.TaintToleration<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#9tainttoleration" class="hash-link" aria-label="Direct link to 9.TaintToleration" title="Direct link to 9.TaintToleration">​</a></h4>
<p><code>TaintToleration</code>是一个污点容忍度的插件，用于检查<code>Pod</code>是否能容忍次污点。<code>Taint</code>污点是<code>Node</code>上的标签，<code>Toleration</code>容忍度是<code>Pod</code>上的功能，一个容忍度和一个污点相“匹配”是指它们有一样的<code>key</code>和<code>value</code>。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="10volumebinding">10.VolumeBinding<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#10volumebinding" class="hash-link" aria-label="Direct link to 10.VolumeBinding" title="Direct link to 10.VolumeBinding">​</a></h4>
<p><code>VolumeBinding</code>检查<code>Pod</code>挂载的<code>PVC</code>，如果其对应<code>SC(StorageClass)</code>的<code>VolumeBindingMode</code>是<code>Immediate</code>模式，该<code>PVC</code>必须已经是<code>bound</code>，否则需要返回<code>UnschedulableAndUnresolvable</code>。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11volumerestrictions">11.VolumeRestrictions<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#11volumerestrictions" class="hash-link" aria-label="Direct link to 11.VolumeRestrictions" title="Direct link to 11.VolumeRestrictions">​</a></h4>
<p><code>VolumeRestrictions</code> 检查挂载该Node上的卷是否满足存储提供者的要求</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="score优选">Score(优选)<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#score%E4%BC%98%E9%80%89" class="hash-link" aria-label="Direct link to Score(优选)" title="Direct link to Score(优选)">​</a></h3>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1imagelocality">1.ImageLocality<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#1imagelocality" class="hash-link" aria-label="Direct link to 1.ImageLocality" title="Direct link to 1.ImageLocality">​</a></h4>
<p><code>ImageLocality</code>是一个打分插件，对于调度<code>Pod</code>的镜像已经存在<code>Node</code>上给评分。已经存在的镜像并且镜像越大的分越高；（逻辑就是越大的镜像如果被重新拉取需要花费更多的时间，但是小的镜像拉起来就快，所以镜像存在并且越大的分越高就是这个逻辑）;如果一个节点上的镜像总大小<code>&lt; 23Mb</code>则<code>node</code>会被打<code>0</code>分；如果一个节点上的镜像总大于<code>1G * 容器数</code>则会被打<code>1</code>分。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2interpodaffinity">2.InterPodAffinity<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#2interpodaffinity" class="hash-link" aria-label="Direct link to 2.InterPodAffinity" title="Direct link to 2.InterPodAffinity">​</a></h4>
<p><code>InterPodAffinity</code>在<code>Pod</code>亲和性之间计算亲和性的的分值。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3nodeaffinity">3.NodeAffinity<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#3nodeaffinity" class="hash-link" aria-label="Direct link to 3.NodeAffinity" title="Direct link to 3.NodeAffinity">​</a></h4>
<p><code>NodeAffinity</code>是通过节点的亲和性来进行节点打分的，<code>PreScore</code> 主要逻辑是从<code>pod.Spec.Affinity.NodeAffinity.PreferredDuringSchedulingIgnoredDuringExecution</code>字段中获取首选节点亲和配置，主要的是配置的<code>weight</code>字段值，在通过<code>Label</code>匹配过程中，发现<code>Node.Meta.Label</code>是匹配<code>matchExpressions</code>中的字段则<code>score += weight</code>，这样这个节点的优先级就提高了。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4noderesourcesbalancedallocation">4.NodeResourcesBalancedAllocation<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#4noderesourcesbalancedallocation" class="hash-link" aria-label="Direct link to 4.NodeResourcesBalancedAllocation" title="Direct link to 4.NodeResourcesBalancedAllocation">​</a></h4>
<p><code>NodeResourcesBalancedAllocation</code>节点资源均衡插件，是一个通过<code>cpu</code>和<code>memory</code>容量分数之间的差异，根据他们的优先级进行排名；对于资源使用率均衡的节点分值更高。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># ResourceSpec[{"name":"cpu","Weight":1},{"name":"memory","Weight":1}]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">std =  Σ((fraction(i)-mean)^2)/len(resources)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># std计算取决于需要均衡几种资源，如果只有cpu和memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">std=Abs( (cpuRequest1/cpuAllocable1 - memoryRequest1/memoryAllocable1) / 2 )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># node打分则由如下计算</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">score = (1 - std) * MaxNodeScore(100)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="5noderesourcesfit-1">5.NodeResourcesFit<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#5noderesourcesfit-1" class="hash-link" aria-label="Direct link to 5.NodeResourcesFit" title="Direct link to 5.NodeResourcesFit">​</a></h4>
<p><code>NodeResourcesFit</code>打分已经配置的策略进行，有如下三种：</p>
<ul>
<li><code>LeastAllocated</code>: 优先分配资源最少的节点；就是资源堆叠</li>
<li><code>MostAllocated</code>: 优先分配资源最多的节点；就是资源打散</li>
<li><code>RequestedToCapacityRatio</code>: 可以自定义函数，对资源容量进行打分。</li>
</ul>
<p><code>LeastAllocated</code>计算节点分值逻辑：<code>(cpu((capacity-requested)*MaxNodeScore*cpuWeight/capacity) + memory((capacity-requested)*MaxNodeScore*memoryWeight/capacity) + ...)/weightSum</code></p>
<p>MostAllocated 计算节点分值逻辑：<code>(cpu(MaxNodeScore * sum(requested) / capacity) + memory(MaxNodeScore * sum(requested) / capacity) + ...) / weightSum</code></p>
<p><code>capacity</code>是<code>allocable</code></p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="6podtopologyspread">6.PodTopologySpread<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#6podtopologyspread" class="hash-link" aria-label="Direct link to 6.PodTopologySpread" title="Direct link to 6.PodTopologySpread">​</a></h4>
<p><code>PodTopologySpread</code>权重为2</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7selectorspread">7.SelectorSpread<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#7selectorspread" class="hash-link" aria-label="Direct link to 7.SelectorSpread" title="Direct link to 7.SelectorSpread">​</a></h4>
<p><code>SelectorSpread</code>是一个计算选择器传播优先级的打分插件；</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="8tainttoleration">8.TaintToleration<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#8tainttoleration" class="hash-link" aria-label="Direct link to 8.TaintToleration" title="Direct link to 8.TaintToleration">​</a></h4>
<p><code>TaintToleration计算无法容忍污点的一个插件，用于给</code>Pod 无法容忍污点打分，每一个无法容忍则<code>+1</code>，最后得到的就是<code>Node</code>的分。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="binding绑定">Binding(绑定)<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#binding%E7%BB%91%E5%AE%9A" class="hash-link" aria-label="Direct link to Binding(绑定)" title="Direct link to Binding(绑定)">​</a></h3>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-defaultbind">1. DefaultBind<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#1-defaultbind" class="hash-link" aria-label="Direct link to 1. DefaultBind" title="Direct link to 1. DefaultBind">​</a></h4>
<p><code>DefaultBind</code>是通过使用<code>k8s client</code>绑定<code>Pod</code>到<code>Node</code>。绑定流程是先创建一个<code>Binding</code>类型对象，通过设置<code>Target</code>字段值，来记录绑定对象的目标对象。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Binding是将一个对象与另一个对象联系起来</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Binding </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TypeMeta </span><span class="token string" style="color:#e3116c">`json:",inline"`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ObjectMeta </span><span class="token string" style="color:#e3116c">`json:"metadata,omitempty" protobuf:"bytes,1,opt,name=metadata"`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Target ObjectReference </span><span class="token string" style="color:#e3116c">`json:"target" protobuf:"bytes,2,opt,name=target"`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">binding </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Binding</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		ObjectMeta</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ObjectMeta</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Namespace</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> UID</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UID</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		Target</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ObjectReference</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Node"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nodeName</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>创建<code>Binding</code>对象之后，通过<code>Pods</code>的<code>Bind</code>方法就可以进行结果绑定。最终是创建<code>Pod</code>的绑定。</p>
<div class="language-http codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-http codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /api/v1/namespaces/{namespace}/pods/{name}/binding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace: pod namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">name: binding 名字</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">body: Binding对象结构体</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>选中的节点在和待调度Pod进行Bind的时候，有可能会Bind失败，此时需要做回退，把Pod的Assumed状态退回Initial，从Node里面把Pod数据账本擦除掉，会把Pod重新丢回到unschedulableQ队列里面。在unschedulableQ里，如果一个Pod一分钟没调度过，就会重新回到activeQ。它的轮询周期是30s。</p>
<p>调度失败的<code>Pod</code>会放到<code>backoffQ</code>，在<code>backoffQ</code>里等待的时间会比在<code>unschedulableQ</code>里更短，<code>backoffQ</code>里的降级策略是<code>2</code>的指数次幂降级。假设重试第一次为<code>1s</code>，那第二次就是<code>2s</code>，第三次就是<code>4s</code>，但最大到<code>10s</code>。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2volumebinding">2.VolumeBinding<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#2volumebinding" class="hash-link" aria-label="Direct link to 2.VolumeBinding" title="Direct link to 2.VolumeBinding">​</a></h4>
<p><code>VolumeBinding</code>是<code>PreBinding</code>作为<code>Binding</code>之前检查的<code>Volume</code>是否绑定到<code>Node</code>上面，</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="preemption抢占">Preemption(抢占)<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#preemption%E6%8A%A2%E5%8D%A0" class="hash-link" aria-label="Direct link to Preemption(抢占)" title="Direct link to Preemption(抢占)">​</a></h3>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1defaultpreemption">1.DefaultPreemption<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#1defaultpreemption" class="hash-link" aria-label="Direct link to 1.DefaultPreemption" title="Direct link to 1.DefaultPreemption">​</a></h4>
<p><code>DefaultPreemption</code>是一个<code>PostFilter</code>插件，实现了默认抢占逻辑；当高优先级的<code>Pod</code>没有找到合适的<code>Node</code>时，会执行<code>Preempt</code>抢占算法，抢占的流程。</p>
<ul>
<li>一个<code>Pod</code>进入抢占的时候，首先会判断<code>Pod</code>是否拥有抢占的资格，有可能上次已经抢占过一次。</li>
<li>如果符合抢占资格，会先对所有的节点进行一次过滤，过滤出符合这次抢占要求的节点。然后</li>
<li>模拟一次调度，把优先级低的<code>Pod</code>先移除出去，再尝试能否把待抢占的<code>Pod</code>放置到此节点上。然后通过这个过程从过滤剩下的节点中选出一批节点进行抢占。</li>
<li><code>ProcessPreemptionWithExtenders</code>是一个扩展的钩子，用户可以在这里加一些自己抢占节点的策略。如果没有扩展的钩子，这里面不做任何动作。</li>
<li><code>PickOneNodeForPreemption</code>，从上面选出的节点里挑选出最合适的一个节点，策略包括：<!-- -->
<ul>
<li>优先选择打破<code>PDB</code>最少的节点；</li>
<li>其次选择待抢占<code>Pods</code>中最大优先级最小的节点；</li>
<li>再次选择待抢占<code>Pods</code>优先级加和最小的节点；</li>
<li>接下来选择待抢占<code>Pods</code>数目最小的节点；</li>
<li>最后选择拥有最晚启动<code>Pod</code>的节点；</li>
</ul>
</li>
</ul>
<p>通过过滤之后，会选出一个最合适的节点。对这个节点上待抢占的<code>Pod</code>进行<code>delete</code>，完成抢占过程。</p>]]></content:encoded>
            <category>Kubernetes</category>
            <category>Kubernetes Scheduler</category>
        </item>
        <item>
            <title><![CDATA[读《云计算那些事儿》]]></title>
            <link>https://lengrongfu.github.io/blog/读云计算那些事儿</link>
            <guid>https://lengrongfu.github.io/blog/读云计算那些事儿</guid>
            <pubDate>Wed, 18 May 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[云计算的根本就是把基础资源虚拟化之后以更小的力度提供出来的能力。]]></description>
            <content:encoded><![CDATA[<p>云计算的根本就是把基础资源虚拟化之后以更小的力度提供出来的能力。</p>
<p>云计算的根本就是把基础资源虚拟化之后以更小的力度提供出来的能力。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="云计算分类">云计算分类<a href="https://lengrongfu.github.io/blog/%E8%AF%BB%E4%BA%91%E8%AE%A1%E7%AE%97%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF#%E4%BA%91%E8%AE%A1%E7%AE%97%E5%88%86%E7%B1%BB" class="hash-link" aria-label="Direct link to 云计算分类" title="Direct link to 云计算分类">​</a></h2>
<ul>
<li>IaaS: 基础设施即服务，就是将基础设施当作服务队外输出，计算、网络、存储这些原始资源就是基础设施资源，通过互联网队外提供服务。虚拟化是IaaS实现的基础，通过计算虚拟化、网络虚拟化、存储虚拟化将物理资源整合成虚拟的资源池，然后把资源以按需的形式提供给资源申请者，从而完成资源的二次分配。</li>
<li>PaaS：平台即服务，它直接为用户提供一套平台，包括语言运行环境、编程框架及数据存储中间件等一系列功能。PaaS将管理的对象从资源升级到服务，面向接口编程和运维。</li>
<li>SaaS: 软件即服务，它是最高层的抽象，对于最终的用户，它不关心任何技术相关内容，以服务的方式交付。如：在线的云编辑器。</li>
<li>FaaS：函数即服务，通过定义一些CRUD操作函数，在特定事件下触发这些函数， 并执行。</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="关键技术">关键技术<a href="https://lengrongfu.github.io/blog/%E8%AF%BB%E4%BA%91%E8%AE%A1%E7%AE%97%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF#%E5%85%B3%E9%94%AE%E6%8A%80%E6%9C%AF" class="hash-link" aria-label="Direct link to 关键技术" title="Direct link to 关键技术">​</a></h2>
<p>资源调度：资源调度就是当用户申请资源的时候，系统需要通过调度确定资源位置。</p>
<p>Google在Omega的调度系统论文中将调度分为三类：</p>
<ul>
<li>单体：单体调度是指所有任务都是通过一个串行调度器分配的，典型代表是Kubernetes，它的优点是简单，缺点是很难支持多类型任务的执行，如同时支持批处理和长任务。</li>
<li>二层调度：二层调度是将资源分配和任务调度分离，第一层是从全局的资源池中分配资源给各种类型任务调度器，第二层任务调度器依据任务特点启动任务，典型代表是Mesos和Yarn。二层调度的优点是可以减少调度时间，缺点是：资源调度无法感知全局资源，只了解自己的可用资源，并且每个任务调度器只会最大化自己的利益，造成全局资源的使用平衡。</li>
<li>共享状态：共享状态调度器，它通过在每个任务调度器中保存一份整个集群状态信息的副本，从而实现全局调度，如Omega的实现。</li>
</ul>
<p>通常的调度流程分为两层：第一层是主机过滤，第二层是主机打分，当服务器达到一定规模后，过滤和打分将会耗费很多时间，优化的方式通常包括：分区调度（将主机划分成多个集群，每次调度只针对集群）、并行调度（将调度算法并行化处理，提高执行效率，并采用乐观锁和重试机制）。在资源混部的情况下，资源调度更加复杂：虚拟机和容器混部、流或批处理任务与常驻进程混部、多任务优先级QOS等。</p>
<h1>虚拟化与IaaS</h1>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="计算虚拟化">计算虚拟化<a href="https://lengrongfu.github.io/blog/%E8%AF%BB%E4%BA%91%E8%AE%A1%E7%AE%97%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF#%E8%AE%A1%E7%AE%97%E8%99%9A%E6%8B%9F%E5%8C%96" class="hash-link" aria-label="Direct link to 计算虚拟化" title="Direct link to 计算虚拟化">​</a></h2>
<p>计算虚拟化就是在虚拟系统和底层硬件之间抽象出CPU和内存等，以供虚拟机使用。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="网络虚拟化">网络虚拟化<a href="https://lengrongfu.github.io/blog/%E8%AF%BB%E4%BA%91%E8%AE%A1%E7%AE%97%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF#%E7%BD%91%E7%BB%9C%E8%99%9A%E6%8B%9F%E5%8C%96" class="hash-link" aria-label="Direct link to 网络虚拟化" title="Direct link to 网络虚拟化">​</a></h2>
<p>网络虚拟化是在物理网络拓扑基础之上建立的虚拟网络，它不依赖底层物理网络，能狗实现网络拓扑的动态变化，并且提供多租户隔离。
在网络虚拟化环境中，一切都可以自定义，首先是网络设备的虚拟化，虚拟交换机，虚拟路由器，虚拟负载均衡和虚拟防火墙。</p>
<ul>
<li>网卡虚拟化：通过SR-IOV技术可以实现一个物理网卡虚拟多个网卡，还可以通过tap/veth实现网卡虚拟化。</li>
<li>链路层虚拟化：主要通过虚拟交换机，实现网络包的VLAN设置、隧道建立等。</li>
<li>网络层虚拟化：包括VPN、Overlay网络等，创建一套隔离的三层网络。</li>
</ul>
<p>随着云计算和大数据的兴起，东西流量越来越多：</p>
<ul>
<li>南北流泪：从防火墙进入到目标服务器经过的流量。</li>
<li>东西流量：服务器和服务器之间的流量；比如分布式存储系统在服务之间进行数据复制会产生较多的东西流量。</li>
</ul>
<p>Linux收发包流程：
<img decoding="async" loading="lazy" alt="netfilter" src="https://lengrongfu.github.io/assets/images/netfilter-23e56d5d87761d44efdbe45c1833993a.jpeg" width="1476" height="749" class="img_ev3q"></p>
<p>网络模块<code>net_rx_action</code>会调用驱动将网络包转化为网络模块能够识别的SKB格式，然后经过<code>netfilter</code>后发送到用上层协议栈中。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="vlan">VLAN<a href="https://lengrongfu.github.io/blog/%E8%AF%BB%E4%BA%91%E8%AE%A1%E7%AE%97%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF#vlan" class="hash-link" aria-label="Direct link to VLAN" title="Direct link to VLAN">​</a></h3>
<p><code>VLAN</code>的中文名为虚拟局域网，VLAN的出现是为了解决二层链路中广播域的问题，传统的二层链路层广播访问太广，需要用三层路由来做lan切分隔离广播域，但是路由器的接口较少，因此在交换机上配置VLAN，使之一个交换机可以按需求配置多个LAN，来屏蔽广播域。</p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/35616289" target="_blank" rel="noopener noreferrer">VLAN基础知识</a></li>
<li><a href="https://blog.csdn.net/weixin_40748006/article/details/80181493" target="_blank" rel="noopener noreferrer">VLAN详解</a></li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="存储虚拟化">存储虚拟化<a href="https://lengrongfu.github.io/blog/%E8%AF%BB%E4%BA%91%E8%AE%A1%E7%AE%97%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF#%E5%AD%98%E5%82%A8%E8%99%9A%E6%8B%9F%E5%8C%96" class="hash-link" aria-label="Direct link to 存储虚拟化" title="Direct link to 存储虚拟化">​</a></h2>
<p>存储虚拟化通过软件的方式重塑存储系统，不依赖具体的存储硬件。比如通常云存储所指的公有云提供的文件存储、块存储、对象存储都是通过存储虚拟化实现的。</p>
<p>存储分类：</p>
<ul>
<li>块存储：文件会被分块存储到磁盘，以磁盘方式提供。块存储都遵循SCSI协议，</li>
<li>文件存储：以文件目录的方式提供。网络文件系统NFS。</li>
<li>对象存储：以二进制对象的形式提供服务。</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="分布式存储">分布式存储<a href="https://lengrongfu.github.io/blog/%E8%AF%BB%E4%BA%91%E8%AE%A1%E7%AE%97%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF#%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8" class="hash-link" aria-label="Direct link to 分布式存储" title="Direct link to 分布式存储">​</a></h3>
<p><img decoding="async" loading="lazy" alt="dis" src="https://lengrongfu.github.io/assets/images/dis-storage-7aaa39b774f81427f5f5656b23b244c7.png" width="705" height="364" class="img_ev3q">
上图展示了分布式存储的总体架构，总体有有元数据管理节点和数据管理节点，要实现分布式系统，保证存储元数据模块的高可用。</p>
<p>分布式系统都不能违背CAP定理：</p>
<ul>
<li>C（Consistenncy）：一致性，指在分布式系统中多副本数据的一致性。</li>
<li>A（Avaliability）：可用性，这里指能够随时读写数据。</li>
<li>P（Partition tolerance）：即分区容错性，这里指能够容忍网络中断出现分区的情况。</li>
</ul>
<p>在一些要求不高的场景下，保证基本可用和弱一致即可，对应的是BASE理论L：</p>
<ul>
<li>B（Basically Avaliable）：基本可用</li>
<li>S（Soft State）：软状态</li>
<li>E（Eventual Consistency）最终一致。</li>
</ul>
<p>数据分布寻址问题，如何查找到文件在那个数据节点中，共有两种种方法：；</p>
<ul>
<li>在元数据中标示数据的分布，如HDFS中，NameNode保存了所有块的元数据；它的优点是：避免在添加节点时数据迁移，缺点是：需要额外维护一套元数据，并且元数据服务的可用性是个问题。可用通过采用Raft算法来解决元数据服务的可用性问题。</li>
<li>通过DHT算法计算得到数据的分布，如采用一致性Hash环算法，或者rados算法；它的优点是：不会存储元数据服务瓶颈和可用性问题，缺点是：在增减节点的时候，整个算法需要重新计算，导致大量数据重新分布，不仅影响集群性能，还可能造成集群暂时不可用。</li>
</ul>
<p>开源Ceph解决数据分布寻址使用的是CRUSH方案。</p>]]></content:encoded>
            <category>读书笔记</category>
        </item>
        <item>
            <title><![CDATA[Linux网络虚拟化:探索NetWork Namespace]]></title>
            <link>https://lengrongfu.github.io/blog/Linux-Network-Namespace</link>
            <guid>https://lengrongfu.github.io/blog/Linux-Network-Namespace</guid>
            <pubDate>Thu, 12 May 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[NetWork Namespace 是 Linux 2.6 版本引入的，作用是隔离出一个独立的网络栈（包括设备、IP、路由表、端口、防火墙等），它能创建多个隔离的网络空间。]]></description>
            <content:encoded><![CDATA[<p><code>NetWork Namespace</code> 是 <code>Linux 2.6</code> 版本引入的，作用是隔离出一个独立的网络栈（包括设备、IP、路由表、端口、防火墙等），它能创建多个隔离的网络空间。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="network-namespace简介">NetWork Namespace简介<a href="https://lengrongfu.github.io/blog/Linux-Network-Namespace#network-namespace%E7%AE%80%E4%BB%8B" class="hash-link" aria-label="Direct link to NetWork Namespace简介" title="Direct link to NetWork Namespace简介">​</a></h2>
<p><code>NetWork Namespace</code> 是 <code>Linux 2.6</code> 版本引入的，作用是隔离出一个独立的网络栈（包括设备、IP、路由表、端口、防火墙等），它能创建多个隔离的网络空间。</p>
<p>在<code>Linux</code>系统上，我们可以使用<code>ip</code>命令来创建和管理<code>Network namespace</code>。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="ip-netns-命令手册">ip netns 命令手册<a href="https://lengrongfu.github.io/blog/Linux-Network-Namespace#ip-netns-%E5%91%BD%E4%BB%A4%E6%89%8B%E5%86%8C" class="hash-link" aria-label="Direct link to ip netns 命令手册" title="Direct link to ip netns 命令手册">​</a></h3>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SYNOPSIS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ip netns [ list ]：列出所有的network namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ip netns add NETNSNAME：添加一个新的ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ip [-all] netns del [ NETNSNAME ]：删除所有或者指定的ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ip netns set NETNSNAME NETNSID：修改netnsname或者netnsid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ip netns identify [ PID ]：把某个进程加入到network namespace中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ip netns pids NETNSNAME：列出加入当前ns的pid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ip [-all] netns exec [ NETNSNAME ] command...：在netns中执行命令，如ping、ifconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ip netns monitor：监控</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>按照操作手册中的命令就可以创建 <code>ns</code>.</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="管理network-namespace">管理Network Namespace<a href="https://lengrongfu.github.io/blog/Linux-Network-Namespace#%E7%AE%A1%E7%90%86network-namespace" class="hash-link" aria-label="Direct link to 管理Network Namespace" title="Direct link to 管理Network Namespace">​</a></h3>
<ul>
<li>创建NS</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns add nets1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nets1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>查看NS中的网络信息</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets1 ip link list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1: lo: &lt;LOOPBACK&gt; mtu 65536 qdisc noop state DOWN mode DEFAULT group default qlen 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets1 route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kernel IP routing table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets1 iptables -L</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Chain INPUT (policy ACCEPT)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">target     prot opt source               destination         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Chain FORWARD (policy ACCEPT)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">target     prot opt source               destination         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Chain OUTPUT (policy ACCEPT)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">target     prot opt source               destination</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>从结果来看，创建的<code>nets1</code>网络栈中只有<code>lo</code>这个未启用的回环设备，并且没有配置路由和防火墙规则等。</p>
<ul>
<li>创建一个网络设备并配置IP</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 创建veth pair虚拟网络设备网卡</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建一个veth0和veth1的veth 对，把veth1插入到nets1的网络栈中，veth0默认在跟network namespace中。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link add  veth0 type veth peer name veth1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link set veth1 netns nets1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 此时查看就发现多了一个网络设备veth1，但是设备没有启动，并且没有配置IP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets1 ip link list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1: lo: &lt;LOOPBACK&gt; mtu 65536 qdisc noop state DOWN mode DEFAULT group default qlen 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">9: veth1@if10: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link/ether aa:54:ee:12:3a:34 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 启用网卡，并设置ip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets1 ifconfig veth1 10.1.1.1/24 up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets1 ifconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">veth1: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inet 10.1.1.1  netmask 255.255.255.0  broadcast 10.1.1.255</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ether aa:54:ee:12:3a:34  txqueuelen 1000  (Ethernet)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RX packets 0  bytes 0 (0.0 B)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RX errors 0  dropped 0  overruns 0  frame 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TX packets 0  bytes 0 (0.0 B)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>删除veth对和ns</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># veth对是一个整体，删除veth0，veth1也就不存在。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link del veth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns del nets1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="单主机两个-network-namespace-之间通信">单主机两个 NetWork Namespace 之间通信<a href="https://lengrongfu.github.io/blog/Linux-Network-Namespace#%E5%8D%95%E4%B8%BB%E6%9C%BA%E4%B8%A4%E4%B8%AA-network-namespace-%E4%B9%8B%E9%97%B4%E9%80%9A%E4%BF%A1" class="hash-link" aria-label="Direct link to 单主机两个 NetWork Namespace 之间通信" title="Direct link to 单主机两个 NetWork Namespace 之间通信">​</a></h2>
<p><img decoding="async" loading="lazy" alt="veth1" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAeMAAADJCAIAAACfVc2LAAAAAXNSR0IArs4c6QAAAJBlWElmTU0AKgAAAAgABgEGAAMAAAABAAIAAAESAAMAAAABAAEAAAEaAAUAAAABAAAAVgEbAAUAAAABAAAAXgEoAAMAAAABAAIAAIdpAAQAAAABAAAAZgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAAeOgAwAEAAAAAQAAAMkAAAAAaRpUAwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAgtpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpSZXNvbHV0aW9uVW5pdD4yPC90aWZmOlJlc29sdXRpb25Vbml0PgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICAgICA8dGlmZjpDb21wcmVzc2lvbj41PC90aWZmOkNvbXByZXNzaW9uPgogICAgICAgICA8dGlmZjpQaG90b21ldHJpY0ludGVycHJldGF0aW9uPjI8L3RpZmY6UGhvdG9tZXRyaWNJbnRlcnByZXRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CtQK6igAABbVSURBVHgB7d17lE31/8fxGZcQFnL5IneKkkouFSktJIxcVmWJ6LbSCmH9VFau00XLj8hCkUVuqxWyqq9RCLnlOqWLW+6Ma7mNCU2Y+b2aXXvNzxnjzDmfz9n7zDzPH2ftvc9nvz/7PPY+L9tn7zMnNj09PYYHAggggICPBQpo2+Lj4328hWwaAgggkNcF/k5qPeLi4pwJnhFAAAEEfCWQkJCQz1cbxMYggAACCAQKkNSBJixBAAEE/CVAUvtrf7A1CCCAQKAASR1owhIEEEDAXwIktb/2B1uDAAIIBAqQ1IEmLEEAAQT8JUBS+2t/sDUIIIBAoABJHWjCEgQQQMBfAiS1v/YHW4MAAggECpDUgSYsQQABBPwlQFL7a3+wNQgggECgAEkdaMISBBBAwF8CJLW/9gdbgwACCAQKkNSBJixBAAEE/CVAUvtrf7A1CCCAQKAASR1owhIEEEDAXwIktb/2B1uDAAIIBAqQ1IEmLEEAAQT8JUBS+2t/sDUIIIBAoABJHWjCEgQQQMBfAiS1v/YHW4MAAggECpDUgSYsQQABBPwlQFL7a3+wNQgggECgAEkdaMISBBBAwF8CJLW/9gdbgwACCAQKkNSBJixBAAEE/CVAUvtrf7A1CCCAQKAASR1owhIEEEDAXwIktb/2B1uDAAIIBAqQ1IEmLEEAAQT8JUBS29of58+fX758+YkTJ4LsYNOmTS1btgy+fZBlaYZA8Ifihg0bXnnllbi4uG7dun344YcXLlxAzycCJLWtHXHgwIHXX3/9559/DqaDpKSkMWPGnD17Ni0tLZj2tEEgeIEgD8WVK1f26dPn0KFDOmMoVarUtGnTBg0alJ6eHnxHtLQnUMBeaSoHI7B27dr33ntPSR1MY9ogYE9g8uTJCuiZM2eWKFFCvQwdOvTrr78+ePBgtWrV7HVK5SAFSOrrQ/3xxx8vvfRSz549NUCxZs0azTZu3Hjw4MGlS5fWypodN27c+vXrU1NTGzZsqJbVq1efOnXq4sWL9eqECRNmz549a9asY8eOKZETExPVrFKlSj169Gjfvr0aqEjz5s01sXPnzs2bN2uCBwLXErB3KF66dGnv3r2dO3d2YlobcP/99yupdYpNUl9rd0RyOUl9fW2NSChG4+Pjy5Qp06ZNmx07dqxevfrGG298++23dXw/++yzR44ceeyxxwoUKLBw4cKffvppxowZyt8KFSrofEQnKQpu9TFw4MD9+/d36tSpePHiCnFVU17Xr1//toyHGsydO5ekvv7OyNst7B2Kd9xxh06ib731Vhd4165dmq5YsaK7hAkPBUjqYPGLFSs2Z84cPWuFLl26fP/995pYsGCB8nfixIn33XefZpXXOln+7LPPNN5Xu3ZtXZ/p3r17q1atLl68+Ouvv2r479VXX1Uz5fXTTz+9bds2JbVmeSCQIwFLh6KOXnczdNKgU4c6derUrFnTXciEhwJcUQwWv0WLFk5MawUl7Llz5zShA1rnyJcvX9Zwsx6//fZbuXLlVq1adVXRIkWK1KhRQ7eCjBgxQq9qdunSpQrxq5oxi0AwAlYPRZ226z+Fffv2LVmy5MiRI2NjY4PZJNrYFuCcOlhhZ1Taae0evhr3SElJ6d+/f+Yqyu7Ms8706NGjR40a9dVXXyUkJOTLl69Jkya6sF6+fPnAlixBIHsBe4fi0aNHNQaiEbymTZsOGzYsc0fZbxKv2hYgqUMUdu5e0qGsm1V12TBzFTfHMy+sWrXqBx98kJycvGXLFg1n68z6zTff1JLMbZhGIAQBU4eiTjteeOEFjdTpyGzbtm0IW8Iq9gQY/QjLVoPR+q6KolnXx/XQVUSdknzyySdXFd2zZ0/Hjh2XLVumC+u600M3gegyoxZe1YxZBEIWCP9Q1H/7FNO6bYmYDnkv2FuRc+qwbLt27aoLL71799bNeRp91k0duktkyJAhKqpZPS9ZskRf9NKhr2+16LstukWvcuXKurqo/2Y2atQorL5ZGYFMAmEeir///rsutOgOkO0ZD7fwgw8+qPuX3FkmvBIgqa8vr2FlNXKendaadmbLli07ZcoU/W9Rlwr10i233KK78XR2o+kqVaooizMuNK7t0KHD2LFj33nnneHDhzsVGjRooDuynWnn2SmYeQnTCFwl4BwkmQ8VTTuzYR6KOsNQX1szHpk71RdhSOrMIF5Nx2qQS/f26pv+Xm1B7uhX1xX//PNPfVqyeTuiPnXqlL68oNHtLK86ZrMuLyEQpACHYpBQUdRMtyF4cE6tXqPIiE3NkYAP/8nneMvRHoyuxj483iwBepDUGe/kn0EAS++Ksh4JxHvU73W6/XfM6TrNeDm6BOJ9erhZUeTeDyusFEUAAQQMCpDUBjEphQACCFgRIKmtsFIUAQQQMChAUhvEpBQCCCBgRYCktsJKUQQQQMCgAEltEJNSCCCAgBUBktoKK0URQAABgwIktUFMSiGAAAJWBEhqK6wURQABBAwKkNQGMSmFAAIIWBEgqa2wUhQBBBAwKEBSG8SkFAIIIGBFgKS2wkpRBBBAwKAASW0Qk1IIIICAFQGS2gorRRFAAAGDAiS1QUxKIYAAAlYESGorrBRFAAEEDAqQ1AYxKYUAAghYESCprbBSFAEEEDAoQFIbxKQUAgggYEWApLbCSlEEEEDAoABJbRCTUggggIAVAZLaCitFEUAAAYMCJLVBTEohgAACVgRIaiusFEUAAQQMCpDUBjEphQACCFgRIKmtsFIUAQQQMChAUhvEpBQCCCBgRYCktsJKUQQQQMCgAEltEJNSCCCAgBUBktoKK0URQAABgwIktUFMSiGAAAJWBEhqK6wURQABBAwKkNQGMSmFAAIIWBEgqa2wUhQBBBAwKEBSG8SkFAIIIGBFgKS2wkpRBBBAwKAASW0Qk1IIIICAFQGS2gorRRFAAAGDAiS1QUxKIYAAAlYESGorrBRFAAEEDAqQ1AYxKYUAAghYESCprbBSFAEEEDAoQFIbxKQUAgggYEWApLbCSlEEEEDAoABJbRCTUggggIAVAZLaCitFEUAAAYMCJLVBTEohgAACVgRIaiusFEUAAQQMCpDUBjEphQACCFgRIKmtsFIUAQQQMChAUhvEpBQCCCBgRYCktsJKUQQQQMCgAEltEJNSCCCAgBUBktoKK0URQAABgwIFDNbKJaXS42NiPXor6TExscM96ptuo0AgPv7vQ8SjDU0fPtyrrj16x37qlqQO2BuxMcNXrgxYGokF8c2bR6Ib+ohigVgOzijee2FsOqMfYeCxKgIIIBARAZI6Isx0ggACCIQhQFKHgceqCCCAQEQESOqIMNMJAgggEIYASR0GHqsigAACEREgqSPCTCcIIIBAGAK5KqlTU1O2b1+QnHzYAZk9u/WUKQ2vhXPo0Lo5c9qOG1ftww/vXrLkf7TutVqyHAEEwhdISUldsGD74cPJTqnWrWc3bDgl+7LLl+8rW/Z/3VWyb5y7X81VSX3y5M558x5PSlrn7LO0tCvp6Vey3H/Hjm2ZMeOho0cT69TpWLJk1fXrx376aacsW7IQAQSMCOzcefLxx+etW5fkVLtyJe3KFX2R55qPPXtO9ev39cmTF7Jvds31c9cLXn3zJd4O45GMsvNjYnZkTOyLibkYE5NFX2vXzleI9+z5+H/+UyomptR//3v4hx+WJyW9ULlyZTsbFnzVLLY2+JVpmaVAPKhZuuRwYZiMRzI+nfPnx+zI+HTu2xdz8WJMljV37dq1ePHi06dPOxv4/vsxJUvmcFtzXXMPkjouLi4YxuHDhx85cmTKlCn58+d32g8YMKBUqVLDhg3T7Ny5cz///POkpKTbb7+9c+fObdq0mTp16tKlS/XSunXrtm/fPmvWrEWLFiUnJ588eXLevHl6rl69+sCBAxs1aqQ248ePv/POO59//nmnco0aNXr06FG4cGFtW0JCgrPQk+cgcTzZtijtNDeR+ufgtPrx3LFjh/Op37lz5+bNm1u0aFGhQoUoPfxMbbZ/Rz+qVav2448/btmyxXmrBw8eXLNmTaVKlTQ7ceLE0aNHlylTpmvXrikpKUOHDtW/wKVLl3Z2p9JcyeuspX+clfVNmzZt166dcv+11167cOFCamrqmTNnFNwuotP++PHj7hImEEAgGwF7H091etttt/XLeDRv3jybbchTL3lwTh2k76OPPjpp0qQVK1Y0bPj3VcFVq1bpuXXr1seOHZszZ07Hjh2HDBmiJb169XrmmWcmT578xRdf1K5de8OGDd27d2/VqpXbizL9gQce0OzNN9+sZrt3765atapmixUr5rbR2bT+DVeIu0uYQACBbATsfTzvuuuubPrNsy/595xaJ8h33333t99+m57+92WHlStX1qtXT2mrE+3Lly9rQHltxmPjxo01a9Y8fPjw3r17A/eiTrSdmNZLqqZnnYPHxsZq4sqV/3exMS0tzekosAhLEEDgKgF7H8+rOmLWEfDvObW2T6PP77777rZt23RY/PLLLxpl1kINYuh5woQJzhtwn0+dOlW0aFF31plQUrtLnIBWHBcsWFALNQbivqRpLS9UqJC7hAkEEMhewNLHM/tO8+yrvk7qli1bauxCAyA6g1bOOmMaTviOGTNGI2WZd1u5cuX279+fecm1pm/MeBw6dMhtoCuTmtbAt7uECQQQyF7A0scz+07z7Kv+Hf3QLilRooQuBiqpNfTRuHHjm266SQvr1Kmj5wMHDiipncfChQt1up0vXw7ei+4Y0Un6iRMnnB2/bNkyTdStW9eZ5RkBBK4rYO/jed2u82ADX59Ta3/of1iDBg3SMPSIESOc3aPrwkptXRvUkIUuPmzdulUXGHVRUVcFixQpojZLlizRtcEOHTo47bN87tSpU2Jiom4F0d0jOqGePXu2BljuvffeLBuzEAEEshSw9PHMsq88vtDvSd2sWTONPl+6dCnz/ToavNbj448/1qVFnWjrDryePXtqR1apUkW3SztXGq+V1M5ote4hUfpPnz7duYGkVq1a8fHxjFPn8Q8Dbz+nApY+nu5m5Og/yu5auXIiVlfSFFLR+O0AxbTugNbdIE74hrB7dPuH7vkrXry4/h/nrq4vF3j4A0jRuCNcOiZsC0TRwRn+x9M2ZhTV1373+zl1NpoFChRwvgiTTZvsX9I91GFWyL4+ryKQZwXC/3jmWbos33gUJ3WW78fIQn551ggjRWwIcHDaUPV/TZL66n0UzviD/senb73rO5A6obi6LvMIhC3AwRk2YbQWyMGdbdH6FiO43forJV26dPnhhx8i2CddIRCUAAdnUEx+bURSm9wz8+fP1+VNPZssSi0ETAhwcJpQ9KwGSW2M/vz587pBUPfSfPfdd5o2VpdCCIQtwMEZNqHHBUhqYztAX3R0/qiunr/55htjdSmEQNgCHJxhE3pcgKQ2tgM+/fTTi/oRC/3MzMWL+qEDY3UphEDYAhycYRN6XICkNrMD9I1H3fXh1tK0lrizTCDgoQAHp4f4promqc1I6ncMNELt1tK0fjzMnWUCAQ8FODg9xDfVNUltRnLGjBn6GwX6yyHOQ0k9c+ZMM6WpgkB4Ahyc4fn5Ym2+oGFmN+iv8elnOlVr5MiRb7zxhib0N//MlKYKAuEJcHCG5+eLtaP4LzT5wi9gI/Srj/p7qgGLWYCA9wIcnN7vg5C2QH+hidGPkORYCQEEEIigAEkdQWy6QgABBEISIKlDYmMlBBBAIIICJHUEsekKAQQQCEmApA6JjZUQQACBCAqQ1BHEpisEEEAgJAGSOiQ2VkIAAQQiKEBSRxCbrhBAAIGQBEjqkNhYCQEEEIigAEkdQWy6QgABBEISIKlDYmMlBBBAIIICJHUEsekKAQQQCEmApA6JjZUQQACBCAqQ1BHEpisEEEAgJAGSOiQ2VkIAAQQiKEBSRxCbrhBAAIGQBEjqkNhYCQEEEIigAEkdQWy6QgABBEISIKlDYmMlBBBAIIICJHUEsekKAQQQCEmApA6JjZUQQACBCAoUiGBfeaUr/QJ0XnmrvM9oE+DnyaNtj/2zvSS14R2XmJhouCLlEDAhwAmECUXPapDUntHTMQKRFOAcIpLaxvtinNo4KQURQAABwwIktWFQyiGAAALGBUhq46QURAABBAwLkNSGQSmHAAIIGBcgqY2TUhABBBAwLEBSGwalHAIIIGBcgKQ2TkpBBBBAwLAASW0YlHIIIICAcYF/vvmSkJBgvDQFEUAAAQSMCMSmp6cbKUQRBBBAAAFLAox+WIKlLAIIIGBMgKQ2RkkhBBBAwJIASW0JlrIIIICAMQGS2hglhRBAAAFLAiS1JVjKIoAAAsYESGpjlBRCAAEELAmQ1JZgKYsAAggYEyCpjVFSKBoFzp8/v2XLltTU1GjceLY57wiQ1HlnX+eSd1quXLkqVaokJydnfj8K3IIFC77//vuZFwYzvWTJknvuuScpKSmYxrRBwCsBktorefoNUeCvv/5SsPbv3z/z+mlpaZcvX+YLt5lNmM5NAiR1btqbeeW9lC1bdsaMGYsWLcorb5j3mecFSOo8fwhEIcBTTz318MMPv/jii2fOnMly8/fs2RMXF6dxEmV6mzZtduzY4TbTKt26dStfvnylSpX69eunM3H3JZ2Sjxw5sm7dukWLFm3QoMGkSZPcl5hAwFsBktpbf3oPRSBfvnzTpk3TULWiNnD93bt3N2zYcNu2bYMGDRo8ePDevXsbN268detWtVQuP/TQQ19++eXLL78cHx+va4kDBw50K/Tp00ftFeJvvfVWiRIl+vbtqwn3VSYQ8FJA5xE8EIgiAWXogAEDtMETJ07UJ0exq+lz585peuzYsZp+4okndHXxyJEjzps6efJk8eLF27Vrp1mNmajZ3LlznZd0y0fFihW1ROGuKNc/AL1793Ze0rNOvbXi2bNn3SVMIOCVAOfU+pzyiEoBnRdrDKRXr16nT5/O/AaWLVvWpEkTJ4K1vHTp0mq2fPlyXXVctWpV/vz5W7du7bS/4YYb3GmnwSOPPHLo30eLFi1SUlI2btyYuTjTCHgiQFJ7wk6nBgRiY2M1BqIw1aiFW05DIhqJbtasmbtEE5r9888/jx8/rptGateurbNy99XmzZs70wcOHNBEhw4dqv77eO6557Rk//79TgOeEfBQ4J/ffPFwC+gagZAFqlevPmrUKCW1e2qs8YrChQtnvoSo4prVyIZOrnWBcd26dZcuXdLwiNOpxj2cCV1+1MTq1atV01niPGutzLNMI+CJAOfUnrDTqTEBjYHovFhX/5yKSuT69etrKMO9qUMDi0uXLtUdHYUKFapXr96FCxcSExPd7lesWOFM6yVNrF+/XveEOA/9ZJ2uTB49etRtzAQCXgmQ1F7J068ZAY2BTJ8+XWPQbjnd1KHLgE8++aRu/9DZtC4MHj58eMSIEWqgG/t00q2h7U2bNumSo1rqFNtZsW3btrozb9y4cbpNWyMhH330kW4d0R1+NWvWdCszgYBnAl5dyqRfBEITcO/9yLy6cx+Ivk3uLJw/f747alGyZMlZs2a5jZXR7viGzp3Hjx+vz57u5FMDXUrUVUT3o9i+ffsTJ064KzKBgIcC/OKt+8FkIlcJ6EO1b98+nWvXqlVL591XvTeFsr6VrpeuWq5ZXZDUVUSlealSpQJfZQkCngiQ1J6w0ykCCCCQAwHGqXOARVMEEEDAEwGS2hN2OkUAAQRyIEBS5wCLpggggIAnAiS1J+x0igACCORAgKTOARZNEUAAAU8ESGpP2OkUAQQQyIEASZ0DLJoigAACngiQ1J6w0ykCCCCQA4H/A2TkrncU392uAAAAAElFTkSuQmCC" width="483" height="201" class="img_ev3q"></p>
<p>主机上创建两个<code>ns</code>，它们之间如何通信呢，可以使用<code>veth pair</code>进行连接。</p>
<ul>
<li>创建两个<code>ns</code></li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#创建两个ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns add nets1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns add nets2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建veth，并分别插入ns中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link add veth0 type veth peer name veth1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link set veth0 netns nets1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link set veth1 netns nets2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>配置两个veth网络设备</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets2 ifconfig veth1 10.1.1.2/24 up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets1 ifconfig veth0 10.1.1.1/24 up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 检查是否配置成功</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets1 ifconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">veth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inet 10.1.1.1  netmask 255.255.255.0  broadcast 10.1.1.255</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inet6 fe80::b4c2:70ff:fe8d:3b0e  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ether b6:c2:70:8d:3b:0e  txqueuelen 1000  (Ethernet)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RX packets 8  bytes 656 (656.0 B)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RX errors 0  dropped 0  overruns 0  frame 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TX packets 8  bytes 656 (656.0 B)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets2 ifconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">veth1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inet 10.1.1.2  netmask 255.255.255.0  broadcast 10.1.1.255</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inet6 fe80::f046:44ff:fe62:1ecc  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ether f2:46:44:62:1e:cc  txqueuelen 1000  (Ethernet)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RX packets 9  bytes 726 (726.0 B)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RX errors 0  dropped 0  overruns 0  frame 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TX packets 9  bytes 726 (726.0 B)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>测试网络</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 从nets1 ping nets2网络是通的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets1 ping 10.1.1.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PING 10.1.1.2 (10.1.1.2) 56(84) bytes of data.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 10.1.1.2: icmp_seq=1 ttl=64 time=0.106 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 10.1.1.2: icmp_seq=2 ttl=64 time=0.079 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 10.1.1.2: icmp_seq=3 ttl=64 time=0.083 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 从nets2 ping nets1 网络是通的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets2 ping 10.1.1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PING 10.1.1.1 (10.1.1.1) 56(84) bytes of data.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 10.1.1.1: icmp_seq=1 ttl=64 time=0.108 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 10.1.1.1: icmp_seq=2 ttl=64 time=0.085 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 10.1.1.1: icmp_seq=3 ttl=64 time=0.078 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="单主机多个-network-namespace-之间通信">单主机多个 NetWork Namespace 之间通信<a href="https://lengrongfu.github.io/blog/Linux-Network-Namespace#%E5%8D%95%E4%B8%BB%E6%9C%BA%E5%A4%9A%E4%B8%AA-network-namespace-%E4%B9%8B%E9%97%B4%E9%80%9A%E4%BF%A1" class="hash-link" aria-label="Direct link to 单主机多个 NetWork Namespace 之间通信" title="Direct link to 单主机多个 NetWork Namespace 之间通信">​</a></h2>
<p><img decoding="async" loading="lazy" alt="bridge" src="https://lengrongfu.github.io/assets/images/bridge-fc2ae5550a1d11c81f5f337691607b6d.png" width="640" height="252" class="img_ev3q"></p>
<p>上述是两个<code>ns</code>可以采用直接<code>veth</code>的模式进行通信，就好比采用一根网线，连接两台电脑，如果出现3台电脑需要通信，此时就不能再通过拉取网线的新式了，在物理网络中是采用交换机来处理这种问题。</p>
<p>在虚拟网络中通常用<code>Linux bridge</code>, <code>Linux Bridge</code>可以连接任意真实的物理设备（如：eth0网卡）或任意虚拟设备（如：veth pair设备，tap设备）。</p>
<ul>
<li>创建一个bridge</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link add name br0 type bridge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link set br0 up</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>创建三个ns</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 创建3个ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns add nets1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns add nets2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns add nets3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建3对veth pair</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link add type veth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link add type veth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link add type veth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>把br0和3个ns版定</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 把veth1、veth3、veth5分别插入nets1、nets2、nets3中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link set veth1 netns nets1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link set veth3 netns nets2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link set veth5 netns nets3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 把veth0、veth2、veth4插入br0中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link set dev veth0 master br0 up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link set dev veth2 master br0 up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link set dev veth4 master br0 up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 设置三个ip给veth1、veth3、veth5设备并启用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets1 ifconfig veth1 10.1.1.1/24 up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets2 ifconfig veth3 10.1.1.2/24 up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets3 ifconfig veth5 10.1.1.3/24 up</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>进过上述配置之后呢就把这三个ns通过br0这个桥绑定上了，就可以做到两两任意访问了。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets1 ping 10.1.1.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PING 10.1.1.2 (10.1.1.2) 56(84) bytes of data.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 10.1.1.2: icmp_seq=1 ttl=64 time=0.138 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 10.1.1.2: icmp_seq=2 ttl=64 time=0.172 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 10.1.1.2: icmp_seq=3 ttl=64 time=0.138 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets1 ping 10.1.1.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PING 10.1.1.3 (10.1.1.3) 56(84) bytes of data.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 10.1.1.3: icmp_seq=1 ttl=64 time=0.149 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 10.1.1.3: icmp_seq=2 ttl=64 time=0.114 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 10.1.1.3: icmp_seq=3 ttl=64 time=0.130 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="跨主机多个-network-namespace-之间通信">跨主机多个 NetWork Namespace 之间通信<a href="https://lengrongfu.github.io/blog/Linux-Network-Namespace#%E8%B7%A8%E4%B8%BB%E6%9C%BA%E5%A4%9A%E4%B8%AA-network-namespace-%E4%B9%8B%E9%97%B4%E9%80%9A%E4%BF%A1" class="hash-link" aria-label="Direct link to 跨主机多个 NetWork Namespace 之间通信" title="Direct link to 跨主机多个 NetWork Namespace 之间通信">​</a></h2>
<p>跨主机网络通信涉及到需要通过<code>vxlan</code>、<code>macvlan</code>、<code>ipvlan</code>等技术进行跨主机组网，</p>]]></content:encoded>
            <category>Kubernetes</category>
            <category>Kubernetes Network</category>
        </item>
        <item>
            <title><![CDATA[Kubernetes网络之CNI规范解读]]></title>
            <link>https://lengrongfu.github.io/blog/k8s之CNI规范解读</link>
            <guid>https://lengrongfu.github.io/blog/k8s之CNI规范解读</guid>
            <pubDate>Wed, 11 May 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[容器网络接口（Container Network Interface），简称 CNI，是 CNCF 旗下的一个项目，由一组用于配置 Linux 容器的网络接口的规范和库组成，同时还包含了一些插件。CNI 仅关心容器创建时的网络分配，和当容器被删除时释放网络资源。]]></description>
            <content:encoded><![CDATA[<p>容器网络接口（Container Network Interface），简称 CNI，是 CNCF 旗下的一个项目，由一组用于配置 Linux 容器的网络接口的规范和库组成，同时还包含了一些插件。CNI 仅关心容器创建时的网络分配，和当容器被删除时释放网络资源。</p>
<p><img decoding="async" loading="lazy" alt="image" src="https://lengrongfu.github.io/assets/images/cni-horizontal-color-b8776810d383699b9fd709a9163613fc.png" width="1627" height="632" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="cni-简介">CNI 简介<a href="https://lengrongfu.github.io/blog/k8s%E4%B9%8BCNI%E8%A7%84%E8%8C%83%E8%A7%A3%E8%AF%BB#cni-%E7%AE%80%E4%BB%8B" class="hash-link" aria-label="Direct link to CNI 简介" title="Direct link to CNI 简介">​</a></h2>
<p>容器网络接口（Container Network Interface），简称 CNI，是 CNCF 旗下的一个项目，由一组用于配置 Linux 容器的网络接口的规范和库组成，同时还包含了一些插件。CNI 仅关心容器创建时的网络分配，和当容器被删除时释放网络资源。</p>
<p>使用CNI的容器运行时有：</p>
<ul>
<li>Kubernetes</li>
<li>ContainerD</li>
<li>Mesos</li>
<li>Cloud Foundry</li>
<li>OpenShift</li>
</ul>
<p>实现了CNI规范的网络插件有：</p>
<ul>
<li>Flannel</li>
<li>Calico</li>
<li>Weave</li>
<li>Cilium</li>
<li><a href="https://www.cni.dev/docs/#3rd-party-plugins" target="_blank" rel="noopener noreferrer">等等</a></li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="cni插件">CNI插件<a href="https://lengrongfu.github.io/blog/k8s%E4%B9%8BCNI%E8%A7%84%E8%8C%83%E8%A7%A3%E8%AF%BB#cni%E6%8F%92%E4%BB%B6" class="hash-link" aria-label="Direct link to CNI插件" title="Direct link to CNI插件">​</a></h2>
<p>CNI 插件必须实现一个可执行文件，这个文件可以被容器管理系统（例如 rkt 或 Kubernetes）调用。</p>
<p>CNI 插件负责将网络接口插入容器网络命名空间（例如，veth 对的一端），并在主机上进行任何必要的改变（例如将 veth 的另一端连接到网桥）。然后将 IP 分配给接口，并通过调用适当的 IPAM 插件来设置与 “IP 地址管理” 部分一致的路由。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="cni规范">CNI规范<a href="https://lengrongfu.github.io/blog/k8s%E4%B9%8BCNI%E8%A7%84%E8%8C%83%E8%A7%A3%E8%AF%BB#cni%E8%A7%84%E8%8C%83" class="hash-link" aria-label="Direct link to CNI规范" title="Direct link to CNI规范">​</a></h2>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-cni定义规范版本用来控制版本兼容性问题但是版本不是一尘不变的">1. CNI定义规范版本，用来控制版本兼容性问题，但是版本不是一尘不变的。<a href="https://lengrongfu.github.io/blog/k8s%E4%B9%8BCNI%E8%A7%84%E8%8C%83%E8%A7%A3%E8%AF%BB#1-cni%E5%AE%9A%E4%B9%89%E8%A7%84%E8%8C%83%E7%89%88%E6%9C%AC%E7%94%A8%E6%9D%A5%E6%8E%A7%E5%88%B6%E7%89%88%E6%9C%AC%E5%85%BC%E5%AE%B9%E6%80%A7%E9%97%AE%E9%A2%98%E4%BD%86%E6%98%AF%E7%89%88%E6%9C%AC%E4%B8%8D%E6%98%AF%E4%B8%80%E5%B0%98%E4%B8%8D%E5%8F%98%E7%9A%84" class="hash-link" aria-label="Direct link to 1. CNI定义规范版本，用来控制版本兼容性问题，但是版本不是一尘不变的。" title="Direct link to 1. CNI定义规范版本，用来控制版本兼容性问题，但是版本不是一尘不变的。">​</a></h5>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2-概念">2. 概念：<a href="https://lengrongfu.github.io/blog/k8s%E4%B9%8BCNI%E8%A7%84%E8%8C%83%E8%A7%A3%E8%AF%BB#2-%E6%A6%82%E5%BF%B5" class="hash-link" aria-label="Direct link to 2. 概念：" title="Direct link to 2. 概念：">​</a></h4>
<ul>
<li>容器是一个网络隔离域。</li>
<li>网络是指一组可以唯一寻址的端点，它们可以相互通信。</li>
<li>Container Runtime是负责执行CNI插件的地方。</li>
<li>Plugin是指网络配置的程序。</li>
</ul>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3-规范">3. 规范<a href="https://lengrongfu.github.io/blog/k8s%E4%B9%8BCNI%E8%A7%84%E8%8C%83%E8%A7%A3%E8%AF%BB#3-%E8%A7%84%E8%8C%83" class="hash-link" aria-label="Direct link to 3. 规范" title="Direct link to 3. 规范">​</a></h4>
<p>CNI规范定义了5点：</p>
<ul>
<li>
<ol>
<li>系统管理员去定义网络配置的格式。</li>
</ol>
</li>
<li>
<ol start="2">
<li>Container Runtime向网络插件发起请求的协议。</li>
</ol>
</li>
<li>
<ol start="3">
<li>基于系统管理员提供的配置执行插件，由第2步发起调用。</li>
</ol>
</li>
<li>
<ol start="4">
<li>CNI插件会将功能委托给其他插件。</li>
</ol>
</li>
<li>
<ol start="5">
<li>插件返回result到container runtime的数据类型。</li>
</ol>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="CNI Arch" src="https://lengrongfu.github.io/assets/images/cni-67a136be6b09bc7facbb9aa3eafc1b6e.png" width="650" height="305" class="img_ev3q"></p>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="31-网络配置">3.1 网络配置<a href="https://lengrongfu.github.io/blog/k8s%E4%B9%8BCNI%E8%A7%84%E8%8C%83%E8%A7%A3%E8%AF%BB#31-%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE" class="hash-link" aria-label="Direct link to 3.1 网络配置" title="Direct link to 3.1 网络配置">​</a></h5>
<p>网络配置是具有如下字段的json格式：</p>
<ul>
<li><code>cniVersion</code>: 指定CNI规范的版本。</li>
<li><code>Name</code>: 网络名字，这在主机的网络配置中应该唯一。</li>
<li><code>disableCheck</code>: 是否禁用检查网络，如果为true,则 <code>container runtime</code> 不会调用 Check 方法进行网络检查。</li>
<li><code>plugin</code>: cni插件及其配置列表，可以配置多个插件。</li>
</ul>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="32-执行协议">3.2 执行协议<a href="https://lengrongfu.github.io/blog/k8s%E4%B9%8BCNI%E8%A7%84%E8%8C%83%E8%A7%A3%E8%AF%BB#32-%E6%89%A7%E8%A1%8C%E5%8D%8F%E8%AE%AE" class="hash-link" aria-label="Direct link to 3.2 执行协议" title="Direct link to 3.2 执行协议">​</a></h5>
<p>CNI协议基于容器运行时调用插件二进制程序。CNI程序逻辑本身被封装在了<code>libcni</code>中，会被其他容器运行时调用。在<code>libcni</code>中总共暴露了 4 个核心方法：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> CNI </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 添加网络</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">AddNetwork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> net </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">NetworkConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rt </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">RuntimeConf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 检查网络</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">CheckNetwork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> net </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">NetworkConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rt </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">RuntimeConf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 删除网络</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">DelNetwork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> net </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">NetworkConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rt </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">RuntimeConf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 获取网络缓存结果</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">GetNetworkCachedResult</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">net </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">NetworkConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rt </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">RuntimeConf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 获取网络缓存配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">GetNetworkCachedConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">net </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">NetworkConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rt </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">RuntimeConf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">RuntimeConf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 校验网络</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">ValidateNetwork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> net </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">NetworkConfig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>CNI</code>插件负责以某种方式配置容器的网络接口，通过标准输入提供配置，标准输出上返回结果，标准错误上返回error。</p>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="33-cni操作">3.3 CNI操作<a href="https://lengrongfu.github.io/blog/k8s%E4%B9%8BCNI%E8%A7%84%E8%8C%83%E8%A7%A3%E8%AF%BB#33-cni%E6%93%8D%E4%BD%9C" class="hash-link" aria-label="Direct link to 3.3 CNI操作" title="Direct link to 3.3 CNI操作">​</a></h5>
<p>CNI插件定义了4个操作：ADD、DEL、CHECK、Version。</p>
<ol>
<li>ADD：添加容器到网络中，插件收到ADD命令执行如下步骤；不支持多次调用。</li>
</ol>
<ul>
<li>在CNI_NETNS的容器中创建CNI_IFNAME的接口。</li>
<li>调整CNI_NETNS容器内CNI_IFNAME的配置。</li>
</ul>
<ol start="2">
<li>DEL：从容器中删除网络，插件收到DEL命令执行如下步骤；支持多次调用。</li>
</ol>
<ul>
<li>删除CNI_NETNS容器内的CNI_IFNAME定义的接口。</li>
<li>撤销插件ADD功能中应用的修改。</li>
</ul>
<ol start="3">
<li>
<p>Check：检查容器的网络是否符合预期。</p>
</li>
<li>
<p>Version：探测CNI插件版本是否支持。</p>
</li>
</ol>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="cni-plugin-项目">CNI Plugin 项目<a href="https://lengrongfu.github.io/blog/k8s%E4%B9%8BCNI%E8%A7%84%E8%8C%83%E8%A7%A3%E8%AF%BB#cni-plugin-%E9%A1%B9%E7%9B%AE" class="hash-link" aria-label="Direct link to CNI Plugin 项目" title="Direct link to CNI Plugin 项目">​</a></h2>
<p>Plugin中提供了3个维度的插件，一个是main，用户创建网络接口的插件，一个ipam，用于管理ip地址的插件，可以被main插件调用，一个meta插件，就是其它插件。</p>]]></content:encoded>
            <category>Kubernetes</category>
            <category>Kubernetes Network</category>
        </item>
        <item>
            <title><![CDATA[Serverless 基础知识]]></title>
            <link>https://lengrongfu.github.io/blog/serverless基础知识</link>
            <guid>https://lengrongfu.github.io/blog/serverless基础知识</guid>
            <pubDate>Tue, 01 Mar 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[Serverless 是什么，它有什么优势，有什么限制，应该什么时候使用它.]]></description>
            <content:encoded><![CDATA[<p>Serverless 是什么，它有什么优势，有什么限制，应该什么时候使用它.</p>
<p><img decoding="async" loading="lazy" alt="image" src="https://lengrongfu.github.io/assets/images/Serverless-architecture-preview-image-f096e15227130ce059ebeb266279303b.png" width="1440" height="500" class="img_ev3q"></p>
<p>Serverless 是什么，它有什么优势，有什么限制，应该什么时候使用它.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="serverless-是什么">Serverless 是什么<a href="https://lengrongfu.github.io/blog/serverless%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86#serverless-%E6%98%AF%E4%BB%80%E4%B9%88" class="hash-link" aria-label="Direct link to Serverless 是什么" title="Direct link to Serverless 是什么">​</a></h2>
<p>无服务器架构是一种基于事件的软件设计模式，无需处理、供应和扩展服务器和数据库。这样，企业就可以通过第三方服务运行他们的应用程序，而无需投资物理或虚拟服务器。许多处理云服务的提供商处理计算、服务器管理、编码和动态分配资源的复杂性。</p>
<p>在无服务的发展过程中主要有两种模式：</p>
<ul>
<li>后端即服务（BaaS）</li>
<li>功能即服务（FaaS）</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="什么是-baas">什么是 BaaS<a href="https://lengrongfu.github.io/blog/serverless%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86#%E4%BB%80%E4%B9%88%E6%98%AF-baas" class="hash-link" aria-label="Direct link to 什么是 BaaS" title="Direct link to 什么是 BaaS">​</a></h3>
<p>后端即服务使开发人员能够专注于管理应用程序的前端，并让他们摆脱托管、云存储和数据库管理等后端开发任务。这样，他们就不必为服务器端活动（例如数据库管理、用户身份验证和加密）管理或编写代码。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="什么是-faas">什么是 FaaS<a href="https://lengrongfu.github.io/blog/serverless%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86#%E4%BB%80%E4%B9%88%E6%98%AF-faas" class="hash-link" aria-label="Direct link to 什么是 FaaS" title="Direct link to 什么是 FaaS">​</a></h3>
<p>功能即服务是一种事件驱动的执行模型，可以执行小代码模块。当应用程序模块中发生某些事件的执行时，它会触发函数。这带来了卓越的成本效率、资源的动态扩展和简化的流程。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="serverless-有什么优势">Serverless 有什么优势<a href="https://lengrongfu.github.io/blog/serverless%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86#serverless-%E6%9C%89%E4%BB%80%E4%B9%88%E4%BC%98%E5%8A%BF" class="hash-link" aria-label="Direct link to Serverless 有什么优势" title="Direct link to Serverless 有什么优势">​</a></h2>
<ul>
<li>您的开发人员现在可以专注于编写代码和优化应用程序设计。</li>
<li>您可以变得更加敏捷，获得创业创新，并拥有企业竞争优势。</li>
<li>由于无服务器架构将业务逻辑/代码作为函数执行，因此您不再需要手动管理基础架构。</li>
<li>具有成本效益的定价模式——按价值付费——消除了在管理内部架构方面进行大量投资的需要。</li>
<li>故障不会影响整个应用程序开发，因为基于事件的架构使应用程序模块彼此独立。</li>
<li>您可以更快地部署应用程序并在发布中变得更加灵活。除此之外，命令行界面还有助于在几分钟内部署代码。</li>
<li>它使您能够构建优雅、无缝的用户体验并满足客户的需求。</li>
<li>您可以按需和按使用情况扩展或缩小应用程序。</li>
<li>功能即服务架构使开发人员能够创建独立的、有目的的功能，例如 API 调用。</li>
<li>由于基于模块化、快速和较小的版本，它显着缩短了产品上市时间。</li>
<li>您无需担心基础架构的安全性，因为云提供商会维护它。</li>
<li>您的团队可以使用 AWS Lambda边缘等现代无服务器功能来改善延迟期。</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="serverless-有什么限制">Serverless 有什么限制<a href="https://lengrongfu.github.io/blog/serverless%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86#serverless-%E6%9C%89%E4%BB%80%E4%B9%88%E9%99%90%E5%88%B6" class="hash-link" aria-label="Direct link to Serverless 有什么限制" title="Direct link to Serverless 有什么限制">​</a></h2>
<ul>
<li>长时间运行的工作负载在无服务器上可能比专用服务器成本更高。</li>
<li>在执行函数时处理冷启动请求时，您可能会遇到延迟。但是，您可以通过发送定期请求以保持活动状态来解决此问题。</li>
<li>您将依赖于您的提供商来提供调试和监控工具，并且对平台架构和可用性的控制有限。</li>
<li>由于更多的功能，开发人员面临着越来越多的复杂性。忽略几个函数的粒度和它们之间的平衡会造成混乱。</li>
<li>由于无服务器架构中的小型模块，您可能会面临部署、版本控制和其他实施问题。这在对一组部署的功能进行集成测试时提出了挑战。</li>
<li>由于云提供商可以控制组件之间的交互，因此可能会影响系统的灵活性和定制化。</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="serverless-什么场景可以使用它">Serverless 什么场景可以使用它<a href="https://lengrongfu.github.io/blog/serverless%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86#serverless-%E4%BB%80%E4%B9%88%E5%9C%BA%E6%99%AF%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%E5%AE%83" class="hash-link" aria-label="Direct link to Serverless 什么场景可以使用它" title="Direct link to Serverless 什么场景可以使用它">​</a></h2>
<p>无服务器架构为敏捷工作环境、资源分配自动化、可扩展性、改进响应时间等未来业务目标奠定了基础。此外，您会看到物理基础设施的运营开销和配置减少，从而为您的投资带来价值。</p>
<p>以下是无服务器应用程序列表，展示了您可以在哪些地方将无服务器架构集成到您的业务中：</p>
<ul>
<li>构建高延迟的实时应用程序，例如多媒体应用程序，以执行内存的自动分配和复杂的数据处理</li>
<li>为了满足快速变化的开发需求、客户需求功能添加和其他复杂的可扩展性需求，为不可预测的工作负载提供服务。</li>
<li>动态调整图像大小或转码视频并简化不同设备的多媒体处理。</li>
<li>支持多语言服务集成，满足现代软件需求。</li>
<li>使用物联网获取精确的设备状态并处理智能设备应用程序。</li>
<li>建立安全的客户交付调度系统并帮助动态调整大小。</li>
</ul>]]></content:encoded>
            <category>Serveless</category>
        </item>
        <item>
            <title><![CDATA[gRPC 学习之-高级知识]]></title>
            <link>https://lengrongfu.github.io/blog/gRPC 学习之-高级知识</link>
            <guid>https://lengrongfu.github.io/blog/gRPC 学习之-高级知识</guid>
            <pubDate>Sat, 01 Jan 2022 00:00:00 GMT</pubDate>
            <description><![CDATA[gRPC 学习通信基础]]></description>
            <content:encoded><![CDATA[<p>gRPC 学习通信基础</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="高级知识">高级知识<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E9%AB%98%E7%BA%A7%E7%9F%A5%E8%AF%86#%E9%AB%98%E7%BA%A7%E7%9F%A5%E8%AF%86" class="hash-link" aria-label="Direct link to 高级知识" title="Direct link to 高级知识">​</a></h2>
<p>之前的文章中记录了对 gRPC 的使用，但是都没有涉及底层的通信基础知识。这篇文章主要介绍 gRPC 的高级知识，涉及到 gRPC 的底层原理、</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="grpc-底层原理">gRPC 底层原理<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E9%AB%98%E7%BA%A7%E7%9F%A5%E8%AF%86#grpc-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86" class="hash-link" aria-label="Direct link to gRPC 底层原理" title="Direct link to gRPC 底层原理">​</a></h3>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="grpc-超越基础知识">gRPC 超越基础知识<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E9%AB%98%E7%BA%A7%E7%9F%A5%E8%AF%86#grpc-%E8%B6%85%E8%B6%8A%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86" class="hash-link" aria-label="Direct link to gRPC 超越基础知识" title="Direct link to gRPC 超越基础知识">​</a></h3>
<p>这部分主要讲述在构建真正的gRPC应用时，对于需要增强它们的各种能力，比如：拦截gRPC的输入和输出、弹性处理网络延迟、处理错误、在服务和消费者之间共享元数据。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="拦截器">拦截器<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E9%AB%98%E7%BA%A7%E7%9F%A5%E8%AF%86#%E6%8B%A6%E6%88%AA%E5%99%A8" class="hash-link" aria-label="Direct link to 拦截器" title="Direct link to 拦截器">​</a></h4>
<p>在 <code>gRPC</code> 中，可以拦截 <code>gRPC</code> 的执行.来满足特定的需求，如日志、认证、性能度盐指标等，这会使用一种名为拦截器的扩展机制。它是 <code>gRPC</code> 核心扩展机制之一 ，在一些使用场呆中非常有用，比如日志、身份验证、授权、性能度盘指标、跟踪以及其他一些自定义错求.</p>
<p>根据所拦截的 <code>RPC</code> 调用类型，<code>gRPC</code> 拦截可以分为两类，对于一元<code>RPC</code>，使用一元拦截器，对于流<code>RPC</code>，使用流拦截器；这些拦截器既可以用在服务端也可以用在客户端。</p>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="服务端拦截器">服务端拦截器<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E9%AB%98%E7%BA%A7%E7%9F%A5%E8%AF%86#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8B%A6%E6%88%AA%E5%99%A8" class="hash-link" aria-label="Direct link to 服务端拦截器" title="Direct link to 服务端拦截器">​</a></h5>
<p>当客户端调用 gRPC服务的远程方法肘，通过使用服务器端拦截器，可以在执行远程方法 之前，执行一个通用的逻辑。</p>
<p><img decoding="async" loading="lazy" alt="grpc-server-intercepter" src="https://lengrongfu.github.io/assets/images/grpc-server-intercepter-f68440ad8d9a6174631a19af9d37f663.png" width="2294" height="1399" class="img_ev3q"></p>
<p>在服务器销， 一元拦截器拦截一元 RPC，梳拦iliV:ìI售出1拦截流 RPC. 下回来右一下服务器揣
一元拦敲器.</p>
<ul>
<li>一元拦截</li>
</ul>
<p>要实现这一点 ，需要先实现 <code>UnaryServerlnterceptor</code> 类型的函数， 并在创 <code>gRPC</code> 服务器端时将函数注册进来。 <code>UnaryServerlnterceptor</code> 是用于服务器端一元拦截的类型。函数定义类型如下。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> req </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> info 叫JnaryServerlnfo，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hand1er UnaryHand1er</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">re5p </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>例如：进行一元拦截，打印日志。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">orderUnaryServerlnterceptor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> req </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	info </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UnaryServerInfo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> handler grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UnaryHandler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"======= [Server Interceptor1 "</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> info</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FullMethod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	m</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"post proc mess: %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 可以拦截修改返回内容</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> order</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ok </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Order</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> ok </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		order</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Price </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> order</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">省略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	s </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewServer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">UnaryInterceptor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">orderUnaryServerlnterceptor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RegisterOrderManagementServer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Serve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">listen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">panic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>流拦截</li>
</ul>
<p>服务器端流拦截器会拦截 <code>gRPC</code> 服务器所处理的所有流<code>RPC</code>。 流拦截器包括前置处理阶段和流操作拦截阶段。</p>
<p>要实现流拦截，需要实现<code>Streal'1Serverlnterceptor</code> 函数：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">srv </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ss grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServerStream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">info </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StreamServerInfo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">handler grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StreamHandler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>grpc.ServerStream</code> 的包装器可以拦截 <code>gRPC</code> 服务发送或接收到的数据，它实现了 <code>SendMsg</code> 函数和 <code>RecvMsg</code> 函数，这两个函数分别会在服务发送和接收 <code>RPC</code> 流消息的时候调用。</p>
<p>在流 <code>RPC</code> 进入服务前，可以通过 <code>grpc.ServeStream</code> 进行流的处理，再通过 <code>grpc.StreamHandler</code> 来进行调用。</p>
<p>例如：在 <code>OrderManager</code> 的流接口中先进行输入流的处理，再调用 <code>RPC</code>.</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> wrappedSteam </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServerStream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServerStream </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">wrappedSteam</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">w </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">wrappedSteam</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">RecvMsg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"=====RecvMSg==== %T"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> w</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServerStream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RecvMsg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">w </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">wrappedSteam</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SendMsg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"====SendMsg===="</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> w</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServerStream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SendMsg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">newWrappedStream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServerStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServerStream </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">wrappedSteam</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">orderServerStreamInterceptor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">srv </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ss grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServerStream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> info </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StreamServerInfo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> handler grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StreamHandler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"===== [Server Steam Interceptor ]"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> info</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FullMethod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">srv</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">newWrappedStream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ss</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatalf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"RPC failed with error %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	s </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewServer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">StreamInterceptor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">orderServerStreamInterceptor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RegisterOrderManagementServer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Serve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">listen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">panic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在流开始时会进入 <code>orderServerStreamInterceptor</code> 方法，流结束后才会推出，在流每次 <code>RecvMsg</code> 时会进入到流拦截的 <code>(w *wrappedSteam) RecvMsg</code> 方法中，<code>SendMsg</code> 同理。</p>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="客户端拦截器">客户端拦截器<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E9%AB%98%E7%BA%A7%E7%9F%A5%E8%AF%86#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8B%A6%E6%88%AA%E5%99%A8" class="hash-link" aria-label="Direct link to 客户端拦截器" title="Direct link to 客户端拦截器">​</a></h5>
<p><img decoding="async" loading="lazy" alt="grpc-client-interceptor" src="https://lengrongfu.github.io/assets/images/grpc-client-interceptor-4ade8737b7230d0b2141eb661e0811ad.png" width="2328" height="1395" class="img_ev3q"></p>
<ul>
<li>一元拦截</li>
</ul>
<p>一元拦截的函数签名：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> UnaryClientInterceptor </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reply </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cc </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ClientConn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> invoker UnaryInvoker</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">CallOption</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>与服务端拦截一元拦截器一样，客户端一元拦截器也有不同的阶段。</p>
<p>例子：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">orderClientInterceptor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> apply </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cc </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClientConn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> invoker grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UnaryInvoker</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallOption</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Method :"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	start </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">invoker</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> apply</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"cost is [%d]ms"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">start</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Milliseconds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Dial</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">address</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithInsecure</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithUnaryInterceptor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">orderClientInterceptor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>流拦截</li>
</ul>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> StreamClientInterceptor </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> desc </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">StreamDesc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cc </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ClientConn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> streamer Streamer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">CallOption</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ClientStream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>例子：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> wrappedSteam </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClientStream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">w </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">wrappedSteam</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">RecvMsg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"===== [ Client Stream Interceptor ] Receive a message (Type :%T) at %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RFC3339</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> w</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClientStream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RecvMsg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">w </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">wrappedSteam</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SendMsg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"===== [Client Stream Interceptor ] Send a message (Type :%T) at %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RFC3339</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> w</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClientStream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SendMsg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">newWrappedStream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cs grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClientStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClientStream </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">wrappedSteam</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">cs</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">orderClientStreamInterceptor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> desc </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StreamDesc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cc </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClientConn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> streamer grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Streamer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallOption</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClientStream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"===== [Client Interceptor] "</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">streamer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> desc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">newWrappedStream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Dial</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">address</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithInsecure</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithStreamInterceptor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">orderClientStreamInterceptor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content:encoded>
            <category>golang</category>
        </item>
        <item>
            <title><![CDATA[gRPC 学习之-中级知识]]></title>
            <link>https://lengrongfu.github.io/blog/gRPC 学习之-中级知识</link>
            <guid>https://lengrongfu.github.io/blog/gRPC 学习之-中级知识</guid>
            <pubDate>Thu, 30 Dec 2021 00:00:00 GMT</pubDate>
            <description><![CDATA[gRPC 学习通信模型]]></description>
            <content:encoded><![CDATA[<p>gRPC 学习通信模型</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="中级知识">中级知识<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E4%B8%AD%E7%BA%A7%E7%9F%A5%E8%AF%86#%E4%B8%AD%E7%BA%A7%E7%9F%A5%E8%AF%86" class="hash-link" aria-label="Direct link to 中级知识" title="Direct link to 中级知识">​</a></h2>
<p>借助 gRPC 可以实现不同的进程间通信模式（也称RPC风格）；本章将讨论 gRPC 应用的四种通信模式，一元RPC、服务端流RPC、客户端流RPC、以及双向RPC。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一元rpc">一元RPC<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E4%B8%AD%E7%BA%A7%E7%9F%A5%E8%AF%86#%E4%B8%80%E5%85%83rpc" class="hash-link" aria-label="Direct link to 一元RPC" title="Direct link to 一元RPC">​</a></h3>
<p>一元RPC：一元RPC模式也被称为简单RPC模式，当客户端调用服务端的远程方法时，客户端发送请求到服务端并获得一个响应，与响应一起发送还有元数据。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="服务器端流-rppc-模式">服务器端流 RPPC 模式<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E4%B8%AD%E7%BA%A7%E7%9F%A5%E8%AF%86#%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E6%B5%81-rppc-%E6%A8%A1%E5%BC%8F" class="hash-link" aria-label="Direct link to 服务器端流 RPPC 模式" title="Direct link to 服务器端流 RPPC 模式">​</a></h3>
<p>一元RPC模式：gRPC 服务器端和 gRPC 客户端在通信时始终只有一个请求和一个响应。
服务器端流 RPC 模式：gRPC 服务器端在接收到客户端的请求消息后，会发回一个响应序列（简单说就是会发回多个响应）。这种多个响应所组成的序列也被称为流。</p>
<p>例如：</p>
<blockquote>
<p>在 OrderManagement 服务中，假设需要实现一个订单搜索功能；利用服务器端流 gRPC 模式时 OrderManagement 服务不会将所有匹配的订单一次性的发送给客户端，而是在找到匹配的订单时，逐步将其发送出去。</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="grpc-server-stream" src="https://lengrongfu.github.io/assets/images/grpc-server-stream-0ac241830eca1af2a9dea3926b403dd0.png" width="1850" height="706" class="img_ev3q"></p>
<ul>
<li>grpc server</li>
</ul>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SearchOrders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">searchQuery </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">wrappers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StringValue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">stream pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OrderManagement_SearchOrdersServer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> order </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> orderMap </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> order</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> itemStr </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> order</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Items </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">itemStr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> strings</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Contains</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">itemStr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> searchQuery</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token comment" style="color:#999988;font-style:italic">// Send the matching orders in a stream</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">order</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"error sending message to stream : %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Matching Order Found : "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>grpc clinet</li>
</ul>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    searchStream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 	</span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SearchOrders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">wrappers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StringValue</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Google"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		searchOrder</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> searchStream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Recv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EOF </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"EOF"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Search Result : "</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> searchOrder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上述就是 <code>gRPC</code> 服务器端流模式，服务在检索到订单时，通过以流的形式发送给客户端 <code>err := stream.Send(&amp;order)</code> ; 客户端在调用时，返回一个客户端流，它有一个 <code>Recv</code> 方法，调用客户端的 <code>Recv</code> 方法，可以逐个读取服务端写入的数据。当发现流结束时， <code>Recv</code> 会返回 <code>io.EOF</code>。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="客户端流-rpc-模式">客户端流 RPC 模式<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E4%B8%AD%E7%BA%A7%E7%9F%A5%E8%AF%86#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%B5%81-rpc-%E6%A8%A1%E5%BC%8F" class="hash-link" aria-label="Direct link to 客户端流 RPC 模式" title="Direct link to 客户端流 RPC 模式">​</a></h3>
<p>客户端流RPC模式：客户端会发起多个请求给服务端，而不再是单个请求，服务器端则会发送一个响应给客户端。但是，服务端不一定要等到从客户端接受到所有消息后才发送响应。</p>
<p>例如：</p>
<blockquote>
<p>在 OrderManagement 服务中希望添加 updateOrders 方法，从而更新一个订单集合。</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="grpc client stream" src="https://lengrongfu.github.io/assets/images/grpc-client-stream-0ec6aa42f48e68466ac8b76a758cde13.png" width="1868" height="724" class="img_ev3q"></p>
<ul>
<li>grpc server : 如下方法定义了一个服务端接收客户端流的方法</li>
</ul>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">UpdateOrders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stream pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OrderManagement_UpdateOrdersServer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ordersStr </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Updated Order IDs : "</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		order</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Recv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EOF </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">// 客户端发送完流数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SendAndClose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">wrappers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StringValue</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Orders processed "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> ordersStr</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// Update order</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		orderMap</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">order</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">order</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Order ID : %s - %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> order</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Updated"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		ordersStr </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> order</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Id </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">", "</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>grpc client</li>
</ul>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">省略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// =========================================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Update Orders : Client streaming scenario</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	updOrder1 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Order</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"102"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Items</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"Google Pixel 3A"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Google Pixel Book"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Destination</span><span class="token punctuation" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"Mountain View, CA"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Price</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1100.00</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	updOrder2 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Order</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"103"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Items</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"Apple Watch S4"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Mac Book Pro"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"iPad Pro"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Destination</span><span class="token punctuation" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"San Jose, CA"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Price</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2800.00</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	updOrder3 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Order</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"104"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Items</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"Google Home Mini"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Google Nest Hub"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"iPad Mini"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Destination</span><span class="token punctuation" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"Mountain View, CA"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Price</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2200.00</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	updateStream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">UpdateOrders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatalf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%v.UpdateOrders(_) = _, %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Updating order 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> updateStream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">updOrder1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatalf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%v.Send(%v) = %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updateStream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updOrder1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Updating order 2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> updateStream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">updOrder2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatalf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%v.Send(%v) = %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updateStream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updOrder2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Updating order 3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> updateStream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">updOrder3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatalf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%v.Send(%v) = %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updateStream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updOrder3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	updateRes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> updateStream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">CloseAndRecv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatalf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%v.CloseAndRecv() got error %v, want %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updateStream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Update Orders Res : %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updateRes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>客户端以流的形式发送<code>updateStream.Send(&amp;updOrder2)</code>给服务端，一旦所有消息都以流的形式发送出去，客户端就可以将流标记为已完成，并通过 <code>CloseAndRecv</code> 方法来读取服务端的响应。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="双向流-rpc-模式">双向流 RPC 模式<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E4%B8%AD%E7%BA%A7%E7%9F%A5%E8%AF%86#%E5%8F%8C%E5%90%91%E6%B5%81-rpc-%E6%A8%A1%E5%BC%8F" class="hash-link" aria-label="Direct link to 双向流 RPC 模式" title="Direct link to 双向流 RPC 模式">​</a></h3>
<p>双向流RPC模式：客户端以消息流的形式发送请求到服务器端，服务器端也以消息流的形式进行响应。调用必须由客户端发起，但在此之后，通信完全基于 gRPC 客户端和服务器端的应用程序逻辑。</p>
<p>例如：</p>
<blockquote>
<p>在 OrderManagement 服务中，假设需要一个订单处理功能，通过该功能，用户可以发送连续的订单集合，并根据投递地址对它们进行组合发货。</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="grpc-double-stream" src="https://lengrongfu.github.io/assets/images/grpc-double-stream-f63347d2fa5a77f302f28e1d06ed4609.png" width="1909" height="771" class="img_ev3q"></p>
<p>这个业务用例的关键步骤如下所示：</p>
<ul>
<li>每个订单以独立的 gRPC 消息的形式发送至服务器端。</li>
<li>每个发货组合可能会包含多个订单，它们应该被投递到相同的目的地。</li>
<li>订单是成批处理的，当达到指定的批次大小时，当前创建的所有发货组合都会被发送至客户端。</li>
<li>假设：流中有4个订单，其中有两个订单要发送至X，两个要发送至Y，则可以将其表示为：X、Y、X、Y。如果批次大小为3，那么所创建的订单发货组合会是[X，X],[Y],[Y]。</li>
</ul>
<p>gRpc Server：主要逻辑就是通过客户端发送过来的订单ID按照指定批次大小以及发货地址进行分组，再把分组后的信息返回给客户端。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> orderBatchSize </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ProcessOrders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stream pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OrderManagement_ProcessOrdersServer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	batchMarker </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> combinedShipmentMap </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CombinedShipment</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		orderId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Recv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Reading Proc order : %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> orderId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EOF </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">// 客户端发送关闭时，需要把服务端已经接收到的进行发送</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"EOF : %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> orderId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shipment </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> combinedShipmentMap </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">shipment</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		destination </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> orderMap</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">orderId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Destination</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		shipment</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> found </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> combinedShipmentMap</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">destination</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> found </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			ord </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> orderMap</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">orderId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			shipment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OrdersList </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shipment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OrdersList</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ord</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			combinedShipmentMap</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">destination</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> shipment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			comShip </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CombinedShipment</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"cmb - "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">orderMap</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">orderId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Destination</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Status</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Processed!"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			ord </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> orderMap</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">orderId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			comShip</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OrdersList </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shipment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OrdersList</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ord</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			combinedShipmentMap</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">destination</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> comShip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">comShip</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OrdersList</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> comShip</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> batchMarker </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> orderBatchSize </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> comb </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> combinedShipmentMap </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Shipping : %v -&gt; %v"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> comb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">comb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OrdersList</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">comb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			batchMarker </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			combinedShipmentMap </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CombinedShipment</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			batchMarker</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>gRpc Client：主要逻辑就是发送订单ID给服务端，之后开启 Go协程来读取服务端返回的消息。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// =========================================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Process Order : Bi-di streaming scenario</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	streamProcOrder</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ProcessOrders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatalf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%v.ProcessOrders(_) = _, %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> streamProcOrder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">wrappers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StringValue</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"102"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatalf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%v.Send(%v) = %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"102"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> streamProcOrder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">wrappers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StringValue</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"103"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatalf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%v.Send(%v) = %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"103"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> streamProcOrder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">wrappers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StringValue</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"104"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatalf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%v.Send(%v) = %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"104"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> streamProcOrder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">wrappers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StringValue</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"101"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatalf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%v.Send(%v) = %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"101"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    channel </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">asncClientBidirectionalRPC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">streamProcOrder</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> channel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> streamProcOrder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">CloseSend</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	channel </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">asncClientBidirectionalRPC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">streamProcOrder pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OrderManagement_ProcessOrdersClient</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c </span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		combinedShipment</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> errProcOrder </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> streamProcOrder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Recv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> errProcOrder </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EOF </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 判断服务端流是否结束；服务端方法只要有return就意味着流结束流了，可能是因为正常结束，也可能是错误导致结束，总之只要return之后双向流就断开了。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Combined shipment : "</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> combinedShipment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OrdersList</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在双向流中可以通过定义客户端流和服务端流的方式来实现，客户端和服务端都定义了 <code>Send</code> 和 <code>Recv</code> 方法。可以实现双向传输。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 客户端流</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> OrderManagement_ProcessOrdersClient </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">Send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">wrappers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StringValue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">Recv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">CombinedShipment</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClientStream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 服务端流</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> OrderManagement_ProcessOrdersServer </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">Send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">CombinedShipment</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">Recv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">wrappers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StringValue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServerStream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>客户端可以并发读取和写入同一个流，输入流和输出流可以独立进行操作。</p>]]></content:encoded>
            <category>golang</category>
        </item>
    </channel>
</rss>