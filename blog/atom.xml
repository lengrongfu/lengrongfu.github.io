<?xml version="1.0" encoding="utf-8"?><?xml-stylesheet type="text/xsl" href="atom.xsl"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://lengrongfu.github.io/blog</id>
    <title>My Site Blog</title>
    <updated>2024-08-28T00:00:00.000Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://lengrongfu.github.io/blog"/>
    <subtitle>My Site Blog</subtitle>
    <icon>https://lengrongfu.github.io/img/favicon.ico</icon>
    <entry>
        <title type="html"><![CDATA[kubelet源码分析 syncLoopIteration（一） podUpdateCh]]></title>
        <id>https://lengrongfu.github.io/blog/kubelet-one-analyze</id>
        <link href="https://lengrongfu.github.io/blog/kubelet-one-analyze"/>
        <updated>2024-08-28T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[podUpdateCh 主要是负责接收 Pod 的数据，分别从文件、URL、Kube-APIServer 三个地方来，下面将详细分析这个 chan 的读写流程。]]></summary>
        <content type="html"><![CDATA[<p><code>podUpdateCh</code> 主要是负责接收 <code>Pod</code> 的数据，分别从文件、URL、Kube-APIServer 三个地方来，下面将详细分析这个 <code>chan</code> 的读写流程。</p>
<p><code>Pod</code> 的 <code>source</code> 定义了四种表现方式，在代码 <code>pod_update.go</code></p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// These constants identify the sources of pods.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Filesource idenitified updates from a file.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	FileSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"file"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// HTTPSource identifies updates from querying a web page.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	HTTPSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"http"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// ApiserverSource identifies updates from Kubernetes API Server.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ApiserverSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"api"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// AllSource identifies updates from all sources.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	AllSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"*"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="https://firebasestorage.googleapis.com/v0/b/notiondiagram.appspot.com/o/diagram%2Fm5smUNzLG7NDZmSPY82qhFvWnsu1%2F7182ab7e-9b66-4472-b508-6ce8abb3bd7e.svg?alt=media&amp;token=dc26e818-bbd5-4c18-8070-70649d577ad7" alt="a" class="img_ev3q"></p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="file">File<a href="https://lengrongfu.github.io/blog/kubelet-one-analyze#file" class="hash-link" aria-label="Direct link to File" title="Direct link to File">​</a></h3>
<p><code>file</code> Watch 功能只在 <code>linux</code> 操作系统上支持，其它操作系统都不支持。</p>
<p>会把 <code>fsnotify</code> 监听的文件事件转换为 <code>Pod</code> 的操作类型；</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sourceFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">produceWatchEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">fsnotify</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> eventType podEventType</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Op </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> fsnotify</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Create</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		eventType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> podAdd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Op </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> fsnotify</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Write</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		eventType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> podModify</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Op </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> fsnotify</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Chmod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		eventType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> podModify</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Op </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> fsnotify</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Remove</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		eventType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> podDelete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Op </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> fsnotify</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Rename</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		eventType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> podDelete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">default</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// Ignore rest events</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">watchEvents </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">watchEvent</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> eventType</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后根据监听到的文件名的变化，来读取 <code>Pod</code> 的内容，之后更新 <code>store</code> 对象；这里是令我奇怪的，我以为它会往 <code>chan</code> 里面发送一个事件。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sourceFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">consumeWatchEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">watchEvent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">eventType </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> podAdd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> podModify</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">extractFromFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fileName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> podDelete</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> objKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> keyExist </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fileKeyMapping</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fileName</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> keyExist </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> podExist</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetByKey</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">objKey</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"failed to remove deleted pod from cache: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>除了 <code>Watch</code> 文件变化之后，它还有一个 <code>time.Ticker</code> 每隔 <code>10s</code> 会执行一遍全量读取目录下 <code>Pod</code> 的操作；</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sourceFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	listTicker </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewTicker</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">period</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> #默认配置是10s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// 启动之后先读取一遍所有的</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">listConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ErrorS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Unable to read config path"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"path"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain">listTicker</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">C</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">listConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ErrorS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Unable to read config path"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"path"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> e </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">watchEvents</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">consumeWatchEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ErrorS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Unable to process watch event"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">startWatch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上面有一个疑问：这里是令我奇怪的，我以为它会往 <code>chan</code> 里面发送一个事件。发现它的 <code>send</code> 是写在 <code>store.Add、store.Delete</code>  里面的，它会在每次触发这个函数的时候，把存储起来的 <code>pod</code> 全量的发送到 <code>chan</code> 里面. <code>undelta_store.go#45</code></p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">UndeltaStore</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">PushFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">List</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">UndeltaStore</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">PushFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">List</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">UndeltaStore</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">PushFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">List</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="url">URL<a href="https://lengrongfu.github.io/blog/kubelet-one-analyze#url" class="hash-link" aria-label="Direct link to URL" title="Direct link to URL">​</a></h3>
<p><code>URL</code> 的方式是通过用户配置的外部服务地址，然后每 <code>20s</code> 去访问一次外部服务。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sourceURL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">extractFromURL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	  </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在 <code>extractFromURL</code> 会通过访问 <code>HTTP</code> GET 的方式解析返回值，返回当个对象或者是数组都可以解析成功，解析成功之后也是会发送到 <code>merge</code> 中进行合并处理。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="api">API<a href="https://lengrongfu.github.io/blog/kubelet-one-analyze#api" class="hash-link" aria-label="Direct link to API" title="Direct link to API">​</a></h3>
<p><code>API</code> 的方式是通过 <code>list-watch</code> 去读取 <code>kube-apiserver</code> 的数据，并且通过 <code>field</code> 进行过滤当前的节点。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">lw </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewListWatchFromClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">CoreV1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RESTClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"pods"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NamespaceAll</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fields</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">OneTermEqualSelector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"spec.nodeName"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nodeName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>传递的 <code>store</code> 对象里面有 <code>send</code> 的功能，和 <code>file</code> 处理逻辑一样，一个 <code>pod</code> 发生变更，就会要发送所有的 <code>pod</code> 去执行 <code>merge</code> 操作。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">r </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewReflector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewUndeltaStore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">send</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MetaNamespaceKeyFunc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="merge">Merge<a href="https://lengrongfu.github.io/blog/kubelet-one-analyze#merge" class="hash-link" aria-label="Direct link to Merge" title="Direct link to Merge">​</a></h2>
<p><code>merge</code> 是为了把从不同的 <code>source</code> 过来的 <code>pod</code> 进一步合并，避免出现重复、冲突的操作，最终得到一个一致的操作，最终合并后会得到各种事件的结果：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">adds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updates</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> deletes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> removes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reconciles </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">merge</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">source</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> change</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>合并的难点在于判断是不是要更新，添加、删除这种场景都比较简单，之前不存在就添加，之前存在，现在不存在就删除，但是要不要更新是比较难判断的，里面有一个 <code>checkAndUpdatePod</code> 方法。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">checkAndUpdatePod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">existing</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ref </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">needUpdate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> needReconcile</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> needGracefulDelete </span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">1.</span><span class="token plain"> 检查Spec、Labels、DeletionTimestamp、DeletionGracePeriodSeconds、Annotations这些是否发生变更</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">2.</span><span class="token plain"> 如果都没有发生变更判断Status是否发生变更，如果有则更新，没有则不更新。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">3.</span><span class="token plain"> 如果DeletionTimestamp不为空，则需要删除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>Leng Student</name>
            <uri>https://github.com/lengrongfu</uri>
        </author>
        <category label="kubernetes" term="kubernetes"/>
        <category label="Kubelet" term="Kubelet"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[kubelet源码分析(一)：工作原理]]></title>
        <id>https://lengrongfu.github.io/blog/kubelet-one-analyze</id>
        <link href="https://lengrongfu.github.io/blog/kubelet-one-analyze"/>
        <updated>2024-08-25T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[从 kubelet 源码来分析它的工作原理.]]></summary>
        <content type="html"><![CDATA[<p><code>podUpdateCh</code> 主要是负责接收 <code>Pod</code> 的数据，分别从文件、URL、Kube-APIServer 三个地方来，下面将详细分析这个 <code>chan</code> 的读写流程。</p>
<p><code>Pod</code> 的 <code>source</code> 定义了四种表现方式，在代码 <code>pod_update.go</code></p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// These constants identify the sources of pods.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Filesource idenitified updates from a file.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	FileSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"file"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// HTTPSource identifies updates from querying a web page.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	HTTPSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"http"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// ApiserverSource identifies updates from Kubernetes API Server.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ApiserverSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"api"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// AllSource identifies updates from all sources.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	AllSource </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"*"</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="https://firebasestorage.googleapis.com/v0/b/notiondiagram.appspot.com/o/diagram%2Fm5smUNzLG7NDZmSPY82qhFvWnsu1%2F7182ab7e-9b66-4472-b508-6ce8abb3bd7e.svg?alt=media&amp;token=dc26e818-bbd5-4c18-8070-70649d577ad7" alt="a" class="img_ev3q"></p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="file">File<a href="https://lengrongfu.github.io/blog/kubelet-one-analyze#file" class="hash-link" aria-label="Direct link to File" title="Direct link to File">​</a></h3>
<p><code>file</code> Watch 功能只在 <code>linux</code> 操作系统上支持，其它操作系统都不支持。</p>
<p>会把 <code>fsnotify</code> 监听的文件事件转换为 <code>Pod</code> 的操作类型；</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sourceFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">produceWatchEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">fsnotify</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Event</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> eventType podEventType</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Op </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> fsnotify</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Create</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		eventType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> podAdd</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Op </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> fsnotify</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Write</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		eventType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> podModify</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Op </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> fsnotify</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Chmod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		eventType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> podModify</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Op </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> fsnotify</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Remove</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		eventType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> podDelete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Op </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain"> fsnotify</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Rename</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		eventType </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> podDelete</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">default</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// Ignore rest events</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">watchEvents </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">watchEvent</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> eventType</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后根据监听到的文件名的变化，来读取 <code>Pod</code> 的内容，之后更新 <code>store</code> 对象；这里是令我奇怪的，我以为它会往 <code>chan</code> 里面发送一个事件。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sourceFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">consumeWatchEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">watchEvent</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">switch</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">eventType </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> podAdd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> podModify</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">extractFromFile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fileName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> podDelete</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> objKey</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> keyExist </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fileKeyMapping</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fileName</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> keyExist </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			pod</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> podExist</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetByKey</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">objKey</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"failed to remove deleted pod from cache: %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>除了 <code>Watch</code> 文件变化之后，它还有一个 <code>time.Ticker</code> 每隔 <code>10s</code> 会执行一遍全量读取目录下 <code>Pod</code> 的操作；</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sourceFile</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	listTicker </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewTicker</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">period</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> #默认配置是10s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// 启动之后先读取一遍所有的</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">listConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ErrorS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Unable to read config path"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"path"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">select</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain">listTicker</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">C</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">listConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ErrorS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Unable to read config path"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"path"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">case</span><span class="token plain"> e </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">watchEvents</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">consumeWatchEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					klog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ErrorS</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Unable to process watch event"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">startWatch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上面有一个疑问：这里是令我奇怪的，我以为它会往 <code>chan</code> 里面发送一个事件。发现它的 <code>send</code> 是写在 <code>store.Add、store.Delete</code>  里面的，它会在每次触发这个函数的时候，把存储起来的 <code>pod</code> 全量的发送到 <code>chan</code> 里面. <code>undelta_store.go#45</code></p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">UndeltaStore</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">PushFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">List</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">UndeltaStore</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Update</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">PushFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">List</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">UndeltaStore</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">Delete</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">obj </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">PushFunc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Store</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">List</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="url">URL<a href="https://lengrongfu.github.io/blog/kubelet-one-analyze#url" class="hash-link" aria-label="Direct link to URL" title="Direct link to URL">​</a></h3>
<p><code>URL</code> 的方式是通过用户配置的外部服务地址，然后每 <code>20s</code> 去访问一次外部服务。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sourceURL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">extractFromURL</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	  </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在 <code>extractFromURL</code> 会通过访问 <code>HTTP</code> GET 的方式解析返回值，返回当个对象或者是数组都可以解析成功，解析成功之后也是会发送到 <code>merge</code> 中进行合并处理。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="api">API<a href="https://lengrongfu.github.io/blog/kubelet-one-analyze#api" class="hash-link" aria-label="Direct link to API" title="Direct link to API">​</a></h3>
<p><code>API</code> 的方式是通过 <code>list-watch</code> 去读取 <code>kube-apiserver</code> 的数据，并且通过 <code>field</code> 进行过滤当前的节点。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">lw </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewListWatchFromClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">CoreV1</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RESTClient</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"pods"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">NamespaceAll</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> fields</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">OneTermEqualSelector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"spec.nodeName"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">string</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nodeName</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>传递的 <code>store</code> 对象里面有 <code>send</code> 的功能，和 <code>file</code> 处理逻辑一样，一个 <code>pod</code> 发生变更，就会要发送所有的 <code>pod</code> 去执行 <code>merge</code> 操作。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">r </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewReflector</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lw</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewUndeltaStore</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">send</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cache</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">MetaNamespaceKeyFunc</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="merge">Merge<a href="https://lengrongfu.github.io/blog/kubelet-one-analyze#merge" class="hash-link" aria-label="Direct link to Merge" title="Direct link to Merge">​</a></h2>
<p><code>merge</code> 是为了把从不同的 <code>source</code> 过来的 <code>pod</code> 进一步合并，避免出现重复、冲突的操作，最终得到一个一致的操作，最终合并后会得到各种事件的结果：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">adds</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updates</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> deletes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> removes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reconciles </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">merge</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">source</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> change</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>合并的难点在于判断是不是要更新，添加、删除这种场景都比较简单，之前不存在就添加，之前存在，现在不存在就删除，但是要不要更新是比较难判断的，里面有一个 <code>checkAndUpdatePod</code> 方法。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">checkAndUpdatePod</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">existing</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ref </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">needUpdate</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> needReconcile</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> needGracefulDelete </span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">1.</span><span class="token plain"> 检查Spec、Labels、DeletionTimestamp、DeletionGracePeriodSeconds、Annotations这些是否发生变更</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">2.</span><span class="token plain"> 如果都没有发生变更判断Status是否发生变更，如果有则更新，没有则不更新。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token number" style="color:#36acaa">3.</span><span class="token plain"> 如果DeletionTimestamp不为空，则需要删除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>Leng Student</name>
            <uri>https://github.com/lengrongfu</uri>
        </author>
        <category label="kubernetes" term="kubernetes"/>
        <category label="Kubelet" term="Kubelet"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[JSON Patch and JSON Merge Patch]]></title>
        <id>https://lengrongfu.github.io/blog/jsonpatch-jsonmergepatch</id>
        <link href="https://lengrongfu.github.io/blog/jsonpatch-jsonmergepatch"/>
        <updated>2022-09-22T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[JSON Patch vs JSON Merge Patch]]></summary>
        <content type="html"><![CDATA[<p>JSON Patch vs JSON Merge Patch</p>
<p><code>PATCH</code> 作为 <code>HTTP</code> 的一种 <code>Method</code>, 近年来受到较多的关注，于是便提出关于使用 <code>JSON</code> 驱动 <code>PATCH</code> 格式的想法，这种格式用声明式的形式来描述两个<code>JSON</code>文档之间的差异，<code>IETF</code>发布了两种格式来解决这个问题： <a href="https://tools.ietf.org/html/rfc6902" target="_blank" rel="noopener noreferrer">RFC 6902 (JSON Patch)</a>和&nbsp;<a href="https://www.rfc-editor.org/rfc/rfc7396" target="_blank" rel="noopener noreferrer">RFC 7396 (JSON Merge Patch)</a>，两者各有优缺点，没有一种是可以适用于任何人的，让我们来看下他们的区别。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="json-patch">JSON PATCH<a href="https://lengrongfu.github.io/blog/jsonpatch-jsonmergepatch#json-patch" class="hash-link" aria-label="Direct link to JSON PATCH" title="Direct link to JSON PATCH">​</a></h2>
<p><code>JSON PATCH</code> 的格式类似于数据库事物，它是一个 <code>JSON Document,</code>它基本上是由<code>ADD</code>、<code>REMOVE</code>、<code>REPLACE</code>、<code>MOVE</code>、<code>COPY</code> 一系列操作组成的。</p>
<p>下面一个简单的示例描述了一个 <code>JSON</code> 的内容：</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	"users" : [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		{ "name" : "Alice" , "email" : "alice@example.org" },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		{ "name" : "Bob" , "email" : "bob@example.org" }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在这个 <code>JSON</code>中执行<code>JSON PATCH</code>操作，更改<code>Alice</code>的电子邮件，并且添加一个新的<code>user</code>到数组中：</p>
<div class="language-Json language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"op" : "replace" ,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"path" : "/users/0/email" ,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"value" : "alice@wonderland.org"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	},</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"op" : "add" ,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"path" : "/users/-" ,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"value" : {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			"name" : "Christine",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			"email" : "christine@example.org"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>它的结果将是：</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	"users" : [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		{ "name" : "Alice" , "email" : "alice@wonderland.org" },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		{ "name" : "Bob" , "email" : "bob@example.org" },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		{ "name" : "Christine" , "email" : "christine@example.org" }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>一个<code>JSON PATCH</code> 有以下几个基本元素描述而成：</p>
<ul>
<li><code>op </code>健表示操作类型。</li>
<li>操作的参数由其他元素描述。</li>
<li><code>path</code>是指向作为操作目标的<code>JSON</code>中的指针，是一个必须存在的参数。</li>
</ul>
<p><code>JSON PATCH</code> 操作提供了一个 <code>test</code> 操作类型，它没有任何坏处，所以它不是一个数据操作运算符，它可以用来对执行过程进行断言，如果<code>test</code>评估结果为<code>false</code>,则可以中断执行。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="json-merge-patch">JSON MERGE PATCH<a href="https://lengrongfu.github.io/blog/jsonpatch-jsonmergepatch#json-merge-patch" class="hash-link" aria-label="Direct link to JSON MERGE PATCH" title="Direct link to JSON MERGE PATCH">​</a></h2>
<p><code>JSON MERGE PATCH</code> 它描述了 <code>json document</code>的更改版本，与<code>JSON PATCH</code> 类似，区别在于它类似<code>diff</code>文件，只包含执行后应该不同的<code>document</code>节点。</p>
<p>如下是一个简单的<code>JSON</code>文档，来说明<code>JSON MERGE PATCH</code>的格式：</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	"a": "b",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	"c": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"d": "e",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"f": "g"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>我们可以在上述的<code>JSON</code>中运行如下的<code>MERGE PATCH</code>:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	"a":"z",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	"c": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		"f": null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个将 <code>a</code> 的值改为 <code>z</code> ,并且将删除 <code>c</code>。</p>
<p>它看着很简单，但是这种简单性也带来了限制：</p>
<ul>
<li>通过将<code>key</code>的值设置为<code>null</code>来进行删除，这本质上就导致用户不能主动设置<code>null</code>值。</li>
<li>数组不能被<code>PATCH</code>操作，如果想将一个元素添加到数组中，或者改变它的任何元素，那么必须要提供一个完整的数据才能执行。</li>
<li><code>MERGE PATCH</code>操作永远不会导致错误，任何格式错误的补丁都会被<code>PATCH</code>,所以它是一种自由的格式，这不一定是好的，因为我们可能需要在执行完<code>MEGER PATCH</code> 之后进行<code>JSON SCHEMA</code>的验证，错误就撤销<code>PATCH</code>，但是目前实现不了。</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="总结">总结<a href="https://lengrongfu.github.io/blog/jsonpatch-jsonmergepatch#%E6%80%BB%E7%BB%93" class="hash-link" aria-label="Direct link to 总结" title="Direct link to 总结">​</a></h2>
<p><code>JOSN MERGE PATCH</code> 是一种非常简单的格式，可用性有限，对于更复杂的用户，请使用<code>JSON PATCH</code>,由于它使用与任何<code>JSON</code>文档，该规范还提供了原子执行和执行前后执行<code>test</code>检查。</p>
<p><code>Kubernetes</code> 的 <code>PATCH</code>是支持<code>JSON MERGER PATCH</code> 和 <code>MERGE PATCH</code>的，但是使用<code>JSON MERGE PATCH</code>的场景较少，也是建议使用<code>JSON PATCH</code>，最根本原因就是<code>JSON MERGE PATCH</code>的协议格式过于简单，难以应用在复杂场景。</p>]]></content>
        <author>
            <name>Leng Student</name>
            <uri>https://github.com/lengrongfu</uri>
        </author>
        <category label="kubernetes" term="kubernetes"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Vscode Remote Golang开发环境打造]]></title>
        <id>https://lengrongfu.github.io/blog/remote-golang-developer-env</id>
        <link href="https://lengrongfu.github.io/blog/remote-golang-developer-env"/>
        <updated>2022-08-31T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[通过Vscode打造远程开发环境，可以加快工作效率.]]></summary>
        <content type="html"><![CDATA[<p>通过<code>Vscode</code>打造远程开发环境，可以加快工作效率.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="背景">背景<a href="https://lengrongfu.github.io/blog/remote-golang-developer-env#%E8%83%8C%E6%99%AF" class="hash-link" aria-label="Direct link to 背景" title="Direct link to 背景">​</a></h2>
<p>我之前的开发环境一直都是使用 <code>Mac + Goland</code>，但是最近在编译一个程序的时候发现编译不通过，经过排查发现是 <code>Mac</code>上的 <code>Make</code> 语法出现了不兼容，于是想到了打造一套 <code>Remote Linux + Vscode</code> 的开发环境。</p>
<p>刚好有一个大学时候的笔记本，重装为了 <code>Ubuntu</code> 系统，就用这个电脑来打造就可以，远程开发环境和本地开发环境相比，有利有弊；</p>
<table><thead><tr><th>对比</th><th>本地环境</th><th>远程环境</th></tr></thead><tbody><tr><td>优点</td><td>1.程序启动快，环境加载快。<br> 2.不会受限于网络环境和地域环境。</td><td>1. 可以使用较多资源，如内存、CPU、磁盘等。<br>2. 减少对Mac环境的影响，使用Linux开发环境。</td></tr><tr><td>缺点</td><td>1. 和本地系统绑定，有些软件在Mac下不能很好的执行和编辑<br>2. 内存、资源这些都受限</td><td>1. 这个原创环境只能在家里私有化网络环境下使用<br>2.因为操作都是网络传输，所以初始化的时候比较慢。``</td></tr></tbody></table>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="基本环境">基本环境<a href="https://lengrongfu.github.io/blog/remote-golang-developer-env#%E5%9F%BA%E6%9C%AC%E7%8E%AF%E5%A2%83" class="hash-link" aria-label="Direct link to 基本环境" title="Direct link to 基本环境">​</a></h2>
<ul>
<li>有一个远程的<code>Linux</code>环境，可以是<code>Ubuntu</code>，也可以是<code>Centos</code>，并打开远程连接<code>ssh 22</code>端口。</li>
<li>本地机器安装<code>Vscode</code>。</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="远程环境">远程环境<a href="https://lengrongfu.github.io/blog/remote-golang-developer-env#%E8%BF%9C%E7%A8%8B%E7%8E%AF%E5%A2%83" class="hash-link" aria-label="Direct link to 远程环境" title="Direct link to 远程环境">​</a></h2>
<p>按照如下的流程配置开发环境；</p>
<ol>
<li>
<p>本地Vscode安装扩展插件：在<code>Vscode</code>的扩展中搜索<code>ssh</code>插件，选择安装<code>Remote - SSH</code>这个插件。</p>
</li>
<li>
<p>创建<code>ssh</code>密钥：</p>
</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 执行如下的命令，就会在~/.ssh目录下生成 id_rsa_goland_developer_com、id_rsa_goland_developer_com.pub 两个文件</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ssh-keygen -f id_rsa_goland_developer_com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="3">
<li>在<code>Remote Linux</code>上配置本地公钥，实现免密登录</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 把本地id_rsa_goland_developer_com.pub文件上传到远程机器上，并写入到 ~/.ssh/authorized_keys 文件中，也可以直接复制通过vim编辑写入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ cat id_rsa_goland_developer_com.pub &gt; ~/.ssh/authorized_keys</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="4">
<li>
<p>点击<code>remote ssh</code>的<code>Configure</code>，选择第一个配置文件;
<img decoding="async" loading="lazy" alt="image-20220507210602712" src="https://lengrongfu.github.io/assets/images/image-20220507210602712-a5caf451431e4895398ac73be0be7157.png" width="1747" height="390" class="img_ev3q"></p>
</li>
<li>
<p>添加远程主机配置：</p>
</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Host GoDev</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    User {user}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    HostName {ip}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    IdentityFile ~/.ssh/id_rsa_goland_developer_com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><code>GoDev</code>：远程主机的标示名称，可以随意取，方便识别就可以。</li>
<li><code>{user}</code>：远程主机的用户，最好不要使用<code>root</code>，可以通过<code>useradd</code>命令新添加一个用户。</li>
<li><code>{ip}</code>：远程主机的地址。</li>
<li><code>IdentityFile</code>：用于远程登录的秘钥</li>
</ul>
<ol start="6">
<li>使用 <code>VS CODE</code> 连接远程开发机器</li>
</ol>
<ul>
<li>
<p>连接远程主机
<img decoding="async" loading="lazy" alt="image-20220507211751447.png" src="https://lengrongfu.github.io/assets/images/image-20220507211751447-ce2d9cac3eaf63bc351b85d4c9c26930.png" width="2163" height="426" class="img_ev3q"></p>
</li>
<li>
<p>连接成功后可以选择打开的工作目录
<img decoding="async" loading="lazy" alt="image-20220507212224603.png" src="https://lengrongfu.github.io/assets/images/image-20220507212224603-b045fa239539a9c2ac833a7abf33e22e.png" width="1771" height="418" class="img_ev3q"></p>
</li>
</ul>
<p>这样远程环境就配置好了，下面就开始配置开发环境。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="开发环境">开发环境<a href="https://lengrongfu.github.io/blog/remote-golang-developer-env#%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83" class="hash-link" aria-label="Direct link to 开发环境" title="Direct link to 开发环境">​</a></h2>
<p>如果这是一个新的<code>Linue</code>环境，所以我上面没有<code>go</code>环境这些，需要新进行安装<code>go</code>环境。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="go环境安装">Go环境安装<a href="https://lengrongfu.github.io/blog/remote-golang-developer-env#go%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85" class="hash-link" aria-label="Direct link to Go环境安装" title="Direct link to Go环境安装">​</a></h3>
<ul>
<li><code>Go</code>源码包下载地址：<a href="https://go.dev/doc/install" target="_blank" rel="noopener noreferrer">https://go.dev/doc/install</a></li>
</ul>
<ol>
<li>Go download.</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ wget -c https://dl.google.com/go/go1.19.linux-amd64.tar.gz</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>Go install.</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo tar -C /usr/local -xzf go1.19.linux-amd64.tar.gz</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ vim /etc/profile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">export PATH=$PATH:/usr/local/go/bin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ source /etc/profile</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="3">
<li>设置 go env</li>
</ol>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ go env -w GO111MODULE=on</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ go env -w GOPROXY=https://goproxy.cn</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="vscode-go环境配置">Vscode Go环境配置<a href="https://lengrongfu.github.io/blog/remote-golang-developer-env#vscode-go%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE" class="hash-link" aria-label="Direct link to Vscode Go环境配置" title="Direct link to Vscode Go环境配置">​</a></h3>
<ol>
<li>
<p>在打开远程连接的<code>Vscode</code>中安装<code>go</code>插件
<img decoding="async" loading="lazy" alt="image-20220507212648391" src="https://lengrongfu.github.io/assets/images/image-20220507212648391-e5cc19d1225d86856018143e361dee8b.png" width="864" height="483" class="img_ev3q"></p>
</li>
<li>
<p>安装其他Go插件</p>
</li>
</ol>
<blockquote>
<p>按快捷键ctrl+shift+p ，选择go install/update tools（安装所有相关包）。</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="image-20220507212945157" src="https://lengrongfu.github.io/assets/images/image-20220507212945157-eb34b09c75585b3e8a452721c0ab5ef1.png" width="1099" height="324" class="img_ev3q"></p>
<ol start="3">
<li>选择全部进行安装</li>
</ol>
<blockquote>
<p>最新版的Tools只有7个了，网上有些文章里面看着有10几个，那是很久之前的版本，在新版本中做了很多整合，比如：golint和goimports都整合到staticcheck中了。</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="image-20220507213258802" src="https://lengrongfu.github.io/assets/images/image-20220507213258802-cc83851190040f52b70a441ff6d969f3.png" width="1141" height="299" class="img_ev3q"></p>
<ol start="4">
<li>安装 <code>Code Run</code> 插件</li>
</ol>
<blockquote>
<p>搜索关键词code，安装Code Runner插件，这样就可以使用快捷键Ctrl+Alt+N运行代码了。</p>
</blockquote>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="其他设置">其他设置<a href="https://lengrongfu.github.io/blog/remote-golang-developer-env#%E5%85%B6%E4%BB%96%E8%AE%BE%EF%BF%BD%EF%BF%BD%E7%BD%AE" class="hash-link" aria-label="Direct link to 其他设置" title="Direct link to 其他设置">​</a></h2>
<p>因为使用的笔记本做为远程环境，所以为了避免屏幕一直亮着，可以配置让屏幕关闭显示。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 在如下文件中加入或者修改如下两个变量值</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo vim /etc/systemd/logind.conf</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HandleLidSwitch=ignore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HandleLidSwitchExternalPower=ignore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 之后重启就可以了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ sudo service systemd-logind restart</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="未来">未来<a href="https://lengrongfu.github.io/blog/remote-golang-developer-env#%E6%9C%AA%E6%9D%A5" class="hash-link" aria-label="Direct link to 未来" title="Direct link to 未来">​</a></h2>
<p>目前暂时使用笔记本，但是笔记本受限于内存大小、磁盘大小、<code>CPU</code> 性能，并且没有<code>GPU</code>,未来主要朝着家庭低功耗服务器去演进。</p>
<ul>
<li><a href="https://www.reddit.com/r/homelab/comments/rlouof/trying_to_build_a_small_low_power_server/" target="_blank" rel="noopener noreferrer">https://www.reddit.com/r/homelab/comments/rlouof/trying_to_build_a_small_low_power_server/</a></li>
<li><a href="https://kit.co/TechnoTim/efficient-low-power-powerful-virtualization-server" target="_blank" rel="noopener noreferrer">https://kit.co/TechnoTim/efficient-low-power-powerful-virtualization-server</a></li>
<li><a href="https://www.proxmox.com/en/" target="_blank" rel="noopener noreferrer">https://www.proxmox.com/en/</a></li>
</ul>]]></content>
        <author>
            <name>Leng Student</name>
            <uri>https://github.com/lengrongfu</uri>
        </author>
        <category label="Developer Env" term="Developer Env"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Github Contribute 注意事项]]></title>
        <id>https://lengrongfu.github.io/blog/github-contribute</id>
        <link href="https://lengrongfu.github.io/blog/github-contribute"/>
        <updated>2022-08-28T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[当我们在Github上贡献代码时要注意些什么？如下是个人贡献时总结的一些小心得，欢迎轻拍。]]></summary>
        <content type="html"><![CDATA[<p>当我们在<code>Github</code>上贡献代码时要注意些什么？如下是个人贡献时总结的一些小心得，欢迎轻拍。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="代码提交流程">代码提交流程<a href="https://lengrongfu.github.io/blog/github-contribute#%E4%BB%A3%E7%A0%81%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B" class="hash-link" aria-label="Direct link to 代码提交流程" title="Direct link to 代码提交流程">​</a></h2>
<p>如下以以<code>kubernetes</code>为例，核心操作步骤如下图：
<img decoding="async" loading="lazy" alt="git_workflow.png" src="https://lengrongfu.github.io/assets/images/git_workflow-a05c064048d6c2754123c6510faef769.png" width="1280" height="720" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="签署贡献协议">签署贡献协议<a href="https://lengrongfu.github.io/blog/github-contribute#%E7%AD%BE%E7%BD%B2%E8%B4%A1%E7%8C%AE%E5%8D%8F%E8%AE%AE" class="hash-link" aria-label="Direct link to 签署贡献协议" title="Direct link to 签署贡献协议">​</a></h2>
<p>目前大多数开源项目都需要签署贡献协议，比如<code>DCO</code>协议，签署使用的就是当前<code>github</code>账号的账号和邮箱，所以在项目提交代码的时候需要先进行配置：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ git config --local user.name lengrongfu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ git config --local user.email 1275177125@qq.com</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一个pr尽量只用一个commit">一个PR尽量只用一个Commit<a href="https://lengrongfu.github.io/blog/github-contribute#%E4%B8%80%E4%B8%AApr%E5%B0%BD%E9%87%8F%E5%8F%AA%E7%94%A8%E4%B8%80%E4%B8%AAcommit" class="hash-link" aria-label="Direct link to 一个PR尽量只用一个Commit" title="Direct link to 一个PR尽量只用一个Commit">​</a></h2>
<p>单发生多次代码修改的时候，在<code>commit</code>的时候使用最开始的<code>commit</code>，使用命令如下：</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ git commit -s --amend --no-edit</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># -s 后会在PR中加入签名信息：Signed-off-by: lengrongfu 1275177125@qq.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># --amend 追加commit，使用同一个commit ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># --no-edit 不进行任何更改，如果要修改commit 信息就不要使用这个标签</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="go项目开发要注意什么">Go项目开发要注意什么<a href="https://lengrongfu.github.io/blog/github-contribute#go%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E8%A6%81%E6%B3%A8%E6%84%8F%E4%BB%80%E4%B9%88" class="hash-link" aria-label="Direct link to Go项目开发要注意什么" title="Direct link to Go项目开发要注意什么">​</a></h2>
<p><code>go</code>开源项目目前大多都是使用的<code>golangci-lint</code>、<code>goimports</code>来做代码格式等相关静态检查，在提交<code>PR</code>的时候都会检查是否符合这些工具的规范。</p>
<p>在<code>golangd</code>中配置上述工具，在文件产生变更的时候自动执行上述命令，进行格式校验，下面以<code>Mac Goland</code>为例讲解配置 ：</p>
<ul>
<li>通过<code>command+,</code>快捷键打开系统配置，或者点击左上角<code>preferences</code>菜单。</li>
<li>搜索<code>File Watchers</code></li>
<li>点击添加按钮，选择对应工具即可：
<img decoding="async" loading="lazy" alt="file-watcher.png" src="https://lengrongfu.github.io/assets/images/file-watcher-f877ea9658d79dce06211b14b3052467.png" width="1198" height="604" class="img_ev3q"></li>
<li>添加后可以选择所有项目生效或者当前项目生效。</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="gitignore是否可以不修改">.gitignore是否可以不修改<a href="https://lengrongfu.github.io/blog/github-contribute#gitignore%E6%98%AF%E5%90%A6%E5%8F%AF%E4%BB%A5%E4%B8%8D%E4%BF%AE%E6%94%B9" class="hash-link" aria-label="Direct link to .gitignore是否可以不修改" title="Direct link to .gitignore是否可以不修改">​</a></h2>
<p>很多编辑器都有对应的隐藏文件<code>.vscode</code>、<code>.idea</code>等，我们通过编辑器首次打开项目后都会生成这个文件，如果我们不想让这个文件提交，就只能往<code>.gitignore</code>里面加入忽略文件的信息。</p>
<p>但是从代码仓库管理员的角度看，如果每个人都把特定于个人的配置加入到<code>.gitignore</code>中，那整体维护起来将会很难。</p>
<p>有一个更好的解决办法：为您的所有存储库创建一个个人的全局<code>.gitignore</code>文件。</p>
<ul>
<li>选择一个地方存储全局<code>.gitignore</code>的文件，大多数人选择主目录</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ touch ~/.gitignore</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>在里面加入自己需要忽略的文件或者文件夹</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ vim ~/.gitignore</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.DS_Store</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.idea</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">.vscode</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>最后，配置git使用我们新创建的~/.gitignore文件</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ git config --global core.excludesfile ~/.gitignore</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>如果您是 Windows 用户，则需要以不同方式格式化路径</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ git config --global core.excludesfile %USERPROFILE%\.gitignore</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="引用">引用<a href="https://lengrongfu.github.io/blog/github-contribute#%E5%BC%95%E7%94%A8" class="hash-link" aria-label="Direct link to 引用" title="Direct link to 引用">​</a></h2>
<ul>
<li><a href="https://github.com/kubernetes/community/blob/master/contributors/guide/github-workflow.md" target="_blank" rel="noopener noreferrer">github-workflow.md</a></li>
</ul>]]></content>
        <author>
            <name>Leng Student</name>
            <uri>https://github.com/lengrongfu</uri>
        </author>
        <category label="Github" term="Github"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Distribution Auth Type]]></title>
        <id>https://lengrongfu.github.io/blog/distribution-auth</id>
        <link href="https://lengrongfu.github.io/blog/distribution-auth"/>
        <updated>2022-08-05T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Distribution Auth认证流程介绍]]></summary>
        <content type="html"><![CDATA[<p>Distribution Auth认证流程介绍</p>
<p><a href="https://github.com/distribution/distribution" target="_blank" rel="noopener noreferrer"><code>Distribution</code></a> 是一个按照 <code>OCI</code> 的规范实现的一个制品库管理工具，它提供了三种的认证方式，<code>htpasswd</code>、<code>silly</code>、<code>token</code>，在 <code>Distribution</code> 项目中采用的是策略模式。</p>
<p>它的认证流程如下图所示：</p>
<p><img decoding="async" loading="lazy" alt="auth" src="https://lengrongfu.github.io/assets/images/auth-02304b74ba61487a8263ce6a891a474d.png" width="610" height="781" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="htpasswd">htpasswd<a href="https://lengrongfu.github.io/blog/distribution-auth#htpasswd" class="hash-link" aria-label="Direct link to htpasswd" title="Direct link to htpasswd">​</a></h2>
<p><code>htpasswd</code> 是一种在系统中，它包含一个 <code>htpasswd</code> 的文件（文件内容是初始的用户名<code>docker</code>，以及一个使用特定算法随机生成的密码）以及如何解析这个文件的算法（目前只能使用 <code>bcrypt</code> 加密算法）。</p>
<p>配置格式如下：</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">auth</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">htpasswd</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">realm</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> harbor</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">registry</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">basic</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">realm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">path</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /etc/registry/passwd</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li>
<p>启动过程中会校验 <code>path</code> 对应的文件是否存在，如果不存在，就创建并写入内容，内容为用户：<code>docker</code>, 密码为随机生成并加密存储。</p>
</li>
<li>
<p>用户在请求过程中，每个请求都会进入配置好的访问控制器中，进行权限验证。</p>
</li>
<li>
<p>会首先判断 <code>Header</code> 中是否存在 <code>Authorization</code> 字段值，并正确解析；如果不存在，则认为无效认证。</p>
</li>
<li>
<p>如果存在用户密码则会和文件中写入的内容进行对比，确保是一致的（提示：在对比之前系统会先校验这个文件是否被修改过，如果被修改过就会从新生成文件内容）。</p>
</li>
</ol>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="silly">silly<a href="https://lengrongfu.github.io/blog/distribution-auth#silly" class="hash-link" aria-label="Direct link to silly" title="Direct link to silly">​</a></h2>
<p>这个主要是用于测试的，是简单功能的实现；它主要是检查 <code>Header</code> 中是否存在 <code>Authorization</code> 并且值非空，如果是就进行授权通过。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="token">token<a href="https://lengrongfu.github.io/blog/distribution-auth#token" class="hash-link" aria-label="Direct link to token" title="Direct link to token">​</a></h2>
<p><img decoding="async" loading="lazy" alt="auth" src="https://lengrongfu.github.io/assets/images/v2-registry-auth-df4a5006246cd127c0d0c30510537f50.png" width="472" height="360" class="img_ev3q"></p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">auth</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">token</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">realm</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> https</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">5011/auth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">service</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Authentication</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">issuer</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Sample Issuer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">rootCertBundle</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> /mnt/local/certs/RootCA.crt</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>token</code> 认证需要借助外部认证服务，可以实现资源、权限的管理，<code>distribution</code> 的响应的时候会返回给用户 <code>scope</code> 就是资源权限</p>
<ol>
<li>启动过程会校验 <code>token</code> 配置的参数是否正确，并且校验 <code>tls</code> 证书。</li>
<li>用户请求时，会从 <code>Header</code> 中获取认证信息，如果没有认证，则会根据是否配置 <code>autoRedirect</code> 以及重定向地址 <code>realm</code>。</li>
<li><code>distribution</code> 会返回 <code>401</code> 的请求，并携带<code>WWW-Authenticate</code> 告诉客户端改如何向认证服务进行认证。</li>
</ol>
<blockquote>
<p>如：一个未授权的用户正在 <code>Push</code>镜像到 <code>samalba/my-app</code> repoName 中，就会返回</p>
<ul>
<li>scope: 授权范围</li>
<li>service: 授权服务</li>
<li>realm: 认证服务</li>
</ul>
</blockquote>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/1.1 401 Unauthorized</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: application/json; charset=utf-8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Docker-Distribution-Api-Version: registry/2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Www-Authenticate: Bearer realm="https://auth.docker.io/token",service="registry.docker.io",scope="repository:samalba/my-app:pull,push"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Date: Thu, 10 Sep 2015 19:32:31 GMT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Length: 235</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Strict-Transport-Security: max-age=31536000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{"errors":[{"code":"UNAUTHORIZED","message":"access to the requested resource is not authorized","detail":[{"Type":"repository","Name":"samalba/my-app","Action":"pull"},{"Type":"repository","Name":"samalba/my-app","Action":"push"}]}]}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="4">
<li>如果开启自动重定向，则请求的就是 <code>distribution</code> host 的接口：<code>https://%s/auth/token</code>，没有则走用户配置<code>realm</code></li>
</ol>]]></content>
        <author>
            <name>Leng Student</name>
            <uri>https://github.com/lengrongfu</uri>
        </author>
        <category label="镜像仓库" term="镜像仓库"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Kubernetes Scheduler]]></title>
        <id>https://lengrongfu.github.io/blog/Kubernetes-Scheduler</id>
        <link href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler"/>
        <updated>2022-07-11T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Kubernetes Scheduler 基本使用概念]]></summary>
        <content type="html"><![CDATA[<p>Kubernetes Scheduler 基本使用概念</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="scheduler-workflow">Scheduler Workflow<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#scheduler-workflow" class="hash-link" aria-label="Direct link to Scheduler Workflow" title="Direct link to Scheduler Workflow">​</a></h2>
<p><img decoding="async" loading="lazy" alt="schedule-workflow" src="https://lengrongfu.github.io/assets/images/schedule-workflow-258bff258660b628d176de7fd4f26c2e.jpeg" width="1643" height="863" class="img_ev3q"></p>
<p><code>Scheduler WorkFlow</code>定义了<code>Scheduler Cycle</code>和<code>Binding Cycle</code>，在<code>Scheduler Cycle</code>中有串行<code>Filter </code>和<code>Score</code>两个阶段，<code>Bind</code>是异步并行阶段。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="scheduler-framework">Scheduler FrameWork<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#scheduler-framework" class="hash-link" aria-label="Direct link to Scheduler FrameWork" title="Direct link to Scheduler FrameWork">​</a></h2>
<p><code>Scheduler FrameWork</code>是通过在<code>Scheduler  Cycle</code>中通过预留扩展点来进行扩展调度流程，<code>FrameWork</code>预留了多个扩展点:</p>
<ul>
<li><code>QueueSortFunc() LessFunc</code>： <code>Pod</code> 从队列中获取的优先级</li>
<li><code>PreFilter</code>： 在过滤之前执行</li>
<li><code>Filter</code>： 执行过滤函数</li>
<li><code>PostFilter</code>: 执行抢占</li>
<li><code>PreScore</code>：执行`Score之前执行</li>
<li><code>Score</code>: 执行<code>Node</code>打分</li>
<li><code>PreBind</code>: 执行<code>Binding</code>之前</li>
<li><code>Bind</code>： 执行<code>Binding</code>动作</li>
<li><code>PostBind</code>：执行<code>Binding</code>之后</li>
</ul>
<p>自定义<code>Schedlue</code>可以通过直接实现<code>Scheduler FrameWork</code>中暴露的接口，然后在启动过程中进行<code>Plugin</code>注册即可。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	rand</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Seed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">UTC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">UnixNano</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	logs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">InitLogs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">defer</span><span class="token plain"> logs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">FlushLogs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	cmd </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewSchedulerCommand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		app</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithPlugin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sample</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sample</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">New</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> cmd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Stderr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"%v\n"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="scheduler-plugin">Scheduler Plugin<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#scheduler-plugin" class="hash-link" aria-label="Direct link to Scheduler Plugin" title="Direct link to Scheduler Plugin">​</a></h2>
<p>如下的<code>Scheduler Plugin</code>是<code>kube-scheduler</code>里面内嵌的插件，涵盖了<code>WorkFlow</code>里面的所有流程。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="sort排序">Sort(排序)<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#sort%E6%8E%92%E5%BA%8F" class="hash-link" aria-label="Direct link to Sort(排序)" title="Direct link to Sort(排序)">​</a></h3>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1prioritysort">1.PrioritySort<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#1prioritysort" class="hash-link" aria-label="Direct link to 1.PrioritySort" title="Direct link to 1.PrioritySort">​</a></h4>
<p><code>PrioritySort</code>优先队列是进行<code>Pod</code>在入队时的排序函数，按找<code>Pod</code>的优先级进行排序，通过读取<code>pod.Spec.Priority</code>字段值进行排序，如果未设置<code>Pod</code>的优先级则按照添加到队列的时间先后进行排序。</p>
<div class="language-Go language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">p1 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> pod1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Priority </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> ? </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pod1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Priority </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p2 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> pod2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Priority </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> ? </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pod2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Spec</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Priority </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p1 </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> p2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">p1 </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> p2 </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> pInfo1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Timestamp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Before</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pInfo2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Timestamp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="filter预选">Filter(预选)<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#filter%E9%A2%84%E9%80%89" class="hash-link" aria-label="Direct link to Filter(预选)" title="Direct link to Filter(预选)">​</a></h3>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-interpodaffinity">1. InterPodAffinity<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#1-interpodaffinity" class="hash-link" aria-label="Direct link to 1. InterPodAffinity" title="Direct link to 1. InterPodAffinity">​</a></h4>
<p><code>InterPodAffinity</code> 检查<code>Pod</code>的亲和性是否满足，实现了<code>PreFilterPlugin</code>和<code>FilterPlugin</code>两个插件；</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2-nodeaffinity">2. NodeAffinity<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#2-nodeaffinity" class="hash-link" aria-label="Direct link to 2. NodeAffinity" title="Direct link to 2. NodeAffinity">​</a></h4>
<p><code>NodeAffinity</code>是<code>Node</code>亲和性的过滤，通过<code>pod.Spec.Affinity.NodeAffinity </code>是否配置<code>Node</code>亲和性和<code>Node</code>进行<code>Match</code>动作。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3nodename">3.NodeName<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#3nodename" class="hash-link" aria-label="Direct link to 3.NodeName" title="Direct link to 3.NodeName">​</a></h4>
<p><code>NodeName</code>用于在对<code>pod.Spec.NodeName</code>字段值的判断，判断是否是当前的<code>Node</code>，如果指定了<code>pod.Spec.NodeName</code>并且不是当前的节点，则返回<code>UnschedulableAndUnresolvable</code>状态。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4nodeports">4.NodePorts<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#4nodeports" class="hash-link" aria-label="Direct link to 4.NodePorts" title="Direct link to 4.NodePorts">​</a></h4>
<p><code>NodePorts</code>用于检查要启用的端口是否已经在<code>Node</code>上使用过，如果使用过则返回<code>Unschedulable</code>状态。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="5noderesourcesfit">5.NodeResourcesFit<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#5noderesourcesfit" class="hash-link" aria-label="Direct link to 5.NodeResourcesFit" title="Direct link to 5.NodeResourcesFit">​</a></h4>
<p><code>NodeResourcesFit</code> 检查节点是否有足够的资源，如:<code>cpu</code>、<code>memory</code>、<code>gpu</code>等，通过那取<code>max_resource(sum_pod, any_init_container)</code>和<code>node</code>可分配的资源来判断节点是否资源足够。如果有任一资源不够，此节点则会返回资源不足被过滤。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="6nodeunschedulable">6.NodeUnschedulable<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#6nodeunschedulable" class="hash-link" aria-label="Direct link to 6.NodeUnschedulable" title="Direct link to 6.NodeUnschedulable">​</a></h4>
<p><code>NodeUnschedulable</code> 插件过滤设置<code>node.Spec.Unschedulable=true</code>的节点，但是如果<code>Pod</code>设置了容忍<code>Unschedulable</code>的污点则不过滤。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7nodevolumelimits">7.NodeVolumeLimits<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#7nodevolumelimits" class="hash-link" aria-label="Direct link to 7.NodeVolumeLimits" title="Direct link to 7.NodeVolumeLimits">​</a></h4>
<p><code>NodeVolumeLimits</code>是一个节点检查<code>volume</code>容量的插件； 校验PVC指定的Provision在CSI plugin或非CSI Plugin（后三个）上报的单机最大挂盘数（存储插件提供方一般对每个节点的单机最大挂载磁盘数是有限制的）</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="8podtopologyspread">8.PodTopologySpread<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#8podtopologyspread" class="hash-link" aria-label="Direct link to 8.PodTopologySpread" title="Direct link to 8.PodTopologySpread">​</a></h4>
<p><code>PodTopologySpread</code> 是用于检查<code>Pod</code>的拓扑逻辑是否满足条件，</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="9tainttoleration">9.TaintToleration<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#9tainttoleration" class="hash-link" aria-label="Direct link to 9.TaintToleration" title="Direct link to 9.TaintToleration">​</a></h4>
<p><code>TaintToleration</code>是一个污点容忍度的插件，用于检查<code>Pod</code>是否能容忍次污点。<code>Taint</code>污点是<code>Node</code>上的标签，<code>Toleration</code>容忍度是<code>Pod</code>上的功能，一个容忍度和一个污点相“匹配”是指它们有一样的<code>key</code>和<code>value</code>。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="10volumebinding">10.VolumeBinding<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#10volumebinding" class="hash-link" aria-label="Direct link to 10.VolumeBinding" title="Direct link to 10.VolumeBinding">​</a></h4>
<p><code>VolumeBinding</code>检查<code>Pod</code>挂载的<code>PVC</code>，如果其对应<code>SC(StorageClass)</code>的<code>VolumeBindingMode</code>是<code>Immediate</code>模式，该<code>PVC</code>必须已经是<code>bound</code>，否则需要返回<code>UnschedulableAndUnresolvable</code>。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="11volumerestrictions">11.VolumeRestrictions<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#11volumerestrictions" class="hash-link" aria-label="Direct link to 11.VolumeRestrictions" title="Direct link to 11.VolumeRestrictions">​</a></h4>
<p><code>VolumeRestrictions</code> 检查挂载该Node上的卷是否满足存储提供者的要求</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="score优选">Score(优选)<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#score%E4%BC%98%E9%80%89" class="hash-link" aria-label="Direct link to Score(优选)" title="Direct link to Score(优选)">​</a></h3>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1imagelocality">1.ImageLocality<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#1imagelocality" class="hash-link" aria-label="Direct link to 1.ImageLocality" title="Direct link to 1.ImageLocality">​</a></h4>
<p><code>ImageLocality</code>是一个打分插件，对于调度<code>Pod</code>的镜像已经存在<code>Node</code>上给评分。已经存在的镜像并且镜像越大的分越高；（逻辑就是越大的镜像如果被重新拉取需要花费更多的时间，但是小的镜像拉起来就快，所以镜像存在并且越大的分越高就是这个逻辑）;如果一个节点上的镜像总大小<code>&lt; 23Mb</code>则<code>node</code>会被打<code>0</code>分；如果一个节点上的镜像总大于<code>1G * 容器数</code>则会被打<code>1</code>分。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2interpodaffinity">2.InterPodAffinity<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#2interpodaffinity" class="hash-link" aria-label="Direct link to 2.InterPodAffinity" title="Direct link to 2.InterPodAffinity">​</a></h4>
<p><code>InterPodAffinity</code>在<code>Pod</code>亲和性之间计算亲和性的的分值。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3nodeaffinity">3.NodeAffinity<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#3nodeaffinity" class="hash-link" aria-label="Direct link to 3.NodeAffinity" title="Direct link to 3.NodeAffinity">​</a></h4>
<p><code>NodeAffinity</code>是通过节点的亲和性来进行节点打分的，<code>PreScore</code> 主要逻辑是从<code>pod.Spec.Affinity.NodeAffinity.PreferredDuringSchedulingIgnoredDuringExecution</code>字段中获取首选节点亲和配置，主要的是配置的<code>weight</code>字段值，在通过<code>Label</code>匹配过程中，发现<code>Node.Meta.Label</code>是匹配<code>matchExpressions</code>中的字段则<code>score += weight</code>，这样这个节点的优先级就提高了。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4noderesourcesbalancedallocation">4.NodeResourcesBalancedAllocation<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#4noderesourcesbalancedallocation" class="hash-link" aria-label="Direct link to 4.NodeResourcesBalancedAllocation" title="Direct link to 4.NodeResourcesBalancedAllocation">​</a></h4>
<p><code>NodeResourcesBalancedAllocation</code>节点资源均衡插件，是一个通过<code>cpu</code>和<code>memory</code>容量分数之间的差异，根据他们的优先级进行排名；对于资源使用率均衡的节点分值更高。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># ResourceSpec[{"name":"cpu","Weight":1},{"name":"memory","Weight":1}]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">std =  Σ((fraction(i)-mean)^2)/len(resources)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># std计算取决于需要均衡几种资源，如果只有cpu和memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">std=Abs( (cpuRequest1/cpuAllocable1 - memoryRequest1/memoryAllocable1) / 2 )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># node打分则由如下计算</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">score = (1 - std) * MaxNodeScore(100)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="5noderesourcesfit-1">5.NodeResourcesFit<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#5noderesourcesfit-1" class="hash-link" aria-label="Direct link to 5.NodeResourcesFit" title="Direct link to 5.NodeResourcesFit">​</a></h4>
<p><code>NodeResourcesFit</code>打分已经配置的策略进行，有如下三种：</p>
<ul>
<li><code>LeastAllocated</code>: 优先分配资源最少的节点；就是资源堆叠</li>
<li><code>MostAllocated</code>: 优先分配资源最多的节点；就是资源打散</li>
<li><code>RequestedToCapacityRatio</code>: 可以自定义函数，对资源容量进行打分。</li>
</ul>
<p><code>LeastAllocated</code>计算节点分值逻辑：<code>(cpu((capacity-requested)*MaxNodeScore*cpuWeight/capacity) + memory((capacity-requested)*MaxNodeScore*memoryWeight/capacity) + ...)/weightSum</code></p>
<p>MostAllocated 计算节点分值逻辑：<code>(cpu(MaxNodeScore * sum(requested) / capacity) + memory(MaxNodeScore * sum(requested) / capacity) + ...) / weightSum</code></p>
<p><code>capacity</code>是<code>allocable</code></p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="6podtopologyspread">6.PodTopologySpread<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#6podtopologyspread" class="hash-link" aria-label="Direct link to 6.PodTopologySpread" title="Direct link to 6.PodTopologySpread">​</a></h4>
<p><code>PodTopologySpread</code>权重为2</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="7selectorspread">7.SelectorSpread<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#7selectorspread" class="hash-link" aria-label="Direct link to 7.SelectorSpread" title="Direct link to 7.SelectorSpread">​</a></h4>
<p><code>SelectorSpread</code>是一个计算选择器传播优先级的打分插件；</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="8tainttoleration">8.TaintToleration<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#8tainttoleration" class="hash-link" aria-label="Direct link to 8.TaintToleration" title="Direct link to 8.TaintToleration">​</a></h4>
<p><code>TaintToleration计算无法容忍污点的一个插件，用于给</code>Pod 无法容忍污点打分，每一个无法容忍则<code>+1</code>，最后得到的就是<code>Node</code>的分。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="binding绑定">Binding(绑定)<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#binding%E7%BB%91%E5%AE%9A" class="hash-link" aria-label="Direct link to Binding(绑定)" title="Direct link to Binding(绑定)">​</a></h3>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-defaultbind">1. DefaultBind<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#1-defaultbind" class="hash-link" aria-label="Direct link to 1. DefaultBind" title="Direct link to 1. DefaultBind">​</a></h4>
<p><code>DefaultBind</code>是通过使用<code>k8s client</code>绑定<code>Pod</code>到<code>Node</code>。绑定流程是先创建一个<code>Binding</code>类型对象，通过设置<code>Target</code>字段值，来记录绑定对象的目标对象。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Binding是将一个对象与另一个对象联系起来</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Binding </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">TypeMeta </span><span class="token string" style="color:#e3116c">`json:",inline"`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ObjectMeta </span><span class="token string" style="color:#e3116c">`json:"metadata,omitempty" protobuf:"bytes,1,opt,name=metadata"`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Target ObjectReference </span><span class="token string" style="color:#e3116c">`json:"target" protobuf:"bytes,2,opt,name=target"`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">binding </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Binding</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		ObjectMeta</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> metav1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ObjectMeta</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Namespace</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Namespace</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> UID</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> p</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UID</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		Target</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">     v1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ObjectReference</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Kind</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Node"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nodeName</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>创建<code>Binding</code>对象之后，通过<code>Pods</code>的<code>Bind</code>方法就可以进行结果绑定。最终是创建<code>Pod</code>的绑定。</p>
<div class="language-http codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-http codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /api/v1/namespaces/{namespace}/pods/{name}/binding</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">namespace: pod namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">name: binding 名字</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">body: Binding对象结构体</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>选中的节点在和待调度Pod进行Bind的时候，有可能会Bind失败，此时需要做回退，把Pod的Assumed状态退回Initial，从Node里面把Pod数据账本擦除掉，会把Pod重新丢回到unschedulableQ队列里面。在unschedulableQ里，如果一个Pod一分钟没调度过，就会重新回到activeQ。它的轮询周期是30s。</p>
<p>调度失败的<code>Pod</code>会放到<code>backoffQ</code>，在<code>backoffQ</code>里等待的时间会比在<code>unschedulableQ</code>里更短，<code>backoffQ</code>里的降级策略是<code>2</code>的指数次幂降级。假设重试第一次为<code>1s</code>，那第二次就是<code>2s</code>，第三次就是<code>4s</code>，但最大到<code>10s</code>。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2volumebinding">2.VolumeBinding<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#2volumebinding" class="hash-link" aria-label="Direct link to 2.VolumeBinding" title="Direct link to 2.VolumeBinding">​</a></h4>
<p><code>VolumeBinding</code>是<code>PreBinding</code>作为<code>Binding</code>之前检查的<code>Volume</code>是否绑定到<code>Node</code>上面，</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="preemption抢占">Preemption(抢占)<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#preemption%E6%8A%A2%E5%8D%A0" class="hash-link" aria-label="Direct link to Preemption(抢占)" title="Direct link to Preemption(抢占)">​</a></h3>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1defaultpreemption">1.DefaultPreemption<a href="https://lengrongfu.github.io/blog/Kubernetes-Scheduler#1defaultpreemption" class="hash-link" aria-label="Direct link to 1.DefaultPreemption" title="Direct link to 1.DefaultPreemption">​</a></h4>
<p><code>DefaultPreemption</code>是一个<code>PostFilter</code>插件，实现了默认抢占逻辑；当高优先级的<code>Pod</code>没有找到合适的<code>Node</code>时，会执行<code>Preempt</code>抢占算法，抢占的流程。</p>
<ul>
<li>一个<code>Pod</code>进入抢占的时候，首先会判断<code>Pod</code>是否拥有抢占的资格，有可能上次已经抢占过一次。</li>
<li>如果符合抢占资格，会先对所有的节点进行一次过滤，过滤出符合这次抢占要求的节点。然后</li>
<li>模拟一次调度，把优先级低的<code>Pod</code>先移除出去，再尝试能否把待抢占的<code>Pod</code>放置到此节点上。然后通过这个过程从过滤剩下的节点中选出一批节点进行抢占。</li>
<li><code>ProcessPreemptionWithExtenders</code>是一个扩展的钩子，用户可以在这里加一些自己抢占节点的策略。如果没有扩展的钩子，这里面不做任何动作。</li>
<li><code>PickOneNodeForPreemption</code>，从上面选出的节点里挑选出最合适的一个节点，策略包括：<!-- -->
<ul>
<li>优先选择打破<code>PDB</code>最少的节点；</li>
<li>其次选择待抢占<code>Pods</code>中最大优先级最小的节点；</li>
<li>再次选择待抢占<code>Pods</code>优先级加和最小的节点；</li>
<li>接下来选择待抢占<code>Pods</code>数目最小的节点；</li>
<li>最后选择拥有最晚启动<code>Pod</code>的节点；</li>
</ul>
</li>
</ul>
<p>通过过滤之后，会选出一个最合适的节点。对这个节点上待抢占的<code>Pod</code>进行<code>delete</code>，完成抢占过程。</p>]]></content>
        <author>
            <name>Leng Student</name>
            <uri>https://github.com/lengrongfu</uri>
        </author>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="Kubernetes Scheduler" term="Kubernetes Scheduler"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[读《云计算那些事儿》]]></title>
        <id>https://lengrongfu.github.io/blog/读云计算那些事儿</id>
        <link href="https://lengrongfu.github.io/blog/读云计算那些事儿"/>
        <updated>2022-05-18T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[云计算的根本就是把基础资源虚拟化之后以更小的力度提供出来的能力。]]></summary>
        <content type="html"><![CDATA[<p>云计算的根本就是把基础资源虚拟化之后以更小的力度提供出来的能力。</p>
<p>云计算的根本就是把基础资源虚拟化之后以更小的力度提供出来的能力。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="云计算分类">云计算分类<a href="https://lengrongfu.github.io/blog/%E8%AF%BB%E4%BA%91%E8%AE%A1%E7%AE%97%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF#%E4%BA%91%E8%AE%A1%E7%AE%97%E5%88%86%E7%B1%BB" class="hash-link" aria-label="Direct link to 云计算分类" title="Direct link to 云计算分类">​</a></h2>
<ul>
<li>IaaS: 基础设施即服务，就是将基础设施当作服务队外输出，计算、网络、存储这些原始资源就是基础设施资源，通过互联网队外提供服务。虚拟化是IaaS实现的基础，通过计算虚拟化、网络虚拟化、存储虚拟化将物理资源整合成虚拟的资源池，然后把资源以按需的形式提供给资源申请者，从而完成资源的二次分配。</li>
<li>PaaS：平台即服务，它直接为用户提供一套平台，包括语言运行环境、编程框架及数据存储中间件等一系列功能。PaaS将管理的对象从资源升级到服务，面向接口编程和运维。</li>
<li>SaaS: 软件即服务，它是最高层的抽象，对于最终的用户，它不关心任何技术相关内容，以服务的方式交付。如：在线的云编辑器。</li>
<li>FaaS：函数即服务，通过定义一些CRUD操作函数，在特定事件下触发这些函数， 并执行。</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="关键技术">关键技术<a href="https://lengrongfu.github.io/blog/%E8%AF%BB%E4%BA%91%E8%AE%A1%E7%AE%97%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF#%E5%85%B3%E9%94%AE%E6%8A%80%E6%9C%AF" class="hash-link" aria-label="Direct link to 关键技术" title="Direct link to 关键技术">​</a></h2>
<p>资源调度：资源调度就是当用户申请资源的时候，系统需要通过调度确定资源位置。</p>
<p>Google在Omega的调度系统论文中将调度分为三类：</p>
<ul>
<li>单体：单体调度是指所有任务都是通过一个串行调度器分配的，典型代表是Kubernetes，它的优点是简单，缺点是很难支持多类型任务的执行，如同时支持批处理和长任务。</li>
<li>二层调度：二层调度是将资源分配和任务调度分离，第一层是从全局的资源池中分配资源给各种类型任务调度器，第二层任务调度器依据任务特点启动任务，典型代表是Mesos和Yarn。二层调度的优点是可以减少调度时间，缺点是：资源调度无法感知全局资源，只了解自己的可用资源，并且每个任务调度器只会最大化自己的利益，造成全局资源的使用平衡。</li>
<li>共享状态：共享状态调度器，它通过在每个任务调度器中保存一份整个集群状态信息的副本，从而实现全局调度，如Omega的实现。</li>
</ul>
<p>通常的调度流程分为两层：第一层是主机过滤，第二层是主机打分，当服务器达到一定规模后，过滤和打分将会耗费很多时间，优化的方式通常包括：分区调度（将主机划分成多个集群，每次调度只针对集群）、并行调度（将调度算法并行化处理，提高执行效率，并采用乐观锁和重试机制）。在资源混部的情况下，资源调度更加复杂：虚拟机和容器混部、流或批处理任务与常驻进程混部、多任务优先级QOS等。</p>
<h1>虚拟化与IaaS</h1>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="计算虚拟化">计算虚拟化<a href="https://lengrongfu.github.io/blog/%E8%AF%BB%E4%BA%91%E8%AE%A1%E7%AE%97%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF#%E8%AE%A1%E7%AE%97%E8%99%9A%E6%8B%9F%E5%8C%96" class="hash-link" aria-label="Direct link to 计算虚拟化" title="Direct link to 计算虚拟化">​</a></h2>
<p>计算虚拟化就是在虚拟系统和底层硬件之间抽象出CPU和内存等，以供虚拟机使用。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="网络虚拟化">网络虚拟化<a href="https://lengrongfu.github.io/blog/%E8%AF%BB%E4%BA%91%E8%AE%A1%E7%AE%97%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF#%E7%BD%91%E7%BB%9C%E8%99%9A%E6%8B%9F%E5%8C%96" class="hash-link" aria-label="Direct link to 网络虚拟化" title="Direct link to 网络虚拟化">​</a></h2>
<p>网络虚拟化是在物理网络拓扑基础之上建立的虚拟网络，它不依赖底层物理网络，能狗实现网络拓扑的动态变化，并且提供多租户隔离。
在网络虚拟化环境中，一切都可以自定义，首先是网络设备的虚拟化，虚拟交换机，虚拟路由器，虚拟负载均衡和虚拟防火墙。</p>
<ul>
<li>网卡虚拟化：通过SR-IOV技术可以实现一个物理网卡虚拟多个网卡，还可以通过tap/veth实现网卡虚拟化。</li>
<li>链路层虚拟化：主要通过虚拟交换机，实现网络包的VLAN设置、隧道建立等。</li>
<li>网络层虚拟化：包括VPN、Overlay网络等，创建一套隔离的三层网络。</li>
</ul>
<p>随着云计算和大数据的兴起，东西流量越来越多：</p>
<ul>
<li>南北流泪：从防火墙进入到目标服务器经过的流量。</li>
<li>东西流量：服务器和服务器之间的流量；比如分布式存储系统在服务之间进行数据复制会产生较多的东西流量。</li>
</ul>
<p>Linux收发包流程：
<img decoding="async" loading="lazy" alt="netfilter" src="https://lengrongfu.github.io/assets/images/netfilter-23e56d5d87761d44efdbe45c1833993a.jpeg" width="1476" height="749" class="img_ev3q"></p>
<p>网络模块<code>net_rx_action</code>会调用驱动将网络包转化为网络模块能够识别的SKB格式，然后经过<code>netfilter</code>后发送到用上层协议栈中。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="vlan">VLAN<a href="https://lengrongfu.github.io/blog/%E8%AF%BB%E4%BA%91%E8%AE%A1%E7%AE%97%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF#vlan" class="hash-link" aria-label="Direct link to VLAN" title="Direct link to VLAN">​</a></h3>
<p><code>VLAN</code>的中文名为虚拟局域网，VLAN的出现是为了解决二层链路中广播域的问题，传统的二层链路层广播访问太广，需要用三层路由来做lan切分隔离广播域，但是路由器的接口较少，因此在交换机上配置VLAN，使之一个交换机可以按需求配置多个LAN，来屏蔽广播域。</p>
<ul>
<li><a href="https://zhuanlan.zhihu.com/p/35616289" target="_blank" rel="noopener noreferrer">VLAN基础知识</a></li>
<li><a href="https://blog.csdn.net/weixin_40748006/article/details/80181493" target="_blank" rel="noopener noreferrer">VLAN详解</a></li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="存储虚拟化">存储虚拟化<a href="https://lengrongfu.github.io/blog/%E8%AF%BB%E4%BA%91%E8%AE%A1%E7%AE%97%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF#%E5%AD%98%E5%82%A8%E8%99%9A%E6%8B%9F%E5%8C%96" class="hash-link" aria-label="Direct link to 存储虚拟化" title="Direct link to 存储虚拟化">​</a></h2>
<p>存储虚拟化通过软件的方式重塑存储系统，不依赖具体的存储硬件。比如通常云存储所指的公有云提供的文件存储、块存储、对象存储都是通过存储虚拟化实现的。</p>
<p>存储分类：</p>
<ul>
<li>块存储：文件会被分块存储到磁盘，以磁盘方式提供。块存储都遵循SCSI协议，</li>
<li>文件存储：以文件目录的方式提供。网络文件系统NFS。</li>
<li>对象存储：以二进制对象的形式提供服务。</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="分布式存储">分布式存储<a href="https://lengrongfu.github.io/blog/%E8%AF%BB%E4%BA%91%E8%AE%A1%E7%AE%97%E9%82%A3%E4%BA%9B%E4%BA%8B%E5%84%BF#%E5%88%86%E5%B8%83%E5%BC%8F%E5%AD%98%E5%82%A8" class="hash-link" aria-label="Direct link to 分布式存储" title="Direct link to 分布式存储">​</a></h3>
<p><img decoding="async" loading="lazy" alt="dis" src="https://lengrongfu.github.io/assets/images/dis-storage-7aaa39b774f81427f5f5656b23b244c7.png" width="705" height="364" class="img_ev3q">
上图展示了分布式存储的总体架构，总体有有元数据管理节点和数据管理节点，要实现分布式系统，保证存储元数据模块的高可用。</p>
<p>分布式系统都不能违背CAP定理：</p>
<ul>
<li>C（Consistenncy）：一致性，指在分布式系统中多副本数据的一致性。</li>
<li>A（Avaliability）：可用性，这里指能够随时读写数据。</li>
<li>P（Partition tolerance）：即分区容错性，这里指能够容忍网络中断出现分区的情况。</li>
</ul>
<p>在一些要求不高的场景下，保证基本可用和弱一致即可，对应的是BASE理论L：</p>
<ul>
<li>B（Basically Avaliable）：基本可用</li>
<li>S（Soft State）：软状态</li>
<li>E（Eventual Consistency）最终一致。</li>
</ul>
<p>数据分布寻址问题，如何查找到文件在那个数据节点中，共有两种种方法：；</p>
<ul>
<li>在元数据中标示数据的分布，如HDFS中，NameNode保存了所有块的元数据；它的优点是：避免在添加节点时数据迁移，缺点是：需要额外维护一套元数据，并且元数据服务的可用性是个问题。可用通过采用Raft算法来解决元数据服务的可用性问题。</li>
<li>通过DHT算法计算得到数据的分布，如采用一致性Hash环算法，或者rados算法；它的优点是：不会存储元数据服务瓶颈和可用性问题，缺点是：在增减节点的时候，整个算法需要重新计算，导致大量数据重新分布，不仅影响集群性能，还可能造成集群暂时不可用。</li>
</ul>
<p>开源Ceph解决数据分布寻址使用的是CRUSH方案。</p>]]></content>
        <author>
            <name>Leng Student</name>
            <uri>https://github.com/lengrongfu</uri>
        </author>
        <category label="读书笔记" term="读书笔记"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Linux网络虚拟化:探索NetWork Namespace]]></title>
        <id>https://lengrongfu.github.io/blog/Linux-Network-Namespace</id>
        <link href="https://lengrongfu.github.io/blog/Linux-Network-Namespace"/>
        <updated>2022-05-12T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[NetWork Namespace 是 Linux 2.6 版本引入的，作用是隔离出一个独立的网络栈（包括设备、IP、路由表、端口、防火墙等），它能创建多个隔离的网络空间。]]></summary>
        <content type="html"><![CDATA[<p><code>NetWork Namespace</code> 是 <code>Linux 2.6</code> 版本引入的，作用是隔离出一个独立的网络栈（包括设备、IP、路由表、端口、防火墙等），它能创建多个隔离的网络空间。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="network-namespace简介">NetWork Namespace简介<a href="https://lengrongfu.github.io/blog/Linux-Network-Namespace#network-namespace%E7%AE%80%E4%BB%8B" class="hash-link" aria-label="Direct link to NetWork Namespace简介" title="Direct link to NetWork Namespace简介">​</a></h2>
<p><code>NetWork Namespace</code> 是 <code>Linux 2.6</code> 版本引入的，作用是隔离出一个独立的网络栈（包括设备、IP、路由表、端口、防火墙等），它能创建多个隔离的网络空间。</p>
<p>在<code>Linux</code>系统上，我们可以使用<code>ip</code>命令来创建和管理<code>Network namespace</code>。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="ip-netns-命令手册">ip netns 命令手册<a href="https://lengrongfu.github.io/blog/Linux-Network-Namespace#ip-netns-%E5%91%BD%E4%BB%A4%E6%89%8B%E5%86%8C" class="hash-link" aria-label="Direct link to ip netns 命令手册" title="Direct link to ip netns 命令手册">​</a></h3>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SYNOPSIS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ip netns [ list ]：列出所有的network namespace</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ip netns add NETNSNAME：添加一个新的ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ip [-all] netns del [ NETNSNAME ]：删除所有或者指定的ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ip netns set NETNSNAME NETNSID：修改netnsname或者netnsid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ip netns identify [ PID ]：把某个进程加入到network namespace中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ip netns pids NETNSNAME：列出加入当前ns的pid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ip [-all] netns exec [ NETNSNAME ] command...：在netns中执行命令，如ping、ifconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       ip netns monitor：监控</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>按照操作手册中的命令就可以创建 <code>ns</code>.</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="管理network-namespace">管理Network Namespace<a href="https://lengrongfu.github.io/blog/Linux-Network-Namespace#%E7%AE%A1%E7%90%86network-namespace" class="hash-link" aria-label="Direct link to 管理Network Namespace" title="Direct link to 管理Network Namespace">​</a></h3>
<ul>
<li>创建NS</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns add nets1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nets1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>查看NS中的网络信息</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets1 ip link list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1: lo: &lt;LOOPBACK&gt; mtu 65536 qdisc noop state DOWN mode DEFAULT group default qlen 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets1 route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kernel IP routing table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets1 iptables -L</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Chain INPUT (policy ACCEPT)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">target     prot opt source               destination         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Chain FORWARD (policy ACCEPT)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">target     prot opt source               destination         </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Chain OUTPUT (policy ACCEPT)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">target     prot opt source               destination</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>从结果来看，创建的<code>nets1</code>网络栈中只有<code>lo</code>这个未启用的回环设备，并且没有配置路由和防火墙规则等。</p>
<ul>
<li>创建一个网络设备并配置IP</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 创建veth pair虚拟网络设备网卡</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建一个veth0和veth1的veth 对，把veth1插入到nets1的网络栈中，veth0默认在跟network namespace中。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link add  veth0 type veth peer name veth1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link set veth1 netns nets1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 此时查看就发现多了一个网络设备veth1，但是设备没有启动，并且没有配置IP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets1 ip link list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1: lo: &lt;LOOPBACK&gt; mtu 65536 qdisc noop state DOWN mode DEFAULT group default qlen 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">9: veth1@if10: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    link/ether aa:54:ee:12:3a:34 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 启用网卡，并设置ip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets1 ifconfig veth1 10.1.1.1/24 up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets1 ifconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">veth1: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inet 10.1.1.1  netmask 255.255.255.0  broadcast 10.1.1.255</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ether aa:54:ee:12:3a:34  txqueuelen 1000  (Ethernet)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RX packets 0  bytes 0 (0.0 B)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RX errors 0  dropped 0  overruns 0  frame 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TX packets 0  bytes 0 (0.0 B)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>删除veth对和ns</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># veth对是一个整体，删除veth0，veth1也就不存在。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link del veth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns del nets1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="单主机两个-network-namespace-之间通信">单主机两个 NetWork Namespace 之间通信<a href="https://lengrongfu.github.io/blog/Linux-Network-Namespace#%E5%8D%95%E4%B8%BB%E6%9C%BA%E4%B8%A4%E4%B8%AA-network-namespace-%E4%B9%8B%E9%97%B4%E9%80%9A%E4%BF%A1" class="hash-link" aria-label="Direct link to 单主机两个 NetWork Namespace 之间通信" title="Direct link to 单主机两个 NetWork Namespace 之间通信">​</a></h2>
<p><img decoding="async" loading="lazy" alt="veth1" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAeMAAADJCAIAAACfVc2LAAAAAXNSR0IArs4c6QAAAJBlWElmTU0AKgAAAAgABgEGAAMAAAABAAIAAAESAAMAAAABAAEAAAEaAAUAAAABAAAAVgEbAAUAAAABAAAAXgEoAAMAAAABAAIAAIdpAAQAAAABAAAAZgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAAeOgAwAEAAAAAQAAAMkAAAAAaRpUAwAAAAlwSFlzAAALEwAACxMBAJqcGAAAAgtpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpSZXNvbHV0aW9uVW5pdD4yPC90aWZmOlJlc29sdXRpb25Vbml0PgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICAgICA8dGlmZjpDb21wcmVzc2lvbj41PC90aWZmOkNvbXByZXNzaW9uPgogICAgICAgICA8dGlmZjpQaG90b21ldHJpY0ludGVycHJldGF0aW9uPjI8L3RpZmY6UGhvdG9tZXRyaWNJbnRlcnByZXRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CtQK6igAABbVSURBVHgB7d17lE31/8fxGZcQFnL5IneKkkouFSktJIxcVmWJ6LbSCmH9VFau00XLj8hCkUVuqxWyqq9RCLnlOqWLW+6Ma7mNCU2Y+b2aXXvNzxnjzDmfz9n7zDzPH2ftvc9nvz/7PPY+L9tn7zMnNj09PYYHAggggICPBQpo2+Lj4328hWwaAgggkNcF/k5qPeLi4pwJnhFAAAEEfCWQkJCQz1cbxMYggAACCAQKkNSBJixBAAEE/CVAUvtrf7A1CCCAQKAASR1owhIEEEDAXwIktb/2B1uDAAIIBAqQ1IEmLEEAAQT8JUBS+2t/sDUIIIBAoABJHWjCEgQQQMBfAiS1v/YHW4MAAggECpDUgSYsQQABBPwlQFL7a3+wNQgggECgAEkdaMISBBBAwF8CJLW/9gdbgwACCAQKkNSBJixBAAEE/CVAUvtrf7A1CCCAQKAASR1owhIEEEDAXwIktb/2B1uDAAIIBAqQ1IEmLEEAAQT8JUBS+2t/sDUIIIBAoABJHWjCEgQQQMBfAiS1v/YHW4MAAggECpDUgSYsQQABBPwlQFL7a3+wNQgggECgAEkdaMISBBBAwF8CJLW/9gdbgwACCAQKkNSBJixBAAEE/CVAUvtrf7A1CCCAQKAASR1owhIEEEDAXwIktb/2B1uDAAIIBAqQ1IEmLEEAAQT8JUBS29of58+fX758+YkTJ4LsYNOmTS1btgy+fZBlaYZA8Ifihg0bXnnllbi4uG7dun344YcXLlxAzycCJLWtHXHgwIHXX3/9559/DqaDpKSkMWPGnD17Ni0tLZj2tEEgeIEgD8WVK1f26dPn0KFDOmMoVarUtGnTBg0alJ6eHnxHtLQnUMBeaSoHI7B27dr33ntPSR1MY9ogYE9g8uTJCuiZM2eWKFFCvQwdOvTrr78+ePBgtWrV7HVK5SAFSOrrQ/3xxx8vvfRSz549NUCxZs0azTZu3Hjw4MGlS5fWypodN27c+vXrU1NTGzZsqJbVq1efOnXq4sWL9eqECRNmz549a9asY8eOKZETExPVrFKlSj169Gjfvr0aqEjz5s01sXPnzs2bN2uCBwLXErB3KF66dGnv3r2dO3d2YlobcP/99yupdYpNUl9rd0RyOUl9fW2NSChG4+Pjy5Qp06ZNmx07dqxevfrGG298++23dXw/++yzR44ceeyxxwoUKLBw4cKffvppxowZyt8KFSrofEQnKQpu9TFw4MD9+/d36tSpePHiCnFVU17Xr1//toyHGsydO5ekvv7OyNst7B2Kd9xxh06ib731Vhd4165dmq5YsaK7hAkPBUjqYPGLFSs2Z84cPWuFLl26fP/995pYsGCB8nfixIn33XefZpXXOln+7LPPNN5Xu3ZtXZ/p3r17q1atLl68+Ouvv2r479VXX1Uz5fXTTz+9bds2JbVmeSCQIwFLh6KOXnczdNKgU4c6derUrFnTXciEhwJcUQwWv0WLFk5MawUl7Llz5zShA1rnyJcvX9Zwsx6//fZbuXLlVq1adVXRIkWK1KhRQ7eCjBgxQq9qdunSpQrxq5oxi0AwAlYPRZ226z+Fffv2LVmy5MiRI2NjY4PZJNrYFuCcOlhhZ1Taae0evhr3SElJ6d+/f+Yqyu7Ms8706NGjR40a9dVXXyUkJOTLl69Jkya6sF6+fPnAlixBIHsBe4fi0aNHNQaiEbymTZsOGzYsc0fZbxKv2hYgqUMUdu5e0qGsm1V12TBzFTfHMy+sWrXqBx98kJycvGXLFg1n68z6zTff1JLMbZhGIAQBU4eiTjteeOEFjdTpyGzbtm0IW8Iq9gQY/QjLVoPR+q6KolnXx/XQVUSdknzyySdXFd2zZ0/Hjh2XLVumC+u600M3gegyoxZe1YxZBEIWCP9Q1H/7FNO6bYmYDnkv2FuRc+qwbLt27aoLL71799bNeRp91k0duktkyJAhKqpZPS9ZskRf9NKhr2+16LstukWvcuXKurqo/2Y2atQorL5ZGYFMAmEeir///rsutOgOkO0ZD7fwgw8+qPuX3FkmvBIgqa8vr2FlNXKendaadmbLli07ZcoU/W9Rlwr10i233KK78XR2o+kqVaooizMuNK7t0KHD2LFj33nnneHDhzsVGjRooDuynWnn2SmYeQnTCFwl4BwkmQ8VTTuzYR6KOsNQX1szHpk71RdhSOrMIF5Nx2qQS/f26pv+Xm1B7uhX1xX//PNPfVqyeTuiPnXqlL68oNHtLK86ZrMuLyEQpACHYpBQUdRMtyF4cE6tXqPIiE3NkYAP/8nneMvRHoyuxj483iwBepDUGe/kn0EAS++Ksh4JxHvU73W6/XfM6TrNeDm6BOJ9erhZUeTeDyusFEUAAQQMCpDUBjEphQACCFgRIKmtsFIUAQQQMChAUhvEpBQCCCBgRYCktsJKUQQQQMCgAEltEJNSCCCAgBUBktoKK0URQAABgwIktUFMSiGAAAJWBEhqK6wURQABBAwKkNQGMSmFAAIIWBEgqa2wUhQBBBAwKEBSG8SkFAIIIGBFgKS2wkpRBBBAwKAASW0Qk1IIIICAFQGS2gorRRFAAAGDAiS1QUxKIYAAAlYESGorrBRFAAEEDAqQ1AYxKYUAAghYESCprbBSFAEEEDAoQFIbxKQUAgggYEWApLbCSlEEEEDAoABJbRCTUggggIAVAZLaCitFEUAAAYMCJLVBTEohgAACVgRIaiusFEUAAQQMCpDUBjEphQACCFgRIKmtsFIUAQQQMChAUhvEpBQCCCBgRYCktsJKUQQQQMCgAEltEJNSCCCAgBUBktoKK0URQAABgwIktUFMSiGAAAJWBEhqK6wURQABBAwKkNQGMSmFAAIIWBEgqa2wUhQBBBAwKEBSG8SkFAIIIGBFgKS2wkpRBBBAwKAASW0Qk1IIIICAFQGS2gorRRFAAAGDAiS1QUxKIYAAAlYESGorrBRFAAEEDAqQ1AYxKYUAAghYESCprbBSFAEEEDAoQFIbxKQUAgggYEWApLbCSlEEEEDAoABJbRCTUggggIAVAZLaCitFEUAAAYMCJLVBTEohgAACVgRIaiusFEUAAQQMCpDUBjEphQACCFgRIKmtsFIUAQQQMChAUhvEpBQCCCBgRYCktsJKUQQQQMCgAEltEJNSCCCAgBUBktoKK0URQAABgwIFDNbKJaXS42NiPXor6TExscM96ptuo0AgPv7vQ8SjDU0fPtyrrj16x37qlqQO2BuxMcNXrgxYGokF8c2bR6Ib+ohigVgOzijee2FsOqMfYeCxKgIIIBARAZI6Isx0ggACCIQhQFKHgceqCCCAQEQESOqIMNMJAgggEIYASR0GHqsigAACEREgqSPCTCcIIIBAGAK5KqlTU1O2b1+QnHzYAZk9u/WUKQ2vhXPo0Lo5c9qOG1ftww/vXrLkf7TutVqyHAEEwhdISUldsGD74cPJTqnWrWc3bDgl+7LLl+8rW/Z/3VWyb5y7X81VSX3y5M558x5PSlrn7LO0tCvp6Vey3H/Hjm2ZMeOho0cT69TpWLJk1fXrx376aacsW7IQAQSMCOzcefLxx+etW5fkVLtyJe3KFX2R55qPPXtO9ev39cmTF7Jvds31c9cLXn3zJd4O45GMsvNjYnZkTOyLibkYE5NFX2vXzleI9+z5+H/+UyomptR//3v4hx+WJyW9ULlyZTsbFnzVLLY2+JVpmaVAPKhZuuRwYZiMRzI+nfPnx+zI+HTu2xdz8WJMljV37dq1ePHi06dPOxv4/vsxJUvmcFtzXXMPkjouLi4YxuHDhx85cmTKlCn58+d32g8YMKBUqVLDhg3T7Ny5cz///POkpKTbb7+9c+fObdq0mTp16tKlS/XSunXrtm/fPmvWrEWLFiUnJ588eXLevHl6rl69+sCBAxs1aqQ248ePv/POO59//nmnco0aNXr06FG4cGFtW0JCgrPQk+cgcTzZtijtNDeR+ufgtPrx3LFjh/Op37lz5+bNm1u0aFGhQoUoPfxMbbZ/Rz+qVav2448/btmyxXmrBw8eXLNmTaVKlTQ7ceLE0aNHlylTpmvXrikpKUOHDtW/wKVLl3Z2p9JcyeuspX+clfVNmzZt166dcv+11167cOFCamrqmTNnFNwuotP++PHj7hImEEAgGwF7H091etttt/XLeDRv3jybbchTL3lwTh2k76OPPjpp0qQVK1Y0bPj3VcFVq1bpuXXr1seOHZszZ07Hjh2HDBmiJb169XrmmWcmT578xRdf1K5de8OGDd27d2/VqpXbizL9gQce0OzNN9+sZrt3765atapmixUr5rbR2bT+DVeIu0uYQACBbATsfTzvuuuubPrNsy/595xaJ8h33333t99+m57+92WHlStX1qtXT2mrE+3Lly9rQHltxmPjxo01a9Y8fPjw3r17A/eiTrSdmNZLqqZnnYPHxsZq4sqV/3exMS0tzekosAhLEEDgKgF7H8+rOmLWEfDvObW2T6PP77777rZt23RY/PLLLxpl1kINYuh5woQJzhtwn0+dOlW0aFF31plQUrtLnIBWHBcsWFALNQbivqRpLS9UqJC7hAkEEMhewNLHM/tO8+yrvk7qli1bauxCAyA6g1bOOmMaTviOGTNGI2WZd1u5cuX279+fecm1pm/MeBw6dMhtoCuTmtbAt7uECQQQyF7A0scz+07z7Kv+Hf3QLilRooQuBiqpNfTRuHHjm266SQvr1Kmj5wMHDiipncfChQt1up0vXw7ei+4Y0Un6iRMnnB2/bNkyTdStW9eZ5RkBBK4rYO/jed2u82ADX59Ta3/of1iDBg3SMPSIESOc3aPrwkptXRvUkIUuPmzdulUXGHVRUVcFixQpojZLlizRtcEOHTo47bN87tSpU2Jiom4F0d0jOqGePXu2BljuvffeLBuzEAEEshSw9PHMsq88vtDvSd2sWTONPl+6dCnz/ToavNbj448/1qVFnWjrDryePXtqR1apUkW3SztXGq+V1M5ote4hUfpPnz7duYGkVq1a8fHxjFPn8Q8Dbz+nApY+nu5m5Og/yu5auXIiVlfSFFLR+O0AxbTugNbdIE74hrB7dPuH7vkrXry4/h/nrq4vF3j4A0jRuCNcOiZsC0TRwRn+x9M2ZhTV1373+zl1NpoFChRwvgiTTZvsX9I91GFWyL4+ryKQZwXC/3jmWbos33gUJ3WW78fIQn551ggjRWwIcHDaUPV/TZL66n0UzviD/senb73rO5A6obi6LvMIhC3AwRk2YbQWyMGdbdH6FiO43forJV26dPnhhx8i2CddIRCUAAdnUEx+bURSm9wz8+fP1+VNPZssSi0ETAhwcJpQ9KwGSW2M/vz587pBUPfSfPfdd5o2VpdCCIQtwMEZNqHHBUhqYztAX3R0/qiunr/55htjdSmEQNgCHJxhE3pcgKQ2tgM+/fTTi/oRC/3MzMWL+qEDY3UphEDYAhycYRN6XICkNrMD9I1H3fXh1tK0lrizTCDgoQAHp4f4promqc1I6ncMNELt1tK0fjzMnWUCAQ8FODg9xDfVNUltRnLGjBn6GwX6yyHOQ0k9c+ZMM6WpgkB4Ahyc4fn5Ym2+oGFmN+iv8elnOlVr5MiRb7zxhib0N//MlKYKAuEJcHCG5+eLtaP4LzT5wi9gI/Srj/p7qgGLWYCA9wIcnN7vg5C2QH+hidGPkORYCQEEEIigAEkdQWy6QgABBEISIKlDYmMlBBBAIIICJHUEsekKAQQQCEmApA6JjZUQQACBCAqQ1BHEpisEEEAgJAGSOiQ2VkIAAQQiKEBSRxCbrhBAAIGQBEjqkNhYCQEEEIigAEkdQWy6QgABBEISIKlDYmMlBBBAIIICJHUEsekKAQQQCEmApA6JjZUQQACBCAqQ1BHEpisEEEAgJAGSOiQ2VkIAAQQiKEBSRxCbrhBAAIGQBEjqkNhYCQEEEIigAEkdQWy6QgABBEISIKlDYmMlBBBAIIICJHUEsekKAQQQCEmApA6JjZUQQACBCAoUiGBfeaUr/QJ0XnmrvM9oE+DnyaNtj/2zvSS14R2XmJhouCLlEDAhwAmECUXPapDUntHTMQKRFOAcIpLaxvtinNo4KQURQAABwwIktWFQyiGAAALGBUhq46QURAABBAwLkNSGQSmHAAIIGBcgqY2TUhABBBAwLEBSGwalHAIIIGBcgKQ2TkpBBBBAwLAASW0YlHIIIICAcYF/vvmSkJBgvDQFEUAAAQSMCMSmp6cbKUQRBBBAAAFLAox+WIKlLAIIIGBMgKQ2RkkhBBBAwJIASW0JlrIIIICAMQGS2hglhRBAAAFLAiS1JVjKIoAAAsYESGpjlBRCAAEELAmQ1JZgKYsAAggYEyCpjVFSKBoFzp8/v2XLltTU1GjceLY57wiQ1HlnX+eSd1quXLkqVaokJydnfj8K3IIFC77//vuZFwYzvWTJknvuuScpKSmYxrRBwCsBktorefoNUeCvv/5SsPbv3z/z+mlpaZcvX+YLt5lNmM5NAiR1btqbeeW9lC1bdsaMGYsWLcorb5j3mecFSOo8fwhEIcBTTz318MMPv/jii2fOnMly8/fs2RMXF6dxEmV6mzZtduzY4TbTKt26dStfvnylSpX69eunM3H3JZ2Sjxw5sm7dukWLFm3QoMGkSZPcl5hAwFsBktpbf3oPRSBfvnzTpk3TULWiNnD93bt3N2zYcNu2bYMGDRo8ePDevXsbN268detWtVQuP/TQQ19++eXLL78cHx+va4kDBw50K/Tp00ftFeJvvfVWiRIl+vbtqwn3VSYQ8FJA5xE8EIgiAWXogAEDtMETJ07UJ0exq+lz585peuzYsZp+4okndHXxyJEjzps6efJk8eLF27Vrp1mNmajZ3LlznZd0y0fFihW1ROGuKNc/AL1793Ze0rNOvbXi2bNn3SVMIOCVAOfU+pzyiEoBnRdrDKRXr16nT5/O/AaWLVvWpEkTJ4K1vHTp0mq2fPlyXXVctWpV/vz5W7du7bS/4YYb3GmnwSOPPHLo30eLFi1SUlI2btyYuTjTCHgiQFJ7wk6nBgRiY2M1BqIw1aiFW05DIhqJbtasmbtEE5r9888/jx8/rptGateurbNy99XmzZs70wcOHNBEhw4dqv77eO6557Rk//79TgOeEfBQ4J/ffPFwC+gagZAFqlevPmrUKCW1e2qs8YrChQtnvoSo4prVyIZOrnWBcd26dZcuXdLwiNOpxj2cCV1+1MTq1atV01niPGutzLNMI+CJAOfUnrDTqTEBjYHovFhX/5yKSuT69etrKMO9qUMDi0uXLtUdHYUKFapXr96FCxcSExPd7lesWOFM6yVNrF+/XveEOA/9ZJ2uTB49etRtzAQCXgmQ1F7J068ZAY2BTJ8+XWPQbjnd1KHLgE8++aRu/9DZtC4MHj58eMSIEWqgG/t00q2h7U2bNumSo1rqFNtZsW3btrozb9y4cbpNWyMhH330kW4d0R1+NWvWdCszgYBnAl5dyqRfBEITcO/9yLy6cx+Ivk3uLJw/f747alGyZMlZs2a5jZXR7viGzp3Hjx+vz57u5FMDXUrUVUT3o9i+ffsTJ064KzKBgIcC/OKt+8FkIlcJ6EO1b98+nWvXqlVL591XvTeFsr6VrpeuWq5ZXZDUVUSlealSpQJfZQkCngiQ1J6w0ykCCCCQAwHGqXOARVMEEEDAEwGS2hN2OkUAAQRyIEBS5wCLpggggIAnAiS1J+x0igACCORAgKTOARZNEUAAAU8ESGpP2OkUAQQQyIEASZ0DLJoigAACngiQ1J6w0ykCCCCQA4H/A2TkrncU392uAAAAAElFTkSuQmCC" width="483" height="201" class="img_ev3q"></p>
<p>主机上创建两个<code>ns</code>，它们之间如何通信呢，可以使用<code>veth pair</code>进行连接。</p>
<ul>
<li>创建两个<code>ns</code></li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#创建两个ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns add nets1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns add nets2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建veth，并分别插入ns中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link add veth0 type veth peer name veth1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link set veth0 netns nets1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link set veth1 netns nets2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>配置两个veth网络设备</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets2 ifconfig veth1 10.1.1.2/24 up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets1 ifconfig veth0 10.1.1.1/24 up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 检查是否配置成功</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets1 ifconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">veth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inet 10.1.1.1  netmask 255.255.255.0  broadcast 10.1.1.255</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inet6 fe80::b4c2:70ff:fe8d:3b0e  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ether b6:c2:70:8d:3b:0e  txqueuelen 1000  (Ethernet)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RX packets 8  bytes 656 (656.0 B)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RX errors 0  dropped 0  overruns 0  frame 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TX packets 8  bytes 656 (656.0 B)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets2 ifconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">veth1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inet 10.1.1.2  netmask 255.255.255.0  broadcast 10.1.1.255</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inet6 fe80::f046:44ff:fe62:1ecc  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ether f2:46:44:62:1e:cc  txqueuelen 1000  (Ethernet)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RX packets 9  bytes 726 (726.0 B)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RX errors 0  dropped 0  overruns 0  frame 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TX packets 9  bytes 726 (726.0 B)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>测试网络</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 从nets1 ping nets2网络是通的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets1 ping 10.1.1.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PING 10.1.1.2 (10.1.1.2) 56(84) bytes of data.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 10.1.1.2: icmp_seq=1 ttl=64 time=0.106 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 10.1.1.2: icmp_seq=2 ttl=64 time=0.079 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 10.1.1.2: icmp_seq=3 ttl=64 time=0.083 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 从nets2 ping nets1 网络是通的</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets2 ping 10.1.1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PING 10.1.1.1 (10.1.1.1) 56(84) bytes of data.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 10.1.1.1: icmp_seq=1 ttl=64 time=0.108 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 10.1.1.1: icmp_seq=2 ttl=64 time=0.085 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 10.1.1.1: icmp_seq=3 ttl=64 time=0.078 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="单主机多个-network-namespace-之间通信">单主机多个 NetWork Namespace 之间通信<a href="https://lengrongfu.github.io/blog/Linux-Network-Namespace#%E5%8D%95%E4%B8%BB%E6%9C%BA%E5%A4%9A%E4%B8%AA-network-namespace-%E4%B9%8B%E9%97%B4%E9%80%9A%E4%BF%A1" class="hash-link" aria-label="Direct link to 单主机多个 NetWork Namespace 之间通信" title="Direct link to 单主机多个 NetWork Namespace 之间通信">​</a></h2>
<p><img decoding="async" loading="lazy" alt="bridge" src="https://lengrongfu.github.io/assets/images/bridge-fc2ae5550a1d11c81f5f337691607b6d.png" width="640" height="252" class="img_ev3q"></p>
<p>上述是两个<code>ns</code>可以采用直接<code>veth</code>的模式进行通信，就好比采用一根网线，连接两台电脑，如果出现3台电脑需要通信，此时就不能再通过拉取网线的新式了，在物理网络中是采用交换机来处理这种问题。</p>
<p>在虚拟网络中通常用<code>Linux bridge</code>, <code>Linux Bridge</code>可以连接任意真实的物理设备（如：eth0网卡）或任意虚拟设备（如：veth pair设备，tap设备）。</p>
<ul>
<li>创建一个bridge</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link add name br0 type bridge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link set br0 up</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>创建三个ns</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 创建3个ns</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns add nets1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns add nets2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns add nets3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建3对veth pair</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link add type veth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link add type veth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link add type veth</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>把br0和3个ns版定</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 把veth1、veth3、veth5分别插入nets1、nets2、nets3中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link set veth1 netns nets1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link set veth3 netns nets2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link set veth5 netns nets3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 把veth0、veth2、veth4插入br0中</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link set dev veth0 master br0 up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link set dev veth2 master br0 up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip link set dev veth4 master br0 up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 设置三个ip给veth1、veth3、veth5设备并启用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets1 ifconfig veth1 10.1.1.1/24 up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets2 ifconfig veth3 10.1.1.2/24 up</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets3 ifconfig veth5 10.1.1.3/24 up</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>进过上述配置之后呢就把这三个ns通过br0这个桥绑定上了，就可以做到两两任意访问了。</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets1 ping 10.1.1.2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PING 10.1.1.2 (10.1.1.2) 56(84) bytes of data.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 10.1.1.2: icmp_seq=1 ttl=64 time=0.138 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 10.1.1.2: icmp_seq=2 ttl=64 time=0.172 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 10.1.1.2: icmp_seq=3 ttl=64 time=0.138 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@k8s-master-168 ~]# ip netns exec nets1 ping 10.1.1.3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PING 10.1.1.3 (10.1.1.3) 56(84) bytes of data.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 10.1.1.3: icmp_seq=1 ttl=64 time=0.149 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 10.1.1.3: icmp_seq=2 ttl=64 time=0.114 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">64 bytes from 10.1.1.3: icmp_seq=3 ttl=64 time=0.130 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="跨主机多个-network-namespace-之间通信">跨主机多个 NetWork Namespace 之间通信<a href="https://lengrongfu.github.io/blog/Linux-Network-Namespace#%E8%B7%A8%E4%B8%BB%E6%9C%BA%E5%A4%9A%E4%B8%AA-network-namespace-%E4%B9%8B%E9%97%B4%E9%80%9A%E4%BF%A1" class="hash-link" aria-label="Direct link to 跨主机多个 NetWork Namespace 之间通信" title="Direct link to 跨主机多个 NetWork Namespace 之间通信">​</a></h2>
<p>跨主机网络通信涉及到需要通过<code>vxlan</code>、<code>macvlan</code>、<code>ipvlan</code>等技术进行跨主机组网，</p>]]></content>
        <author>
            <name>Leng Student</name>
            <uri>https://github.com/lengrongfu</uri>
        </author>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="Kubernetes Network" term="Kubernetes Network"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Kubernetes网络之CNI规范解读]]></title>
        <id>https://lengrongfu.github.io/blog/k8s之CNI规范解读</id>
        <link href="https://lengrongfu.github.io/blog/k8s之CNI规范解读"/>
        <updated>2022-05-11T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[容器网络接口（Container Network Interface），简称 CNI，是 CNCF 旗下的一个项目，由一组用于配置 Linux 容器的网络接口的规范和库组成，同时还包含了一些插件。CNI 仅关心容器创建时的网络分配，和当容器被删除时释放网络资源。]]></summary>
        <content type="html"><![CDATA[<p>容器网络接口（Container Network Interface），简称 CNI，是 CNCF 旗下的一个项目，由一组用于配置 Linux 容器的网络接口的规范和库组成，同时还包含了一些插件。CNI 仅关心容器创建时的网络分配，和当容器被删除时释放网络资源。</p>
<p><img decoding="async" loading="lazy" alt="image" src="https://lengrongfu.github.io/assets/images/cni-horizontal-color-b8776810d383699b9fd709a9163613fc.png" width="1627" height="632" class="img_ev3q"></p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="cni-简介">CNI 简介<a href="https://lengrongfu.github.io/blog/k8s%E4%B9%8BCNI%E8%A7%84%E8%8C%83%E8%A7%A3%E8%AF%BB#cni-%E7%AE%80%E4%BB%8B" class="hash-link" aria-label="Direct link to CNI 简介" title="Direct link to CNI 简介">​</a></h2>
<p>容器网络接口（Container Network Interface），简称 CNI，是 CNCF 旗下的一个项目，由一组用于配置 Linux 容器的网络接口的规范和库组成，同时还包含了一些插件。CNI 仅关心容器创建时的网络分配，和当容器被删除时释放网络资源。</p>
<p>使用CNI的容器运行时有：</p>
<ul>
<li>Kubernetes</li>
<li>ContainerD</li>
<li>Mesos</li>
<li>Cloud Foundry</li>
<li>OpenShift</li>
</ul>
<p>实现了CNI规范的网络插件有：</p>
<ul>
<li>Flannel</li>
<li>Calico</li>
<li>Weave</li>
<li>Cilium</li>
<li><a href="https://www.cni.dev/docs/#3rd-party-plugins" target="_blank" rel="noopener noreferrer">等等</a></li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="cni插件">CNI插件<a href="https://lengrongfu.github.io/blog/k8s%E4%B9%8BCNI%E8%A7%84%E8%8C%83%E8%A7%A3%E8%AF%BB#cni%E6%8F%92%E4%BB%B6" class="hash-link" aria-label="Direct link to CNI插件" title="Direct link to CNI插件">​</a></h2>
<p>CNI 插件必须实现一个可执行文件，这个文件可以被容器管理系统（例如 rkt 或 Kubernetes）调用。</p>
<p>CNI 插件负责将网络接口插入容器网络命名空间（例如，veth 对的一端），并在主机上进行任何必要的改变（例如将 veth 的另一端连接到网桥）。然后将 IP 分配给接口，并通过调用适当的 IPAM 插件来设置与 “IP 地址管理” 部分一致的路由。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="cni规范">CNI规范<a href="https://lengrongfu.github.io/blog/k8s%E4%B9%8BCNI%E8%A7%84%E8%8C%83%E8%A7%A3%E8%AF%BB#cni%E8%A7%84%E8%8C%83" class="hash-link" aria-label="Direct link to CNI规范" title="Direct link to CNI规范">​</a></h2>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1-cni定义规范版本用来控制版本兼容性问题但是版本不是一尘不变的">1. CNI定义规范版本，用来控制版本兼容性问题，但是版本不是一尘不变的。<a href="https://lengrongfu.github.io/blog/k8s%E4%B9%8BCNI%E8%A7%84%E8%8C%83%E8%A7%A3%E8%AF%BB#1-cni%E5%AE%9A%E4%B9%89%E8%A7%84%E8%8C%83%E7%89%88%E6%9C%AC%E7%94%A8%E6%9D%A5%E6%8E%A7%E5%88%B6%E7%89%88%E6%9C%AC%E5%85%BC%E5%AE%B9%E6%80%A7%E9%97%AE%E9%A2%98%E4%BD%86%E6%98%AF%E7%89%88%E6%9C%AC%E4%B8%8D%E6%98%AF%E4%B8%80%E5%B0%98%E4%B8%8D%E5%8F%98%E7%9A%84" class="hash-link" aria-label="Direct link to 1. CNI定义规范版本，用来控制版本兼容性问题，但是版本不是一尘不变的。" title="Direct link to 1. CNI定义规范版本，用来控制版本兼容性问题，但是版本不是一尘不变的。">​</a></h5>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2-概念">2. 概念：<a href="https://lengrongfu.github.io/blog/k8s%E4%B9%8BCNI%E8%A7%84%E8%8C%83%E8%A7%A3%E8%AF%BB#2-%E6%A6%82%E5%BF%B5" class="hash-link" aria-label="Direct link to 2. 概念：" title="Direct link to 2. 概念：">​</a></h4>
<ul>
<li>容器是一个网络隔离域。</li>
<li>网络是指一组可以唯一寻址的端点，它们可以相互通信。</li>
<li>Container Runtime是负责执行CNI插件的地方。</li>
<li>Plugin是指网络配置的程序。</li>
</ul>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3-规范">3. 规范<a href="https://lengrongfu.github.io/blog/k8s%E4%B9%8BCNI%E8%A7%84%E8%8C%83%E8%A7%A3%E8%AF%BB#3-%E8%A7%84%E8%8C%83" class="hash-link" aria-label="Direct link to 3. 规范" title="Direct link to 3. 规范">​</a></h4>
<p>CNI规范定义了5点：</p>
<ul>
<li>
<ol>
<li>系统管理员去定义网络配置的格式。</li>
</ol>
</li>
<li>
<ol start="2">
<li>Container Runtime向网络插件发起请求的协议。</li>
</ol>
</li>
<li>
<ol start="3">
<li>基于系统管理员提供的配置执行插件，由第2步发起调用。</li>
</ol>
</li>
<li>
<ol start="4">
<li>CNI插件会将功能委托给其他插件。</li>
</ol>
</li>
<li>
<ol start="5">
<li>插件返回result到container runtime的数据类型。</li>
</ol>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="CNI Arch" src="https://lengrongfu.github.io/assets/images/cni-67a136be6b09bc7facbb9aa3eafc1b6e.png" width="650" height="305" class="img_ev3q"></p>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="31-网络配置">3.1 网络配置<a href="https://lengrongfu.github.io/blog/k8s%E4%B9%8BCNI%E8%A7%84%E8%8C%83%E8%A7%A3%E8%AF%BB#31-%E7%BD%91%E7%BB%9C%E9%85%8D%E7%BD%AE" class="hash-link" aria-label="Direct link to 3.1 网络配置" title="Direct link to 3.1 网络配置">​</a></h5>
<p>网络配置是具有如下字段的json格式：</p>
<ul>
<li><code>cniVersion</code>: 指定CNI规范的版本。</li>
<li><code>Name</code>: 网络名字，这在主机的网络配置中应该唯一。</li>
<li><code>disableCheck</code>: 是否禁用检查网络，如果为true,则 <code>container runtime</code> 不会调用 Check 方法进行网络检查。</li>
<li><code>plugin</code>: cni插件及其配置列表，可以配置多个插件。</li>
</ul>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="32-执行协议">3.2 执行协议<a href="https://lengrongfu.github.io/blog/k8s%E4%B9%8BCNI%E8%A7%84%E8%8C%83%E8%A7%A3%E8%AF%BB#32-%E6%89%A7%E8%A1%8C%E5%8D%8F%E8%AE%AE" class="hash-link" aria-label="Direct link to 3.2 执行协议" title="Direct link to 3.2 执行协议">​</a></h5>
<p>CNI协议基于容器运行时调用插件二进制程序。CNI程序逻辑本身被封装在了<code>libcni</code>中，会被其他容器运行时调用。在<code>libcni</code>中总共暴露了 4 个核心方法：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> CNI </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 添加网络</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">AddNetwork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> net </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">NetworkConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rt </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">RuntimeConf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 检查网络</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">CheckNetwork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> net </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">NetworkConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rt </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">RuntimeConf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 删除网络</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">DelNetwork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> net </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">NetworkConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rt </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">RuntimeConf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 获取网络缓存结果</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">GetNetworkCachedResult</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">net </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">NetworkConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rt </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">RuntimeConf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">types</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Result</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 获取网络缓存配置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">GetNetworkCachedConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">net </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">NetworkConfig</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rt </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">RuntimeConf</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">byte</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">RuntimeConf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 校验网络</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">ValidateNetwork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> net </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">NetworkConfig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>CNI</code>插件负责以某种方式配置容器的网络接口，通过标准输入提供配置，标准输出上返回结果，标准错误上返回error。</p>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="33-cni操作">3.3 CNI操作<a href="https://lengrongfu.github.io/blog/k8s%E4%B9%8BCNI%E8%A7%84%E8%8C%83%E8%A7%A3%E8%AF%BB#33-cni%E6%93%8D%E4%BD%9C" class="hash-link" aria-label="Direct link to 3.3 CNI操作" title="Direct link to 3.3 CNI操作">​</a></h5>
<p>CNI插件定义了4个操作：ADD、DEL、CHECK、Version。</p>
<ol>
<li>ADD：添加容器到网络中，插件收到ADD命令执行如下步骤；不支持多次调用。</li>
</ol>
<ul>
<li>在CNI_NETNS的容器中创建CNI_IFNAME的接口。</li>
<li>调整CNI_NETNS容器内CNI_IFNAME的配置。</li>
</ul>
<ol start="2">
<li>DEL：从容器中删除网络，插件收到DEL命令执行如下步骤；支持多次调用。</li>
</ol>
<ul>
<li>删除CNI_NETNS容器内的CNI_IFNAME定义的接口。</li>
<li>撤销插件ADD功能中应用的修改。</li>
</ul>
<ol start="3">
<li>
<p>Check：检查容器的网络是否符合预期。</p>
</li>
<li>
<p>Version：探测CNI插件版本是否支持。</p>
</li>
</ol>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="cni-plugin-项目">CNI Plugin 项目<a href="https://lengrongfu.github.io/blog/k8s%E4%B9%8BCNI%E8%A7%84%E8%8C%83%E8%A7%A3%E8%AF%BB#cni-plugin-%E9%A1%B9%E7%9B%AE" class="hash-link" aria-label="Direct link to CNI Plugin 项目" title="Direct link to CNI Plugin 项目">​</a></h2>
<p>Plugin中提供了3个维度的插件，一个是main，用户创建网络接口的插件，一个ipam，用于管理ip地址的插件，可以被main插件调用，一个meta插件，就是其它插件。</p>]]></content>
        <author>
            <name>Leng Student</name>
            <uri>https://github.com/lengrongfu</uri>
        </author>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="Kubernetes Network" term="Kubernetes Network"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Serverless 基础知识]]></title>
        <id>https://lengrongfu.github.io/blog/serverless基础知识</id>
        <link href="https://lengrongfu.github.io/blog/serverless基础知识"/>
        <updated>2022-03-01T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Serverless 是什么，它有什么优势，有什么限制，应该什么时候使用它.]]></summary>
        <content type="html"><![CDATA[<p>Serverless 是什么，它有什么优势，有什么限制，应该什么时候使用它.</p>
<p><img decoding="async" loading="lazy" alt="image" src="https://lengrongfu.github.io/assets/images/Serverless-architecture-preview-image-f096e15227130ce059ebeb266279303b.png" width="1440" height="500" class="img_ev3q"></p>
<p>Serverless 是什么，它有什么优势，有什么限制，应该什么时候使用它.</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="serverless-是什么">Serverless 是什么<a href="https://lengrongfu.github.io/blog/serverless%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86#serverless-%E6%98%AF%E4%BB%80%E4%B9%88" class="hash-link" aria-label="Direct link to Serverless 是什么" title="Direct link to Serverless 是什么">​</a></h2>
<p>无服务器架构是一种基于事件的软件设计模式，无需处理、供应和扩展服务器和数据库。这样，企业就可以通过第三方服务运行他们的应用程序，而无需投资物理或虚拟服务器。许多处理云服务的提供商处理计算、服务器管理、编码和动态分配资源的复杂性。</p>
<p>在无服务的发展过程中主要有两种模式：</p>
<ul>
<li>后端即服务（BaaS）</li>
<li>功能即服务（FaaS）</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="什么是-baas">什么是 BaaS<a href="https://lengrongfu.github.io/blog/serverless%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86#%E4%BB%80%E4%B9%88%E6%98%AF-baas" class="hash-link" aria-label="Direct link to 什么是 BaaS" title="Direct link to 什么是 BaaS">​</a></h3>
<p>后端即服务使开发人员能够专注于管理应用程序的前端，并让他们摆脱托管、云存储和数据库管理等后端开发任务。这样，他们就不必为服务器端活动（例如数据库管理、用户身份验证和加密）管理或编写代码。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="什么是-faas">什么是 FaaS<a href="https://lengrongfu.github.io/blog/serverless%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86#%E4%BB%80%E4%B9%88%E6%98%AF-faas" class="hash-link" aria-label="Direct link to 什么是 FaaS" title="Direct link to 什么是 FaaS">​</a></h3>
<p>功能即服务是一种事件驱动的执行模型，可以执行小代码模块。当应用程序模块中发生某些事件的执行时，它会触发函数。这带来了卓越的成本效率、资源的动态扩展和简化的流程。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="serverless-有什么优势">Serverless 有什么优势<a href="https://lengrongfu.github.io/blog/serverless%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86#serverless-%E6%9C%89%E4%BB%80%E4%B9%88%E4%BC%98%E5%8A%BF" class="hash-link" aria-label="Direct link to Serverless 有什么优势" title="Direct link to Serverless 有什么优势">​</a></h2>
<ul>
<li>您的开发人员现在可以专注于编写代码和优化应用程序设计。</li>
<li>您可以变得更加敏捷，获得创业创新，并拥有企业竞争优势。</li>
<li>由于无服务器架构将业务逻辑/代码作为函数执行，因此您不再需要手动管理基础架构。</li>
<li>具有成本效益的定价模式——按价值付费——消除了在管理内部架构方面进行大量投资的需要。</li>
<li>故障不会影响整个应用程序开发，因为基于事件的架构使应用程序模块彼此独立。</li>
<li>您可以更快地部署应用程序并在发布中变得更加灵活。除此之外，命令行界面还有助于在几分钟内部署代码。</li>
<li>它使您能够构建优雅、无缝的用户体验并满足客户的需求。</li>
<li>您可以按需和按使用情况扩展或缩小应用程序。</li>
<li>功能即服务架构使开发人员能够创建独立的、有目的的功能，例如 API 调用。</li>
<li>由于基于模块化、快速和较小的版本，它显着缩短了产品上市时间。</li>
<li>您无需担心基础架构的安全性，因为云提供商会维护它。</li>
<li>您的团队可以使用 AWS Lambda边缘等现代无服务器功能来改善延迟期。</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="serverless-有什么限制">Serverless 有什么限制<a href="https://lengrongfu.github.io/blog/serverless%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86#serverless-%E6%9C%89%E4%BB%80%E4%B9%88%E9%99%90%E5%88%B6" class="hash-link" aria-label="Direct link to Serverless 有什么限制" title="Direct link to Serverless 有什么限制">​</a></h2>
<ul>
<li>长时间运行的工作负载在无服务器上可能比专用服务器成本更高。</li>
<li>在执行函数时处理冷启动请求时，您可能会遇到延迟。但是，您可以通过发送定期请求以保持活动状态来解决此问题。</li>
<li>您将依赖于您的提供商来提供调试和监控工具，并且对平台架构和可用性的控制有限。</li>
<li>由于更多的功能，开发人员面临着越来越多的复杂性。忽略几个函数的粒度和它们之间的平衡会造成混乱。</li>
<li>由于无服务器架构中的小型模块，您可能会面临部署、版本控制和其他实施问题。这在对一组部署的功能进行集成测试时提出了挑战。</li>
<li>由于云提供商可以控制组件之间的交互，因此可能会影响系统的灵活性和定制化。</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="serverless-什么场景可以使用它">Serverless 什么场景可以使用它<a href="https://lengrongfu.github.io/blog/serverless%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86#serverless-%E4%BB%80%E4%B9%88%E5%9C%BA%E6%99%AF%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%E5%AE%83" class="hash-link" aria-label="Direct link to Serverless 什么场景可以使用它" title="Direct link to Serverless 什么场景可以使用它">​</a></h2>
<p>无服务器架构为敏捷工作环境、资源分配自动化、可扩展性、改进响应时间等未来业务目标奠定了基础。此外，您会看到物理基础设施的运营开销和配置减少，从而为您的投资带来价值。</p>
<p>以下是无服务器应用程序列表，展示了您可以在哪些地方将无服务器架构集成到您的业务中：</p>
<ul>
<li>构建高延迟的实时应用程序，例如多媒体应用程序，以执行内存的自动分配和复杂的数据处理</li>
<li>为了满足快速变化的开发需求、客户需求功能添加和其他复杂的可扩展性需求，为不可预测的工作负载提供服务。</li>
<li>动态调整图像大小或转码视频并简化不同设备的多媒体处理。</li>
<li>支持多语言服务集成，满足现代软件需求。</li>
<li>使用物联网获取精确的设备状态并处理智能设备应用程序。</li>
<li>建立安全的客户交付调度系统并帮助动态调整大小。</li>
</ul>]]></content>
        <author>
            <name>Leng Student</name>
            <uri>https://github.com/lengrongfu</uri>
        </author>
        <category label="Serveless" term="Serveless"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[gRPC 学习之-高级知识]]></title>
        <id>https://lengrongfu.github.io/blog/gRPC 学习之-高级知识</id>
        <link href="https://lengrongfu.github.io/blog/gRPC 学习之-高级知识"/>
        <updated>2022-01-01T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[gRPC 学习通信基础]]></summary>
        <content type="html"><![CDATA[<p>gRPC 学习通信基础</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="高级知识">高级知识<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E9%AB%98%E7%BA%A7%E7%9F%A5%E8%AF%86#%E9%AB%98%E7%BA%A7%E7%9F%A5%E8%AF%86" class="hash-link" aria-label="Direct link to 高级知识" title="Direct link to 高级知识">​</a></h2>
<p>之前的文章中记录了对 gRPC 的使用，但是都没有涉及底层的通信基础知识。这篇文章主要介绍 gRPC 的高级知识，涉及到 gRPC 的底层原理、</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="grpc-底层原理">gRPC 底层原理<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E9%AB%98%E7%BA%A7%E7%9F%A5%E8%AF%86#grpc-%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86" class="hash-link" aria-label="Direct link to gRPC 底层原理" title="Direct link to gRPC 底层原理">​</a></h3>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="grpc-超越基础知识">gRPC 超越基础知识<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E9%AB%98%E7%BA%A7%E7%9F%A5%E8%AF%86#grpc-%E8%B6%85%E8%B6%8A%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86" class="hash-link" aria-label="Direct link to gRPC 超越基础知识" title="Direct link to gRPC 超越基础知识">​</a></h3>
<p>这部分主要讲述在构建真正的gRPC应用时，对于需要增强它们的各种能力，比如：拦截gRPC的输入和输出、弹性处理网络延迟、处理错误、在服务和消费者之间共享元数据。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="拦截器">拦截器<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E9%AB%98%E7%BA%A7%E7%9F%A5%E8%AF%86#%E6%8B%A6%E6%88%AA%E5%99%A8" class="hash-link" aria-label="Direct link to 拦截器" title="Direct link to 拦截器">​</a></h4>
<p>在 <code>gRPC</code> 中，可以拦截 <code>gRPC</code> 的执行.来满足特定的需求，如日志、认证、性能度盐指标等，这会使用一种名为拦截器的扩展机制。它是 <code>gRPC</code> 核心扩展机制之一 ，在一些使用场呆中非常有用，比如日志、身份验证、授权、性能度盘指标、跟踪以及其他一些自定义错求.</p>
<p>根据所拦截的 <code>RPC</code> 调用类型，<code>gRPC</code> 拦截可以分为两类，对于一元<code>RPC</code>，使用一元拦截器，对于流<code>RPC</code>，使用流拦截器；这些拦截器既可以用在服务端也可以用在客户端。</p>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="服务端拦截器">服务端拦截器<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E9%AB%98%E7%BA%A7%E7%9F%A5%E8%AF%86#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8B%A6%E6%88%AA%E5%99%A8" class="hash-link" aria-label="Direct link to 服务端拦截器" title="Direct link to 服务端拦截器">​</a></h5>
<p>当客户端调用 gRPC服务的远程方法肘，通过使用服务器端拦截器，可以在执行远程方法 之前，执行一个通用的逻辑。</p>
<p><img decoding="async" loading="lazy" alt="grpc-server-intercepter" src="https://lengrongfu.github.io/assets/images/grpc-server-intercepter-f68440ad8d9a6174631a19af9d37f663.png" width="2294" height="1399" class="img_ev3q"></p>
<p>在服务器销， 一元拦截器拦截一元 RPC，梳拦iliV:ìI售出1拦截流 RPC. 下回来右一下服务器揣
一元拦敲器.</p>
<ul>
<li>一元拦截</li>
</ul>
<p>要实现这一点 ，需要先实现 <code>UnaryServerlnterceptor</code> 类型的函数， 并在创 <code>gRPC</code> 服务器端时将函数注册进来。 <code>UnaryServerlnterceptor</code> 是用于服务器端一元拦截的类型。函数定义类型如下。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> req </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> info 叫JnaryServerlnfo，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hand1er UnaryHand1er</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">re5p </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>例如：进行一元拦截，打印日志。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">orderUnaryServerlnterceptor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> req </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	info </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UnaryServerInfo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> handler grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UnaryHandler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"======= [Server Interceptor1 "</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> info</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FullMethod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	m</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"post proc mess: %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// 可以拦截修改返回内容</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> order</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ok </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Order</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> ok </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		order</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Price </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> order</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">省略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	s </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewServer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">UnaryInterceptor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">orderUnaryServerlnterceptor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RegisterOrderManagementServer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Serve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">listen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">panic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>流拦截</li>
</ul>
<p>服务器端流拦截器会拦截 <code>gRPC</code> 服务器所处理的所有流<code>RPC</code>。 流拦截器包括前置处理阶段和流操作拦截阶段。</p>
<p>要实现流拦截，需要实现<code>Streal'1Serverlnterceptor</code> 函数：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">srv </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ss grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServerStream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">info </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StreamServerInfo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">handler grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StreamHandler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>grpc.ServerStream</code> 的包装器可以拦截 <code>gRPC</code> 服务发送或接收到的数据，它实现了 <code>SendMsg</code> 函数和 <code>RecvMsg</code> 函数，这两个函数分别会在服务发送和接收 <code>RPC</code> 流消息的时候调用。</p>
<p>在流 <code>RPC</code> 进入服务前，可以通过 <code>grpc.ServeStream</code> 进行流的处理，再通过 <code>grpc.StreamHandler</code> 来进行调用。</p>
<p>例如：在 <code>OrderManager</code> 的流接口中先进行输入流的处理，再调用 <code>RPC</code>.</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> wrappedSteam </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServerStream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServerStream </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">wrappedSteam</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">w </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">wrappedSteam</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">RecvMsg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"=====RecvMSg==== %T"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> w</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServerStream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RecvMsg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">w </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">wrappedSteam</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SendMsg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"====SendMsg===="</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> w</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServerStream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SendMsg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">newWrappedStream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServerStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServerStream </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">wrappedSteam</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">orderServerStreamInterceptor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">srv </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ss grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServerStream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> info </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StreamServerInfo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> handler grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StreamHandler</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"===== [Server Steam Interceptor ]"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> info</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">FullMethod</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">handler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">srv</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">newWrappedStream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ss</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatalf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"RPC failed with error %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	s </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">NewServer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">StreamInterceptor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">orderServerStreamInterceptor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RegisterOrderManagementServer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> s</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Serve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">listen</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">panic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在流开始时会进入 <code>orderServerStreamInterceptor</code> 方法，流结束后才会推出，在流每次 <code>RecvMsg</code> 时会进入到流拦截的 <code>(w *wrappedSteam) RecvMsg</code> 方法中，<code>SendMsg</code> 同理。</p>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="客户端拦截器">客户端拦截器<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E9%AB%98%E7%BA%A7%E7%9F%A5%E8%AF%86#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%8B%A6%E6%88%AA%E5%99%A8" class="hash-link" aria-label="Direct link to 客户端拦截器" title="Direct link to 客户端拦截器">​</a></h5>
<p><img decoding="async" loading="lazy" alt="grpc-client-interceptor" src="https://lengrongfu.github.io/assets/images/grpc-client-interceptor-4ade8737b7230d0b2141eb661e0811ad.png" width="2328" height="1395" class="img_ev3q"></p>
<ul>
<li>一元拦截</li>
</ul>
<p>一元拦截的函数签名：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> UnaryClientInterceptor </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reply </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cc </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ClientConn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> invoker UnaryInvoker</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">CallOption</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>与服务端拦截一元拦截器一样，客户端一元拦截器也有不同的阶段。</p>
<p>例子：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">orderClientInterceptor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> apply </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cc </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClientConn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> invoker grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">UnaryInvoker</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallOption</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Method :"</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	start </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">invoker</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> req</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> apply</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"cost is [%d]ms"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Sub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">start</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Milliseconds</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Dial</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">address</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithInsecure</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithUnaryInterceptor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">orderClientInterceptor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>流拦截</li>
</ul>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> StreamClientInterceptor </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> desc </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">StreamDesc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cc </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">ClientConn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> streamer Streamer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">CallOption</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ClientStream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>例子：</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> wrappedSteam </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClientStream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">w </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">wrappedSteam</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">RecvMsg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"===== [ Client Stream Interceptor ] Receive a message (Type :%T) at %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> m</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RFC3339</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> w</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClientStream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">RecvMsg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">w </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">wrappedSteam</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SendMsg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m </span><span class="token keyword" style="color:#00009f">interface</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"===== [Client Stream Interceptor ] Send a message (Type :%T) at %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Now</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">time</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">RFC3339</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> w</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClientStream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SendMsg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">newWrappedStream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cs grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClientStream</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClientStream </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">wrappedSteam</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">cs</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">orderClientStreamInterceptor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> desc </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StreamDesc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cc </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClientConn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> streamer grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Streamer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts </span><span class="token operator" style="color:#393A34">...</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CallOption</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClientStream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"===== [Client Interceptor] "</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">method</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">streamer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> desc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cc</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> opts</span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">newWrappedStream</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	conn</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Dial</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">address</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithInsecure</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">WithStreamInterceptor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">orderClientStreamInterceptor</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>]]></content>
        <author>
            <name>Leng Student</name>
            <uri>https://github.com/lengrongfu</uri>
        </author>
        <category label="golang" term="golang"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[gRPC 学习之-中级知识]]></title>
        <id>https://lengrongfu.github.io/blog/gRPC 学习之-中级知识</id>
        <link href="https://lengrongfu.github.io/blog/gRPC 学习之-中级知识"/>
        <updated>2021-12-30T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[gRPC 学习通信模型]]></summary>
        <content type="html"><![CDATA[<p>gRPC 学习通信模型</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="中级知识">中级知识<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E4%B8%AD%E7%BA%A7%E7%9F%A5%E8%AF%86#%E4%B8%AD%E7%BA%A7%E7%9F%A5%E8%AF%86" class="hash-link" aria-label="Direct link to 中级知识" title="Direct link to 中级知识">​</a></h2>
<p>借助 gRPC 可以实现不同的进程间通信模式（也称RPC风格）；本章将讨论 gRPC 应用的四种通信模式，一元RPC、服务端流RPC、客户端流RPC、以及双向RPC。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一元rpc">一元RPC<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E4%B8%AD%E7%BA%A7%E7%9F%A5%E8%AF%86#%E4%B8%80%E5%85%83rpc" class="hash-link" aria-label="Direct link to 一元RPC" title="Direct link to 一元RPC">​</a></h3>
<p>一元RPC：一元RPC模式也被称为简单RPC模式，当客户端调用服务端的远程方法时，客户端发送请求到服务端并获得一个响应，与响应一起发送还有元数据。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="服务器端流-rppc-模式">服务器端流 RPPC 模式<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E4%B8%AD%E7%BA%A7%E7%9F%A5%E8%AF%86#%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%AB%AF%E6%B5%81-rppc-%E6%A8%A1%E5%BC%8F" class="hash-link" aria-label="Direct link to 服务器端流 RPPC 模式" title="Direct link to 服务器端流 RPPC 模式">​</a></h3>
<p>一元RPC模式：gRPC 服务器端和 gRPC 客户端在通信时始终只有一个请求和一个响应。
服务器端流 RPC 模式：gRPC 服务器端在接收到客户端的请求消息后，会发回一个响应序列（简单说就是会发回多个响应）。这种多个响应所组成的序列也被称为流。</p>
<p>例如：</p>
<blockquote>
<p>在 OrderManagement 服务中，假设需要实现一个订单搜索功能；利用服务器端流 gRPC 模式时 OrderManagement 服务不会将所有匹配的订单一次性的发送给客户端，而是在找到匹配的订单时，逐步将其发送出去。</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="grpc-server-stream" src="https://lengrongfu.github.io/assets/images/grpc-server-stream-0ac241830eca1af2a9dea3926b403dd0.png" width="1850" height="706" class="img_ev3q"></p>
<ul>
<li>grpc server</li>
</ul>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">SearchOrders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">searchQuery </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">wrappers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StringValue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">stream pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OrderManagement_SearchOrdersServer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> order </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> orderMap </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> order</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> itemStr </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> order</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Items </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">itemStr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> strings</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Contains</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">itemStr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> searchQuery</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token comment" style="color:#999988;font-style:italic">// Send the matching orders in a stream</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">order</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> fmt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Errorf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"error sending message to stream : %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Matching Order Found : "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>grpc clinet</li>
</ul>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    searchStream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> 	</span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SearchOrders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">wrappers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StringValue</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Google"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		searchOrder</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> searchStream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Recv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EOF </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"EOF"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Search Result : "</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> searchOrder</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上述就是 <code>gRPC</code> 服务器端流模式，服务在检索到订单时，通过以流的形式发送给客户端 <code>err := stream.Send(&amp;order)</code> ; 客户端在调用时，返回一个客户端流，它有一个 <code>Recv</code> 方法，调用客户端的 <code>Recv</code> 方法，可以逐个读取服务端写入的数据。当发现流结束时， <code>Recv</code> 会返回 <code>io.EOF</code>。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="客户端流-rpc-模式">客户端流 RPC 模式<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E4%B8%AD%E7%BA%A7%E7%9F%A5%E8%AF%86#%E5%AE%A2%E6%88%B7%E7%AB%AF%E6%B5%81-rpc-%E6%A8%A1%E5%BC%8F" class="hash-link" aria-label="Direct link to 客户端流 RPC 模式" title="Direct link to 客户端流 RPC 模式">​</a></h3>
<p>客户端流RPC模式：客户端会发起多个请求给服务端，而不再是单个请求，服务器端则会发送一个响应给客户端。但是，服务端不一定要等到从客户端接受到所有消息后才发送响应。</p>
<p>例如：</p>
<blockquote>
<p>在 OrderManagement 服务中希望添加 updateOrders 方法，从而更新一个订单集合。</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="grpc client stream" src="https://lengrongfu.github.io/assets/images/grpc-client-stream-0ec6aa42f48e68466ac8b76a758cde13.png" width="1868" height="724" class="img_ev3q"></p>
<ul>
<li>grpc server : 如下方法定义了一个服务端接收客户端流的方法</li>
</ul>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">UpdateOrders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stream pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OrderManagement_UpdateOrdersServer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	ordersStr </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Updated Order IDs : "</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		order</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Recv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EOF </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">// 客户端发送完流数据</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">SendAndClose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">wrappers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StringValue</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Orders processed "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> ordersStr</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// Update order</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		orderMap</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">order</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">order</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Order ID : %s - %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> order</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Updated"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		ordersStr </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> order</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Id </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">", "</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>grpc client</li>
</ul>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">省略</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// =========================================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Update Orders : Client streaming scenario</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	updOrder1 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Order</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"102"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Items</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"Google Pixel 3A"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Google Pixel Book"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Destination</span><span class="token punctuation" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"Mountain View, CA"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Price</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1100.00</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	updOrder2 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Order</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"103"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Items</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"Apple Watch S4"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Mac Book Pro"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"iPad Pro"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Destination</span><span class="token punctuation" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"San Jose, CA"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Price</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2800.00</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	updOrder3 </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Order</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"104"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Items</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">"Google Home Mini"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Google Nest Hub"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"iPad Mini"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Destination</span><span class="token punctuation" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"Mountain View, CA"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Price</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2200.00</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	updateStream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">UpdateOrders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatalf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%v.UpdateOrders(_) = _, %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Updating order 1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> updateStream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">updOrder1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatalf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%v.Send(%v) = %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updateStream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updOrder1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Updating order 2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> updateStream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">updOrder2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatalf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%v.Send(%v) = %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updateStream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updOrder2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Updating order 3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> updateStream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">updOrder3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatalf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%v.Send(%v) = %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updateStream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updOrder3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	updateRes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> updateStream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">CloseAndRecv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatalf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%v.CloseAndRecv() got error %v, want %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updateStream</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Update Orders Res : %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> updateRes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>客户端以流的形式发送<code>updateStream.Send(&amp;updOrder2)</code>给服务端，一旦所有消息都以流的形式发送出去，客户端就可以将流标记为已完成，并通过 <code>CloseAndRecv</code> 方法来读取服务端的响应。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="双向流-rpc-模式">双向流 RPC 模式<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E4%B8%AD%E7%BA%A7%E7%9F%A5%E8%AF%86#%E5%8F%8C%E5%90%91%E6%B5%81-rpc-%E6%A8%A1%E5%BC%8F" class="hash-link" aria-label="Direct link to 双向流 RPC 模式" title="Direct link to 双向流 RPC 模式">​</a></h3>
<p>双向流RPC模式：客户端以消息流的形式发送请求到服务器端，服务器端也以消息流的形式进行响应。调用必须由客户端发起，但在此之后，通信完全基于 gRPC 客户端和服务器端的应用程序逻辑。</p>
<p>例如：</p>
<blockquote>
<p>在 OrderManagement 服务中，假设需要一个订单处理功能，通过该功能，用户可以发送连续的订单集合，并根据投递地址对它们进行组合发货。</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="grpc-double-stream" src="https://lengrongfu.github.io/assets/images/grpc-double-stream-f63347d2fa5a77f302f28e1d06ed4609.png" width="1909" height="771" class="img_ev3q"></p>
<p>这个业务用例的关键步骤如下所示：</p>
<ul>
<li>每个订单以独立的 gRPC 消息的形式发送至服务器端。</li>
<li>每个发货组合可能会包含多个订单，它们应该被投递到相同的目的地。</li>
<li>订单是成批处理的，当达到指定的批次大小时，当前创建的所有发货组合都会被发送至客户端。</li>
<li>假设：流中有4个订单，其中有两个订单要发送至X，两个要发送至Y，则可以将其表示为：X、Y、X、Y。如果批次大小为3，那么所创建的订单发货组合会是[X，X],[Y],[Y]。</li>
</ul>
<p>gRpc Server：主要逻辑就是通过客户端发送过来的订单ID按照指定批次大小以及发货地址进行分组，再把分组后的信息返回给客户端。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> orderBatchSize </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ProcessOrders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stream pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OrderManagement_ProcessOrdersServer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	batchMarker </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> combinedShipmentMap </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CombinedShipment</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		orderId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Recv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Reading Proc order : %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> orderId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EOF </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">// 客户端发送关闭时，需要把服务端已经接收到的进行发送</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"EOF : %s"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> orderId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> shipment </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> combinedShipmentMap </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">shipment</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		destination </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> orderMap</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">orderId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Destination</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		shipment</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> found </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> combinedShipmentMap</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">destination</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> found </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			ord </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> orderMap</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">orderId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			shipment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OrdersList </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shipment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OrdersList</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ord</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			combinedShipmentMap</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">destination</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> shipment</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			comShip </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CombinedShipment</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"cmb - "</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">orderMap</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">orderId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Destination</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Status</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"Processed!"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			ord </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> orderMap</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">orderId</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetValue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			comShip</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OrdersList </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shipment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OrdersList</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">ord</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			combinedShipmentMap</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">destination</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> comShip</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">comShip</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OrdersList</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> comShip</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">GetId</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> batchMarker </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> orderBatchSize </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> comb </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">range</span><span class="token plain"> combinedShipmentMap </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Shipping : %v -&gt; %v"</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> comb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">comb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OrdersList</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> stream</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">comb</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			batchMarker </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			combinedShipmentMap </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">map</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CombinedShipment</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			batchMarker</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>gRpc Client：主要逻辑就是发送订单ID给服务端，之后开启 Go协程来读取服务端返回的消息。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// =========================================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Process Order : Bi-di streaming scenario</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	streamProcOrder</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ProcessOrders</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ctx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatalf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%v.ProcessOrders(_) = _, %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> streamProcOrder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">wrappers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StringValue</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"102"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatalf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%v.Send(%v) = %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"102"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> streamProcOrder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">wrappers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StringValue</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"103"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatalf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%v.Send(%v) = %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"103"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> streamProcOrder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">wrappers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StringValue</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"104"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatalf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%v.Send(%v) = %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"104"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> streamProcOrder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">wrappers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StringValue</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Value</span><span class="token punctuation" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">"101"</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatalf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"%v.Send(%v) = %v"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">"101"</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    channel </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">make</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">go</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">asncClientBidirectionalRPC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">streamProcOrder</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> channel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> streamProcOrder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">CloseSend</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Fatal</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">err</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	channel </span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">asncClientBidirectionalRPC</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">streamProcOrder pb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OrderManagement_ProcessOrdersClient</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c </span><span class="token keyword" style="color:#00009f">chan</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		combinedShipment</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> errProcOrder </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> streamProcOrder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Recv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> errProcOrder </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> io</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">EOF </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// 判断服务端流是否结束；服务端方法只要有return就意味着流结束流了，可能是因为正常结束，也可能是错误导致结束，总之只要return之后双向流就断开了。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		log</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"Combined shipment : "</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> combinedShipment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OrdersList</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">&lt;-</span><span class="token plain">c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在双向流中可以通过定义客户端流和服务端流的方式来实现，客户端和服务端都定义了 <code>Send</code> 和 <code>Recv</code> 方法。可以实现双向传输。</p>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 客户端流</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> OrderManagement_ProcessOrdersClient </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">Send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">wrappers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StringValue</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">Recv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">CombinedShipment</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ClientStream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// 服务端流</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> OrderManagement_ProcessOrdersServer </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">Send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">CombinedShipment</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">Recv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">wrappers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">StringValue</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	grpc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ServerStream</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>客户端可以并发读取和写入同一个流，输入流和输出流可以独立进行操作。</p>]]></content>
        <author>
            <name>Leng Student</name>
            <uri>https://github.com/lengrongfu</uri>
        </author>
        <category label="golang" term="golang"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[gRPC 学习之-初级知识]]></title>
        <id>https://lengrongfu.github.io/blog/gRPC 学习之-初级知识</id>
        <link href="https://lengrongfu.github.io/blog/gRPC 学习之-初级知识"/>
        <updated>2021-12-25T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[gRPC 学习之基本概念]]></summary>
        <content type="html"><![CDATA[<p>gRPC 学习之基本概念</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="初级知识">初级知识<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E5%88%9D%E7%BA%A7%E7%9F%A5%E8%AF%86#%E5%88%9D%E7%BA%A7%E7%9F%A5%E8%AF%86" class="hash-link" aria-label="Direct link to 初级知识" title="Direct link to 初级知识">​</a></h2>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1进程间通信">1、进程间通信<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E5%88%9D%E7%BA%A7%E7%9F%A5%E8%AF%86#1%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1" class="hash-link" aria-label="Direct link to 1、进程间通信" title="Direct link to 1、进程间通信">​</a></h3>
<ul>
<li>同步请求的响应风格</li>
<li>异步请求的事件驱动风格</li>
</ul>
<p>请求响应的风格最常见和传统的方式就是构建为RESTful 服务，但是，使用RESTful 服务来实现进程间通信显得过于笨重、低效并且容易出错。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2进程间通信技术的演进">2、进程间通信技术的演进<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E5%88%9D%E7%BA%A7%E7%9F%A5%E8%AF%86#2%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1%E6%8A%80%E6%9C%AF%E7%9A%84%E6%BC%94%E8%BF%9B" class="hash-link" aria-label="Direct link to 2、进程间通信技术的演进" title="Direct link to 2、进程间通信技术的演进">​</a></h3>
<ul>
<li>传统的RPC：</li>
</ul>
<blockquote>
<p>早期有一些流行的RPC实现，比如通用对象请求代理体系结构CORBA和 Java 的远程调用(remot method invocation, RMI)；但是，他们的实现极其复杂，因为他们是构建在TCP这样的通信协议之上。</p>
</blockquote>
<ul>
<li>SOAP</li>
</ul>
<blockquote>
<p>鉴于CORBA等传统RPC实现的局限性，简单对象访问协议（SOAP）就产生了，SOAP是面向服务的架构（SOA）中的标准通信技术，能够基于任意的底层通信协议进行通信，其中最常用的就是HTTP。</p>
</blockquote>
<ul>
<li>RESTFul</li>
</ul>
<blockquote>
<p>描述性状态迁移 (REST) 是面向资源的架构的基础，在这种架构中，需要将分布式应用程序建模为资源集合，访问这些资源的客户端可以变更这些资源的状态（创建、修改、删除）。RUST 的通用实现是 HTTP。</p>
<p>随着微服务的数量及其网络交互的激增，RESTFul 服务已经无法慢煮现代化的需求了，下面介绍 3 个主要的局限性：</p>
<ol>
<li>基于文本的低效消息协议：RESTFul 服务建立在基于文本的传输协议之上，并且会使用人类可读的文本格式，如 JSON。</li>
<li>应用程序之间缺乏强类型接口：越来越多的服务要通过网络进行交互，而且这些服务使用完全不同的语言来构建，缺乏明确定义和强类型的服务接口成了使用RESTFul 服务的主要障碍。</li>
<li>REST 架构风格难以强制实施：REST 架构风格有很多好的实践，只有遵循这些实践，才能构建出真正的 RESTFul 服务；但是，由于没有作为实现协议（如：HTTP）的一部分强制要求，因此，在实践阶段，这些实践难以实施。</li>
</ol>
</blockquote>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3grpc-的起源">3、gRPC 的起源<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E5%88%9D%E7%BA%A7%E7%9F%A5%E8%AF%86#3grpc-%E7%9A%84%E8%B5%B7%E6%BA%90" class="hash-link" aria-label="Direct link to 3、gRPC 的起源" title="Direct link to 3、gRPC 的起源">​</a></h3>
<p>来源于 Google 的 Stubby 的通用 RPC 框架。2015 年 Google 发布了 Stubby 的社区版本 gRPC 框架，并捐献给了 CNCF 社区。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="4grpc-的优势">4、gRPC 的优势<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E5%88%9D%E7%BA%A7%E7%9F%A5%E8%AF%86#4grpc-%E7%9A%84%E4%BC%98%E5%8A%BF" class="hash-link" aria-label="Direct link to 4、gRPC 的优势" title="Direct link to 4、gRPC 的优势">​</a></h3>
<ul>
<li>提供高效的进程间通信。</li>
</ul>
<blockquote>
<ol>
<li>gRPC 没有使用类似 JSON 、 XML 之类的文本传输协议，而是采用自定义的  <code>protocol buffers </code> 的二进制协议。</li>
<li>gRPC 在 HTTP/2 上实现了 protocol buffers 的协议。</li>
</ol>
</blockquote>
<ul>
<li>具有简单且定义良好的服务接口和模式</li>
</ul>
<blockquote>
<p>gRPC 为应用提供了必须先定义接口，才能去处理细节的要求，gRPC 为应用提供了简单但一致，可靠且可扩展的应用程序。</p>
<p>解决了类似 REST 模式需要遵循好的架构风格实践，才能构建出真正的 RESTFul 服务，但是 gRPC 自带类似的好的架构风格。</p>
</blockquote>
<ul>
<li>属于强类型</li>
</ul>
<blockquote>
<p>通过定义应用服务之间通信所使用的类型，对于其所产生的大多数运行时错误和互操作错误，可以通过静态类型来克服。</p>
</blockquote>
<ul>
<li>支持多语言</li>
</ul>
<blockquote>
<p>gRPC 支持多语言，基于 protocol buffers 定义的服务时语言中立的。</p>
</blockquote>
<ul>
<li>支持双工流</li>
</ul>
<blockquote>
<p>gRPC 客户端和服务端都提供了对流的原生支持。</p>
</blockquote>
<ul>
<li>具备内置的商业化特性</li>
</ul>
<blockquote>
<p>gRPC 提供了商业化特性的内置支持，如<strong>认证、加密、弹性、元数据交换、压缩、负载均衡、服务发现</strong>等。</p>
</blockquote>
<ul>
<li>与云原生系统进行了集成</li>
</ul>
<blockquote>
<p>gRPC 是 CNCF 的一部分，大多数框架和技术都对 gRPC 提供了原生的支持。</p>
<p>同时提供了丰富的应用性能监控工具。如 metrics、tracing、logging。</p>
</blockquote>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="5grpc-的劣势">5、gRPC 的劣势<a href="https://lengrongfu.github.io/blog/gRPC%20%E5%AD%A6%E4%B9%A0%E4%B9%8B-%E5%88%9D%E7%BA%A7%E7%9F%A5%E8%AF%86#5grpc-%E7%9A%84%E5%8A%A3%E5%8A%BF" class="hash-link" aria-label="Direct link to 5、gRPC 的劣势" title="Direct link to 5、gRPC 的劣势">​</a></h3>
<ul>
<li>gRPC 不太适合面向外部的服务</li>
</ul>
<blockquote>
<p>gRPC 服务具有契约精神、强类型等特点，会限制暴露外部服务的灵活性，同时消费者的控制权会削弱很多。gRPC 网关是克服该问题的解决方案。</p>
</blockquote>
<ul>
<li>大的服务变更是复杂的开发流程</li>
</ul>
<blockquote>
<p>gRPC 服务出现变更，需要重新生成客户端和服务端代码。</p>
</blockquote>
<ul>
<li>gRPC 系统相对较小</li>
</ul>
<blockquote>
<p>与 REST 和 HTTP 等协议相比，gRPC 的生态系统相对较小。</p>
</blockquote>]]></content>
        <author>
            <name>Leng Student</name>
            <uri>https://github.com/lengrongfu</uri>
        </author>
        <category label="golang" term="golang"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[技术写作 第二课]]></title>
        <id>https://lengrongfu.github.io/blog/技术写作</id>
        <link href="https://lengrongfu.github.io/blog/技术写作"/>
        <updated>2021-05-25T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[技术写作 第二课]]></summary>
        <content type="html"><![CDATA[<p>技术写作 第二课</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="目标读者">目标读者<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C#%E7%9B%AE%E6%A0%87%E8%AF%BB%E8%80%85" class="hash-link" aria-label="Direct link to 目标读者" title="Direct link to 目标读者">​</a></h3>
<p>​		本课程的目标读者为已完成<a href="https://lengrongfu.github.io/2021/05/21/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%8A%82/" target="_blank" rel="noopener noreferrer">技术写作 第一课</a>，但是仍然渴望进行更多写作培训的人员。如果你没有接受过任何技术写作的培训，最好先看一下第一课能容。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="学习目标">学习目标<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87" class="hash-link" aria-label="Direct link to 学习目标" title="Direct link to 学习目标">​</a></h3>
<p>​		这节课侧重于技术写作中的几个中间主题，学习完本课程之后，将收获如下的知识：</p>
<ul>
<li>从几种不同的策略中选择一种编写第一稿的策略，以及第二稿、第三稿的其他策略。</li>
<li>使用多种技术来检测写作中的错误。</li>
<li>学会组织大型的文档。</li>
<li>介绍文档的范围和所有先决条件。</li>
<li>写下清晰的图形标题。</li>
<li>在技术插图中选择适当的信息密度。</li>
<li>将读者的注意力集中在插图上。</li>
<li>通过图片建立上下文。</li>
<li>有效的修改技术插图。</li>
<li>创建有用、准确、简洁，清晰，可重用和注释良好的代码，用来演示一系列的复杂性。</li>
<li>标示不同的文档类型。</li>
<li>描述所有的内容。</li>
<li>体谅初学者，并为他们编写教程。</li>
</ul>
<p>​		成为一名优秀的工程师或者优秀的技术作家都需要花费多年的专注实践，这门课程能提高你的写作水平，但不会立即使你成为一个出色的作家。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="自我编辑">自我编辑<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C#%E8%87%AA%E6%88%91%E7%BC%96%E8%BE%91" class="hash-link" aria-label="Direct link to 自我编辑" title="Direct link to 自我编辑">​</a></h3>
<p>参考《<a href="https://developers.google.com/style/highlights" target="_blank" rel="noopener noreferrer">Google开发分档风格指南</a>》</p>
<p>换位思考：</p>
<ul>
<li>尝试从读者的角度阅读文档，确保文档目的是明确的；并考虑好不同的角色所拥有的知识储备。</li>
<li>然后从作者的角度阅读文档，确保你做的假设有用，还可以提供资源的链接。</li>
<li>最后请注意，过分依赖角色，会导致文档过于狭隘，而无法对大多数读者有用。</li>
</ul>
<p>大声读出来：</p>
<ul>
<li>自己大声的朗读或者使用屏幕阅读器朗读，来听取尴尬的措辞，冗长的句子或其他不自然的内容。</li>
</ul>
<p>编写每一搞的策略：</p>
<ul>
<li>编写完每一个版本之后，先放边上一个小时，然后再回来阅读一遍，总会发现有可以改进的地方，推荐做三遍。</li>
</ul>
<p>检查写作中的错误：</p>
<ul>
<li>邀请某人查看你的文档，并给你具体的，建设性意见。</li>
<li>阅读的人不一定是同行，但是最好熟悉你遵循的文档风格。</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="写一个大型文档">写一个大型文档<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C#%E5%86%99%E4%B8%80%E4%B8%AA%E5%A4%A7%E5%9E%8B%E6%96%87%E6%A1%A3" class="hash-link" aria-label="Direct link to 写一个大型文档" title="Direct link to 写一个大型文档">​</a></h3>
<p>使用以下策略可以帮助你们撰写大型文档：</p>
<ul>
<li>选择编写单个大型文档或一组简短文档。</li>
<li>把简短文档整理为一个大型文档。</li>
<li>给大型文档添加导航。</li>
<li>逐步暴露信息。</li>
</ul>
<p>什么时候写大文档：</p>
<ul>
<li>当你的阅读对象是刚入门的读者时，写操作指南、入门概述和概念性指南通常能以短文的形式提供更好的作用。</li>
<li>当已经对工具和主题有一定经验的读者，写深入教程，最佳实践指南和命令行参考页可以作为更长的文档使用。</li>
<li>好的教程能可以依靠叙述来引导读者完成较长文档中的一系列相关任务。</li>
</ul>
<p>写较长文档的方法：</p>
<ul>
<li>创建大纲和起草宣言。</li>
<li>完成初稿之后，可以更具概述和简介对其进行复审。</li>
</ul>
<p>编写大纲的实用技巧：</p>
<ul>
<li>在要求读者执行任务前，先解释为什么要执行此任务。</li>
<li>将大纲的每个步骤限制为描述概念或完成特定任务。</li>
<li>构造轮廓，以便文档在与读者最相关时引入信息。</li>
<li>在起草前，先与贡献者共享大纲内容。</li>
</ul>
<p>可以提供一个基本信息来介绍文档：</p>
<ul>
<li>说明文档涵盖的内容。</li>
<li>希望读者具备哪些知识储备。</li>
<li>说明文档没有涵盖那些内容。</li>
</ul>
<p>为文档添加目录，可确保读者能快速的找到所需要的内容，清晰的目录包括：</p>
<ul>
<li>简介和摘要</li>
<li>主题清晰</li>
<li>有助于用户理解的标题和子标题</li>
<li>提示用户在目录中的位置</li>
<li>可以通过目录能跳转到相关位置</li>
<li>有下一步学习的链接</li>
</ul>
<p>在每个标题下都进行简短的介绍，避免在标题后面马上放入下一级标题。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="图片">图片<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C#%E5%9B%BE%E7%89%87" class="hash-link" aria-label="Direct link to 图片" title="Direct link to 图片">​</a></h3>
<p>在插入图之前写标题会很有帮助，然后，插入能说明标题的图片</p>
<p>图片中好的标题应该具有下面的特征：</p>
<ul>
<li>他们很简短，通常只是几句话。</li>
<li>说明了重点。</li>
<li>能吸引读者的注意力。</li>
</ul>
<p>考虑以下三个图形，每个图形使用相同的标题。</p>
<p><img decoding="async" loading="lazy" src="https://gitee.com/lengrongfu/blog-static-file/raw/master/20210521214527.png" alt="" class="img_ev3q"></p>
<p><strong>标题A。单链接列表包含内容和指向下一个节点的指针。</strong></p>
<p><img decoding="async" loading="lazy" src="https://gitee.com/lengrongfu/blog-static-file/raw/master/20210521214546.png" alt="" class="img_ev3q"></p>
<p><strong>标题B。单链接列表包含内容和指向下一个节点的指针。</strong></p>
<p><img decoding="async" loading="lazy" src="https://gitee.com/lengrongfu/blog-static-file/raw/master/20210521214602.png" alt="" class="img_ev3q"></p>
<p><strong>标题C。单链接列表包含内容和指向下一个节点的指针。</strong></p>
<p>上述三个标题中<strong>标题C</strong>是最具启发性的，标题清晰的描述了图片的功能。</p>
<p>如下图片中的信息量不要过大。</p>
<p><img decoding="async" loading="lazy" src="https://gitee.com/lengrongfu/blog-static-file/raw/master/20210521214727.png" alt="" class="img_ev3q"></p>
<p>如上图的复杂性就会让很多读者望而却步，就像避免过长的句子一样，请尽量避免较复杂的图片。</p>
<p>将复杂的图片变为连贯且有用的诀窍是将复杂的系统组织成子系统。</p>
<p><img decoding="async" loading="lazy" src="https://raw.githubusercontent.com/lengrongfu/images/master/img20210521215106.png" alt="" class="img_ev3q"></p>
<p><strong>图4.分为三个子系统的复杂系统。</strong></p>
<p>显示大图之后再分别提供每个子系统的图片。</p>
<p><img decoding="async" loading="lazy" src="https://raw.githubusercontent.com/lengrongfu/images/master/img20210521215224.png" alt="" class="img_ev3q"></p>
<p><strong>图5.复杂系统的一个子系统的扩展细节。</strong></p>
<p>画图工具</p>
<ul>
<li><a href="https://drawings.google.com/" target="_blank" rel="noopener noreferrer">Google绘图</a></li>
<li><a href="https://diagrams.net/" target="_blank" rel="noopener noreferrer">diagrams.net</a></li>
<li><a href="https://www.lucidchart.com/pages/" target="_blank" rel="noopener noreferrer">lucidchart</a></li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="创建示例代码">创建示例代码<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C#%E5%88%9B%E5%BB%BA%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81" class="hash-link" aria-label="Direct link to 创建示例代码" title="Direct link to 创建示例代码">​</a></h3>
<p>代码仍然是技术人最喜欢读的，好的代码通常是最好的文档。</p>
<p>好的代码样本是正确、简洁，你的读者可以快速理解它们，并能以最小的代价重复使用它们。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="正确">正确<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C#%E6%AD%A3%E7%A1%AE" class="hash-link" aria-label="Direct link to 正确" title="Direct link to 正确">​</a></h4>
<p>示例代码应该满足下面条件：</p>
<ul>
<li>代码构建没有错误。</li>
<li>能按要求进行执行。</li>
<li>要做好生产使用的准备，比如，代码不能有安全漏洞。</li>
<li>遵循语言的约定。</li>
</ul>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="简洁">简洁<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C#%E7%AE%80%E6%B4%81" class="hash-link" aria-label="Direct link to 简洁" title="Direct link to 简洁">​</a></h4>
<p>​	    示例代码应该简短，仅包括基本组件，不相关的代码可能会使你的读者分散注意力。但是，也不要用错误的做法来缩短你的代码，在正确和简短之间，我们更看重正确性。</p>]]></content>
        <author>
            <name>Leng Student</name>
            <uri>https://github.com/lengrongfu</uri>
        </author>
        <category label="写作" term="写作"/>
        <category label="软技能" term="软技能"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[代码质量好坏如何评判]]></title>
        <id>https://lengrongfu.github.io/blog/代码质量好坏如何评判</id>
        <link href="https://lengrongfu.github.io/blog/代码质量好坏如何评判"/>
        <updated>2021-05-24T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[代码质量好坏如何评判？]]></summary>
        <content type="html"><![CDATA[<p>代码质量好坏如何评判？</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="代码质量好和坏指什么">代码质量"好"和"坏"指什么？<a href="https://lengrongfu.github.io/blog/%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E5%A5%BD%E5%9D%8F%E5%A6%82%E4%BD%95%E8%AF%84%E5%88%A4#%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E5%A5%BD%E5%92%8C%E5%9D%8F%E6%8C%87%E4%BB%80%E4%B9%88" class="hash-link" aria-label="Direct link to 代码质量&quot;好&quot;和&quot;坏&quot;指什么？" title="Direct link to 代码质量&quot;好&quot;和&quot;坏&quot;指什么？">​</a></h2>
<p>"好"可以表示代码的质量高，"坏"表示代码的质量低。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="代码质量高又是指什么">代码质量"高"又是指什么？<a href="https://lengrongfu.github.io/blog/%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E5%A5%BD%E5%9D%8F%E5%A6%82%E4%BD%95%E8%AF%84%E5%88%A4#%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E9%AB%98%E5%8F%88%E6%98%AF%E6%8C%87%E4%BB%80%E4%B9%88" class="hash-link" aria-label="Direct link to 代码质量&quot;高&quot;又是指什么？" title="Direct link to 代码质量&quot;高&quot;又是指什么？">​</a></h2>
<p>代码质量高指代码：可维护性、可读性、可扩展性、灵活性、简洁性、可复用、可测试性。其中<strong>可维护性、可读性、可扩展性</strong>是最重要的三个指标。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="可维护性">可维护性<a href="https://lengrongfu.github.io/blog/%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E5%A5%BD%E5%9D%8F%E5%A6%82%E4%BD%95%E8%AF%84%E5%88%A4#%E5%8F%AF%E7%BB%B4%E6%8A%A4%E6%80%A7" class="hash-link" aria-label="Direct link to 可维护性" title="Direct link to 可维护性">​</a></h3>
<p>可维护性是一个主观性很强的评判标准，因为熟悉系统的资深工程师可能会任务易维护，但是资历浅的工程师就会认为难维护。</p>
<ul>
<li>所谓可维护性就是指，在不破坏原有代码设计、不引入新的<code>BUG</code>的情况下，能够快速地修改或者添加代码。</li>
<li>所谓代码不易维护就是值，修改或者添加代码需要冒着极大的引入新<code>bug</code>的风险，并且需要花费很长的时间才能完成。</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="可读性">可读性<a href="https://lengrongfu.github.io/blog/%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E5%A5%BD%E5%9D%8F%E5%A6%82%E4%BD%95%E8%AF%84%E5%88%A4#%E5%8F%AF%E8%AF%BB%E6%80%A7" class="hash-link" aria-label="Direct link to 可读性" title="Direct link to 可读性">​</a></h3>
<p>代码的可读性从如下几个方面来进行评价。</p>
<ul>
<li>是否符合编码规范、命名是否达意、注释是否详尽、函数是否长短合适、模块划分是否清晰、是否符合高内聚低耦合等。</li>
</ul>
<p>但是最简单的评价标准就是让同事来做<code>Code Receive</code>,如果同事能够轻松的读懂你的代码，那就是可读性很好，反之就是需要改善代码了。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="可扩展性">可扩展性<a href="https://lengrongfu.github.io/blog/%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E5%A5%BD%E5%9D%8F%E5%A6%82%E4%BD%95%E8%AF%84%E5%88%A4#%E5%8F%AF%E6%89%A9%E5%B1%95%E6%80%A7" class="hash-link" aria-label="Direct link to 可扩展性" title="Direct link to 可扩展性">​</a></h3>
<ul>
<li>可扩展性表示，我们在不修改或少量修改原有代码的情况下，通过扩展的方式添加新的功能代码。</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="灵活性">灵活性<a href="https://lengrongfu.github.io/blog/%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E5%A5%BD%E5%9D%8F%E5%A6%82%E4%BD%95%E8%AF%84%E5%88%A4#%E7%81%B5%E6%B4%BB%E6%80%A7" class="hash-link" aria-label="Direct link to 灵活性" title="Direct link to 灵活性">​</a></h3>
<p>代码灵活性主要提现在易扩展方面。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="简洁性">简洁性<a href="https://lengrongfu.github.io/blog/%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E5%A5%BD%E5%9D%8F%E5%A6%82%E4%BD%95%E8%AF%84%E5%88%A4#%E7%AE%80%E6%B4%81%E6%80%A7" class="hash-link" aria-label="Direct link to 简洁性" title="Direct link to 简洁性">​</a></h3>
<p>我们要遵从<code>KISS</code>原则，代码要尽可能的简单；但是<strong>思从深而行从简，真正的高手能云淡风轻地用最简单的方法解决最复杂的问题。这也是一个编程老手跟编程新手的本质区别之一。</strong></p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="可复用性">可复用性<a href="https://lengrongfu.github.io/blog/%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E5%A5%BD%E5%9D%8F%E5%A6%82%E4%BD%95%E8%AF%84%E5%88%A4#%E5%8F%AF%E5%A4%8D%E7%94%A8%E6%80%A7" class="hash-link" aria-label="Direct link to 可复用性" title="Direct link to 可复用性">​</a></h3>
<ul>
<li>可复用性是很多设计模式、思想、原则所要达到的最终效果。</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="可测试性">可测试性<a href="https://lengrongfu.github.io/blog/%E4%BB%A3%E7%A0%81%E8%B4%A8%E9%87%8F%E5%A5%BD%E5%9D%8F%E5%A6%82%E4%BD%95%E8%AF%84%E5%88%A4#%E5%8F%AF%E6%B5%8B%E8%AF%95%EF%BF%BD%E6%80%A7" class="hash-link" aria-label="Direct link to 可测试性" title="Direct link to 可测试性">​</a></h3>
<ul>
<li>可测试就能从侧面上非常准确地反应代码质量的好坏。</li>
</ul>
<p>要写出满足上述评价标准的高质量代码，我们需要掌握一些更加细化、更加能落地的编程方法论，包括面向对象设计思想、设计原则、设计模式、编码规范、重构技巧等。</p>
<p>如：</p>
<ul>
<li>面向对象中的继承、多态能让我们写出可复用的代码；</li>
<li>编码规范能让我们写出可读性好的代码。</li>
<li>设计原则中的单一职责、DRY、基于接口而非实现、里氏替换原则等可以写出易复用、灵活、可读性好、易扩展、易维护的代码；</li>
<li>设计模式可以写出易扩展的代码。</li>
<li>持续重构可以时刻保持代码的可维护性。</li>
</ul>]]></content>
        <author>
            <name>Leng Student</name>
            <uri>https://github.com/lengrongfu</uri>
        </author>
        <category label="设计模式" term="设计模式"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[技术写作 第一课]]></title>
        <id>https://lengrongfu.github.io/blog/技术写作-第一课</id>
        <link href="https://lengrongfu.github.io/blog/技术写作-第一课"/>
        <updated>2021-05-21T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[本课程是技术写作中的第一课，主要学习技术写作的关键基础，在学校任何其他课程之前，请先学习本课程。]]></summary>
        <content type="html"><![CDATA[<p>本课程是技术写作中的第一课，主要学习技术写作的关键基础，在学校任何其他课程之前，请先学习本课程。</p>
<blockquote>
<p>本文是学习<a href="https://developers.google.com/tech-writing" target="_blank" rel="noopener noreferrer"><code>Google</code>技术写作课程</a>的学习笔记，它这个课程主要用于指导我们如何做好技术写作，了解如何计划和编写技术文档；</p>
</blockquote>
<p>本课程是技术写作中的第一课，主要学习技术写作的关键基础，在学校任何其他课程之前，请先学习本课程。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="学习目标">学习目标<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E5%AD%A6%E4%B9%A0%E7%9B%AE%E6%A0%87" class="hash-link" aria-label="Direct link to 学习目标" title="Direct link to 学习目标">​</a></h3>
<p>​		首先我们确定学习的目标，知道学习完本课程之后可以得到什么；本课程教我们技术协作的基础，完成本课程后，我们就知道如何执行如下的操作了。</p>
<ul>
<li>始终使用专业术语（包括缩写词和首字母缩写词）；比如<code>K8s</code>中的最小调度单元<code>Pod</code>。</li>
<li>识别并尽量减少使用代词的句子。</li>
<li>区分主动语句和被动语句。</li>
<li>确定主动语句优于被动语句的三种方式。</li>
<li>制定至少三种形式，使句子更清晰，更加引人入胜。</li>
<li>制定至少四种缩短句子的策略。</li>
<li>了解项目符号列表和编号列表之间的区别。</li>
<li>创建有用的列表。</li>
<li>为段落创建有效的主要句子。</li>
<li>将每个段落集中在一个主题上。</li>
<li>在每个文档的开头说明要点。</li>
<li>确定你的目标受众。</li>
<li>确定你的目标受众已知什么以及需要学习什么。</li>
<li>了解知识的灾难。</li>
<li>识别和修订成语。</li>
<li>说明文档的范围目标和受众。</li>
<li>将较长的主题分为适当的部分。</li>
<li>真确使用标点符号，包括括号、冒号、破折号和分号。</li>
<li>在<code>Markdown</code>中发展初学者的能力。</li>
</ul>
<p>​		成为一名优秀的工程师和一名出色的技术作家，需要花费多年的专注实践，本课程将提高我们的技术写作水平，但不会使我们变成一名出色的技术作家。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="足够的语法">足够的语法<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E8%B6%B3%E5%A4%9F%E7%9A%84%E8%AF%AD%E6%B3%95" class="hash-link" aria-label="Direct link to 足够的语法" title="Direct link to 足够的语法">​</a></h3>
<p>这里主要是介绍与本课程相关的词性。</p>
<table><thead><tr><th style="text-align:center">词性</th><th>定义</th><th style="text-align:left">例子</th></tr></thead><tbody><tr><td style="text-align:center">名词</td><td>人，地方，概念或事物</td><td style="text-align:left"><strong>山姆</strong>跑<strong>比赛</strong>。</td></tr><tr><td style="text-align:center">代词</td><td>替换另一个名词（或更大结构）的名词</td><td style="text-align:left">山姆参加比赛。<strong>他</strong>喜欢竞争。</td></tr><tr><td style="text-align:center">形容词</td><td>修饰名词的单词或短语</td><td style="text-align:left">山姆穿<strong>蓝色的</strong>鞋子。</td></tr><tr><td style="text-align:center">动词</td><td>一个动作词或短语</td><td style="text-align:left">山姆<strong>跑</strong>比赛。</td></tr><tr><td style="text-align:center">副词</td><td>修饰动词，形容词或其他副词的单词或短语</td><td style="text-align:left">山姆运行<strong>缓慢</strong>。</td></tr><tr><td style="text-align:center">介词</td><td>指定两个名词的位置关系的单词或短语</td><td style="text-align:left">山姆的运动鞋很少<strong>在</strong>他的架子上。</td></tr><tr><td style="text-align:center">连词</td><td>连接两个名词或短语的单词</td><td style="text-align:left">山姆的奖杯<strong>和</strong>缎带只存在于他的想象中。</td></tr><tr><td style="text-align:center">过渡</td><td>连接两个句子的单词或短语</td><td style="text-align:left">山姆每周参加比赛。<strong>但是</strong>，他弱势地完成了比赛。</td></tr></tbody></table>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="名词">名词<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E5%90%8D%E8%AF%8D" class="hash-link" aria-label="Direct link to 名词" title="Direct link to 名词">​</a></h4>
<p>名次代表人、地方或事务。朱迪、南极洲和锤子都是名词，无形的概念（例如<strong>健壮性</strong> 和<strong>完美性</strong>）也是名词。</p>
<blockquote>
<p>在<strong>框架中</strong>，<strong>对象</strong>必须复制该<strong>对象</strong>要更改的所有基础<strong>值</strong>。该<strong>PROTOS</strong>的<strong>代码库</strong>是巨大的，所以复制的<strong>PROTOS</strong>是不可接受的昂贵。</p>
</blockquote>
<p>在编程中，我们会把类和变量视为名词。</p>
<p><strong>练习</strong></p>
<p>找出下面段落中识别六个名词</p>
<blockquote>
<p>C使程序员能够控制指针和内存。强大的功能带来巨大的责任。</p>
</blockquote>
<p><strong>答案</strong></p>
<blockquote>
<p>C、指针、内存、程序员、功能、责任。</p>
</blockquote>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="代词">代词<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E4%BB%A3%E8%AF%8D" class="hash-link" aria-label="Direct link to 代词" title="Direct link to 代词">​</a></h4>
<p>代词是一个间接层，它指向或替代了其他名词或句子。例如，考虑以下两个句子：</p>
<blockquote>
<p>珍妮特（Janet）编写了出色的代码。<strong>她</strong>是高级工程师。</p>
</blockquote>
<p>在前面的示例中，第一句话将<strong>Janet</strong>建立为名词。第二句话用代词<strong>她</strong>代替名词<strong>珍妮特</strong>。</p>
<p><strong>练习</strong></p>
<p>在以下段落中确定三个代词：</p>
<blockquote>
<p>自助餐厅的特色是在吐司上撒上腰果、黄油和果酱。员工们发现它很棒，希望他们每天都能吃它。</p>
</blockquote>
<p><strong>答案</strong></p>
<blockquote>
<p>它很棒: 它代指前面描述的在吐司上撒上腰果、黄油和果酱的食物。</p>
<p>他们每天吃：他们指代前面的员工。</p>
<p>吃它：它代指前面描述的食物</p>
</blockquote>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="动词">动词<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E5%8A%A8%E8%AF%8D" class="hash-link" aria-label="Direct link to 动词" title="Direct link to 动词">​</a></h4>
<p>动词是一个动作词或短语。当您要表示两个名词（一个演员和一个目标）之间的关系时，该动词会起作用。动词标识演员对目标的作用。</p>
<p>每个句子必须至少包含一个动词。例如，以下每个句子包含一个动词：</p>
<ul>
<li>酒井<strong>更喜欢</strong>意大利面。</li>
<li>里克<strong>喜欢</strong>大海。</li>
<li>蓝精灵<strong>是</strong>蓝色的。</li>
<li>杰西<strong>患有</strong>过敏症。</li>
</ul>
<p><strong>练习</strong></p>
<p>在下面句子中找到动词：</p>
<blockquote>
<p>萨曼莎（Samantha）正在用C ++编写“斗牛行动”。该项目目前消耗超过80,000行代码。她以前使用过Python，但最近开始使用C ++。萨曼莎（Samantha）领导着一个由四名软件工程师组成的团队，该团队将在下个季度增长到六名软件工程师</p>
</blockquote>
<p><strong>答案</strong></p>
<blockquote>
<p>编写、消耗、领导、增长</p>
</blockquote>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="形容词和副词">形容词和副词<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E5%BD%A2%E5%AE%B9%E8%AF%8D%E5%92%8C%E5%89%AF%E8%AF%8D" class="hash-link" aria-label="Direct link to 形容词和副词" title="Direct link to 形容词和副词">​</a></h4>
<p>形容词修饰名词。</p>
<ul>
<li>汤姆喜欢<strong>红</strong>气球。他准备<strong>美味的</strong>食物。他修复了 <strong>八个</strong>错误。</li>
</ul>
<p>副词修饰动词。</p>
<ul>
<li>Jane可以<strong>有效地</strong>修复错误。</li>
</ul>
<p><strong>练习</strong></p>
<p>在以下段落中确定四个形容词。</p>
<blockquote>
<p>对于有才华的人来说，工程是一个伟大的事业。我认识一位聪明的工程师，可以在任何知识性的工作中脱颖而出。</p>
</blockquote>
<p><strong>答案</strong></p>
<blockquote>
<p>才华、聪明、知识性、伟大</p>
</blockquote>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="连词和过渡">连词和过渡<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E8%BF%9E%E8%AF%8D%E5%92%8C%E8%BF%87%E6%B8%A1" class="hash-link" aria-label="Direct link to 连词和过渡" title="Direct link to 连词和过渡">​</a></h4>
<p>连词连接短语或名词中的句子，过渡将句子本身连起来。</p>
<p>最重要的连接词如下：</p>
<ul>
<li>和</li>
<li>但</li>
<li>或者</li>
</ul>
<p>技术写作中最重要的过渡词如下：</p>
<ul>
<li>然而</li>
<li>所以</li>
<li>例如</li>
</ul>
<p><strong>练习</strong></p>
<blockquote>
<p>通常，Barbara在编写第一行代码之前会研究问题很长时间。_____________，前几天她突然受到启发时，自发地编码了一种方法。</p>
</blockquote>
<p><strong>答案</strong></p>
<blockquote>
<p>然而</p>
</blockquote>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="单词">单词<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E5%8D%95%E8%AF%8D" class="hash-link" aria-label="Direct link to 单词" title="Direct link to 单词">​</a></h3>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="定义新术语">定义新术语<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E5%AE%9A%E4%B9%89%E6%96%B0%E6%9C%AF%E8%AF%AD" class="hash-link" aria-label="Direct link to 定义新术语" title="Direct link to 定义新术语">​</a></h4>
<p>在编写时，识别目标受众可能不熟悉的术语，当识别出来之后，需要采取下面两种措施：</p>
<ul>
<li>如果该术语已经存在，请链接到现有的良好说明。（不要重新发明轮子。）</li>
<li>如果是新引入的术语，需要定义它，如果引入多个术语，请定义收集到词汇表中。</li>
</ul>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="始终使用术语">始终使用术语<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E5%A7%8B%E7%BB%88%E4%BD%BF%E7%94%A8%E6%9C%AF%E8%AF%AD" class="hash-link" aria-label="Direct link to 始终使用术语" title="Direct link to 始终使用术语">​</a></h4>
<p>在同一个文档中使用相同的术语，否则会让看的人疑惑。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="正确使用首字母缩写">正确使用首字母缩写<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E6%AD%A3%E7%A1%AE%E4%BD%BF%E7%94%A8%E9%A6%96%E5%AD%97%E6%AF%8D%E7%BC%A9%E5%86%99" class="hash-link" aria-label="Direct link to 正确使用首字母缩写" title="Direct link to 正确使用首字母缩写">​</a></h4>
<p>在正文中首次使用首字母缩写时，请拼写完整的术语，然后将首字母缩写词放在括号中，首字母缩写词用黑体字体标出。然后就可以在后续使用同名的首字母缩写词了。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="歧义代词">歧义代词<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E6%AD%A7%E4%B9%89%E4%BB%A3%E8%AF%8D" class="hash-link" aria-label="Direct link to 歧义代词" title="Direct link to 歧义代词">​</a></h3>
<p>​		许多代词都是指代前文中的名词，这种代词像编程中的指针，往往容易引入错误；在文中，尽量避免使用代词，只需要重用名词即可。可以在如下的几种情况中使用代词。</p>
<ul>
<li>引入名词后使用代词；在介绍名词之前，请勿使用代词。</li>
<li>代词应尽可能靠近指代名词，通常，如果名词和代词的距离超过五个单词，就请考虑重用名词。</li>
<li>如果在名词和代词之间引入第二名词，请重用名词，而不要使用代词。</li>
</ul>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="它和他们">它和他们<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E5%AE%83%E5%92%8C%E4%BB%96%E4%BB%AC" class="hash-link" aria-label="Direct link to 它和他们" title="Direct link to 它和他们">​</a></h4>
<p>这两个代词在技术文档中引起最大的混乱：</p>
<ul>
<li>它<code>It</code></li>
<li>他们<code>they、them、their</code></li>
</ul>
<p>下面句子中的<strong>它</strong>就是一个不确定的代词。</p>
<blockquote>
<p>Python是解释形语言，而C ++是编译形语言，。<strong>它</strong>具有很多追随者。</p>
</blockquote>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="这个和那个">这个和那个<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E8%BF%99%E4%B8%AA%E5%92%8C%E9%82%A3%E4%B8%AA" class="hash-link" aria-label="Direct link to 这个和那个" title="Direct link to 这个和那个">​</a></h4>
<ul>
<li>这<code>This</code></li>
<li>那<code>That</code></li>
</ul>
<p>下面句子中的<strong>这</strong>就不清楚代之<code>Frambus</code>还是<code>Foo</code>。</p>
<blockquote>
<p>您可以使用<code>Frambus</code>或<code>Foo</code>来计算导数。<strong>这</strong>不是最佳的。</p>
</blockquote>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="主动语态">主动语态<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E4%B8%BB%E5%8A%A8%E8%AF%AD%E6%80%81" class="hash-link" aria-label="Direct link to 主动语态" title="Direct link to 主动语态">​</a></h3>
<p>优先使用主动语态而不是被动语态：</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="清晰的句子">清晰的句子<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E6%B8%85%E6%99%B0%E7%9A%84%E5%8F%A5%E5%AD%90" class="hash-link" aria-label="Direct link to 清晰的句子" title="Direct link to 清晰的句子">​</a></h3>
<p>在技术写作中，文章写的清晰明了要优于其它规则；下面提供了几种可以使文章清晰明了的方法。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="选择有效的动词">选择有效的动词<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E9%80%89%E6%8B%A9%E6%9C%89%E6%95%88%E7%9A%84%E5%8A%A8%E8%AF%8D" class="hash-link" aria-label="Direct link to 选择有效的动词" title="Direct link to 选择有效的动词">​</a></h4>
<p>​		大多数技术作家都认为动词是句子中最重要的部分，选择正确的使用动词更会产生令人满意的结果。</p>
<p>要吸引和让读者学习，请选择精确、有力，特定的动词。减少使用不精确、通用的动词，如：</p>
<ul>
<li><code>be</code>动词：is，are，am，was，are等。</li>
<li>发生</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="简短的句子">简短的句子<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E7%AE%80%E7%9F%AD%E7%9A%84%E5%8F%A5%E5%AD%90" class="hash-link" aria-label="Direct link to 简短的句子" title="Direct link to 简短的句子">​</a></h3>
<p>出于一大原因，我们会在写技术文档时把句子写的足够间断：</p>
<ul>
<li>简短的句子阅读起来更快。</li>
<li>简短的句子通常更容易维护。</li>
<li>较长的句子会让自己更难理解。</li>
</ul>
<p>我们可以通过如下几点来把长句子变为短句：</p>
<ul>
<li>每个句子都只表达一个想法。</li>
<li>将一些长句子转换为列表。</li>
</ul>
<blockquote>
<p><strong>原句</strong></p>
<p>如：要更改循环的常规流程，可以使用<strong>break</strong>语句（使您跳出当前循环）或<strong>continue</strong>语句（跳过当前循环的当前迭代的其余部分）。</p>
<p><strong>修改如下</strong></p>
<p>要更改循环的通常流程，请调用以下语句之一：</p>
<ul>
<li><code>break</code>，使您跳出当前循环。</li>
<li><code>continue</code>，跳过当前循环的当前迭代的其余部分。</li>
</ul>
</blockquote>
<ul>
<li>
<p>减少使用重复的单词</p>
</li>
<li>
<p>减少从属子句。</p>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="列表和表格">列表和表格<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E5%88%97%E8%A1%A8%E5%92%8C%E8%A1%A8%E6%A0%BC" class="hash-link" aria-label="Direct link to 列表和表格" title="Direct link to 列表和表格">​</a></h3>
<p>好的列表可以把混乱的技术内容转变为有序的事物，技术读者通常喜欢列表。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="选择正确的列表类型">选择正确的列表类型<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E9%80%89%E6%8B%A9%E6%AD%A3%E7%A1%AE%E7%9A%84%E5%88%97%E8%A1%A8%E7%B1%BB%E5%9E%8B" class="hash-link" aria-label="Direct link to 选择正确的列表类型" title="Direct link to 选择正确的列表类型">​</a></h4>
<p>下面的列表在技术写作中经常被使用：</p>
<ul>
<li>项目列表。</li>
</ul>
<blockquote>
<p>如：Bash提供以下字符串操作机制：</p>
<ul>
<li>从字符串开头删除子字符串</li>
<li>将整个文件读入一个字符串变量</li>
</ul>
</blockquote>
<ul>
<li>数字编号列表。</li>
</ul>
<blockquote>
<p>如：请执行以下步骤来重新配置服务器：</p>
<ol>
<li>停止服务器。</li>
<li>编辑配置文件。</li>
<li>重新启动服务器。</li>
</ol>
</blockquote>
<ul>
<li>潜入编号清单。</li>
</ul>
<p>​		项目列表和编号列表的区别，使用项目列表的时候，重新排列项目列表中的内容，则列表的含义<strong>不会改变</strong>；使用编号列表是，重新排列编号列表中的内容，则列表的含义会<strong>改变</strong>。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="保持列表项一致">保持列表项一致<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E4%BF%9D%E6%8C%81%E5%88%97%E8%A1%A8%E9%A1%B9%E4%B8%80%E8%87%B4" class="hash-link" aria-label="Direct link to 保持列表项一致" title="Direct link to 保持列表项一致">​</a></h4>
<p>列表项一致是指列表中描述每一项都使用一样的词性、标点、句子结构（如都是主动句）。</p>
<p>如下面句子就是列表项一致的：</p>
<ul>
<li>萝卜</li>
<li>土豆</li>
<li>卷心菜</li>
</ul>
<p>下面的句子就是列表项不一致的：</p>
<ul>
<li>萝卜</li>
<li>土豆</li>
<li>夏日的阳光遮掩了冬天的所有回忆。</li>
</ul>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="创建有用的表">创建有用的表<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E5%88%9B%E5%BB%BA%E6%9C%89%E7%94%A8%E7%9A%84%E8%A1%A8" class="hash-link" aria-label="Direct link to 创建有用的表" title="Direct link to 创建有用的表">​</a></h4>
<p>大家对于表的展示信息会更加的关注。</p>
<p>使用表时，请注意以下几点：</p>
<ul>
<li>每一列的标题都要取的有意义，不要让读者去猜测。</li>
<li>每个单元格中不要放入过多的内容，如果超过两行，就需要仔细想一是否需要。</li>
<li>争取每个列之间是相关性的。</li>
</ul>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="使用表和列表前">使用表和列表前<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E4%BD%BF%E7%94%A8%E8%A1%A8%E5%92%8C%E5%88%97%E8%A1%A8%E5%89%8D" class="hash-link" aria-label="Direct link to 使用表和列表前" title="Direct link to 使用表和列表前">​</a></h4>
<p>​	在使用表和列表前加上一句话，告诉读者表格或者列表是要说明什么，然后用<strong>冒号</strong>来终止介绍语句。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="段落">段落<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E6%AE%B5%E8%90%BD" class="hash-link" aria-label="Direct link to 段落" title="Direct link to 段落">​</a></h3>
<blockquote>
<p>写作的工作：弄清主题各部分之间的依赖关系，并按逻辑的顺序呈现出来，使读者能够理解。</p>
</blockquote>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="写一个好的开头">写一个好的开头<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E5%86%99%E4%B8%80%E4%B8%AA%E5%A5%BD%E7%9A%84%E5%BC%80%E5%A4%B4" class="hash-link" aria-label="Direct link to 写一个好的开头" title="Direct link to 写一个好的开头">​</a></h4>
<p>​		开头句子是段落中最重要的部分，好的开头确定了段落的中心思想。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="每一段都只写一个主题">每一段都只写一个主题<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E6%AF%8F%E4%B8%80%E6%AE%B5%E9%83%BD%E5%8F%AA%E5%86%99%E4%B8%80%E4%B8%AA%E4%B8%BB%E9%A2%98" class="hash-link" aria-label="Direct link to 每一段都只写一个主题" title="Direct link to 每一段都只写一个主题">​</a></h4>
<p>​		一段应只写一个主题，将每个段落都只写一个主题，不要描述之前的话题或者是之后的话题。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="段落不要太长也不要太短">段落不要太长也不要太短<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E6%AE%B5%E8%90%BD%E4%B8%8D%E8%A6%81%E5%A4%AA%E9%95%BF%E4%B9%9F%E4%B8%8D%E8%A6%81%E5%A4%AA%E7%9F%AD" class="hash-link" aria-label="Direct link to 段落不要太长也不要太短" title="Direct link to 段落不要太长也不要太短">​</a></h4>
<p>​		段落太长让看的人第一映像是恐惧，读者更喜欢包含三到五个句子的段落，但会避免包含超过七个句子的段落。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一个段落要提供什么">一个段落要提供什么<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E4%B8%80%E4%B8%AA%E6%AE%B5%E8%90%BD%E8%A6%81%E6%8F%90%E4%BE%9B%E4%BB%80%E4%B9%88" class="hash-link" aria-label="Direct link to 一个段落要提供什么" title="Direct link to 一个段落要提供什么">​</a></h4>
<p>​		好的段落可以回答三个问题：</p>
<ul>
<li>你想告诉读者什么东西？</li>
<li>读者为什么知道这点很重要？</li>
<li>读者应该如何使用这些知识。</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="受众">受众<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E5%8F%97%E4%BC%97" class="hash-link" aria-label="Direct link to 受众" title="Direct link to 受众">​</a></h3>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="如何定义受众">如何定义受众<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E5%A6%82%E4%BD%95%E5%AE%9A%E4%B9%89%E5%8F%97%E4%BC%97" class="hash-link" aria-label="Direct link to 如何定义受众" title="Direct link to 如何定义受众">​</a></h4>
<p>我们通过简单的方式来确定受众；首先确定受众的角色，示例角色包括：</p>
<ul>
<li>软件工程师</li>
<li>技术非工程师角色</li>
<li>科学家们</li>
<li>科学领域的专业人才</li>
<li>本科生</li>
<li>研究生</li>
<li>非技术职位</li>
</ul>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="确定受众需要学习内容">确定受众需要学习内容<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E7%A1%AE%E5%AE%9A%E5%8F%97%E4%BC%97%E9%9C%80%E8%A6%81%E5%AD%A6%E4%B9%A0%E5%86%85%E5%AE%B9" class="hash-link" aria-label="Direct link to 确定受众需要学习内容" title="Direct link to 确定受众需要学习内容">​</a></h4>
<p>​		在写文章之前最好能确定受众需要掌握什么知识才能更好的读懂本文，可以把受众需要掌握的以列表的形式列出来。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="文档">文档<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E6%96%87%E6%A1%A3" class="hash-link" aria-label="Direct link to 文档" title="Direct link to 文档">​</a></h3>
<p>​		需要把所有的段落组织成一个连贯的文档。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="声明文档范围">声明文档范围<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#%E5%A3%B0%E6%98%8E%E6%96%87%E6%A1%A3%E8%8C%83%E5%9B%B4" class="hash-link" aria-label="Direct link to 声明文档范围" title="Direct link to 声明文档�范围">​</a></h4>
<p>​		一个好的文档应该要说明它要说明的主题，以及不会说明什么；如下：</p>
<blockquote>
<p>本文档描述了Project Frambus的总体设计；本文档未介绍相关技术Froobus项目的设计。</p>
</blockquote>
<p>​		说明文档的范围不仅能使读者受益，也能让作者受益。在编写时，可以时刻参考自己定义的文档范围并修正。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="markdown">Markdown<a href="https://lengrongfu.github.io/blog/%E6%8A%80%E6%9C%AF%E5%86%99%E4%BD%9C-%E7%AC%AC%E4%B8%80%E8%AF%BE#markdown" class="hash-link" aria-label="Direct link to Markdown" title="Direct link to Markdown">​</a></h3>
<p>​		<code>Markdown</code>是一种轻量级的标记语言，许多技术专业人员都是用它来创建和编辑技术文档，使用<code>Markdown</code>，通过插入特殊符号用来标示标题、粗体、列表等。</p>]]></content>
        <author>
            <name>Leng Student</name>
            <uri>https://github.com/lengrongfu</uri>
        </author>
        <category label="写作" term="写作"/>
        <category label="软技能" term="软技能"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[2020年十大战略技术趋势：分布式云]]></title>
        <id>https://lengrongfu.github.io/blog/分布式云</id>
        <link href="https://lengrongfu.github.io/blog/分布式云"/>
        <updated>2021-05-19T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[分布式云是第一个将云提供的服务的物理位置作为其定义的一部分的云模型。]]></summary>
        <content type="html"><![CDATA[<p>分布式云是第一个将云提供的服务的物理位置作为其定义的一部分的云模型。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="概述">概述<a href="https://lengrongfu.github.io/blog/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%91#%E6%A6%82%E8%BF%B0" class="hash-link" aria-label="Direct link to 概述" title="Direct link to 概述">​</a></h3>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="关键发现">关键发现<a href="https://lengrongfu.github.io/blog/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%91#%E5%85%B3%E9%94%AE%E5%8F%91%E7%8E%B0" class="hash-link" aria-label="Direct link to 关键发现" title="Direct link to 关键发现">​</a></h3>
<ul>
<li>分布式云是第一个将云提供的服务的物理位置作为其定义的一部分的云模型。</li>
<li>分布式云修复了混合云模型中通常存在的云价值链中的不连续性。云提供商正在采用不同的方法和模型来解决此类问题。</li>
<li>分布式云将分阶段出现。在第一阶段，企业将其作为打包的，受位置限制的分布式云产品进行部署和使用。在第二阶段中，电信公司和市政府等第三方将参与其中。</li>
<li>新的高级用例和对云计算的更复杂的使用正在增加可供IT专业人员使用的云服务的范围。这些分布式云体系结构中的每一个都通常基于邻近性，控制，可伸缩性和可用服务的广度提供一组不同的权衡。</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="推荐建议">推荐建议<a href="https://lengrongfu.github.io/blog/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%91#%E6%8E%A8%E8%8D%90%E5%BB%BA%E8%AE%AE" class="hash-link" aria-label="Direct link to 推荐建议" title="Direct link to 推荐建议">​</a></h3>
<p>评估战略技术趋势的影响和竞争优势潜力的企业体系结构和技术创新领导者必须：</p>
<ul>
<li>通过定位与位置相关的用例，使用分布式云模型作为为下一代云计算做准备的机会。</li>
<li>通过使用分布式云的按需混合特性，克服私有云和混合云实现中的不足。</li>
<li>确定分布式云的未来阶段的用例（例如低延迟，受限的规模和数据驻留），这些用例可通过使用分布式云“变电站”得到增强。</li>
<li>调查使云提供商负责甚至内部部署的云操作，以克服当今的私有云和混合云计算的失败和不足。</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="战略规划假设">战略规划假设<a href="https://lengrongfu.github.io/blog/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%91#%E6%88%98%E7%95%A5%E8%A7%84%E5%88%92%E5%81%87%E8%AE%BE" class="hash-link" aria-label="Direct link to 战略规划假设" title="Direct link to 战略规划假设">​</a></h3>
<p>到<code>2024</code>年，大多数云服务平台将至少提供一些在需要时执行的分布式云服务。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="分析">分析<a href="https://lengrongfu.github.io/blog/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%91#%E5%88%86%E6%9E%90" class="hash-link" aria-label="Direct link to 分析" title="Direct link to 分析">​</a></h3>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="为什么分布式云是十大趋势">为什么分布式云是十大趋势<a href="https://lengrongfu.github.io/blog/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%91#%E4%B8%BA%E4%BB%80%E4%B9%88%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%91%E6%98%AF%E5%8D%81%E5%A4%A7%E8%B6%8B%E5%8A%BF" class="hash-link" aria-label="Direct link to 为什么分布式云是十大趋势" title="Direct link to 为什么分布式云是十大趋势">​</a></h4>
<p>​		随着越来越多的人使用云计算，他们将使用更高级的功能。而且供应商正在以更加细致和智能的方式提供云功能，从而在新的业务案例中认识到新的客户价值。"云计算的未来是什么？"这一问题的答案就是<strong>分布式云</strong>。它是指将公共云服务分发到不同的物理位置，而服务的运营，治理和演进仍然是公共云提供商的责任。与描述未来的任何事物一样，分布式云基于今天可见的起源。分布式云将全球公共云区域，混合云和边缘计算的各个方面带入了云计算的原始世界（见图1）。图1.分布式云</p>
<p><img decoding="async" loading="lazy" src="https://gitee.com/lengrongfu/blog-static-file/raw/master/20210519113745.png" alt="" class="img_ev3q"></p>
<p>​		由于云计算本身的重要性，我们已将分布式云确定为<code>2020</code>年十大战略技术趋势。云计算实际上是下一件大事的基础，包括其他十大战略技术趋势。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="分布式云最适合的地方前十名">分布式云最适合的地方前十名<a href="https://lengrongfu.github.io/blog/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%91#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%91%E6%9C%80%E9%80%82%E5%90%88%E7%9A%84%E5%9C%B0%E6%96%B9%E5%89%8D%E5%8D%81%E5%90%8D" class="hash-link" aria-label="Direct link to 分布式云最适合的地方前十名" title="Direct link to 分布式云最适合的地方前十名">​</a></h4>
<p>​		这种趋势是智能空间类别的一部分（参见图2），同时还包括授权的边缘，自治的事物，实用的区块链和<code>AI</code>安全性。图2.分布式云在战略技术趋势的前十大列表中的位置。</p>
<p><img decoding="async" loading="lazy" src="https://gitee.com/lengrongfu/blog-static-file/raw/master/20210519114008.png" alt="" class="img_ev3q"></p>
<p>分布式云与其他十大战略技术趋势中的三个具有很大的协同作用。这以下的三个趋势的实现基础是分布式云：</p>
<ul>
<li><strong>赋权的边缘。</strong> 边缘设备将利用从邻近到端点（例如，在网关和本地微数据中心上）到远程云区域无处不在的分布式云系统。</li>
<li><strong>实用的区块链</strong> 随着区块链的成熟，更多的处理将在边缘和其他地方进行。但是，这些环境中的许多环境都限制了计算能力，缓慢的联网和有限的数据存储功能。他们将越来越依赖由分布式云提供支持的功能。</li>
<li><strong>AI安全。</strong> 手动监视和管理大量的未来边缘设备将是不可能的。基于AI的安全系统对于通过分布式功能识别异常行为至关重要。</li>
</ul>
<p>这三大十大技术成功部署和使用的关键因素是<strong>位置</strong>。分布式云将成为在所需位置交付云功能以支持其他十大技术的基础。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="分布式云介绍">分布式云介绍<a href="https://lengrongfu.github.io/blog/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%91#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%91%E4%BB%8B%E7%BB%8D" class="hash-link" aria-label="Direct link to 分布式云介绍" title="Direct link to 分布式云介绍">​</a></h3>
<p>​		分布式云将公共云服务分布到不同的物理位置，代表着与大多数公共云服务的虚拟化集中式模型以及与通用云概念相关的模型的重大转变。这将引领云计算的新纪元。 <code>Gartner</code>将云计算定义为一种计算样式，其中使用<code>Internet</code>技术将作为服务的弹性可伸缩<code>IT</code>功能交付为服务。此定义没有提及位置。长期以来，云计算一直被视为提供商数据中心中运行的“集中式”服务的代名词。但是，最好将其视为逻辑上集中或统一的服务。私有云和混合云选项补充了此公共云模型。 <em>私有云</em> 指的是专门针对通常在自己的数据中心中运行的各个公司创建云服务。 <em>混合云</em> 指私有云和公共云服务的集成以支持并行，集成或互补的任务。位置是分布式云概念的关键部分。分布式云将功能分布到不同的位置。以分布式方式部署云服务为从中央公共云到边缘设备和场景的连续云服务提供了更强大的支持。访问在边缘设备上运行的云服务的能力可以将云资源分配给不同的用例。它使单个设备可以满足不同的连接要求；附近的景点；以及社区，城市，国家或整个地区。分布式云还可以满足不同的物理安全性和耐用性要求。这个统一体统一了云。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="分布式云具有三个起源公共云区域混合云和边缘计算">分布式云具有三个起源：公共云区域，混合云和边缘计算<a href="https://lengrongfu.github.io/blog/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%91#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%91%E5%85%B7%E6%9C%89%E4%B8%89%E4%B8%AA%E8%B5%B7%E6%BA%90%E5%85%AC%E5%85%B1%E4%BA%91%E5%8C%BA%E5%9F%9F%E6%B7%B7%E5%90%88%E4%BA%91%E5%92%8C%E8%BE%B9%E7%BC%98%E8%AE%A1%E7%AE%97" class="hash-link" aria-label="Direct link to 分布式云具有三个起源：公共云区域，混合云和边缘计算" title="Direct link to 分布式云具有三个起源：公共云区域，混合云和边缘计算">​</a></h3>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="公共云">公共云<a href="https://lengrongfu.github.io/blog/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%91#%E5%85%AC%E5%85%B1%E4%BA%91" class="hash-link" aria-label="Direct link to 公共云" title="Direct link to 公共云">​</a></h4>
<p>​		在超大规模公共云实施中，公共云是“宇宙的中心”。但是，几乎自云计算服务诞生以来，它就已经在全球范围内分布在公共云中。提供商在世界各地具有不同的区域，所有区域均由一个公共云提供商进行集中控制，管理和提供。云服务的位置是分布式云计算模型的关键组成部分。从历史上看，位置与云定义无关，但是在许多情况下，与之相关的问题很重要。出于多种原因（包括数据主权）以及对延迟敏感的用例，位置可能很重要。在这些情况下，分布式云服务为组织提供了在满足其要求的位置提供的公共云服务的功能。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="混合云">混合云<a href="https://lengrongfu.github.io/blog/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%91#%E6%B7%B7%E5%90%88%E4%BA%91" class="hash-link" aria-label="Direct link to 混合云" title="Direct link to 混合云">​</a></h4>
<p>​		混合云概念的目标是以优化，高效和经济高效的方式将提供商的外部服务与内部运行的内部服务混合在一起。但是，实施私有云非常困难。混合云计算需要公共云和私有云。大多数私有云项目无法提供组织所寻求的云成果和收益。此外，Gartner与客户进行的有关混合云的大多数对话都不是真正的混合云方案。相反，它们是关于混合IT场景的，在该场景中，非云技术与一系列类似云的模型一起用于公共云服务。这就是所谓的云启发式（请参阅 “四种类型的云计算描述了云计算的价值范围”））。混合IT和真正的混合云选项是有效的方法，我们建议在某些用例中使用它们。但是大多数混合云样式破坏了许多云计算的价值主张，并且未能：</p>
<ul>
<li>将运行硬件和软件基础架构的责任和工作转移到云提供商</li>
<li>从大量共享资源中利用云弹性的经济性（上下扩展）</li>
<li>与公共云提供商同步从创新的步伐中受益</li>
<li>使用全球超大规模服务的成本经济学</li>
<li>利用大型云提供商的技能来保护和运营世界一流的服务</li>
</ul>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="包装的混合云">包装的混合云<a href="https://lengrongfu.github.io/blog/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%91#%E5%8C%85%E8%A3%85%E7%9A%84%E6%B7%B7%E5%90%88%E4%BA%91" class="hash-link" aria-label="Direct link to 包装的混合云" title="Direct link to 包装的混合云">​</a></h5>
<p>​		下一代混合（和私有）云被打包在一起解决了混合云的许多问题。打包的混合云是指由供应商提供的私有云产品，该产品以捆绑方式打包并连接到公共云。打包的混合云有两种主要方法：“按需比较”混合和“分层技术”混合（跨越不同的技术基础）。</p>
<ol>
<li><code>Microsoft Azure</code>和<code>Azure Stack</code>代表了“按需<strong>混合”方法</strong>。<code>Azure Stack</code>与公共云中的<code>Azure</code>不同。它是一个子集，但提供了一组功能，这些功能可反映<code>Azure</code>公共云中的服务。另一个示例是，<code>AWS Outposts</code>可以在托管的私有云模式下使用（没有其他公司可以访问此模式）。它代表了“按需使用”方法的示例。但是，以<code>AWS Outposts</code>代表的更广泛的策略将鼓励采用更加分散的模型，其中每个<code>Outposts</code>部署都向附近的邻居开放。同类解决方案提供了“完整堆栈”，但不一定提供硬件，所有解决方案均由单个供应商管理。</li>
</ol>
<ul>
<li>在<code>Azure Stack</code>方法中， 客户购买并拥有一个硬件平台。云软件层随提供商的公共云服务的子集一起交付。在这种情况下，云提供商通常不对底层硬件平台的正在进行的操作，维护或更新承担全部责任。云提供商可能仅对该软件承担部分责任。用户自行负责或使用托管服务提供商负责。</li>
<li>在<code>AWS Outposts</code>模型中， 将既包含硬件又包含软件的完整设备交付给客户。云提供商负责支持和维护硬件和软件。客户提供了托管系统的物理设施，但否则云提供商将设备作为其中央云服务的扩展有效运行。</li>
<li>尽管软件方法在公共服务和本地实施之间提供了类似的模型，但是混合云的其他挑战仍然存在。一些客户认为控制服务更新是一种优势。</li>
</ul>
<ol start="2">
<li><strong>分层技术混合方法</strong> 基于不同基础技术，平台和功能的集成-创建各种可移植性层。这就是<code>Google</code>和<code>IBM</code>（及其他公司）关注的重点-带有<code>Anthos</code>（以前称为其云服务平台）的<code>Google</code>和带有<code>Red Hat</code>和<code>OpenShift</code>的<code>IBM</code>。</li>
</ol>
<ul>
<li>通过这种方法，提供商可以提供通常基于<code>Kubernetes</code>构建的可移植层，作为跨分布式环境的服务的基础。在某些情况下，可移植性层仅使用容器来支持容器化应用程序的执行。在其他情况下，提供商将其某些云服务作为可在分布式环境中运行的容器化服务来提供。可移植性方法忽略了底层硬件平台的所有权和管理，这仍然是客户的责任。</li>
</ul>
<p>​		存在组合方法和其他方法。在这些服务中，提供商以硬件/软件组合的形式提供其某些云服务的同类版本，并且提供商致力于管理和更新服务。这减轻了服务使用者的负担，他们可以将服务视为“黑匣子”。但是，有些客户会不满意放弃对底层硬件和软件更新周期的所有控制权。</p>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="混合云promise上的分布式云交付">混合云Promise上的分布式云交付<a href="https://lengrongfu.github.io/blog/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%91#%E6%B7%B7%E5%90%88%E4%BA%91promise%E4%B8%8A%E7%9A%84%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%91%E4%BA%A4%E4%BB%98" class="hash-link" aria-label="Direct link to 混合云Promise上的分布式云交付" title="Direct link to 混合云Promise上的分布式云交付">​</a></h5>
<p>​		分布式云超出了云提供商拥有的数据中心的范围（例如，云提供商具有不同区域的模型）。在分布式云中，原始公共云提供商负责云服务体系结构，交付，运营，治理和更新的所有方面。这将恢复在客户负责交付的一部分时被打破的云价值主张，这在混合云场景中通常是这种情况。云提供商不需要拥有安装分布式云服务的硬件。但是，在完全实施分布式云模型时，云提供商必须对如何管理和维护该硬件承担全部责任。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="边缘云">边缘云<a href="https://lengrongfu.github.io/blog/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%91#%E8%BE%B9%E7%BC%98%E4%BA%91" class="hash-link" aria-label="Direct link to 边缘云" title="Direct link to 边缘云">​</a></h4>
<p>​		分布式云的基本概念是，公有云提供商负责设计，架构，交付，操作，维护，更新和所有权，通常包括底层硬件。但是，随着解决方案越来越靠近边缘，云提供商通常不希望拥有整个技术栈，这是不希望的或不可行的。由于这些服务被分发到操作系统（例如，发电厂或风电场）上，因此消费组织可能不希望将物理工厂的所有权和管理权交给外部供应商。但是，消费组织可能会对提供商在此类设备上交付，管理和更新的服务感兴趣。移动设备，智能手机和其他客户端设备也是如此。因此，我们预计，随着提供商接受不同级别的所有权和责任，将会出现一系列交付模型。另一个会影响公共云服务分布的边缘因素将是边缘，近边缘和远边缘平台的功能。可能不需要或无法运行在集中式云中进行镜像的同类服务。低目标物联网<code>（IoT）</code>或存储设备等针对目标环境量身定制的补充服务将成为分布式云频谱的一部分（例如，<code>AWS IoT Greengrass</code>，<code>AWS Snowball</code>和<code>Azure Stack Edge</code>）。但是，如果要将这些服务视为分布式云频谱的一部分，则云提供商至少必须设计，架构，分发，管理和更新这些服务。分布式云支持从分布到特定和不同位置的公共云中的云服务的连续连接和断续连接操作。这实现了低延迟服务执行，其中云服务更接近远程数据中心的需求点，或者一直传递到边缘设备本身。这可以大大提高性能，降低与全球网络相关的中断的风险，并支持偶尔连接的场景。到<code>2024</code>年，大多数云服务平台将至少提供一些在需要时执行的服务。这实现了低延迟服务执行，其中云服务更接近远程数据中心的需求点，或者一直传递到边缘设备本身。这可以大大提高性能，降低与全球网络相关的中断的风险，并支持偶尔连接的场景。到<code>2024</code>年，大多数云服务平台将至少提供一些在需要时执行的服务。这实现了低延迟服务执行，其中云服务更接近远程数据中心的需求点，或者一直传递到边缘设备本身。这可以大大提高性能，降低与全球网络相关的中断的风险，并支持偶尔连接的场景。到<code>2024</code>年，大多数云服务平台将至少提供一些在需要时执行的服务。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="分布式云的演变">分布式云的演变<a href="https://lengrongfu.github.io/blog/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%91#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%91%E7%9A%84%E6%BC%94%E5%8F%98" class="hash-link" aria-label="Direct link to 分布式云的演变" title="Direct link to 分布式云的演变">​</a></h3>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="分布式云有那几个阶段">分布式云有那几个阶段<a href="https://lengrongfu.github.io/blog/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%91#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%91%E6%9C%89%E9%82%A3%E5%87%A0%E4%B8%AA%E9%98%B6%E6%AE%B5" class="hash-link" aria-label="Direct link to 分布式云有那几个阶段" title="Direct link to 分布式云有那几个阶段">​</a></h4>
<p>我们预计分布式云计算将分四个阶段进行：</p>
<ul>
<li><strong>阶段1.</strong> 相似的混合模式，其中云提供商以分布式方式交付服务，该服务镜像其集中式云中的服务子集以在企业中交付。</li>
<li><strong>阶段2。</strong> 按需模型的扩展，其中云提供商与第三方合作，以通过第三方提供商向目标社区交付其集中式云服务的子集。一个例子是通过电信提供商或托管提供商提供服务，以支持提供商没有数据中心的较小国家/地区对数据主权的要求。</li>
<li><strong>阶段3。</strong> 组织社区共享分布式云变电站。我们使用“变电站”一词来唤起人们聚集使用服务的子站（例如分支邮局）的形象。如果云客户开放给社区或公共使用，则云客户可以出于常见或多种原因聚集在分布式云变电站中，以使用云服务。这提高了与支付分布式云变电站的安装和运营相关的经济性。当其他公司使用变电站时，他们可以分担安装成本。我们预计，诸如电信服务提供商之类的第三方将考虑在公共云提供商缺少位置的位置创建变电站。如果变电站在为其安装付费的组织外部不开放使用，</li>
<li><strong>阶段4.</strong> 使用嵌入式和个人资源。示例包括在个人设备上使用本地处理，在智能建筑中嵌入功能以及在软件包或应用程序中嵌入的组件。</li>
</ul>
<p>​		具有讽刺意味的是，分布式云采用了与位置无关的东西（云计算），引入了位置重要性，并最终消除了对位置的担忧。以最完整的形式，分布式云方法将使组织能够向云提供商指定其要求（例如，合规性和安全性，预算和容量）。云提供商将越来越以自动化的方式生成最佳配置，而无需详细的位置知识。除了解决区域，混合和边缘问题之外，分布式云方法还将支持其他方案。这些包括针对政府和特定行业社区云的专用连接实施，以及可能满足地缘政治需求的解决方案。此类地缘政治问题导致越来越多的国家关注与主要互联网的连接。其中包括审查制度，安全性，隐私权和数据主权。互联网和云方案的这种“碎片化”无视简单的解决方案-分布式云功能可以提供帮助。</p>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="分布式云的路径">分布式云的路径<a href="https://lengrongfu.github.io/blog/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%91#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%91%E7%9A%84%E8%B7%AF%E5%BE%84" class="hash-link" aria-label="Direct link to 分布式云的路径" title="Direct link to 分布式云的路径">​</a></h4>
<p>​		分布式云处于开发的早期阶段。许多提供商的目标是长期提供分布式的大多数公共服务。但是，它们目前仅以分布式方式提供有限的消费模型（形状因数），仅提供其服务的一个子集（通常是一小部分）。一些提供商不支持完整分布式云的完整交付，操作和更新元素。提供商正在将服务扩展到本地数据中心，第三方数据中心和边缘。他们通过<code>Microsoft Azure Stack</code>，客户的<code>Oracle Cloud</code>，<code>Google Anthos</code>，<code>IBM Red Hat</code>和<code>AWS Outposts</code>（以及<code>AWS Local Zones</code>和<code>AWS Wavelength</code>）等产品来做到这一点。分层技术包装方法。在实现分布式云的愿景方面，每种方法都涉及挑战。类似的方法往往会导致围墙花园。分层方法可能会面临交付便携式开放软件的挑战。这两种方法都可以带来一个开放的，完全托管的多云解决方案，但要通过不同的途径并面临截然不同的挑战。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="行动">行动<a href="https://lengrongfu.github.io/blog/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%91#%E8%A1%8C%E5%8A%A8" class="hash-link" aria-label="Direct link to 行动" title="Direct link to 行动">​</a></h3>
<p>企业架构和技术创新领导者必须：</p>
<ul>
<li>通过定位与位置相关的用例，使用分布式云模型为下一代云计算做准备的机会。</li>
<li>通过使用分布式云的按需混合特性，克服私有云和混合云实现中的不足。</li>
<li>确定分布式云的未来阶段（例如，低延迟，限制规模和数据驻留）的使用案例，这些使用案例可以通过使用分布式云变电站来增强。</li>
<li>确定场景，在这些场景中，分布式云模型将消除对“传统”混合云模型的需求，并且将持续需要多年的混合云模型。</li>
<li>调查使云提供商负责甚至内部部署的云操作，以克服当今的私有云和混合云计算的失败和不足。</li>
</ul>
<p>利用增加的云计算部署选项提供的灵活性。</p>]]></content>
        <author>
            <name>Leng Student</name>
            <uri>https://github.com/lengrongfu</uri>
        </author>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="Kubernetes Network" term="Kubernetes Network"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[Kubernetes Network]]></title>
        <id>https://lengrongfu.github.io/blog/Kubernetes-Network</id>
        <link href="https://lengrongfu.github.io/blog/Kubernetes-Network"/>
        <updated>2021-05-13T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Kubernetes Network 基本概念和原理]]></summary>
        <content type="html"><![CDATA[<p>Kubernetes Network 基本概念和原理</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="一单机容器网络">一、单机容器网络<a href="https://lengrongfu.github.io/blog/Kubernetes-Network#%E4%B8%80%E5%8D%95%E6%9C%BA%E5%AE%B9%E5%99%A8%E7%BD%91%E7%BB%9C" class="hash-link" aria-label="Direct link to 一、单机容器网络" title="Direct link to 一、单机容器网络">​</a></h2>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="名词">名词<a href="https://lengrongfu.github.io/blog/Kubernetes-Network#%E5%90%8D%E8%AF%8D" class="hash-link" aria-label="Direct link to 名词" title="Direct link to 名词">​</a></h3>
<ul>
<li>网络栈：网络栈包括了网卡(<code>Network Interface</code>)、回环设备(<code>Loopback Device</code>)、路由表(<code>Routing Table</code>)和<code>Iptables</code>规则，对于一个进程来说，这些要素，就构成了它发起请求和响应网络请求的基本环境。</li>
<li>网桥(<code>Bridge</code>)：<code>bridge</code>是一个虚拟网络设备，所以具有网络设备的特征，可以配置<code>IP</code>、<code>MAC</code>地址；<code>Bridger</code>是一个虚拟交换机，具有和物理交换机类似的功能。它是工作在数据链路层的设备。</li>
<li><code>Veth Pair</code>: 虚拟网线，用来连接容器到网桥上的；它被创建出来以后，总是以两张虚拟网卡(<code>Veth Peer</code>)的形式成对出现，并且，从其中一个网卡发出的数据包会自动出现在与之对应的网卡上，哪怕是这两张_*网卡_在不同的<code>Network Namespace</code>中。</li>
<li><code>ARP</code>: 是一个通过三层的<code>IP</code>地址找到对应二层<code>MAC</code>地址的协议。</li>
<li><code>CAM表</code>：虚拟交换机(这里是网桥)通过<code>MAC</code>地址学习维护的端口和<code>MAC</code>地址的对应表。</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="host网络">Host网络<a href="https://lengrongfu.github.io/blog/Kubernetes-Network#host%E7%BD%91%E7%BB%9C" class="hash-link" aria-label="Direct link to Host网络" title="Direct link to Host网络">​</a></h3>
<p>作为一个容器，在启动时可以通过指定<code>-net=host</code>，使用宿主机的<code>Network Namespace</code>。</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">$ docker run -d -net=host --name nginx-1 nginx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>使用<code>Host</code>网络的优点是网络性能较好，直接使用宿主机的网络栈，缺点是会引入共享网络资源的问题，比如端口冲突。<strong>所以，在多数情况下，我们都希望能使用自己Network Namespace里的网络栈，拥有属于自己的IP和端口。</strong></p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="如何通信">如何通信<a href="https://lengrongfu.github.io/blog/Kubernetes-Network#%E5%A6%82%E4%BD%95%E9%80%9A%E4%BF%A1" class="hash-link" aria-label="Direct link to 如何通信" title="Direct link to 如何通信">​</a></h3>
<p><img decoding="async" loading="lazy" src="https://gitee.com/lengrongfu/blog-static-file/raw/master/single_node_container_network.png" alt="单节点容器网络通信" class="img_ev3q"></p>
<p>如上图，描述了单节点容器网络的通信流程，下面主要按<code>C1-&gt;C2</code>的访问流程来详细描述交互流程:</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 先创建两个容器，用于模拟发起请求,启动两个centos容器，并在里面安装net-tools工具，才可以使用ifconfig命令</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建C1，并安装net-tools</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker run -d -it --name c1 centos /bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker exec -it c1 bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ [root@60671509044e /]# yum install -y net-tools</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 创建C2，并安装net-tools</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker run -d -it --name c2 centos /bin/bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker exec -it c2 bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ [root@94a6c877b01a /]# yum install -y net-tools</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>容器<code>C1</code>和<code>C2</code>启动之后，在容器中都有一条默认的路由规则，当前容器网段的所有请求都会走<code>eth0</code>网卡设备。<!-- -->
<ul>
<li>C1</li>
</ul>
</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 进入c1容器，查看ip以及路由表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker exec -it c1 bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看IP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ifconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inet 172.17.0.7  netmask 255.255.0.0  broadcast 172.17.255.255</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ether 02:42:ac:11:00:07  txqueuelen 0  (Ethernet)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RX packets 6698  bytes 9678058 (9.2 MiB)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RX errors 0  dropped 0  overruns 0  frame 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TX packets 3518  bytes 195061 (190.4 KiB)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inet 127.0.0.1  netmask 255.0.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        loop  txqueuelen 1000  (Local Loopback)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RX packets 0  bytes 0 (0.0 B)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RX errors 0  dropped 0  overruns 0  frame 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TX packets 0  bytes 0 (0.0 B)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看路由       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kernel IP routing table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default         _gateway        0.0.0.0         UG    0      0        0 eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 eth0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><code>C2</code></li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 进入C2容器查看IP和路由表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker exec -it c2 bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ifconfig</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inet 172.17.0.8  netmask 255.255.0.0  broadcast 172.17.255.255</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ether 02:42:ac:11:00:08  txqueuelen 0  (Ethernet)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RX packets 6771  bytes 9681937 (9.2 MiB)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RX errors 0  dropped 0  overruns 0  frame 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TX packets 3227  bytes 179347 (175.1 KiB)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inet 127.0.0.1  netmask 255.0.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        loop  txqueuelen 1000  (Local Loopback)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RX packets 0  bytes 0 (0.0 B)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RX errors 0  dropped 0  overruns 0  frame 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TX packets 0  bytes 0 (0.0 B)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看路由</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Kernel IP routing table</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default         _gateway        0.0.0.0         UG    0      0        0 eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 eth0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>上述容器现实有自己的<code>IP</code>以及<code>MAC</code>地址，并且每个容器中都有默认路由<code>_gateway</code>指向<code>eth0</code>网卡；并且<code>_gateway</code>有对应的<code>MAC</code>地址已经存在于本地<code>ARP</code>缓存中。</p>
<ul>
<li>主机之间网络通信需要用到<code>MAC</code>地址，这是数据链路层识别主机的方式，<code>C1</code>访问<code>C2</code>的时候会先从本地<code>ARP</code>缓存中查找是否有<code>C2</code>容器对应的<code>IP:172.17.0.3</code>的<code>MAC</code>地址。如果没有就会发起<code>ARP</code>协议查找<code>MAC</code>地址。</li>
</ul>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># c1 -&gt; c2 ,先发起ARP请求查找MAC地址，可以在容器中查看ARP缓存对应IP的MAC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ docker exec -it c1 bash</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 先查看本地的ARP缓存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ [root@94a6c877b01a /]# arp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Address                  HWtype  HWaddress           Flags Mask            Iface</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">_gateway                 ether   02:42:2e:8d:21:d6   C                     eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 执行ping命令就会发起ARP寻址请求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ping 172.17.0.8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 再查询本地arp缓存，发现已经有MAC地址存在了</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ [root@60671509044e /]# arp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Address                  HWtype  HWaddress           Flags Mask            Iface</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">172.17.0.8               ether   02:42:ac:11:00:08   C                     eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">_gateway                 ether   02:42:2e:8d:21:d6   C                     eth0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>ARP</code>寻址流程：<code>C1</code>容器发起<code>ARP</code>请求，进过本地路由协议之后会把请求路由到网桥上，此时网桥(<code>Bridge</code>)充当一个虚拟交换机，虚拟交换机会把<code>ARP</code>广播到其它插入到网桥的所有容器，<code>C2</code>收到<code>ARP</code>协议之后会回复<code>MAC</code>地址。</p>
<ul>
<li>查找到<code>C2</code>的<code>MAC</code>地址之后就可以发起通信。</li>
</ul>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="二跨主机容器通信">二、跨主机容器通信<a href="https://lengrongfu.github.io/blog/Kubernetes-Network#%E4%BA%8C%E8%B7%A8%E4%B8%BB%E6%9C%BA%E5%AE%B9%E5%99%A8%E9%80%9A%E4%BF%A1" class="hash-link" aria-label="Direct link to 二、跨主机容器通信" title="Direct link to 二、跨主机容器通信">​</a></h2>
<blockquote>
<p>跨主机之间容器通信按是否依赖底层网络环境来划分主要分为<code>Overlay</code>和<code>Underlay</code>两种网络结构，<code>Overlay</code>网络要求只是主机之间网络可达即可，不要求主机之间同处二层域；<code>Underlay</code>对底层的基础设施有要求，按照实现的方式对底层的网络基础设施有不同的要求，比如<code>Flanan host-gw</code>组件要求主机之间同处二层域，也就是主机之间要连接到一个交换机上。</p>
</blockquote>
<h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="名词-1">名词<a href="https://lengrongfu.github.io/blog/Kubernetes-Network#%E5%90%8D%E8%AF%8D-1" class="hash-link" aria-label="Direct link to 名词" title="Direct link to 名词">​</a></h4>
<ul>
<li><code>Overlay Network</code>(覆盖网络): 在已有的宿主机网络之上，通过软件构建一个覆盖在宿主机网络之上的、可以把所有容器连通在一起的虚拟网络。</li>
<li><code>Tun设备(Tunnel设备)</code>：在<code>Linux</code>中，<code>TUN</code>设备是一种工作在三层（<code>Network Layer</code>）的虚拟网络设备;<code>Tun</code>设备的功能就是在操作系统内核和用户应用程序之间传递<code>IP</code>包，</li>
<li><code>VXLAN</code>: 虚拟可扩展局域网(<code>Virtual Extensible LAN</code>),是<code>LINUX</code>内核支持的一种网络虚拟化技术，<code>VXLAN</code>完全在内核态实现网络数据包的封装和解封装。</li>
<li><code>VTEP</code>：虚拟隧道端点设备，它既有<code>IP</code>，也有<code>MAC</code>地址。</li>
<li><code>BGP</code>: 边界网关协议（<code>Border Gateway Protocol</code>）,它是一个<code>Linux</code>内核原生就支持的、专门用在大规模数据中心里维护不同的自治系统之间路由信息的、无中心的路由协议。</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="跨主机通信">跨主机通信<a href="https://lengrongfu.github.io/blog/Kubernetes-Network#%E8%B7%A8%E4%B8%BB%E6%9C%BA%E9%80%9A%E4%BF%A1" class="hash-link" aria-label="Direct link to 跨主机通信" title="Direct link to 跨主机通信">​</a></h3>
<p>跨主机之间的容器通信，通过采用<code>Overlay Network</code>来实现跨主机之间的容器通信，<code>Overlay Network</code>的实现有多种方式。</p>
<p><img decoding="async" loading="lazy" src="https://gitee.com/lengrongfu/blog-static-file/raw/master/overlay_network.png" alt="Overlay Network" class="img_ev3q"></p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="overlay-模式">Overlay 模式<a href="https://lengrongfu.github.io/blog/Kubernetes-Network#overlay-%E6%A8%A1%E5%BC%8F" class="hash-link" aria-label="Direct link to Overlay 模式" title="Direct link to Overlay 模式">​</a></h3>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1三层flannel-udp">1、三层Flannel UDP<a href="https://lengrongfu.github.io/blog/Kubernetes-Network#1%E4%B8%89%E5%B1%82flannel-udp" class="hash-link" aria-label="Direct link to 1、三层Flannel UDP" title="Direct link to 1、三层Flannel UDP">​</a></h5>
<blockquote>
<p><code>Flannel UDP</code>模式是<code>Flannel</code>最开始提供的一种最简单且最易实现的容器跨主网络方案，但是因为性能最差，所以后来被弃用。但是对于理解<code>Overlay</code>的实现方式还是很有参考意义的。</p>
</blockquote>
<p>我们以一个例子来讲述这个网络访问的流程，在这个流程中，有两台宿主机，四个容器，我们需要通过<code>Container-1</code>容器请求<code>Container-4</code>。</p>
<p><img decoding="async" loading="lazy" src="https://gitee.com/lengrongfu/blog-static-file/raw/master/flannel_udp_network.png" alt="" class="img_ev3q"></p>
<p><code>Container-1</code>容器向<code>Container-4</code>容器发起请求，<code>Docker0</code>是位于<code>Root Network Namespace</code>的，通过<code>veth peer</code>一头连着容器的<code>Network Namespace</code>一头连着位于<code>Root Netwrok Namespace</code>的<code>Docker0</code>虚拟网络设备。</p>
<ul>
<li>容器<code>100.96.1.2</code>访问<code>100.96.2.2</code>，由于目的地址不在<code>Docker0</code>网桥的网段内(通过<code>ARP</code>请求一次就知道目标容器不在此网桥上)，所以这个<code>IP</code>会执行<code>Container-1</code>的默认路由规则中，容器中的默认路由规则就是如下的<code>default via 172.17.0.1 dev eth0 </code>。对应到上图的步骤1。</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 容器中默认设置的的路由规则，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@94a6c877b01a /]# ip route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default via 172.17.0.1 dev eth0 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">172.17.0.0/16 dev eth0 proto kernel scope link src 172.17.0.2 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 下一跳是172.17.0.1且从eth0设备上出去，通过查看docker的网络，172.17.0.1就是bridge设备的网关IP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lengrongfu@MacintoshdeMacBook-Pro ~ % docker network ls        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NETWORK ID     NAME                               DRIVER    SCOPE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">e522990979b3   bridge                             bridge    local</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 查看网络</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lengrongfu@MacintoshdeMacBook-Pro ~ % docker inspect network e522990979b3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "Name": "bridge",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "Id": "e522990979b365e9df4d967c3600483e598e530361deb28513b6e75b8b66bedf",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "Created": "2021-04-12T12:11:57.321486866Z",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "Scope": "local",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "Driver": "bridge",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "EnableIPv6": false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "IPAM": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "Driver": "default",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "Options": null,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "Config": [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    "Subnet": "172.17.0.0/16",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    "Gateway": "172.17.0.1"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "Internal": false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "Attachable": false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "Ingress": false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "ConfigFrom": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "Network": ""</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "ConfigOnly": false,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "Containers": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "94a6c877b01ac3a1638f1c5cde87e7c58be9ce0aafd4a78efcb96528ab00ed94": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "Name": "c2",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "EndpointID": "a5c12fb3800991228f8dc3a2a8de1d6f4865439701a83558e4430c2aebf783a8",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "MacAddress": "02:42:ac:11:00:02",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "IPv4Address": "172.17.0.2/16",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                "IPv6Address": ""</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "Options": {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "com.docker.network.bridge.default_bridge": "true",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "com.docker.network.bridge.enable_icc": "true",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "com.docker.network.bridge.enable_ip_masquerade": "true",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "com.docker.network.bridge.host_binding_ipv4": "0.0.0.0",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "com.docker.network.bridge.name": "docker0",</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            "com.docker.network.driver.mtu": "1500"</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        "Labels": {}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>进入到<code>Docker0</code>网桥之后就按照主机上的路由取决于后续如何走。如下就是主机的路由表，访问目标<code>IP</code>为<code>100.96.2.2</code>的设备会命中第二条匹配规则，意思是访问<code>100.96.0.0/16</code>网段的数据去<code>flannel0</code>设备，并且愿<code>IP</code>为<code>100.96.1.0</code>。对应到上图的步骤2。</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Node1路由表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ip route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 Default via 10.168.0.1 dev eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2 100.96.0.0/16 dev flannel0 proto kernel scope link src 100.96.1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3 100.96.1.0/24 dev docker0 proto kernel scope link src 100.96.1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4 10.168.0.0/24 dev eth0 proto kernel scope link src 10.168.0.2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h6 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="flannel0设备">Flannel0设备<a href="https://lengrongfu.github.io/blog/Kubernetes-Network#flannel0%E8%AE%BE%E5%A4%87" class="hash-link" aria-label="Direct link to Flannel0设备" title="Direct link to Flannel0设备">​</a></h6>
<ul>
<li>上述说了<code>Flannel0</code>是一个<code>TUN</code>虚拟三层网络设备，主要是在内核态和用户态之间传递<code>IP</code>包；继续按上述的流程分析，数据报文从内核态到达<code>Flannel0</code>设备之后，会被传递给创建<code>Flannel0</code>设备的进程也就是<code>FlannelD</code>进程，然后<code>flanneld</code>进程看到目的地址是<code>100.96.2.2</code>,就把数据报文发送到<code>Node2</code>节点上的<code>flanneld</code>进程监听的<code>UDP</code>端口上。<code>flanneld</code>会把要发送的数据封装为一个<code>UDP</code>数据包发出去。对应到上图的步骤3、4、5、6。<!-- -->
<ul>
<li><code>flanneld</code>进程是怎么知道<code>100.96.2.2</code>这个<code>ip</code>在<code>Node2</code>上呢，这是因为它利用了子网，在每个节点启动的时候都会被指定一个字网段，通过字网就能确定这个<code>ip</code>是属于那个节点的，子网被存在<code>etcd</code>里面。</li>
</ul>
</li>
<li><code>Node2</code>上的<code>flanneld</code>进程收到数据包之后，会发送到<code>flannel0</code>设备上，这是一个从用户态到内核态的过程，所以<code>Linux</code>内核网络协议栈就会负责处理这个<code>IP</code>包，具体的处理方法，就是通过本机的路由表来寻找这个<code>IP</code>包的下一步流向。对应到上图的步骤7、8。</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># node2上的路由表</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ip route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1 default via 10.168.0.1 dev eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2 100.96.0.0/16 dev flannel0 proto kernel scope link src 100.96.2.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3 100.96.2.0/24 dev docker0 proto kernel scope link src 100.96.2.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4 10.168.0.0/24 dev eth0 proto kernel scope link src 10.168.0.3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>通过解析出目标<code>ip</code>为<code>100.96.2.2</code>，他和第三条的路由规则匹配更加精确，这条路由规则的意思是把发往<code>100.96.2.0/24</code>网段的的数据包发送到<code>docker0</code>设备上去，并且设置源<code>IP</code>为<code>100.96.2.1</code>。对应到上图的步骤9。</li>
<li>数据包进入到<code>docker0</code>设备之后，<code>docker0</code>网桥会扮演二层交换机的角色，将数据包发送给正确的<code>veth pair</code>对，进过此设备之后就进入到<code>Contaniner-2</code>的网络协议栈中。对应到上图的步骤10。</li>
</ul>
<p><code>Flannel UDP</code>模式提供的是一个三层的<code>Overlay</code>网络，它首选对发出端的<code>IP</code>包进行<code>UDP</code>封装，然后在接收端进行解封装拿到原始<code>IP</code>包，进而把这个<code>IP</code>包转发给目标容器。</p>
<p><code>Flannel UDP</code>模式有严重的性能问题，主要问题是，由于使用了<code>TUN</code>设备，仅在发出<code>IP</code>包的过程中，就需要经过三次用户态和内核态之间的数据拷贝。</p>
<p><img decoding="async" loading="lazy" src="https://gitee.com/lengrongfu/blog-static-file/raw/master/flannel_tun.png" alt="tun" class="img_ev3q"></p>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2三层calico-ipip">2、三层Calico ipip<a href="https://lengrongfu.github.io/blog/Kubernetes-Network#2%E4%B8%89%E5%B1%82calico-ipip" class="hash-link" aria-label="Direct link to 2、三层Calico ipip" title="Direct link to 2、三层Calico ipip">​</a></h5>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3二层三层vxlan">3、二层+三层VXLAN<a href="https://lengrongfu.github.io/blog/Kubernetes-Network#3%E4%BA%8C%E5%B1%82%E4%B8%89%E5%B1%82vxlan" class="hash-link" aria-label="Direct link to 3、二层+三层VXLAN" title="Direct link to 3、二层+三层VXLAN">​</a></h5>
<blockquote>
<p><code>VXLAN</code>网络的设计思想是，在现有的三层网络之上，覆盖一层虚拟的、由内核<code>VXLAN</code>模块负责维护的二层网络，使得连接在这个<code>VXLAN</code>二层网络上的主机之间，可以像在同一个局域网那样自由通信。</p>
</blockquote>
<blockquote>
<p>为了能在二层网络上打通隧道，<code>VXLAN</code>会在宿主机上设置一个特殊的网络设备作为隧道的两端，这个设备就叫作<code>VTEP</code>，全称是：(<code>VXLAN Tun End Poin</code>)虚拟隧道端点。</p>
</blockquote>
<blockquote>
<p><code>VTEP</code>设备的作用和<code>flanneld</code>进程的作用是一样的，就是做数据包的封装和解封装，只不过，它进行封装和解封装的是二层数据帧，而且这个工作流程，全都是在内核里完成的。</p>
</blockquote>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="underlay-模式">Underlay 模式<a href="https://lengrongfu.github.io/blog/Kubernetes-Network#underlay-%E6%A8%A1%E5%BC%8F" class="hash-link" aria-label="Direct link to Underlay 模式" title="Direct link to Underlay 模式">​</a></h3>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="1三层模式bgp">1、三层模式BGP<a href="https://lengrongfu.github.io/blog/Kubernetes-Network#1%E4%B8%89%E5%B1%82%E6%A8%A1%E5%BC%8Fbgp" class="hash-link" aria-label="Direct link to 1、三层模式BGP" title="Direct link to 1、三层模式BGP">​</a></h5>
<p><img decoding="async" loading="lazy" src="https://gitee.com/lengrongfu/blog-static-file/raw/master/bgp.png" alt="BGP" class="img_ev3q"></p>
<p>如上图是一个典型的<code>BGP</code>网络拓扑图，通过<code>Route1</code>和<code>Route2</code>作为边界路由网关，把其它<code>LAN</code>的路由信息写入到当前的路由中，就实现了不同<code>LAN</code>下的路由信息同步，达到三层网络全通。</p>
<h6 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="calico-bgp-使用">Calico BGP 使用<a href="https://lengrongfu.github.io/blog/Kubernetes-Network#calico-bgp-%E4%BD%BF%E7%94%A8" class="hash-link" aria-label="Direct link to Calico BGP 使用" title="Direct link to Calico BGP 使用">​</a></h6>
<p>​		在了解了<code>BGP</code>之后，<code>Calico</code>项目的架构就非常容易理解了，它把每个主机节点当做一个边界路由来看待，所以在每个节点上都保存了所有其他节点的路由信息，我们来分析一下它的实现，它由三个部分组成：</p>
<ul>
<li><code>Calico</code>的<code>CNI</code>插件，这是<code>Caclico</code>和<code>Kubernetes</code>对接的部分。</li>
<li><code>BIRD</code>是<code>BGP</code>的客户端，专门负责在集群里面分发路由信息。</li>
<li><code>Felix</code>,它是一个<code>Demoset</code>，负责在宿主机上插入路由规则（写入<code>Linux</code>内核的<code>FIB</code>转发信息表），以及维护<code>Calico</code>所需的网络设备等工作。</li>
</ul>
<p>​	<code>Calico BGP</code>模式和<code>Flannel host-gw</code>模式不同，<code>Calico</code>没有创建任何的虚拟网桥设备，<code>Calico</code>的工作方式采用如下图来说明。</p>
<p><img decoding="async" loading="lazy" src="https://gitee.com/lengrongfu/blog-static-file/raw/master/calico_bgp.png" alt="calico_bgp" class="img_ev3q"></p>
<p>​		<code>Calico BGP</code>模式的网络交互图如上所示，如<code>container1</code>需要访问<code>Container3</code>，我们来分析下网络如何到达。因为没有采用<code>cni0</code>虚拟网桥设备，因此<code>veth</code>设备对的一端是在容器的<code>Network Namespace</code>中的，一端是在宿主机的容器网络空间的，</p>
<ul>
<li>首先<code>Calico CNI</code>插件还需要在每个宿主机上为每个容器的<code>Veth Pair</code>设备配置一条路由规则，由于接受传入的<code>IP</code>包，比如：</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 192.168.0.2节点上的路由信息有</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ip route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.20.0.2 dev cali1 scope link</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.20.0.3 dev cali2 scope link</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 192.168.0.3节点上的路由信息有</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ip route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.20.1.2 dev cali3 scope link</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.20.1.3 dev cali4 scope link</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>每个节点上还有<code>BGP</code>广播的其它节点路由协议，比如：</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 192.168.0.2上有一条指向192.169.0.3的路由</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ip route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.20.1.0/24 via 192.168.0.3 dev eth0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 192.168.0.3上有一条指向192.168.0.2的路由</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$ ip route</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10.20.0.0/24 via 192.168.0.2 dev eth0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>默认的<code>Calico BGP</code>使用的是<code>Node to Node</code>的模式，会导致每个节点上的连接以<code>N^2</code>的数独增长，一般推荐少于使用<code>100</code>个节点的集群中。在大规模集群中，需要用到一个叫<code>Route Reflector</code>的模式，所有的路由会统一上报到一个中心节点，其它节点都从中心节点进行同步。</li>
</ul>
<p><code>Calico BGP</code>模式和<code>Flannel host-gw</code>模式一样，都有一个对基础网络设施的依赖，要求集群宿主机之间是二层可达的。假如宿主机之间处在不同的<code>LAN</code>下，就需要使用<code>Calico ipip</code>的<code>Overlay</code>模式了。</p>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="2二层vlan">2、二层VLAN<a href="https://lengrongfu.github.io/blog/Kubernetes-Network#2%E4%BA%8C%E5%B1%82vlan" class="hash-link" aria-label="Direct link to 2、二层VLAN" title="Direct link to 2、二层VLAN">​</a></h5>
<h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="3flannel-host-gw">3、Flannel host-gw<a href="https://lengrongfu.github.io/blog/Kubernetes-Network#3flannel-host-gw" class="hash-link" aria-label="Direct link to 3、Flannel host-gw" title="Direct link to 3、Flannel host-gw">​</a></h5>
<blockquote>
<p><code>Flannel host-gw</code>模式一张图就可以讲清楚他们之间的实现原理。</p>
</blockquote>
<p><img decoding="async" loading="lazy" src="https://gitee.com/lengrongfu/blog-static-file/raw/master/flannel_hostgw.png" alt="host-gw" class="img_ev3q"></p>
<ul>
<li><code>CNI0</code>设备是一个三层交换机，具有二层交换机的功能，同时具有独立<code>IP</code></li>
</ul>
<p><code>flannel</code>以<code>Daemonset</code>的方式在每个节点上启动一个<code>Flanneld</code>进程，用于维护每个节点上的路由信息，实现方式是，本地</p>
<p>如：<code>192.168.1.0/24 via 10.20.0.3 dev eth0</code>路由定义了访问<code>192.168.1.0/24</code>网段的下一跳为<code>10.20.0.3</code>并从<code>eth0</code>设备出。</p>
<p>然后<code>IP</code>包被封装成帧发送出去的时候，会使用路由表里的下一跳来设置目的<code>MAC</code>地址；这样，就能通过二层网络达到目的宿主机。</p>
<p>因为他会使用下一跳的目的<code>MAC</code>地址，所以它要求宿主机之间是二层联通的，不如就没法通过使用<code>ARP</code>协议用<code>IP</code>去获取<code>MAC</code>地址了。</p>]]></content>
        <author>
            <name>Leng Student</name>
            <uri>https://github.com/lengrongfu</uri>
        </author>
        <category label="Kubernetes" term="Kubernetes"/>
        <category label="Kubernetes Network" term="Kubernetes Network"/>
    </entry>
    <entry>
        <title type="html"><![CDATA[go channel 实现]]></title>
        <id>https://lengrongfu.github.io/blog/go-channel源码</id>
        <link href="https://lengrongfu.github.io/blog/go-channel源码"/>
        <updated>2019-09-18T00:00:00.000Z</updated>
        <summary type="html"><![CDATA[Channel是go之间通信的一种方式，从实现上说，channel是一个链表的数据结构，可以将数据放入和读取。]]></summary>
        <content type="html"><![CDATA[<p><code>Channel</code>是<code>go</code>之间通信的一种方式，从实现上说，<code>channel</code>是一个链表的数据结构，可以将数据放入和读取。</p>
<p><code>Channel</code>是<code>go</code>之间通信的一种方式，从实现上说，<code>channel</code>是一个链表的数据结构，可以将数据放入和读取。</p>
<h1>基本使用</h1>
<p><code>channel</code>分为有缓冲区的和无缓冲区的通道。</p>
<h1>原理</h1>
<p><code>channel</code>就是通过一个共享队列来做协程之间的数据传递的，是一种数据结构，低层还是通过锁来控制数据之间的安全；和我们自己实现的差别,加入了协程挂起和通知的功能，使得协程更加的快速。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="发送消息时">发送消息时：<a href="https://lengrongfu.github.io/blog/go-channel%E6%BA%90%E7%A0%81#%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E6%97%B6" class="hash-link" aria-label="Direct link to 发送消息时：" title="Direct link to 发送消息时：">​</a></h2>
<p>channel已经关闭，那就不能发。panic掉。
看一下有没有阻塞在读操作上的goroutine，有的话取出上一次接收的位置，然后把发送的元素插入到缓冲槽尾部。所以写入有序，输出也是有序的。
没有被阻塞的goroutine。如果带buffer，buffer还有空位，就放在buffer里。否则就阻塞挂起当前发送消息的goroutine。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="读取消息时">读取消息时：<a href="https://lengrongfu.github.io/blog/go-channel%E6%BA%90%E7%A0%81#%E8%AF%BB%E5%8F%96%E6%B6%88%E6%81%AF%E6%97%B6" class="hash-link" aria-label="Direct link to 读取消息时：" title="Direct link to 读取消息时：">​</a></h2>
<p>channel已经关闭，也可以读，只是读出来的数据为空。
看一下有没有阻塞的写操作的goroutine，有的话唤醒它。读取它发送的数据(A)。
读取后的数据(A)放哪，视乎是带buffer还是无buffer。无buffer的话，就直接把写数据(A)给读取者。带buffer的话，就先看buffer里是否有数据(B)，有就把数据(B)给读取者，再把数据(A)放到原来数据(B)空出来的位置上。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="chan-结构体解读">chan 结构体解读<a href="https://lengrongfu.github.io/blog/go-channel%E6%BA%90%E7%A0%81#chan-%E7%BB%93%E6%9E%84%E4%BD%93%E8%A7%A3%E8%AF%BB" class="hash-link" aria-label="Direct link to chan 结构体解读" title="Direct link to chan 结构体解读">​</a></h2>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> hchan </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	qcount   </span><span class="token builtin">uint</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">// 队列中的数据量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	dataqsiz </span><span class="token builtin">uint</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">// 队列的容量</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	buf      unsafe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pointer </span><span class="token comment" style="color:#999988;font-style:italic">// 存储数据的缓冲区</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	elemsize </span><span class="token builtin">uint16</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">//元素的占位大小</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	closed   </span><span class="token builtin">uint32</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">//关闭标志位，0 未关闭，1 关闭</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	elemtype </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">_type </span><span class="token comment" style="color:#999988;font-style:italic">// 元素类型</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	sendx    </span><span class="token builtin">uint</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// 发送index</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	recvx    </span><span class="token builtin">uint</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">// 接收index</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	recvq    waitq  </span><span class="token comment" style="color:#999988;font-style:italic">// 接收等待队列，存储了接收挂起的g</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	sendq    waitq  </span><span class="token comment" style="color:#999988;font-style:italic">// 存储了挂起的发送队列</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//锁，保护hchan里面的字段</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	lock mutex</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="chansend-发送源码解读">chansend 发送源码解读<a href="https://lengrongfu.github.io/blog/go-channel%E6%BA%90%E7%A0%81#chansend-%E5%8F%91%E9%80%81%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB" class="hash-link" aria-label="Direct link to chansend 发送源码解读" title="Direct link to chansend 发送源码解读">​</a></h2>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">chansend</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">hchan</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ep unsafe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pointer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> block </span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> callerpc </span><span class="token builtin">uintptr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">bool</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">//加锁</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lock</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//1、如果关闭就panic，不能发送到一个关闭的channel</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">closed </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lock</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">panic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">plainError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"send on closed channel"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//2、接收队列中取出一个g</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> sg </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recvq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">dequeue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> sg </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">//找到一个等待的接收g，把数据直接复制到g的stack上，并把它安排在下一次调度上</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">send</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ep</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lock</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//3、如果缓冲队列还有空间</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">qcount </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dataqsiz </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// 将要发送的消息放入队列中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		qp </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">chanbuf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> raceenabled </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token function" style="color:#d73a49">raceacquire</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">qp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token function" style="color:#d73a49">racerelease</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">qp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">typedmemmove</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">elemtype</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> qp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ep</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendx</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">//记得归位</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendx </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dataqsiz </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">//放入一个+1，取出一个-1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">qcount</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lock</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">block </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lock</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//4、如果没有缓冲区可用，把当前的g挂起，并加入到发送队列中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	gp </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mysg </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">acquireSudog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mysg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">releasetime </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> t0 </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		mysg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">releasetime </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// No stack splits between assigning elem and enqueuing mysg</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// on gp.waiting where copystack can find it.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mysg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">elem </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mysg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">waitlink </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mysg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">g </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mysg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isSelect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mysg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	gp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">waiting </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mysg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	gp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">param </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">enqueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mysg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">goparkunlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lock</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> waitReasonChanSend</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> traceEvGoBlockSend</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Ensure the value being sent is kept alive until the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// receiver copies it out. The sudog has a pointer to the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// stack object, but sudogs aren't considered as roots of the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// stack tracer.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">KeepAlive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ep</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// someone woke us up.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> mysg </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> gp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">waiting </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"G waiting list is corrupted"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	gp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">waiting </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> gp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">param </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">closed </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token function" style="color:#d73a49">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"chansend: spurious wakeup"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">panic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">plainError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"send on closed channel"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	gp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">param </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> mysg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">releasetime </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">blockevent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mysg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">releasetime</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">t0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mysg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">releaseSudog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mysg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="chanrecv-接收解读">chanrecv 接收解读<a href="https://lengrongfu.github.io/blog/go-channel%E6%BA%90%E7%A0%81#chanrecv-%E6%8E%A5%E6%94%B6%E8%A7%A3%E8%AF%BB" class="hash-link" aria-label="Direct link to chanrecv 接收解读" title="Direct link to chanrecv 接收解读">​</a></h2>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">chanrecv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">hchan</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ep unsafe</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Pointer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> block </span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">selected</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> received </span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//先检查如果队列中没有元素，并且发送等待队列中也没有挂起的g，并且未关闭就直接返回</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">block </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dataqsiz </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">first </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dataqsiz </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> atomic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Loaduint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">qcount</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		atomic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">closed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//加锁</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lock</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//1、如果channel已经关闭并且队列元素个数为0，则返回，不会报panic</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">closed </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">qcount </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> raceenabled </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token function" style="color:#d73a49">raceacquire</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">raceaddr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lock</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> ep </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token function" style="color:#d73a49">typedmemclr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">elemtype</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ep</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//2、</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> sg </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">dequeue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> sg </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// Found a waiting sender. If buffer is size 0, receive value</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// directly from sender. Otherwise, receive from head of queue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// and add sender's value to the tail of the queue (both map to</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// the same buffer slot because the queue is full).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// 如果buffer是0，从发送中直接获取并接收；除此之外，从队列头接收并且发送值到队尾</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">recv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sg</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ep</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lock</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//3、如果缓存队列中还有元素，就取出来接收</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">qcount </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// Receive directly from queue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		qp </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">chanbuf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recvx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> raceenabled </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token function" style="color:#d73a49">raceacquire</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">qp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token function" style="color:#d73a49">racerelease</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">qp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> ep </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token function" style="color:#d73a49">typedmemmove</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">elemtype</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ep</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> qp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">typedmemclr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">elemtype</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> qp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recvx</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recvx </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dataqsiz </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recvx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">qcount</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lock</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">block </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lock</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// 没有可用的，就挂起当前的g，并放入接收等待队列中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	gp </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mysg </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">acquireSudog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mysg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">releasetime </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> t0 </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		mysg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">releasetime </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// No stack splits between assigning elem and enqueuing mysg</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// on gp.waiting where copystack can find it.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mysg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">elem </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mysg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">waitlink </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	gp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">waiting </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mysg</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mysg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">g </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> gp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mysg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isSelect </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mysg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	gp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">param </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">recvq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">enqueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mysg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">goparkunlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lock</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> waitReasonChanReceive</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> traceEvGoBlockRecv</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// someone woke us up</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> mysg </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> gp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">waiting </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"G waiting list is corrupted"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	gp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">waiting </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> mysg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">releasetime </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">blockevent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mysg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">releasetime</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">t0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	closed </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> gp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">param </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	gp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">param </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	mysg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">c </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token function" style="color:#d73a49">releaseSudog</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mysg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">closed</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>waitq 双向链表解读</h1>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// waitq 只保存了一个执行头和一个执行尾的指针，保存的元素都是sudog</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> waitq </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	first </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sudog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	last  </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sudog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// sudog 代表一个go在一个等待队列中</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> sudog </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//下面的字段受hchan.lock锁的保护，</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	g </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">g</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// isSelect 为true表示g正在参与select选择，g.selectDone必须被cas算法调用才能唤醒g</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	isSelect </span><span class="token builtin">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	next     </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sudog </span><span class="token comment" style="color:#999988;font-style:italic">// 下一个 这个两个字段组成了一个双向链表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	prev     </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sudog </span><span class="token comment" style="color:#999988;font-style:italic">// 上一个</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="入队列">入队列<a href="https://lengrongfu.github.io/blog/go-channel%E6%BA%90%E7%A0%81#%E5%85%A5%E9%98%9F%E5%88%97" class="hash-link" aria-label="Direct link to 入队列" title="Direct link to 入队列">​</a></h3>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 队头和队尾分别指向第一个元素和最后一个元素，如果只有一个元素，那么队头和队尾都指向他</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">q </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">waitq</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">enqueue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sgp </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sudog</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	sgp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">next </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	x </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> q</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		sgp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">prev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		q</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">first </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sgp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		q</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sgp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	sgp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">prev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">next </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sgp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	q</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sgp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="出队列">出队列<a href="https://lengrongfu.github.io/blog/go-channel%E6%BA%90%E7%A0%81#%E5%87%BA%E9%98%9F%E5%88%97" class="hash-link" aria-label="Direct link to 出队列" title="Direct link to 出队列">​</a></h3>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// 出队列的时候，移动队头往后移动，并设置队头的元素指向下一个为nil，是一个FIFO队列</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">q </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">waitq</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">dequeue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">sudog </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		sgp </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> q</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">first</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> sgp </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		y </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> sgp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">next</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> y </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			q</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">first </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			q</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">last </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			y</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">prev </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			q</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">first </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			sgp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">next </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// mark as removed (see dequeueSudog)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">//当g是在select阻塞的时候需要设置selectDone为1才能唤醒g</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> sgp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isSelect </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain">atomic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Cas</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">sgp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">g</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">selectDone</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">continue</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> sgp</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>lock 实现解读</h1>
<p>加锁和解锁没有使用<code>mutex</code>，而是使用了<code>futex</code>技术，这个是在<code>linux</code>系统环境下的，<code>futex</code>是一种高效的加锁方式。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="lock-加锁">lock 加锁<a href="https://lengrongfu.github.io/blog/go-channel%E6%BA%90%E7%A0%81#lock-%E5%8A%A0%E9%94%81" class="hash-link" aria-label="Direct link to lock 加锁" title="Direct link to lock 加锁">​</a></h2>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">l </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">mutex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	gp </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> gp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">locks </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"runtime·lock: lock count"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	gp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">locks</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// Speculative grab for lock.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	v </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> atomic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Xchg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">key32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">l</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mutex_locked</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> v </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> mutex_unlocked </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// wait is either MUTEX_LOCKED or MUTEX_SLEEPING</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// depending on whether there is a thread sleeping</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// on this mutex. If we ever change l-&gt;key from</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// MUTEX_SLEEPING to some other value, we must be</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// careful to change it back to MUTEX_SLEEPING before</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// returning, to ensure that the sleeping thread gets</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// its wakeup call.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	wait </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// On uniprocessors, no point spinning.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">// On multiprocessors, spin for ACTIVE_SPIN attempts.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	spin </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> ncpu </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		spin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> active_spin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// Try for lock, spinning.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> spin</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> l</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> mutex_unlocked </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> atomic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Cas</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">key32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">l</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mutex_unlocked</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> wait</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token function" style="color:#d73a49">procyield</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">active_spin_cnt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// Try for lock, rescheduling.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> passive_spin</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i</span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> l</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> mutex_unlocked </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> atomic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Cas</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">key32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">l</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mutex_unlocked</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> wait</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">					</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">				</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token function" style="color:#d73a49">osyield</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">// Sleep.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		v </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> atomic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Xchg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">key32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">l</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mutex_sleeping</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> v </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> mutex_unlocked </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		wait </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mutex_sleeping</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">futexsleep</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">key32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">l</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mutex_sleeping</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="unlock-解锁">unlock 解锁<a href="https://lengrongfu.github.io/blog/go-channel%E6%BA%90%E7%A0%81#unlock-%E8%A7%A3%E9%94%81" class="hash-link" aria-label="Direct link to unlock 解锁" title="Direct link to unlock 解锁">​</a></h2>
<div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">unlock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">l </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">mutex</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	v </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> atomic</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Xchg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">key32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">l</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mutex_unlocked</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> v </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> mutex_unlocked </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"unlock of unlocked lock"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> v </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> mutex_sleeping </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">futexwakeup</span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">key32</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">l</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	gp </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getg</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	gp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">locks</span><span class="token operator" style="color:#393A34">--</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> gp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">locks </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token function" style="color:#d73a49">throw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">"runtime·unlock: lock count"</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> gp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">m</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">locks </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"> gp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">preempt </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// restore the preemption request in case we've cleared it in newstack</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		gp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stackguard0 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> stackPreempt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h1>Channel 的优点</h1>
<p>1、和<code>goroutine</code>调度结合起来，使得数据传输更加的高效和快速。
2、使用的锁不是操作系统的<code>mutex</code>互斥锁，而是使用的<code>futex</code>技术。</p>
<h1>参考</h1>
<ul>
<li><a href="http://cbsheng.github.io/posts/go%E7%9A%84channel%E6%BA%90%E7%A0%81%E5%B1%82%E7%90%86%E8%A7%A3/" target="_blank" rel="noopener noreferrer">http://cbsheng.github.io/posts/go%E7%9A%84channel%E6%BA%90%E7%A0%81%E5%B1%82%E7%90%86%E8%A7%A3/</a></li>
<li><a href="https://zh.wikipedia.org/wiki/Futex" target="_blank" rel="noopener noreferrer">https://zh.wikipedia.org/wiki/Futex</a></li>
</ul>]]></content>
        <author>
            <name>Leng Student</name>
            <uri>https://github.com/lengrongfu</uri>
        </author>
        <category label="golang" term="golang"/>
        <category label="channel" term="channel"/>
    </entry>
</feed>